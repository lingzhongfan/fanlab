<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-VBM | è¯­éŸ³ç”Ÿç‰©æ ‡è®°ä¸å£°å­¦ç‰¹å¾æå– (ç§‘ç ”å®Œå…¨ä½“ v4.0)</title>
    <style>
        /* ==================== UI ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --cyan: #06b6d4; --teal: #0d9488; --red: #f43f5e; --green: #10b981; --slate: #64748b; --bg: #fcfcfd; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); user-select: none; }
        .container { max-width: 900px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--cyan); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .sys-btn { width: 100%; padding: 20px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 18px; transition: 0.2s; display: flex; align-items: center; gap: 12px; justify-content: center; }
        
        /* åˆºæ¿€å‘ˆç°åŒº (å·é¥¼å›¾) */
        .stimulus-workspace { width: 100%; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 20px; padding: 20px; box-sizing: border-box; margin-bottom: 20px; text-align: center;}
        .img-placeholder { width: 100%; height: 350px; background: #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--slate); font-weight: bold; font-size: 18px; flex-direction: column; gap: 10px; border: 2px solid #cbd5e1; overflow: hidden;}
        
        /* å£°çº¹ç¤ºæ³¢å™¨ç”»å¸ƒ */
        .audio-visualizer { width: 100%; height: 120px; background: #0f172a; border-radius: 16px; margin-bottom: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); overflow: hidden; position: relative;}
        canvas { display: block; width: 100%; height: 100%; }
        
        /* çŠ¶æ€ä¸æ§åˆ¶åŒº */
        .controls-board { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .btn-record { background: var(--cyan); color: white; box-shadow: 0 8px 20px rgba(6, 182, 212, 0.2); }
        .btn-record:hover { background: #0891b2; transform: translateY(-2px); }
        .btn-stop { background: var(--red); color: white; box-shadow: 0 8px 20px rgba(244, 63, 94, 0.2); }
        .btn-stop:hover { background: #e11d48; transform: translateY(-2px); }
        .btn-stop:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; transform: none;}

        .timer-display { font-size: 40px; font-weight: bold; color: var(--primary); font-family: monospace; text-align: center; margin: 10px 0; }
        .timer-alert { color: var(--red); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* ç‰¹å¾é¢æ¿ */
        .metrics-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px; }
        .metric-card { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: center; }
        .metric-card span { display: block; font-size: 12px; color: var(--slate); font-weight: bold; margin-bottom: 5px; }
        .metric-card strong { font-size: 24px; color: var(--cyan); font-family: monospace; }
        
        .download-box { background: #f0fdf4; border: 2px dashed #86efac; padding: 20px; border-radius: 16px; text-align: center; margin-top: 20px; }
        .btn-download { background: var(--green); color: white; padding: 15px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; border: none; transition: 0.2s;}
        .btn-download:hover { background: #059669; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--cyan); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="main-area">
        <div class="module-header">
            <h2>ğŸ™ï¸ è¯­éŸ³ç”Ÿç‰©æ ‡è®°ä¸å£°å­¦ç‰¹å¾ (VBM)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>è¯„ä¼°è¯­ä¹‰æµç•…æ€§ä¸å‘éŸ³è¿åŠ¨æ§åˆ¶ã€‚<br>
            *åŸºäºâ€œæ³¢å£«é¡¿å·é¥¼å›¾â€èŒƒå¼ï¼Œå‰ç«¯æå–é™é»˜åœé¡¿æ¯”(Silence Ratio)ï¼Œæ•æ‰é˜¿å°”èŒ¨æµ·é»˜ç—…(AD)æ—©æœŸçš„æ‰¾è¯å›°éš¾ä¸ç©ºæ´è¨€è¯­(Empty Speech)ã€‚</p>
        </div>

        <div class="stimulus-workspace">
            <h3 style="margin-top:0; color:var(--primary);">ç»å…¸å›¾ç‰‡æè¿°ä»»åŠ¡ (Picture Description)</h3>
            <p style="color:var(--slate); font-size:14px; text-align:left;"><strong>æŒ‡å¯¼è¯­ï¼š</strong>â€œè¯·ä»”ç»†çœ‹è¿™å¹…å›¾ï¼Œå‘Šè¯‰æˆ‘å›¾é‡Œé¢æ­£åœ¨å‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚è¯·å°½å¯èƒ½è¯´å¾—è¯¦ç»†ä¸€äº›ã€‚æ—¶é—´ä¸º 60 ç§’ã€‚â€</p>
            
            <div class="img-placeholder">
                <div>ğŸª æ³¢å£«é¡¿â€œå·é¥¼å›¾â€æ ‡å‡†åˆºæ¿€æº</div>
                <div style="font-size: 12px; font-weight:normal;">[è¯·åœ¨æ­¤å¤„åŠ è½½ Cookie Theft å›¾åº“]</div>
            </div>
        </div>

        <div class="audio-visualizer">
            <canvas id="oscilloscope"></canvas>
        </div>

        <div class="timer-display" id="time-display">01:00</div>

        <div class="controls-board">
            <button class="sys-btn btn-record" id="btn-record" onclick="startRecording()">ğŸ™ï¸ å¼€å§‹å½•éŸ³ä¸ç‰¹å¾æå–</button>
            <button class="sys-btn btn-stop" id="btn-stop" onclick="stopRecording()" disabled>â¹ï¸ åœæ­¢æµ‹è¯•</button>
        </div>

        <div class="metrics-board" id="metrics-board" style="opacity: 0.3; pointer-events: none;">
            <div class="metric-card"><span>æ€»æ—¶é•¿ (Total Time)</span><strong id="m-total">0.0 s</strong></div>
            <div class="metric-card"><span>å‘å£°æ—¶é•¿ (Phonation)</span><strong id="m-voice">0.0 s</strong></div>
            <div class="metric-card"><span>é™é»˜åœé¡¿æ¯” (Silence Ratio)</span><strong id="m-ratio" style="color:var(--red);">0.0 %</strong></div>
        </div>

        <div id="download-area" class="download-box hidden">
            <h3 style="color:#166534; margin-top:0;">âœ… åŸå§‹æ— æŸéŸ³é¢‘å·²å°±ç»ª</h3>
            <p style="font-size:14px; color:#15803d; margin-bottom:20px;">ç”±äºéŸ³é¢‘æ–‡ä»¶ä½“ç§¯è¾ƒå¤§ï¼Œç³»ç»Ÿå·²å°†ç‰¹å¾å…¥åº“ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†åŸå£°éŸ³é¢‘ä¿å­˜è‡³æœ¬åœ°ï¼Œç”¨äºåç»­çš„ Python openSMILE é«˜ç»´å£°å­¦æå–ã€‚</p>
            <button class="btn-download" id="btn-download-audio">â¬‡ï¸ ä¸‹è½½ WAV éŸ³é¢‘æ–‡ä»¶</button>
        </div>

    </div>

    <script>
        const TIME_LIMIT = 60; // æ ‡å‡†å›¾ç‰‡æè¿°æ—¶é—´ä¸º 1åˆ†é’Ÿ
        let timeLeft = TIME_LIMIT;
        let recordingInterval = null;
        
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let audioUrl = null;

        // Web Audio API å˜é‡
        let audioContext;
        let analyser;
        let microphone;
        let javascriptNode;
        let canvasContext;
        let animationId;

        // ç®€æ˜“å‰ç«¯ VAD (Voice Activity Detection) ç»Ÿè®¡
        let totalFrames = 0;
        let silentFrames = 0;
        let silenceThreshold = 10; // éŸ³é‡æŒ¯å¹…é˜ˆå€¼ (0-255)

        const canvas = document.getElementById('oscilloscope');
        canvasContext = canvas.getContext('2d');
        
        // è‡ªé€‚åº” Canvas å¤§å°
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ç»˜åˆ¶é»˜è®¤é™æ€çº¿
        function drawStaticLine() {
            canvasContext.fillStyle = '#0f172a';
            canvasContext.fillRect(0, 0, canvas.width, canvas.height);
            canvasContext.lineWidth = 2;
            canvasContext.strokeStyle = '#334155';
            canvasContext.beginPath();
            canvasContext.moveTo(0, canvas.height / 2);
            canvasContext.lineTo(canvas.width, canvas.height / 2);
            canvasContext.stroke();
        }
        drawStaticLine();

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                
                // 1. åˆå§‹åŒ– MediaRecorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.start();

                // 2. åˆå§‹åŒ– Web Audio API é¢‘åŸŸåˆ†æ
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                analyser.fftSize = 2048;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                microphone.connect(analyser);

                // é‡ç½®ç»Ÿè®¡å‚æ•°
                totalFrames = 0;
                silentFrames = 0;
                timeLeft = TIME_LIMIT;
                document.getElementById('metrics-board').style.opacity = '0.3';
                document.getElementById('download-area').classList.add('hidden');

                // 3. UI çŠ¶æ€åˆ‡æ¢
                document.getElementById('btn-record').disabled = true;
                document.getElementById('btn-record').innerText = "ğŸ”´ é‡‡é›†ä¸­...";
                document.getElementById('btn-stop').disabled = false;

                // 4. å®æ—¶ç¤ºæ³¢å™¨ä¸ VAD è®¡ç®—å¼•æ“
                function drawOscilloscope() {
                    animationId = requestAnimationFrame(drawOscilloscope);
                    analyser.getByteTimeDomainData(dataArray);

                    canvasContext.fillStyle = '#0f172a';
                    canvasContext.fillRect(0, 0, canvas.width, canvas.height);
                    canvasContext.lineWidth = 2;
                    canvasContext.strokeStyle = '#06b6d4'; // å£°çº¹é¢œè‰²
                    canvasContext.beginPath();

                    let sliceWidth = canvas.width * 1.0 / bufferLength;
                    let x = 0;
                    let currentVolumeSum = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        let v = dataArray[i] / 128.0;
                        let y = v * canvas.height / 2;
                        
                        // è®¡ç®—ç¬æ—¶æŒ¯å¹… (åç§»128çš„ç»å¯¹å€¼)
                        let amplitude = Math.abs(dataArray[i] - 128);
                        currentVolumeSum += amplitude;

                        if (i === 0) canvasContext.moveTo(x, y);
                        else canvasContext.lineTo(x, y);
                        x += sliceWidth;
                    }

                    canvasContext.lineTo(canvas.width, canvas.height / 2);
                    canvasContext.stroke();

                    // VAD: åˆ¤æ–­å½“å‰å¸§æ˜¯å¦å¤„äºé™é»˜
                    totalFrames++;
                    let avgVolume = currentVolumeSum / bufferLength;
                    if(avgVolume < silenceThreshold) {
                        silentFrames++;
                    }
                }
                drawOscilloscope();

                // 5. å€’è®¡æ—¶å¼•æ“
                recordingInterval = setInterval(() => {
                    timeLeft--;
                    let sec = timeLeft < 10 ? '0' + timeLeft : timeLeft;
                    const display = document.getElementById('time-display');
                    display.innerText = `00:${sec}`;
                    
                    if(timeLeft <= 10) display.classList.add('timer-alert');
                    if(timeLeft <= 0) stopRecording();
                }, 1000);

            } catch(err) {
                alert("âš ï¸ æ— æ³•è°ƒç”¨éº¦å…‹é£ï¼è¯·ç¡®ä¿æµè§ˆå™¨æ‹¥æœ‰éº¦å…‹é£æƒé™ä¸”å¤„äº HTTPS ç¯å¢ƒã€‚");
                console.error(err);
            }
        }

        function stopRecording() {
            clearInterval(recordingInterval);
            cancelAnimationFrame(animationId);
            drawStaticLine();

            document.getElementById('time-display').classList.remove('timer-alert');
            document.getElementById('btn-record').disabled = false;
            document.getElementById('btn-record').innerText = "ğŸ”„ é‡æ–°æµ‹è¯•";
            document.getElementById('btn-stop').disabled = true;

            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
                
                // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“é‡Šæ”¾éº¦å…‹é£
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                }

                // è®¡ç®—å¹¶ä¿å­˜ç‰¹å¾
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    audioUrl = URL.createObjectURL(audioBlob);
                    
                    calculateMetricsAndSave();
                    setupDownloadButton();
                };
            }
        }

        function calculateMetricsAndSave() {
            // è®¡ç®—æ—¶é—´ä¸åœé¡¿æ¯”
            const actualDurationSec = TIME_LIMIT - timeLeft;
            const ratio = totalFrames > 0 ? (silentFrames / totalFrames) : 0;
            const silenceRatioPercent = (ratio * 100).toFixed(1);
            const phonationSec = (actualDurationSec * (1 - ratio)).toFixed(1);

            // æ›´æ–° UI é¢æ¿
            document.getElementById('metrics-board').style.opacity = '1';
            document.getElementById('m-total').innerText = actualDurationSec + ' s';
            document.getElementById('m-voice').innerText = phonationSec + ' s';
            document.getElementById('m-ratio').innerText = silenceRatioPercent + ' %';
            
            // é«˜å±é¢„è­¦é¢œè‰²
            if(silenceRatioPercent > 40) document.getElementById('m-ratio').style.color = 'var(--red)';
            else document.getElementById('m-ratio').style.color = 'var(--teal)';

            // å­˜å…¥åº•å±‚å¼•æ“ (ä»…å­˜ç‰¹å¾ï¼Œç”±äº Blob å¤ªå¤§ä¸è¿› LocalStorage)
            let vbmData = {
                module: "Voice_Biomarkers",
                summary: {
                    total_duration_sec: actualDurationSec,
                    phonation_time_sec: parseFloat(phonationSec),
                    silence_ratio_percent: parseFloat(silenceRatioPercent)
                }
            };
            CAS_Storage.saveModuleData('Voice_Biomarkers', vbmData);
            
            let msg = `âœ… VBM å£°å­¦åŸºæœ¬ç‰¹å¾å·²æå–å…¥åº“ï¼\n\n- æ€»è¯´è¯æ—¶é•¿: ${actualDurationSec} ç§’\n- æœ‰æ•ˆå‘å£°æ—¶é•¿: ${phonationSec} ç§’\n- é™é»˜åœé¡¿æ¯”: ${silenceRatioPercent}%\n\n`;
            if(silenceRatioPercent > 45) {
                msg += "âš ï¸ ä¸´åºŠæç¤ºï¼šé™é»˜åœé¡¿æ¯”ä¾‹è¿‡é«˜ã€‚å—è¯•è€…åœ¨æè¿°å›¾ç‰‡æ—¶å¯èƒ½å­˜åœ¨ä¸¥é‡çš„ã€æ‰¾è¯å›°éš¾ã€‘æˆ–è¨€è¯­å‘èµ·éšœç¢ï¼Œè¿™æ˜¯å¤±è¯­ç—‡æˆ–ç—´å‘†æ—©æœŸçš„æ•æ„Ÿæ ‡å¿—ã€‚";
            }
            alert(msg);
        }

        function setupDownloadButton() {
            const dlArea = document.getElementById('download-area');
            const dlBtn = document.getElementById('btn-download-audio');
            dlArea.classList.remove('hidden');
            
            dlBtn.onclick = () => {
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = audioUrl;
                // å‘½åè§„èŒƒï¼šåŒ…å«æ—¶é—´æˆ³ï¼Œæ–¹ä¾¿å¯¹æ¥ BIDS æ ¼å¼
                a.download = `CAS_VBM_CookieTheft_${new Date().getTime()}.wav`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                }, 100);
            };
        }
    </script>
</body>
</html>
