<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-VBM | è¯­éŸ³ç”Ÿç‰©æ ‡å¿—ç‰©æå–</title>
    <style>
        /* ==================== 1. ç§‘æŠ€æ¸©æƒ…é£ UI (Warm-Tech UI) ==================== */
        :root { 
            --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; 
            --green: #10b981; --red: #f43f5e; --purple: #8b5cf6; --slate: #64748b; 
        }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--purple); padding-left: 15px; margin-bottom: 20px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.5; }

        /* ==================== 2. è§†è§‰åˆºæ¿€å‘ˆç°åŒº ==================== */
        .stimulus-box { width: 100%; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 25px; box-sizing: border-box;}
        .stimulus-img { max-width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stimulus-placeholder { font-size: 16px; color: var(--slate); padding: 40px; background: #e2e8f0; border-radius: 12px; font-weight: bold; }

        /* ==================== 3. å®æ—¶æ³¢å½¢å¼•æ“è§†çª— ==================== */
        .visualizer-wrapper { background: #0f172a; border-radius: 16px; padding: 20px; margin-bottom: 25px; position: relative; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        canvas { width: 100%; height: 120px; display: block; }
        
        /* çŠ¶æ€ä¸ä»ªè¡¨ç›˜ */
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .dash-card { background: var(--light-blue); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #c7d2fe; transition: 0.3s;}
        .dash-card span { display: block; font-size: 12px; color: var(--blue); font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .dash-card strong { font-size: 24px; color: var(--primary); font-family: monospace; }

        /* API è¯·æ±‚åŠ è½½çŠ¶æ€ */
        #api-loading { color: var(--amber); font-size: 13px; font-weight: bold; margin-bottom: 20px; display: none; text-align: center; }

        /* ==================== 4. äº¤äº’æ§åˆ¶æŒ‰é’® ==================== */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .btn { padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-record { background: var(--green); color: white; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2); }
        .btn-record:hover { background: #059669; }
        .btn-stop { background: var(--red); color: white; opacity: 0.5; cursor: not-allowed; }
        .btn-stop.active { opacity: 1; cursor: pointer; box-shadow: 0 8px 20px rgba(244, 63, 94, 0.2); }
        .btn-stop.active:hover { background: #e11d48; }
        
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--purple); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="module-header">
            <h2>ğŸ™ï¸ å£°å­¦ä¸å‰¯è¯­è¨€ç‰¹å¾åˆ†æ (Voice Biomarkers)</h2>
            <p>åŸºäºã€Šæ³¢å£«é¡¿å¤±è¯­ç—‡è¯Šæ–­æµ‹éªŒã€‹(BDAE) ä¸­çš„â€œå·é¥¼å›¾â€è‡ªå‘è¯­è¨€èŒƒå¼ã€‚<br>
               <strong>ä¸´åºŠé¶å‘ï¼š</strong>æ—©æœŸ AD/MCI çš„è¯æ±‡æ£€ç´¢å›°éš¾ (è¡¨ç°ä¸ºåœé¡¿å¢åŠ )ã€æ—©æœŸ PD çš„éŸ³è°ƒæ‰°åŠ¨ä¸å‘å£°è¿Ÿç¼“ã€‚</p>
        </div>

        <div class="stimulus-box">
            <img class="stimulus-img" id="cookie-img" src="stimuli/cookie_theft.jpg" alt="å·é¥¼å›¾" onerror="this.style.display='none'; document.getElementById('placeholder').style.display='block';">
            <div class="stimulus-placeholder hidden" id="placeholder">
                [å›¾ç‰‡ç¼ºå¤±] è¯·ç¡®ä¿ stimuli/cookie_theft.jpg æ–‡ä»¶å­˜åœ¨<br>
                <span style="font-weight:normal; font-size:14px; margin-top:10px; display:block; color:var(--blue);">
                    ä¸»è¯•æŒ‡å¯¼è¯­: "è¯·æ‚¨å°½å¯èƒ½è¯¦ç»†åœ°æè¿°è¿™å¼ å›¾ç‰‡é‡Œæ­£åœ¨å‘ç”Ÿä»€ä¹ˆã€‚"
                </span>
            </div>
        </div>

        <div class="visualizer-wrapper">
            <canvas id="oscilloscope"></canvas>
            <div style="position:absolute; top:15px; left:20px; color:#10b981; font-family:monospace; font-weight:bold; font-size:12px; letter-spacing:1px;" id="audio-status">ENGINE: STANDBY</div>
        </div>

        <div class="dashboard">
            <div class="dash-card"><span>æ€»æ—¶é•¿ (Duration)</span><strong id="val-time">0.0s</strong></div>
            <div class="dash-card"><span>å‘éŸ³æ—¶é•¿ (Phonation)</span><strong id="val-speak">0.0s</strong></div>
            <div class="dash-card" id="card-pause"><span>åœé¡¿æ¯” (Pause Ratio)</span><strong id="val-pause">0.0%</strong></div>
        </div>
        
        <div id="api-loading">â³ æ­£åœ¨å‘ Python åç«¯æœåŠ¡å™¨æå–é«˜é˜¶å£°å­¦ç‰¹å¾...</div>

        <div class="controls">
            <button class="btn btn-record" id="btn-start" onclick="startRecording()">ğŸ¤ å¼€å§‹å½•éŸ³ (Start)</button>
            <button class="btn btn-stop" id="btn-stop" onclick="stopRecording()" disabled>â¹ ç»“æŸå¹¶æå– (Stop)</button>
        </div>
    </div>

    <script>
        /* ==================== 1. å…¨å±€å˜é‡ä¸éŸ³é¢‘ä¸Šä¸‹æ–‡ ==================== */
        let audioContext, analyser, microphone;
        let mediaRecorder, audioChunks = [];
        let animationId;
        
        // ä¸´åºŠç‰¹å¾æµ‹ç®—å˜é‡ (åŸºäºå‰ç«¯æ€§èƒ½é«˜ç²¾åº¦æ—¶é—´æˆ³)
        let startTime = 0, totalTimeMs = 0, speakingTimeMs = 0;
        
        // VAD (Voice Activity Detection) èƒ½é‡é˜ˆå€¼
        // èŒƒå›´ 0-255ï¼Œæ ¹æ®é—¨è¯Š/ç¤¾åŒºå®é™…åº•å™ªè°ƒæ•´ã€‚ä½äºæ­¤é˜ˆå€¼åˆ¤å®šä¸ºâ€œæ— å£°åœé¡¿(Silent Pause)â€
        const VOLUME_THRESHOLD = 5; 

        // Canvas åˆå§‹åŒ–é…ç½®
        const canvas = document.getElementById('oscilloscope');
        const ctx = canvas.getContext('2d');
        let dataArray, bufferLength;

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth - 40;
            canvas.height = 120;
            drawStandby();
        }
        window.onresize = resizeCanvas;
        
        // å¾…æœºçŠ¶æ€ä¸‹çš„é™æ€æ¨ªçº¿
        function drawStandby() {
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 2; ctx.strokeStyle = '#334155'; ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2); ctx.lineTo(canvas.width, canvas.height / 2); ctx.stroke();
        }
        resizeCanvas();

        /* ==================== 2. å½•éŸ³ä¸å®æ—¶ VAD å¼•æ“ ==================== */
        async function startRecording() {
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™ï¼Œå¼€å¯å›å£°æ¶ˆé™¤ï¼Œå…³é—­é™å™ªä»¥ä¿ç•™åŸå§‹å‘éŸ³å¾®é¢¤ç‰¹å¾
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: false } });
                
                // åˆå§‹åŒ– Web Audio API 
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048; // é‡‡æ ·çª—å£å¤§å°
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                // é…ç½® MediaRecorder ä»¥æå–çº¯æ­£çš„éŸ³é¢‘ Blob
                // WebM æ ¼å¼åœ¨ç°ä»£æµè§ˆå™¨ä¸­æ”¯æŒåº¦æé«˜
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                audioChunks = [];
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.start();

                // åˆ‡æ¢ UI çŠ¶æ€ä¸ºå½•éŸ³æ¨¡å¼
                document.getElementById('btn-start').classList.add('recording-pulse');
                document.getElementById('btn-start').disabled = true;
                document.getElementById('btn-start').innerText = "å½•éŸ³ä¸­... è¯·æè¿°å›¾ç‰‡";
                
                const btnStop = document.getElementById('btn-stop');
                btnStop.disabled = false; btnStop.classList.add('active');
                document.getElementById('audio-status').innerText = `ENGINE: RECORDING | SR: ${audioContext.sampleRate}Hz`;

                // é‡ç½®æ—¶é—´è½´
                startTime = performance.now();
                totalTimeMs = 0; speakingTimeMs = 0;

                // å¯åŠ¨å¸§æ¸²æŸ“å¾ªç¯
                drawWaveform();

            } catch (err) {
                alert("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥è®¾å¤‡å¹¶èµ‹äºˆæµè§ˆå™¨æƒé™ã€‚\né”™è¯¯ä¿¡æ¯: " + err);
            }
        }

        // é«˜é¢‘æ³¢å½¢æ¸²æŸ“ä¸å®æ—¶â€œå‘éŸ³/åœé¡¿â€åˆ‡åˆ†é€»è¾‘
        function drawWaveform() {
            animationId = requestAnimationFrame(drawWaveform);
            analyser.getByteTimeDomainData(dataArray);

            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 2; ctx.strokeStyle = '#10b981'; ctx.beginPath();

            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;
            let currentVolume = 0; 

            for (let i = 0; i < bufferLength; i++) {
                // 128 æ˜¯é™éŸ³åŸºå‡†çº¿ã€‚è®¡ç®—ç»å¯¹åç¦»å€¼ä½œä¸ºç¬æ—¶å£°å­¦èƒ½é‡
                const v = dataArray[i] / 128.0;
                const y = v * canvas.height / 2;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                x += sliceWidth;
                
                currentVolume += Math.abs(dataArray[i] - 128);
            }
            ctx.lineTo(canvas.width, canvas.height / 2); ctx.stroke();
            currentVolume = currentVolume / bufferLength;

            // æµ‹ç®—æ—¶é•¿æµé€
            const now = performance.now();
            const deltaMs = now - startTime;
            startTime = now;
            totalTimeMs += deltaMs;
            
            // å¦‚æœç¬æ—¶èƒ½é‡è¶Šè¿‡é˜ˆå€¼ï¼Œåˆ¤å®šå¤„äºâ€œå‘éŸ³æœŸâ€
            if (currentVolume > VOLUME_THRESHOLD) {
                speakingTimeMs += deltaMs;
                ctx.strokeStyle = '#8b5cf6'; // å‘éŸ³æ—¶æ³¢å½¢å˜ç´«
                ctx.stroke();
            }

            // æ›´æ–°ä»ªè¡¨ç›˜ UI
            const totalSec = (totalTimeMs / 1000).toFixed(1);
            const speakSec = (speakingTimeMs / 1000).toFixed(1);
            const pauseRatio = ((totalTimeMs - speakingTimeMs) / totalTimeMs * 100).toFixed(1);

            document.getElementById('val-time').innerText = totalSec + 's';
            document.getElementById('val-speak').innerText = speakSec + 's';
            
            // ä¸´åºŠé¢„è­¦é€»è¾‘ï¼šå¯¹äºè¶…è¿‡ 5 ç§’çš„è‡ªå‘è¨€è¯­ï¼Œè‹¥åœé¡¿æ¯” > 40%ï¼ŒèƒŒæ™¯æ ‡çº¢æç¤ºæ‰¾è¯å›°éš¾å¯èƒ½
            const pauseEl = document.getElementById('val-pause');
            const cardPause = document.getElementById('card-pause');
            pauseEl.innerText = pauseRatio + '%';
            
            if(pauseRatio > 40 && totalSec > 5) { 
                cardPause.style.background = '#fff1f2'; cardPause.style.borderColor = 'var(--red)'; pauseEl.style.color = 'var(--red)';
            } else { 
                cardPause.style.background = 'var(--light-blue)'; cardPause.style.borderColor = '#c7d2fe'; pauseEl.style.color = 'var(--primary)'; 
            }
        }

        /* ==================== 3. åœæ­¢ã€ä¿å­˜ä¸åç«¯ API é›†æˆ ==================== */
        function stopRecording() {
            mediaRecorder.stop();
            cancelAnimationFrame(animationId);
            microphone.disconnect();
            audioContext.close();

            // æ¢å¤åˆå§‹ UI çŠ¶æ€
            const btnStart = document.getElementById('btn-start');
            btnStart.classList.remove('recording-pulse'); btnStart.disabled = false; btnStart.innerHTML = "ğŸ¤ é‡æ–°å½•åˆ¶ (Restart)";
            
            const btnStop = document.getElementById('btn-stop');
            btnStop.disabled = true; btnStop.classList.remove('active');
            document.getElementById('audio-status').innerText = "ENGINE: STOPPED";
            drawStandby();

            // å½“éŸ³é¢‘æ•°æ®æ‰“åŒ…å®Œæˆæ—¶è§¦å‘
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); 
                const loadingText = document.getElementById('api-loading');
                loadingText.style.display = 'block';

                // æ„å»ºè¦å­˜å…¥ CAS_Storage çš„åŸºç¡€ç‰¹å¾åŒ… (å«å‰ç«¯è®¡ç®—çš„è¡Œä¸ºå­¦ç‰¹å¾)
                let vbmData = {
                    module: "Voice_Biomarkers",
                    duration_sec: parseFloat(document.getElementById('val-time').innerText),
                    phonation_sec: parseFloat(document.getElementById('val-speak').innerText),
                    pause_ratio: parseFloat(document.getElementById('val-pause').innerText),
                    advanced_features: null // é¢„ç•™ç»™åç«¯çš„æ·±å±‚å£°å­¦ç‰¹å¾ (MFCCs, F0 ç­‰)
                };

                // ğŸš€ è°ƒç”¨ Python åç«¯æ¥å£æå–é«˜é˜¶ç‰¹å¾ (ä¼˜é›…é™çº§æ¶æ„)
                try {
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'cas_recording.webm');
                    
                    // å®é™…éƒ¨ç½²æ—¶ï¼Œå°† localhost æ›¿æ¢ä¸ºæ‚¨çš„äº‘æœåŠ¡å™¨ API åœ°å€
                    const response = await fetch('http://localhost:5000/extract_features', {
                        method: 'POST', body: formData
                    });

                    if (response.ok) {
                        const apiResult = await response.json();
                        // æå–æˆåŠŸï¼Œå°†åç«¯ç‰¹å¾å†™å…¥æ•°æ®åŒ…
                        vbmData.advanced_features = apiResult.features; 
                        console.log("åç«¯æå–æˆåŠŸ:", apiResult.features);
                    } else {
                        console.warn("åç«¯è¿”å›å¼‚å¸¸çŠ¶æ€:", response.status);
                    }
                } catch (error) {
                    // ã€ä¼˜é›…é™çº§ã€‘å¦‚æœ Python æœåŠ¡å™¨æœªå¯åŠ¨æˆ–å¤„äºæ–­ç½‘ç¯å¢ƒï¼Œä¸æ‰“æ–­ä¸»è¯•æµç¨‹
                    console.warn("æœªèƒ½è¿æ¥åˆ° Python åç«¯ç‰¹å¾æå–å¼•æ“ã€‚æœ¬æ¬¡ä»…ä¿å­˜å‰ç«¯ VAD è®¡ç®—å‡ºçš„åœé¡¿æµåˆ©æ€§ç‰¹å¾ã€‚", error);
                }

                loadingText.style.display = 'none';

                // å°†ç»“æ„åŒ–æ•°æ®ä¿å­˜è‡³æœ¬åœ°æ€»æ¡£æ¡ˆ
                CAS_Storage.saveModuleData('Voice_Biomarkers', vbmData);
                
                let successMsg = `è¯­éŸ³è¡¨å‹é‡‡é›†å®Œæˆï¼\n\n- æ€»æ—¶é•¿: ${vbmData.duration_sec} s\n- è¯é—´åœé¡¿æ¯”: ${vbmData.pause_ratio} %\n`;
                if(vbmData.advanced_features) {
                    successMsg += `\nâœ… å·²æˆåŠŸä»æœåŠ¡å™¨æ‹‰å–é«˜é˜¶ MFCCs ä¸å£°å­¦å¾®æ‰° (Jitter) ç‰¹å¾å¹¶å°è£…å…¥åº“ã€‚`;
                } else {
                    successMsg += `\nâš ï¸ åç«¯æœåŠ¡å™¨æœªå“åº”æˆ–å¤„äºç¦»çº¿æ¨¡å¼ï¼Œæœ¬æ¬¡ä»…ä¿å­˜å‰ç«¯è¡Œä¸ºå­¦ç‰¹å¾ã€‚`;
                }
                
                alert(successMsg);
                setTimeout(() => { location.href = 'index.html'; }, 800);
            };
        }
    </script>
</body>
</html>
