<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-KEY | æŒ‰é”®å¾®è§‚åŠ¨åŠ›å­¦è¯„ä¼° (ç§‘ç ”å®Œå…¨ä½“)</title>
    <style>
        /* ==================== UI ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --teal: #0d9488; --orange: #f97316; --slate: #64748b; --red: #f43f5e;}
        body { font-family: -apple-system, sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 900px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        .module-header { border-left: 6px solid var(--orange); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        /* å‚è€ƒæ–‡æœ¬åŒº */
        .reference-box { background: #fff7ed; border: 2px dashed #fed7aa; padding: 25px; border-radius: 16px; margin-bottom: 25px; }
        .reference-box p { margin: 0 0 10px 0; color: #9a3412; font-weight: bold; font-size: 15px; }
        .ref-text { font-family: 'Courier New', Courier, monospace; font-size: 20px; color: var(--orange); font-weight: bold; line-height: 1.5; user-select: none; }

        /* è¾“å…¥åŒº */
        .input-workspace { position: relative; margin-bottom: 30px; }
        textarea { width: 100%; height: 180px; box-sizing: border-box; padding: 20px; border: 2px solid #cbd5e1; border-radius: 16px; font-size: 20px; font-family: 'Courier New', Courier, monospace; outline: none; transition: 0.3s; resize: none; color: var(--primary); font-weight: bold; line-height: 1.5;}
        textarea:focus { border-color: var(--orange); box-shadow: 0 0 0 4px #ffedd5; }
        textarea:disabled { background: #f1f5f9; cursor: not-allowed; }

        /* å®æ—¶ä»ªè¡¨ç›˜ */
        .metrics-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: center; transition: 0.2s;}
        .metric-card span { display: block; font-size: 12px; color: var(--slate); font-weight: bold; margin-bottom: 5px; }
        .metric-card strong { font-size: 22px; color: var(--primary); font-family: monospace; }
        .highlight-val { color: var(--orange) !important; }

        /* æäº¤æŒ‰é’® */
        .btn-submit { width: 100%; padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; background: var(--orange); color: white; box-shadow: 0 8px 20px rgba(249, 115, 22, 0.2);}
        .btn-submit:hover { background: #ea580c; transform: translateY(-2px); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--orange); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="module-header">
            <h2>âŒ¨ï¸ æŒ‰é”®å¾®è§‚åŠ¨åŠ›å­¦ (Keystroke Dynamics)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>æ•æ‰å¸•é‡‘æ£®ç—… (PD) æ—©æœŸçš„è¿åŠ¨è¿Ÿç¼“ä¸è‚Œè‚‰å¼ºç›´å¼•èµ·çš„äºšæ¯«ç§’çº§å¾®è§‚åŠ¨ä½œå˜å¼‚ã€‚<br>
            *åŸºäºå¤§å®¹é‡æ–‡æœ¬æŠ„å†™ï¼Œæå–æ»ç•™æ—¶é—´å‡å€¼ä¸å˜å¼‚ç³»æ•° (CV)ã€‚</p>
        </div>

        <div class="reference-box">
            <p>âš ï¸ ä¸´åºŠè¦æ±‚ï¼šè¯·å…³é—­ä¸­æ–‡è¾“å…¥æ³•ï¼å‡†ç¡®ã€è¿è´¯åœ°æŠ„å†™ä¸‹æ–¹æ®µè½ (çº¦éœ€ 60 ç§’)ï¼š</p>
            <div class="ref-text" id="target-text">The rapid development of digital phenotyping allows researchers to capture subtle motor fluctuations in real time. Patients with early neurodegenerative diseases often show increased dwell times and higher variance before clinical symptoms appear. Please keep typing steadily.</div>
        </div>

        <div class="input-workspace">
            <textarea id="typing-area" placeholder="ç‚¹å‡»æ­¤å¤„å¼€å§‹æ‰“å­— (è¯·å°½é‡ä¸è¦æŒ‰é€€æ ¼é”®ï¼Œæ‰“é”™ç»§ç»­å³å¯)..." autocomplete="off" spellcheck="false" onpaste="return false;" ondrop="return false;"></textarea>
        </div>

        <div class="metrics-board">
            <div class="metric-card"><span>æ€»æŒ‰é”®æ•°</span><strong id="m-keys">0</strong></div>
            <div class="metric-card"><span>å‡æ»ç•™ (Dwell)</span><strong id="m-dwell" class="highlight-val">0 ms</strong></div>
            <div class="metric-card"><span>æ»ç•™å˜å¼‚ (CV)</span><strong id="m-cv" class="highlight-val">0.0 %</strong></div>
            <div class="metric-card"><span>å‡é£è¡Œ (Flight)</span><strong id="m-flight">0 ms</strong></div>
        </div>

        <button class="btn-submit" onclick="submitKeystroke()">ğŸ’¾ æå–é«˜ç»´åŠ¨åŠ›å­¦ç‰¹å¾å¹¶å…¥åº“</button>
    </div>

    <script>
        const inputArea = document.getElementById('typing-area');
        let keystrokeData = { module: "MOT_Keystroke", raw_events: [], key_pairs: [], summary: {} };
        
        let activeKeys = {}; 
        let lastKeyupTime = null;
        let dwellTimesArray = []; // å­˜å‚¨æ‰€æœ‰æœ‰æ•ˆçš„ Dwell Time ç”¨äºè®¡ç®—æ–¹å·®
        let flightTimesArray = [];

        // éœ€è¦è¿‡æ»¤çš„éå­—ç¬¦åŠŸèƒ½é”®
        const ignoredKeys = new Set(["Shift", "Backspace", "CapsLock", "Control", "Alt", "Meta", "Enter", "Tab", "Escape"]);

        inputArea.addEventListener('keydown', (e) => {
            // å±è”½éæ³•åŠŸèƒ½é”®å¹²æ‰°
            if(ignoredKeys.has(e.key)) return;
            // å±è”½ç»„åˆé”® (å¦‚ Ctrl+C, Cmd+V)ï¼Œé˜²æ­¢ç³»ç»Ÿå±‚é¢çš„ä½œå¼Šç»•è¿‡
            if(e.ctrlKey || e.metaKey || e.altKey) return;
            
            const now = performance.now();
            const keyChar = e.key;

            // é¿å…é•¿æŒ‰è§¦å‘çš„æ“ä½œç³»ç»Ÿçº§ keydown é‡å¤äº‹ä»¶
            if(!activeKeys[keyChar]) {
                activeKeys[keyChar] = now; 
                
                // è®¡ç®—é£è¡Œæ—¶é—´ (Flight Time = å½“å‰ keydown - ä¸Šä¸€æ¬¡ä»»æ„é”®çš„ keyup)
                if(lastKeyupTime !== null) {
                    const flightTime = now - lastKeyupTime;
                    // å‰”é™¤å—è¯•è€…ä¸­é€”å‘å‘†ã€ä¼‘æ¯çš„æç«¯é•¿åœé¡¿å™ªéŸ³ (>2000ms è§†ä¸ºéè¿åŠ¨å­¦åœé¡¿)
                    if(flightTime > 0 && flightTime < 2000) {
                        flightTimesArray.push(flightTime);
                    }
                }
                keystrokeData.raw_events.push({ action: 'down', key: keyChar, t: Math.round(now) });
            }
        });

        inputArea.addEventListener('keyup', (e) => {
            if(ignoredKeys.has(e.key)) return;

            const now = performance.now();
            const keyChar = e.key;
            lastKeyupTime = now;

            if(activeKeys[keyChar]) {
                const dwellTime = now - activeKeys[keyChar]; // æ»ç•™æ—¶é—´ = keyup - keydown
                
                // å‰”é™¤å¼‚å¸¸çš„æŒ‰é”®ç²˜è¿ (>1000ms è§†ä¸ºå¼‚å¸¸æ“ä½œè€Œéç—…ç†æ€§ç²˜æ»)
                if(dwellTime > 0 && dwellTime < 1000) {
                    dwellTimesArray.push(dwellTime);
                    keystrokeData.key_pairs.push({ key: keyChar, dwell_ms: Math.round(dwellTime) });
                }
                
                delete activeKeys[keyChar]; // æ¸…ç†çŠ¶æ€ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æŒ‰ä¸‹
                keystrokeData.raw_events.push({ action: 'up', key: keyChar, t: Math.round(now) });
                
                // é™åˆ¶ UI åˆ·æ–°é¢‘ç‡ä»¥èŠ‚çœ JS çº¿ç¨‹æ€§èƒ½ (æ¯ 5 ä¸ªå­—ç¬¦åˆ·æ–°ä¸€æ¬¡ä»ªè¡¨ç›˜)
                if(dwellTimesArray.length % 5 === 0) updateUI();
            }
            
            // è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å®ŒæˆæŠ„å†™ (å¯¹æ¯”å­—ç¬¦é•¿åº¦)
            if(inputArea.value.length >= document.getElementById('target-text').innerText.length) {
                inputArea.style.borderColor = "var(--teal)";
                updateUI(); // æœ€ç»ˆæ›´æ–°ä¸€æ¬¡
            }
        });

        // æ ¸å¿ƒç»Ÿè®¡ç®—æ³•ï¼šå¹³å‡æ•° (Mean) ä¸ å˜å¼‚ç³»æ•° (CV = StdDev / Mean * 100)
        function calculateStats(arr) {
            if(arr.length === 0) return { mean: 0, cv: 0 };
            const sum = arr.reduce((a, b) => a + b, 0);
            const mean = sum / arr.length;
            const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / arr.length;
            const stdDev = Math.sqrt(variance);
            const cv = mean > 0 ? (stdDev / mean) * 100 : 0; 
            return { mean: Math.round(mean), cv: cv.toFixed(1) };
        }

        function updateUI() {
            document.getElementById('m-keys').innerText = dwellTimesArray.length;
            
            const dwellStats = calculateStats(dwellTimesArray);
            document.getElementById('m-dwell').innerText = dwellStats.mean + ' ms';
            document.getElementById('m-cv').innerText = dwellStats.cv + ' %';
            
            // ä¸´åºŠå®æ—¶é¢„è­¦æœºåˆ¶ï¼šDwell å˜å¼‚æå¤§ï¼Œæç¤ºä¸¥é‡éœ‡é¢¤æˆ–è‚Œè‚‰å¼ºç›´å¼•èµ·çš„æŒ‰é”®å¤±ç¨³
            if(dwellStats.cv > 30) {
                document.getElementById('m-cv').style.color = 'var(--red)';
            } else {
                document.getElementById('m-cv').style.color = 'var(--orange)';
            }

            const flightStats = calculateStats(flightTimesArray);
            document.getElementById('m-flight').innerText = flightStats.mean + ' ms';
        }

        function submitKeystroke() {
            // ä¸´åºŠåº•çº¿ï¼šå°‘äº 50 æ¬¡æœ‰æ•ˆæ•²å‡»ï¼Œæ— æ³•ç®—å‡ºå…·æœ‰ç»Ÿè®¡å­¦æ„ä¹‰çš„ CV
            if(dwellTimesArray.length < 50) return alert("æ•°æ®é‡è¿‡å°‘ï¼ä¸´åºŠæœ‰æ•ˆåˆ†æè‡³å°‘éœ€è¦ 50 æ¬¡æŒ‰é”®è®°å½•ï¼Œè¯·å—è¯•è€…ç»§ç»­æŠ„å†™ã€‚");

            const dwellStats = calculateStats(dwellTimesArray);
            const flightStats = calculateStats(flightTimesArray);

            keystrokeData.summary = {
                avg_dwell_ms: dwellStats.mean,
                dwell_cv: parseFloat(dwellStats.cv),
                avg_flight_ms: flightStats.mean,
                flight_cv: parseFloat(flightStats.cv),
                total_keys_pressed: dwellTimesArray.length
            };

            CAS_Storage.saveModuleData('MOT_Keystroke', keystrokeData);
            
            let msg = `âœ… ä¸´åºŠçº§æŒ‰é”®åŠ¨åŠ›å­¦å…¥åº“ï¼\n\n- é‡‡é›†æœ‰æ•ˆæ•°æ®ç‚¹: ${dwellTimesArray.length} å‡»\n- å¹³å‡æ»ç•™æ—¶é—´: ${dwellStats.mean} ms\n- æ»ç•™å˜å¼‚ç³»æ•°(CV): ${dwellStats.cv}%\n\n`;
            
            if(dwellStats.cv > 30) {
                msg += "âš ï¸ ä¸´åºŠæç¤ºï¼šå—è¯•è€…çš„ Dwell CV æ˜¾è‘—é«˜äºå¸¸æ¨¡ï¼Œæç¤ºåŠ¨ä½œæ‰§è¡Œä¸­å­˜åœ¨æ˜æ˜¾çš„å¾®è§‚èµ·ä¼ä¸è¡°å‡ï¼Œé«˜åº¦ç–‘ä¼¼é”¥ä½“å¤–ç³»ç—‡çŠ¶å¼•èµ·çš„è‚Œè‚‰å¼ºç›´ã€‚";
            } else {
                msg += "* é”®ç›˜å¾®è§‚è¿åŠ¨æ§åˆ¶çŠ¶æ€ç¨³å®šã€‚";
            }

            alert(msg);
            setTimeout(() => { location.href = 'index.html'; }, 800);
        }
    </script>
</body>
</html>
