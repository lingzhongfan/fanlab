<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-MOT | æŒ‰é”®åŠ¨åŠ›å­¦è¯„ä¼°</title>
    <style>
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --teal: #0d9488; --orange: #f97316; --slate: #64748b; }
        body { font-family: -apple-system, sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        .module-header { border-left: 6px solid var(--orange); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }
        

        /* æŠ„å†™å‚è€ƒæ–‡æœ¬åŒº */
        .reference-box { background: #fff7ed; border: 2px dashed #fed7aa; padding: 25px; border-radius: 16px; margin-bottom: 25px; text-align: center; }
        .reference-box p { margin: 0 0 10px 0; color: #9a3412; font-weight: bold; font-size: 15px; }
        .ref-text { font-family: 'Courier New', Courier, monospace; font-size: 26px; color: var(--orange); font-weight: bold; letter-spacing: 2px; user-select: none; }

        /* è¾“å…¥åŒº */
        .input-workspace { position: relative; margin-bottom: 30px; }
        textarea { width: 100%; height: 120px; box-sizing: border-box; padding: 20px; border: 2px solid #cbd5e1; border-radius: 16px; font-size: 22px; font-family: 'Courier New', Courier, monospace; outline: none; transition: 0.3s; resize: none; color: var(--primary); font-weight: bold;}
        textarea:focus { border-color: var(--orange); box-shadow: 0 0 0 4px #ffedd5; }
        textarea:disabled { background: #f1f5f9; cursor: not-allowed; }

        /* å®æ—¶ä»ªè¡¨ç›˜ */
        .metrics-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .metric-card span { display: block; font-size: 12px; color: var(--slate); font-weight: bold; margin-bottom: 5px; }
        .metric-card strong { font-size: 24px; color: var(--primary); font-family: monospace; }
        .highlight-val { color: var(--orange) !important; }

        .btn-submit { width: 100%; padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; background: var(--orange); color: white; box-shadow: 0 8px 20px rgba(249, 115, 22, 0.2); }
        .btn-submit:hover { background: #ea580c; transform: translateY(-2px); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--orange); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="module-header">
            <h2>âŒ¨ï¸ æŒ‰é”®åŠ¨åŠ›å­¦ (Keystroke Dynamics)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>æ•æ‰å¸•é‡‘æ£®ç—… (PD) æ—©æœŸçš„è¿åŠ¨å¼ºç›´ä¸åŠ¨ä½œè¿Ÿç¼“ã€‚<br>
            *ä¸ºå‰”é™¤è¾“å…¥æ³•å¸¦æ¥çš„è®¤çŸ¥å»¶è¿Ÿå™ªéŸ³ï¼Œè¯·ä½¿ç”¨å®ä½“é”®ç›˜æŠ„å†™ä»¥ä¸‹çº¯è‹±æ–‡å­—ç¬¦ä¸²ã€‚</p>
        </div>

        <div class="reference-box">
            <p>è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å‡†ç¡®ä¸”å¿«é€Ÿåœ°æŠ„å†™è¿™æ®µæ–‡å­—ï¼š</p>
            <div class="ref-text" id="target-text">the quick brown fox jumps over the lazy dog</div>
        </div>

        <div class="input-workspace">
            <textarea id="typing-area" placeholder="ç‚¹å‡»æ­¤å¤„å¼€å§‹æ‰“å­—..." autocomplete="off" spellcheck="false"></textarea>
        </div>

        <div class="metrics-board">
            <div class="metric-card"><span>æ€»æŒ‰é”®æ¬¡æ•°</span><strong id="m-keys">0</strong></div>
            <div class="metric-card"><span>å¹³å‡æ»ç•™æ—¶é—´ (Dwell)</span><strong id="m-dwell" class="highlight-val">0 ms</strong></div>
            <div class="metric-card"><span>å¹³å‡é£è¡Œæ—¶é—´ (Flight)</span><strong id="m-flight">0 ms</strong></div>
        </div>

        <button class="btn-submit" onclick="submitKeystroke()">ğŸ’¾ æå–å¾®è§‚æŒ‰é”®ç‰¹å¾å¹¶å…¥åº“</button>
    </div>

    <script>
        const inputArea = document.getElementById('typing-area');
        
        // æ ¸å¿ƒæ•°æ®ç»“æ„
        let keystrokeData = {
            module: "MOT_Keystroke",
            raw_events: [],       // è®°å½•æ¯ä¸€æ¬¡æŒ‰ä¸‹å’ŒæŠ¬èµ·çš„æ—¶é—´æˆ³
            key_pairs: [],        // è®°å½•å®Œæ•´çš„ Dwell å’Œ Flight å¯¹
            summary: {}
        };

        // ä¸´æ—¶å˜é‡ï¼Œç”¨äºè¿½è¸ªæŒ‰é”®çŠ¶æ€
        let activeKeys = {}; 
        let lastKeyupTime = null;
        let totalDwellTime = 0;
        let validDwellCount = 0;
        let totalFlightTime = 0;
        let validFlightCount = 0;

        // ç›‘å¬æŒ‰ä¸‹äº‹ä»¶ (è®¡ç®— Flight Time å’Œ Dwell èµ·ç‚¹)
        inputArea.addEventListener('keydown', (e) => {
            // å±è”½åŠŸèƒ½é”®å¹²æ‰°
            if(e.key === "Shift" || e.key === "Backspace" || e.key === "CapsLock") return;
            
            const now = performance.now();
            const keyChar = e.key;

            // é¿å…é•¿æŒ‰è§¦å‘çš„é‡å¤ keydown
            if(!activeKeys[keyChar]) {
                activeKeys[keyChar] = now; // è®°å½•æŒ‰ä¸‹æ—¶é—´
                
                // è®¡ç®—é£è¡Œæ—¶é—´ (Flight Time = å½“å‰ keydown - ä¸Šä¸€ä¸ª keyup)
                if(lastKeyupTime !== null) {
                    const flightTime = now - lastKeyupTime;
                    if(flightTime > 0 && flightTime < 2000) { // å‰”é™¤å¼‚å¸¸é•¿çš„åœé¡¿
                        totalFlightTime += flightTime;
                        validFlightCount++;
                        updateUI();
                    }
                }
                
                keystrokeData.raw_events.push({ action: 'down', key: keyChar, t: Math.round(now) });
            }
        });

        // ç›‘å¬æŠ¬èµ·äº‹ä»¶ (è®¡ç®— Dwell Time)
        inputArea.addEventListener('keyup', (e) => {
            if(e.key === "Shift" || e.key === "Backspace" || e.key === "CapsLock") return;

            const now = performance.now();
            const keyChar = e.key;
            lastKeyupTime = now;

            if(activeKeys[keyChar]) {
                const dwellTime = now - activeKeys[keyChar]; // æ»ç•™æ—¶é—´ = keyup - keydown
                
                totalDwellTime += dwellTime;
                validDwellCount++;
                
                keystrokeData.key_pairs.push({
                    key: keyChar,
                    dwell_ms: Math.round(dwellTime)
                });
                
                delete activeKeys[keyChar]; // æ¸…é™¤çŠ¶æ€
                keystrokeData.raw_events.push({ action: 'up', key: keyChar, t: Math.round(now) });
                
                updateUI();
            }
            
            // è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å®ŒæˆæŠ„å†™
            if(inputArea.value.trim().toLowerCase() === document.getElementById('target-text').innerText.trim()) {
                inputArea.style.borderColor = "var(--green)";
                inputArea.disabled = true;
            }
        });

        function updateUI() {
            document.getElementById('m-keys').innerText = validDwellCount;
            
            if(validDwellCount > 0) {
                const avgDwell = totalDwellTime / validDwellCount;
                document.getElementById('m-dwell').innerText = Math.round(avgDwell) + ' ms';
                // é¢„è­¦æç¤ºï¼šå¥åº·å¹´è½»äººä¸€èˆ¬åœ¨ 80-120msï¼Œè‹¥è¶…è¿‡ 200ms æç¤ºä¸¥é‡è¿åŠ¨è¿Ÿç¼“
                if(avgDwell > 200) document.getElementById('m-dwell').style.color = 'var(--red)';
            }
            
            if(validFlightCount > 0) {
                const avgFlight = totalFlightTime / validFlightCount;
                document.getElementById('m-flight').innerText = Math.round(avgFlight) + ' ms';
            }
        }

        function submitKeystroke() {
            if(validDwellCount < 10) return alert("æŒ‰é”®æ•°æ®è¿‡å°‘ï¼Œè¯·è‡³å°‘æŠ„å†™ä¸€éƒ¨åˆ†æ–‡æœ¬ã€‚");

            keystrokeData.summary = {
                avg_dwell_ms: Math.round(totalDwellTime / validDwellCount),
                avg_flight_ms: validFlightCount > 0 ? Math.round(totalFlightTime / validFlightCount) : 0,
                total_keys_pressed: validDwellCount
            };

            CAS_Storage.saveModuleData('MOT_Keystroke', keystrokeData);
            
            let msg = `âœ… æŒ‰é”®åŠ¨åŠ›å­¦ç‰¹å¾å·²å…¥åº“ï¼\n\n- å¹³å‡æ»ç•™æ—¶é—´ (Dwell): ${keystrokeData.summary.avg_dwell_ms} ms\n- å¹³å‡é£è¡Œæ—¶é—´ (Flight): ${keystrokeData.summary.avg_flight_ms} ms`;
            
            if(keystrokeData.summary.avg_dwell_ms > 200) {
                msg += "\n\nâš ï¸ ä¸´åºŠæç¤ºï¼šå—è¯•è€…çš„ Dwell Time æ˜¾è‘—å»¶é•¿ï¼Œæç¤ºå¯èƒ½å­˜åœ¨é”¥ä½“å¤–ç³»ç—‡çŠ¶å¼•èµ·çš„è‚Œè‚‰å¼ºç›´æˆ–è¿åŠ¨è¿Ÿç¼“ã€‚";
            }

            alert(msg);
            setTimeout(() => { location.href = 'index.html'; }, 800);
        }
    </script>
</body>
</html>
