<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-LAN | è¯­è¨€åŠŸèƒ½ä¸è¯­ä¹‰ç½‘ç»œ</title>
    <style>
        /* å…¨å±€æ ·å¼ä¸é˜²è¯¯è§¦é…ç½® */
        body { 
            font-family: -apple-system, sans-serif; 
            background: #f8fafc; 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
            touch-action: manipulation; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        .container { 
            max-width: 650px; 
            margin: 20px auto; 
            background: white; 
            padding: 35px 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }
        .module-header { 
            color: #0f172a; 
            margin-top: 0; 
            font-size: 24px; 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        
        /* æŒ‰é’®ä¸å¯¼èˆª */
        .sys-btn { 
            background: #0f172a; 
            color: white; 
            border: none; 
            padding: 18px 30px; 
            font-size: 16px; 
            font-weight: bold; 
            border-radius: 12px; 
            cursor: pointer; 
            margin: 10px 0; 
            width: 100%; 
            transition: 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .sys-btn:active { transform: scale(0.98); } 
        .hidden { display: none !important; }
        
        #nav-back { 
            display: inline-flex; 
            align-items: center; 
            text-decoration: none; 
            color: #3b82f6; 
            font-weight: bold; 
            margin-bottom: 15px; 
            padding: 10px 18px; 
            background: #eff6ff; 
            border-radius: 10px; 
            transition: 0.2s; 
        } 
        #nav-back:active { background: #dbeafe; }
        
        /* è¾“å…¥æ¡†æ ·å¼ (VFT & Naming) */
        #vft-input, #naming-input { 
            width: 70%; 
            padding: 18px; 
            font-size: 18px; 
            border: 2px solid #cbd5e1; 
            border-radius: 12px; 
            margin-right: 15px; 
            outline: none; 
            transition: 0.2s; 
            box-sizing: border-box; 
            background: #f8fafc; 
        } 
        #vft-input:focus, #naming-input:focus { 
            border-color: #3b82f6; 
            background: white; 
        }
        
        /* VFT è¯æ±‡äº‘æ ‡ç­¾ */
        .vft-word-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            justify-content: center; 
            margin-top: 30px; 
        } 
        .vft-tag { 
            background: #e0f2fe; 
            color: #0369a1; 
            padding: 10px 18px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        
        /* å‘½åå›¾ç‰‡æ ·å¼ */
        #naming-pic { 
            font-size: 120px; 
            margin: 40px 0; 
        }

        /* è¯­ä¹‰å…³è”æ¨¡å—æ ·å¼ */
        #sema-target { 
            font-size: 40px; 
            font-weight: bold; 
            color: #0f172a; 
            margin: 30px 0 40px 0; 
            letter-spacing: 2px; 
        }
        .sema-options { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        .sema-btn { 
            padding: 20px; 
            font-size: 20px; 
            border: 2px solid #cbd5e1; 
            border-radius: 12px; 
            background: white; 
            color: #334155; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.1s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        }
        .sema-btn:active { 
            background: #3b82f6; 
            color: white; 
            border-color: #3b82f6; 
            transform: scale(0.98); 
        }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div style="text-align: left; max-width: 650px; margin: 0 auto;">
        <a href="index.html" id="nav-back">â† è¿”å›æ§åˆ¶å°</a>
    </div>
    
    <div class="container" id="menu">
        <h2 class="module-header">ğŸ’¬ è¯­è¨€ä¸è¯­ä¹‰ç½‘ç»œ</h2>
        <button class="sys-btn" onclick="show('vft-area'); startVFT();">1. è¯æ±‡æµç•…æ€§æå– (VFT - åŠ¨ç‰©ç±»)</button>
        <button class="sys-btn" onclick="show('naming-area'); startNaming();">2. æ•°å­—åŒ–å›¾ç‰‡å‘½åæ—¶å»¶ (Naming)</button>
        <button class="sys-btn" style="background:#3b82f6;" onclick="show('sema-area'); startSema();">3. è¯­ä¹‰å…³è”ä¸æŠ½è±¡åˆ¤åˆ« (Semantic)</button>
    </div>

    <div class="container hidden" id="vft-area">
        <h2 class="module-header">è¯æ±‡æµç•…æ€§ (VFT)</h2>
        <p style="color:#ef4444; font-weight:bold; font-size:24px; margin-bottom: 5px;" id="vft-timer">å‰©ä½™: 60 s</p>
        <p style="color:#64748b; margin-bottom: 25px;">è¯·åœ¨ 60 ç§’å†…ï¼Œè¾“å…¥å°½å¯èƒ½å¤šçš„<strong>åŠ¨ç‰©åç§°</strong>ã€‚è¾“å…¥åç‚¹å‡»æäº¤æˆ–æŒ‰å›è½¦ã€‚</p>
        
        <div style="display: flex; justify-content: center; align-items: center;">
            <input type="text" id="vft-input" placeholder="ä¾‹å¦‚ï¼šå¤§è±¡" autocomplete="off">
            <button class="sys-btn" style="width:auto; margin:0; padding:18px 25px;" onclick="submitVFTWord()">è¾“å…¥</button>
        </div>
        
        <div class="vft-word-list" id="vft-list"></div>
    </div>

    <div class="container hidden" id="naming-area">
        <h2 class="module-header">å›¾ç‰‡å‘½åæ—¶å»¶</h2>
        <p style="color:#64748b;">è¯·ä»¥æœ€å¿«é€Ÿåº¦åœ¨æ¡†å†…å†™å‡ºä¸‹æ–¹ç‰©å“çš„åç§°ã€‚</p>
        
        <div id="naming-pic">ğŸ«</div>
        
        <div style="display: flex; justify-content: center; margin-bottom: 25px;">
            <input type="text" id="naming-input" placeholder="è¾“å…¥åç§°å¹¶å›è½¦...">
            <button class="sys-btn" style="width:auto; margin:0; padding:18px 25px;" onclick="submitNaming()">ç¡®è®¤</button>
        </div>
        
        <p id="naming-progress" style="font-weight:bold; color:#0f172a;">è¿›åº¦: 1 / 3</p>
    </div>

    <div class="container hidden" id="sema-area">
        <h2 class="module-header">è¯­ä¹‰å…³è”åˆ¤æ–­</h2>
        <p style="color:#64748b; font-size: 15px;">è¯·ä»¥æœ€å¿«é€Ÿåº¦ï¼Œç‚¹å‡»ä¸‹æ–¹ä¸<strong>ä¸Šæ–¹è¯æ±‡</strong>åœ¨æ„ä¹‰ä¸Šæœ€æ¥è¿‘ï¼ˆæˆ–åŒç±»ï¼‰çš„è¯ã€‚</p>
        
        <div id="sema-target">åŒ»ç”Ÿ</div>
        
        <div class="sema-options" id="sema-opts-container">
            </div>
    </div>

    <script>
        // è§†å›¾è·¯ç”±åˆ‡æ¢
        function show(id) { 
            ['menu', 'vft-area', 'naming-area', 'sema-area'].forEach(d => {
                document.getElementById(d).classList.add('hidden');
            }); 
            document.getElementById(id).classList.remove('hidden'); 
            window.scrollTo(0,0); 
        }

        /* ==================== 1. VFT (è¯æ±‡æµç•…æ€§) é€»è¾‘ ==================== */
        let vftData = { module: "Language_VFT", category: "Animals", total_words: 0, words_array: [] };
        let vftTime = 60, vftTimerId, vftStartTime = 0;

        function startVFT() { 
            vftData.words_array = []; 
            document.getElementById('vft-list').innerHTML = ''; 
            document.getElementById('vft-input').value = ''; 
            vftTime = 60; 
            vftStartTime = performance.now(); 
            
            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†ä»¥ä¾¿å¿«é€Ÿä½œç­”
            document.getElementById('vft-input').focus(); 
            
            // å€’è®¡æ—¶é€»è¾‘
            vftTimerId = setInterval(() => { 
                vftTime--; 
                document.getElementById('vft-timer').innerText = `å‰©ä½™: ${vftTime} s`; 
                if(vftTime <= 0) finishVFT(); 
            }, 1000); 
            
            // ç»‘å®šå›è½¦é”®äº‹ä»¶ (ä½¿ç”¨ isComposing é˜²æ­¢ä¸­æ–‡è¾“å…¥æ³•æ‹¼éŸ³é˜¶æ®µè¯¯è§¦)
            document.getElementById('vft-input').addEventListener('keyup', function(e) { 
                if (e.key === 'Enter' && !e.isComposing) submitVFTWord(); 
            }); 
        }

        function submitVFTWord() { 
            if(vftTime <= 0) return; 
            
            let input = document.getElementById('vft-input'); 
            let word = input.value.trim(); 
            
            if(word) { 
                // è®°å½•ç›¸å¯¹æ—¶é—´æˆ³ï¼Œç”¨äºåæœŸåˆ†æè¯æ±‡æå–çš„â€œç°‡çŠ¶èšé›†â€ç‰¹å¾ (Clustering)
                let rt = performance.now() - vftStartTime; 
                vftData.words_array.push({ word: word, timestamp_ms: Math.round(rt) }); 
                
                // åŠ¨æ€ç”Ÿæˆ UI æ ‡ç­¾
                let tag = document.createElement('div'); 
                tag.className = 'vft-tag'; 
                tag.innerText = word; 
                document.getElementById('vft-list').appendChild(tag); 
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = ''; 
            } 
        }

        function finishVFT() { 
            clearInterval(vftTimerId); 
            vftData.total_words = vftData.words_array.length; 
            CAS_Storage.saveModuleData('Language_VFT', vftData); 
            alert(`VFT æµ‹è¯•ç»“æŸã€‚å…±è®°å½• ${vftData.total_words} ä¸ªè¯æ±‡ã€‚`); 
            show('menu'); 
        }
        
        /* ==================== 2. Naming (å›¾ç‰‡å‘½å) é€»è¾‘ ==================== */
        // å›¾åº“ä¸æ­£ç¡®ç­”æ¡ˆæ˜ å°„è¡¨ (ans æ•°ç»„æ”¯æŒå®¹é”™åŒ¹é…)
        const namingStimuli = [ 
            { pic: 'ğŸ«', ans: ['éª†é©¼'] }, 
            { pic: 'ğŸ¦', ans: ['çŠ€ç‰›'] }, 
            { pic: 'ğŸ›¶', ans: ['ç‹¬æœ¨èˆŸ', 'èˆ¹', 'å°èˆ¹'] } 
        ]; 
        let nData = { module: "Language_Naming", records: [] };
        let nTr = 0, nOnset = 0;

        function startNaming() { 
            nTr = 0; 
            nData.records = []; 
            nextNaming(); 
        }

        function nextNaming() { 
            if(nTr >= namingStimuli.length) { 
                CAS_Storage.saveModuleData('Language_Naming', nData); 
                alert("å‘½åæµ‹è¯•ç‰¹å¾å·²å…¥åº“"); 
                show('menu'); 
                return; 
            } 
            
            document.getElementById('naming-pic').innerText = namingStimuli[nTr].pic; 
            document.getElementById('naming-input').value = ''; 
            document.getElementById('naming-progress').innerText = `è¿›åº¦: ${nTr+1} / ${namingStimuli.length}`; 
            
            // å»¶è¿Ÿ 100ms èšç„¦ï¼Œé¿å…ç§»åŠ¨ç«¯é”®ç›˜é—ªçƒ
            setTimeout(() => document.getElementById('naming-input').focus(), 100); 
            
            nOnset = performance.now(); 
            
            document.getElementById('naming-input').onkeyup = function(e) { 
                if(e.key === 'Enter' && !e.isComposing) submitNaming(); 
            }; 
        }

        function submitNaming() { 
            let val = document.getElementById('naming-input').value.trim(); 
            if(!val) return; 
            
            let rt = performance.now() - nOnset; 
            // åªè¦ç”¨æˆ·è¾“å…¥åŒ…å«æ­£ç¡®ç­”æ¡ˆä¸­çš„ä»»æ„ä¸€ä¸ªè¯å³ç®—æ­£ç¡®
            let isCorrect = namingStimuli[nTr].ans.some(a => val.includes(a)); 
            
            nData.records.push({ 
                item: namingStimuli[nTr].pic, 
                user_input: val, 
                correct: isCorrect, 
                rt_ms: Math.round(rt) 
            }); 
            
            nTr++; 
            nextNaming(); 
        }

        /* ==================== 3. Semantic (è¯­ä¹‰å…³è”) é€»è¾‘ ==================== */
        // åˆºæ¿€é¢˜åº“ï¼šåŒ…å«ç›®æ ‡è¯ã€é€‰é¡¹å’Œæ­£ç¡®ç­”æ¡ˆ
        const semaStimuli = [
            { target: 'ç«è½¦', options: ['è‡ªè¡Œè½¦', 'è‹¹æœ', 'æ¡Œå­'], answer: 'è‡ªè¡Œè½¦' }, // åŒå±äº¤é€šå·¥å…·
            { target: 'å‰ªåˆ€', options: ['çº¸å¼ ', 'å¤©ç©º', 'æ—¶é—´'], answer: 'çº¸å¼ ' },     // åŠŸèƒ½å…³è”
            { target: 'ç‹®å­', options: ['æ²³æµ', 'è€è™', 'ä¹¦æœ¬'], answer: 'è€è™' },     // åŒå±åŠ¨ç‰©åˆ†ç±»
            { target: 'åŒ»ç”Ÿ', options: ['åŒ»é™¢', 'æ²™å‘', 'é¦™è•‰'], answer: 'åŒ»é™¢' },     // åœºæ™¯å…³è”
            { target: 'å†¬è£…', options: ['å¯’å†·', 'å¿«ä¹', 'é€Ÿåº¦'], answer: 'å¯’å†·' }      // æŠ½è±¡æ¦‚å¿µå…³è”
        ];
        let semaData = { module: "Language_Semantic", records: [] };
        let s_tr = 0, s_onset = 0;

        function startSema() {
            s_tr = 0;
            semaData.records = [];
            nextSema();
        }

        function nextSema() {
            if(s_tr >= semaStimuli.length) {
                CAS_Storage.saveModuleData('Language_Semantic', semaData);
                alert("è¯­ä¹‰ç½‘ç»œåˆ¤åˆ«æ•°æ®å·²æˆåŠŸå…¥åº“ã€‚");
                show('menu');
                return;
            }

            const trialData = semaStimuli[s_tr];
            document.getElementById('sema-target').innerText = trialData.target;
            
            // éšæœºæ‰“ä¹±é€‰é¡¹æ•°ç»„ï¼Œé˜²æ­¢ç­”æ¡ˆä½ç½®å›ºå®šå¯¼è‡´å­¦ä¹ æ•ˆåº”
            let shuffledOpts = [...trialData.options].sort(() => Math.random() - 0.5);
            
            const container = document.getElementById('sema-opts-container');
            container.innerHTML = '';
            
            // åŠ¨æ€ç”Ÿæˆé€‰é¡¹æŒ‰é’®
            shuffledOpts.forEach(opt => {
                let btn = document.createElement('button');
                btn.className = 'sema-btn';
                btn.innerText = opt;
                
                // ç»‘å®šè§¦æ‘¸ä¸ç‚¹å‡»äº‹ä»¶ï¼ŒåŒæ—¶é˜»æ­¢é»˜è®¤è¡Œä¸ºé¿å…å»¶è¿Ÿ
                btn.ontouchstart = btn.onmousedown = (e) => {
                    e.preventDefault();
                    recordSema(opt, trialData.answer);
                };
                container.appendChild(btn);
            });

            s_onset = performance.now();
        }

        function recordSema(selectedObj, correctObj) {
            let rt = performance.now() - s_onset;
            let isCorrect = (selectedObj === correctObj);
            
            semaData.records.push({
                target: semaStimuli[s_tr].target,
                selected: selectedObj,
                correct: isCorrect,
                rt_ms: Math.round(rt)
            });

            s_tr++;
            nextSema();
        }
    </script>
</body>
</html>
