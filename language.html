<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-LAN | è¯­è¨€ç½‘ç»œä¸æµç•…æ€§è¯„ä¼° (ç§‘ç ”å®Œå…¨ä½“ v4.0)</title>
    <style>
        /* ==================== UI ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --purple: #9333ea; --light-purple: #f3e8ff; --green: #10b981; --red: #f43f5e; --slate: #64748b; --bg: #fcfcfd; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); }
        .container { max-width: 900px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        .module-header { border-left: 6px solid var(--purple); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        /* ä¸´åºŠæŒ‡å¯¼è¯­åŒºå— */
        .instruction-box { background: var(--light-purple); border: 2px dashed #d8b4fe; padding: 25px; border-radius: 16px; margin-bottom: 25px; }
        .instruction-box p { margin: 0 0 10px 0; color: #6b21a8; font-weight: bold; font-size: 16px; }
        .instruction-box ul { margin: 0; padding-left: 20px; color: #7e22ce; font-size: 14px; line-height: 1.5; }

        /* å€’è®¡æ—¶ä¸çŠ¶æ€æ¿ */
        .status-board { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 15px 25px; border-radius: 16px; border: 2px solid #e2e8f0; margin-bottom: 20px; }
        .timer-display { font-size: 32px; font-weight: bold; color: var(--primary); font-family: monospace; }
        .timer-alert { color: var(--red); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .mic-status { display: flex; align-items: center; gap: 10px; font-weight: bold; color: var(--slate); }
        .mic-icon { width: 12px; height: 12px; border-radius: 50%; background: #cbd5e1; }
        .mic-recording { background: var(--red); box-shadow: 0 0 10px rgba(244, 63, 94, 0.5); animation: pulse 1s infinite; }

        /* è¯æ±‡è¾“å…¥å·¥ä½œåŒº */
        .input-workspace { position: relative; margin-bottom: 20px; }
        .word-input { width: 100%; box-sizing: border-box; padding: 20px; border: 2px solid #cbd5e1; border-radius: 16px; font-size: 20px; outline: none; transition: 0.3s; color: var(--primary); font-weight: bold; }
        .word-input:focus { border-color: var(--purple); box-shadow: 0 0 0 4px #f3e8ff; }
        .word-input:disabled { background: #f1f5f9; cursor: not-allowed; }
        .input-hint { position: absolute; right: 20px; top: 22px; font-size: 14px; color: var(--slate); pointer-events: none; }

        /* åŠ¨æ€ç”Ÿæˆçš„è¯æ±‡æ ‡ç­¾æ±  */
        .word-pool { display: flex; flex-wrap: wrap; gap: 10px; min-height: 120px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 16px; padding: 20px; margin-bottom: 30px; align-content: flex-start; }
        .word-tag { display: inline-flex; align-items: center; gap: 8px; background: white; border: 1px solid var(--purple); color: var(--purple); padding: 8px 15px; border-radius: 20px; font-size: 16px; font-weight: bold; box-shadow: 0 2px 5px rgba(147, 51, 234, 0.1); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .word-tag .del-btn { cursor: pointer; color: var(--slate); font-size: 14px; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 50%; background: #f1f5f9; transition: 0.2s; }
        .word-tag .del-btn:hover { background: var(--red); color: white; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .empty-hint { color: #94a3b8; font-size: 16px; width: 100%; text-align: center; margin-top: 30px; }

        /* ç»Ÿè®¡ä»ªè¡¨ç›˜ */
        .metrics-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: center; }
        .metric-card span { display: block; font-size: 12px; color: var(--slate); font-weight: bold; margin-bottom: 5px; }
        .metric-card strong { font-size: 24px; color: var(--primary); font-family: monospace; }
        .highlight-val { color: var(--purple) !important; }

        .btn-group { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; }
        .btn { padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-start { background: #f1f5f9; color: var(--primary); border: 2px solid #e2e8f0;}
        .btn-start:hover { background: #e2e8f0; border-color: var(--slate); }
        .btn-submit { background: var(--purple); color: white; box-shadow: 0 8px 20px rgba(147, 51, 234, 0.2); }
        .btn-submit:hover { background: #7e22ce; transform: translateY(-2px); }
        .btn-submit:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; transform: none; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--purple); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="module-header">
            <h2>ğŸ—£ï¸ è¨€è¯­æµç•…æ€§æµ‹éªŒ (VFT - åŠ¨ç‰©ç±»åˆ«)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>è¯„ä¼°é¢å¶æ‰§è¡Œæœç´¢ç­–ç•¥ä¸é¢å¶è¯­ä¹‰å­˜å‚¨ç½‘ç»œã€‚<br>
            *é€šè¿‡ 60 ç§’ä¸¥æ ¼å€’è®¡æ—¶ä¸å¾®ç§’çº§è¾“å…¥æ—¶é—´æˆ³(Timestamps)ï¼Œè®¡ç®—â€œç°‡(Clustering)â€ä¸â€œè½¬æ¢(Switching)â€çš„åŠ¨åŠ›å­¦è¡°å‡ã€‚</p>
        </div>

        <div class="instruction-box">
            <p>âš ï¸ ä¸´åºŠæŒ‡å¯¼è¯­ (ä¸»è¯•å®£è¯»)ï¼š</p>
            <ul>
                <li>â€œåœ¨æ¥ä¸‹æ¥çš„ 1 åˆ†é’Ÿå†…ï¼Œè¯·æ‚¨å°½å¯èƒ½å¤šåœ°è¯´å‡ºæ‚¨èƒ½æƒ³åˆ°çš„ã€åŠ¨ç‰©ã€‘çš„åå­—ã€‚â€</li>
                <li>â€œä»»ä½•åŠ¨ç‰©éƒ½å¯ä»¥ï¼Œæµ·é‡Œçš„ã€å¤©ä¸Šçš„ã€æ˜†è™«éƒ½å¯ä»¥ã€‚æƒ³åˆ°ä»€ä¹ˆå°±è¯´ä»€ä¹ˆï¼Œå°½é‡ä¸è¦é‡å¤ã€‚â€</li>
                <li>â€œä¸»è¯•æ³¨æ„ï¼šç‚¹å‡»å¼€å§‹åï¼Œè¯·å°†å—è¯•è€…è¯´å‡ºçš„è¯æ•²å‡»ã€ç©ºæ ¼æˆ–å›è½¦ã€‘å½•å…¥ã€‚ç³»ç»Ÿå°†åœ¨åå°åŒæ­¥å½•éŸ³ã€‚â€</li>
            </ul>
        </div>

        <div class="status-board">
            <div class="mic-status">
                <div class="mic-icon" id="mic-indicator"></div>
                <span id="mic-text">éº¦å…‹é£å¾…æœº</span>
            </div>
            <div class="timer-display" id="time-display">01:00</div>
        </div>

        <div class="input-workspace">
            <input type="text" class="word-input" id="word-input" placeholder="è¾“å…¥åŠ¨ç‰©åç§°åï¼ŒæŒ‰ ç©ºæ ¼ æˆ– å›è½¦ é”®ç”Ÿæˆæ ‡ç­¾..." disabled autocomplete="off">
            <div class="input-hint">â / Space</div>
        </div>

        <div class="word-pool" id="word-pool">
            <div class="empty-hint" id="empty-hint">ç­‰å¾…æ•°æ®å½•å…¥...</div>
        </div>

        <div class="metrics-board">
            <div class="metric-card"><span>æœ‰æ•ˆè¯æ±‡é‡ (N)</span><strong id="m-words" class="highlight-val">0</strong></div>
            <div class="metric-card"><span>é¦–è¯æå–æ½œä¼æœŸ (Latency)</span><strong id="m-latency">0 ms</strong></div>
            <div class="metric-card"><span>å¹³å‡è¯é—´é—´éš” (IWI)</span><strong id="m-iwi">0 ms</strong></div>
        </div>

        <div class="btn-group">
            <button class="btn btn-start" id="btn-start" onclick="startVFT()">â–¶ å¯åŠ¨ 60 ç§’è®¡æ—¶ä¸å½•éŸ³</button>
            <button class="btn btn-submit" id="btn-submit" onclick="submitVFT()" disabled>ğŸ’¾ æå–æ—¶åºè¯­ä¹‰ç‰¹å¾å¹¶å…¥åº“</button>
        </div>
    </div>

    <script>
        const TIME_LIMIT = 60; // ä¸¥æ ¼é™åˆ¶ 60 ç§’
        let timeLeft = TIME_LIMIT;
        let timerInterval = null;
        
        let vftData = { module: "Language_VFT", words: [], summary: {} };
        let taskOnset = 0; 
        
        let mediaRecorder;
        let audioChunks = [];

        const inputEl = document.getElementById('word-input');
        const poolEl = document.getElementById('word-pool');
        const emptyHint = document.getElementById('empty-hint');
        const startBtn = document.getElementById('btn-start');
        const submitBtn = document.getElementById('btn-submit');
        const timeDisplay = document.getElementById('time-display');

        // ================= 1. éŸ³é¢‘ä¸å€’è®¡æ—¶å¼•æ“ =================
        
        async function startVFT() {
            // è¯·æ±‚éº¦å…‹é£æƒé™ (çœŸæ­£çš„ä¸´åºŠ VFT å¿…é¡»æœ‰å½•éŸ³å¤‡æ¡ˆï¼Œä»¥å¤‡åç»­æ ¡éªŒé‡å¤æˆ–é”™æ„è¯)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.start();
                
                document.getElementById('mic-indicator').classList.add('mic-recording');
                document.getElementById('mic-text').innerText = "å½•éŸ³ä¸è®¡æ—¶ä¸­...";
                document.getElementById('mic-text').style.color = "var(--red)";
            } catch(err) {
                alert("âš ï¸ æ— æ³•è°ƒç”¨éº¦å…‹é£ï¼Œå½•éŸ³åŠŸèƒ½å·²å…³é—­ã€‚å°†ä»…è®°å½•æ–‡æœ¬å’Œæ—¶é—´æˆ³ã€‚");
            }

            // åˆå§‹åŒ–çŠ¶æ€
            vftData.words = [];
            audioChunks = [];
            timeLeft = TIME_LIMIT;
            poolEl.innerHTML = '';
            
            startBtn.disabled = true;
            startBtn.innerText = "æµ‹è¯•è¿›è¡Œä¸­...";
            submitBtn.disabled = true;
            
            inputEl.disabled = false;
            inputEl.focus();
            
            taskOnset = performance.now(); // è®°å½•æå…¶ç²¾å‡†çš„æµ‹è¯•åŸç‚¹

            // å€’è®¡æ—¶æ ¸å¿ƒ
            timerInterval = setInterval(() => {
                timeLeft--;
                
                // æ ¼å¼åŒ–æ—¶é—´ 00:XX
                let sec = timeLeft < 10 ? '0' + timeLeft : timeLeft;
                timeDisplay.innerText = `00:${sec}`;
                
                if(timeLeft <= 10) timeDisplay.classList.add('timer-alert');

                // å¼ºåˆ¶è§¦åº•é˜»æ–­
                if(timeLeft <= 0) {
                    endVFT();
                }
            }, 1000);
        }

        function endVFT() {
            clearInterval(timerInterval);
            timeDisplay.classList.remove('timer-alert');
            timeDisplay.innerText = "00:00";
            
            inputEl.disabled = true;
            inputEl.value = "";
            inputEl.placeholder = "æµ‹è¯•å·²ç»“æŸã€‚";
            
            startBtn.innerText = "æµ‹è¯•å·²å®Œæˆ";
            submitBtn.disabled = false; // è§£é”å…¥åº“æŒ‰é’®

            if(mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
                document.getElementById('mic-indicator').classList.remove('mic-recording');
                document.getElementById('mic-text').innerText = "å½•éŸ³å·²ä¿å­˜";
                document.getElementById('mic-text').style.color = "var(--green)";
            }
            
            alert("â° 60ç§’æ—¶é—´åˆ°ï¼ç³»ç»Ÿå·²é”å®šè¾“å…¥ï¼Œè¯·ç‚¹å‡»å…¥åº“ã€‚");
        }

        // ================= 2. è¯æ±‡è§£æä¸å¾®è§‚æ—¶é—´æˆ³ (Micro-temporal Dynamics) =================

        inputEl.addEventListener('keydown', (e) => {
            // æ”¯æŒç©ºæ ¼ã€å›è½¦ã€ç”šè‡³é€—å·è¿›è¡Œå¿«é€Ÿåˆ‡è¯
            if(e.key === 'Enter' || e.key === ' ' || e.key === ',') {
                e.preventDefault();
                let word = inputEl.value.trim();
                
                // æ¸…æ´—éæ³•å­—ç¬¦
                word = word.replace(/[,ï¼Œ\s]/g, ''); 

                if(word.length > 0) {
                    addWord(word);
                    inputEl.value = "";
                }
            }
        });

        function addWord(wordText) {
            const timestamp = performance.now();
            const relativeTimeMs = Math.round(timestamp - taskOnset);
            
            // ç”Ÿæˆå”¯ä¸€ ID
            const wordId = 'w_' + Date.now() + Math.floor(Math.random() * 100);
            
            vftData.words.push({
                id: wordId,
                word: wordText,
                t_ms: relativeTimeMs // è®°å½•ç›¸å¯¹æµ‹è¯•èµ·å§‹ç‚¹çš„æ—¶é—´æˆ³ (å…³é”®æŒ‡æ ‡)
            });

            renderWordPool();
            updateMetrics();
        }

        function deleteWord(wordId) {
            // å…è®¸ä¸»è¯•åœ¨è¿‡ç¨‹ä¸­çº æ­£æ‰“é”™çš„è¯
            vftData.words = vftData.words.filter(w => w.id !== wordId);
            renderWordPool();
            updateMetrics();
        }

        function renderWordPool() {
            poolEl.innerHTML = '';
            if(vftData.words.length === 0) {
                poolEl.innerHTML = '<div class="empty-hint" id="empty-hint">ç­‰å¾…æ•°æ®å½•å…¥...</div>';
                return;
            }

            vftData.words.forEach((item, index) => {
                const tag = document.createElement('div');
                tag.className = 'word-tag';
                // æ ‡ç­¾ä¸Šå¸¦ä¸Šç§’æ•°æç¤ºï¼Œç›´è§‚æ˜¾ç¤ºæ˜¯åœ¨ç¬¬å‡ ç§’äº§å‡ºçš„
                const secStr = (item.t_ms / 1000).toFixed(1) + 's';
                
                tag.innerHTML = `
                    <span>${index + 1}. ${item.word}</span>
                    <span style="font-size:10px; color:var(--slate); font-weight:normal; margin-left:5px;">[${secStr}]</span>
                    <div class="del-btn" onclick="deleteWord('${item.id}')">Ã—</div>
                `;
                poolEl.appendChild(tag);
            });
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°è¾“å…¥çš„è¯
            poolEl.scrollTop = poolEl.scrollHeight;
        }

        // ================= 3. å®æ—¶è®¡ç®—åŠ¨åŠ›å­¦ç‰¹å¾ =================

        function updateMetrics() {
            const n = vftData.words.length;
            document.getElementById('m-words').innerText = n;

            if(n > 0) {
                // é¦–è¯æ½œä¼æœŸï¼šåæ˜ å”¤é†’ä¸åˆå§‹æå–èƒ½åŠ›
                document.getElementById('m-latency').innerText = vftData.words[0].t_ms + ' ms';
                
                // è®¡ç®—å¹³å‡è¯é—´é—´éš” (IWI: Inter-word Interval)
                // IWI çš„å¢å¤§å¾€å¾€é¢„ç¤ºç€ä»â€œè¯­ä¹‰ç°‡å†…(Cluster)â€æå–è½¬ä¸ºâ€œè·¨ç°‡æœç´¢(Switching)â€ï¼Œåæ˜ é¢å¶è€—ç«­
                if(n > 1) {
                    let totalGap = 0;
                    for(let i = 1; i < n; i++) {
                        totalGap += (vftData.words[i].t_ms - vftData.words[i-1].t_ms);
                    }
                    const avgGap = Math.round(totalGap / (n - 1));
                    document.getElementById('m-iwi').innerText = avgGap + ' ms';
                } else {
                    document.getElementById('m-iwi').innerText = "0 ms";
                }
            } else {
                document.getElementById('m-latency').innerText = '0 ms';
                document.getElementById('m-iwi').innerText = '0 ms';
            }
        }

        // ================= 4. æ•°æ®å…¥åº“ =================

        function submitVFT() {
            const n = vftData.words.length;
            const latency = n > 0 ? vftData.words[0].t_ms : 0;
            
            let avgIWI = 0;
            if(n > 1) {
                let totalGap = 0;
                for(let i = 1; i < n; i++) totalGap += (vftData.words[i].t_ms - vftData.words[i-1].t_ms);
                avgIWI = Math.round(totalGap / (n - 1));
            }

            vftData.summary = {
                total_valid_words: n,
                first_word_latency_ms: latency,
                avg_inter_word_interval_ms: avgIWI,
                duration_sec: TIME_LIMIT
            };

            CAS_Storage.saveModuleData('Language_VFT', vftData);
            
            // æ­¤å¤„æ¨¡æ‹ŸéŸ³é¢‘ Blob çš„æœ¬åœ°ä¿å­˜ï¼ˆåœ¨å®é™…æœåŠ¡å™¨ç¯å¢ƒä¸­åº”å°†å…¶è½¬æ¢ä¸º File å¹¶ä¸Šä¼  S3 / æœ¬åœ°æ•°æ®åº“ï¼‰
            let msg = `âœ… è¨€è¯­æµç•…æ€§æµ‹éªŒ (VFT) ä¸´åºŠç‰¹å¾å·²å…¥åº“ï¼\n\n- äº§å‡ºæœ‰æ•ˆè¯æ±‡: ${n} ä¸ª\n- æå–æ½œä¼æœŸ: ${latency} ms\n- è¯é—´é—´éš” (IWI): ${avgIWI} ms\n\n`;
            
            if(n < 12) {
                msg += "âš ï¸ ä¸´åºŠæç¤ºï¼š1 åˆ†é’Ÿå†…è¯æ±‡é‡å°‘äº 12 ä¸ªï¼Œæ˜¾è‘—ä½äºå¥åº·è€å¹´äººå¸¸æ¨¡ï¼Œæç¤ºå¯èƒ½å­˜åœ¨è¯­ä¹‰å­˜å‚¨ç½‘ç»œæŸä¼¤æˆ–æ‰§è¡Œæœç´¢éšœç¢ã€‚";
            } else {
                msg += "* è¯­è¨€æå–ä¸æ£€ç´¢æµç•…ã€‚";
            }

            alert(msg);
            setTimeout(() => { location.href = 'index.html'; }, 800);
        }
    </script>
</body>
</html>
