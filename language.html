<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-LAN | è¯­è¨€åŠŸèƒ½ä¸è¯­ä¹‰ç½‘ç»œ</title>
    <style>
        /* ==================== 1. ç§‘æŠ€æ¸©æƒ…é£ UI (Warm-Tech UI) ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --purple: #8b5cf6; --green: #10b981; --slate: #64748b; }
        body { font-family: -apple-system, sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; touch-action: manipulation; }
        .container { max-width: 750px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--purple); padding-left: 15px; margin-bottom: 30px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; }

        .sys-btn { width: 100%; padding: 18px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 15px; transition: 0.2s; display: flex; align-items: center; justify-content: flex-start; gap: 12px; }
        .btn-menu { background: #faf5ff; color: #7e22ce; border: 1px solid #f3e8ff; }
        .btn-menu:hover { background: var(--purple); color: white; transform: translateX(5px); box-shadow: 0 8px 15px rgba(139, 92, 246, 0.2); }
        .btn-action { background: var(--purple); color: white; justify-content: center; margin-top: 20px; }

        /* ==================== 2. ä¸“é¡¹å®éªŒ UI ==================== */
        /* [èŒƒå¼1] VFT è¯­éŸ³è¾“å…¥æ¡† */
        .vft-timer { font-size: 40px; font-weight: bold; color: var(--red); text-align: center; margin: 20px 0; font-variant-numeric: tabular-nums; }
        .input-wrapper { display: flex; gap: 15px; margin: 20px 0; }
        input[type="text"] { flex: 1; padding: 18px; border: 2px solid #e2e8f0; border-radius: 16px; font-size: 18px; outline: none; transition: 0.2s; color: var(--primary); font-weight: bold;}
        input[type="text"]:focus { border-color: var(--purple); box-shadow: 0 0 0 4px #f3e8ff; }
        
        /* æ™ºèƒ½éº¦å…‹é£æŒ‰é’® */
        .btn-mic { background: var(--green); color: white; border: none; border-radius: 16px; padding: 0 25px; font-size: 24px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        .btn-mic:active { transform: scale(0.9); }
        .recording { animation: mic-pulse 1.5s infinite; background: var(--red) !important; }
        @keyframes mic-pulse { 0% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.5); } 70% { box-shadow: 0 0 0 15px rgba(244, 63, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0); } }
        
        .word-tag { background: #f3e8ff; color: #7e22ce; padding: 10px 18px; border-radius: 20px; font-weight: bold; display: inline-block; margin: 5px; animation: popIn 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* [èŒƒå¼2] Naming å›¾ç‰‡å‘½ååŒº */
        .naming-stimulus { font-size: 120px; text-align: center; margin: 40px 0; background: #f8fafc; border-radius: 24px; padding: 40px 0; border: 2px dashed #e2e8f0; }
        
        /* [èŒƒå¼3] Semantic å…³è”åŒº */
        .sema-target { font-size: 50px; font-weight: bold; text-align: center; margin: 30px 0; color: var(--primary); letter-spacing: 5px;}
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .btn-choice { background: white; color: var(--primary); border: 2px solid #e2e8f0; border-radius: 16px; padding: 25px 0; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.1s; }
        .btn-choice:active { background: var(--purple); color: white; border-color: var(--purple); transform: scale(0.95); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--purple); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ’¬ è¯­è¨€ä¸è¯­ä¹‰ (CAS-LAN)</h2>
            <p>è¯„ä¼°è¯æ±‡æ£€ç´¢æµç•…åº¦ã€å›¾æ–‡å‘½åæ—¶å»¶åŠå†…éƒ¨è¯­ä¹‰ç½‘ç»œé€šè¾¾åº¦ã€‚</p>
        </div>
        <button class="sys-btn btn-menu" onclick="startVFT()">ğŸ—£ï¸ 1. è¯æ±‡æµç•…æ€§æå– (VFT) - æ”¯æŒè¯­éŸ³</button>
        <button class="sys-btn btn-menu" onclick="startNaming()">ğŸ–¼ï¸ 2. å›¾ç‰‡æ•°å­—åŒ–å‘½å (BNT èŒƒå¼)</button>
        <button class="sys-btn btn-menu" onclick="startSemantic()">ğŸ§  3. é«˜é˜¶è¯­ä¹‰å…³è”ä¸åˆ†ç±»æµ‹è¯•</button>
    </div>

    <div class="container hidden" id="vft-area">
        <div class="module-header"><h2>è¯æ±‡æµç•…æ€§ (VFT - åŠ¨ç‰©ç±»)</h2>
        <p>ä¸´åºŠæ„ä¹‰: è¯„ä¼°é¢å¶æ‰§è¡ŒåŠŸèƒ½ä¸é¢å¶è¯­ä¹‰åº“çš„æ£€ç´¢æ•ˆç‡ã€‚è¯·åœ¨ 60 ç§’å†…å°½å¯èƒ½å¤šåœ°è¯´å‡ºåŠ¨ç‰©çš„åç§°ã€‚</p></div>
        
        <div class="vft-timer" id="vft-timer">60s</div>
        
        <div class="input-wrapper">
            <input type="text" id="vft-input" placeholder="è¾“å…¥æˆ–ç‚¹å‡»å³ä¾§éº¦å…‹é£è¯­éŸ³è¾“å…¥..." onkeypress="if(event.key === 'Enter') submitVFT()">
            <button class="btn-mic" id="mic-btn" onclick="toggleVoice('vft-input')">ğŸ¤</button>
        </div>
        <button class="sys-btn btn-action" onclick="submitVFT()">å½•å…¥è¯¥è¯æ±‡ (+)</button>
        
        <div id="vft-list" style="margin-top:20px; min-height: 100px; padding: 15px; background: #f8fafc; border-radius: 16px;"></div>
    </div>

    <div class="container hidden" id="naming-area">
        <div class="module-header"><h2>å›¾ç‰‡å‘½å (Naming)</h2>
        <p>ä¸´åºŠæ„ä¹‰: é¶å‘å·¦ä¾§é¢ä¸­å›ï¼Œæ—©æœŸå‘ç°å‘½åæ€§å¤±è¯­ (Anomia) åŠæ‰¾è¯å›°éš¾ã€‚</p></div>
        
        <div style="font-weight:bold; color:var(--purple); margin-bottom: 10px;">è¿›åº¦: <span id="naming-prog">1/5</span></div>
        <div class="naming-stimulus" id="naming-stim">ğŸ˜</div>
        
        <div class="input-wrapper">
            <input type="text" id="naming-input" placeholder="è¿™æ˜¯ä»€ä¹ˆï¼Ÿ" onkeypress="if(event.key === 'Enter') recordNaming()">
            <button class="btn-mic" id="mic-btn-naming" onclick="toggleVoice('naming-input')">ğŸ¤</button>
        </div>
        <button class="sys-btn btn-action" onclick="recordNaming()">ç¡®è®¤å¹¶è¿›å…¥ä¸‹ä¸€é¢˜</button>
    </div>

    <div class="container hidden" id="sema-area">
        <div class="module-header"><h2>è¯­ä¹‰å…³è”ç½‘ç»œ (Semantic Network)</h2>
        <p>ä¸´åºŠæ„ä¹‰: è¯„ä¼°æ¦‚å¿µä¹‹é—´çš„è¿æ¥å¼ºåº¦ã€‚è¯·é€‰æ‹©ä¸ä¸Šæ–¹è¯æ±‡å…³è”æœ€ç´§å¯†çš„é€‰é¡¹ã€‚</p></div>
        <div style="font-weight:bold; color:var(--purple); margin-bottom: 10px;">è¿›åº¦: <span id="sema-prog">1/5</span></div>
        <div class="sema-target" id="sema-target">åŒ»é™¢</div>
        
        <div class="grid-3" id="sema-controls">
            </div>
    </div>

    <script>
        function show(id) {
            ['menu', 'vft-area', 'naming-area', 'sema-area'].forEach(d => {
                const el = document.getElementById(d); if(el) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0);
        }

        /* ==================== 0. HTML5 è¯­éŸ³è¯†åˆ«å¼•æ“åˆå§‹åŒ– ==================== */
        // è°ƒç”¨æµè§ˆå™¨åº•å±‚çš„ Web Speech APIï¼Œé€‚ç”¨äºç¤¾åŒºåŒ»ç”ŸæŒ iPad è¾…åŠ©è€äººæµ‹è¯•
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            // è®¾ç½®ä¸º falseï¼Œç¡®ä¿åªæœ‰åœ¨å—è¯•è€…è¯´å®Œä¸€å¥è¯æ—¶æ‰è¿”å›ç¡®å®šçš„è¯ï¼Œé˜²æ­¢è¯†åˆ«é—ªçƒ
            recognition.interimResults = false; 
            recognition.continuous = false;
        }

        // é€šç”¨è¯­éŸ³åˆ‡æ¢å‡½æ•°
        function toggleVoice(targetInputId) {
            if (!recognition) return alert("æ‚¨çš„è®¾å¤‡/æµè§ˆå™¨ä¸æ”¯æŒåŸç”Ÿè¯­éŸ³è¾“å…¥ï¼Œè¯·æ‰‹åŠ¨æ‰“å­—ã€‚æ¨èä½¿ç”¨ Chrome æˆ– Safariã€‚");
            
            const btn = event.currentTarget; // è·å–å½“å‰ç‚¹å‡»çš„éº¦å…‹é£æŒ‰é’®
            const inputField = document.getElementById(targetInputId);

            if (isRecording) {
                recognition.stop();
            } else {
                btn.classList.add('recording'); inputField.placeholder = "æ­£åœ¨è†å¬...";
                recognition.start();
                
                recognition.onresult = function(e) {
                    // æ­£åˆ™å»é™¤å¥æœ«æ ‡ç‚¹ç¬¦å·
                    const text = e.results[0][0].transcript.replace(/[ã€‚ï¼Œï¼ï¼Ÿ]/g, '');
                    inputField.value = text;
                    // è‹¥åœ¨ VFT æ¨¡å—ä¸­ï¼Œè¯­éŸ³è¯†åˆ«åè‡ªåŠ¨æäº¤
                    if(targetInputId === 'vft-input') submitVFT(); 
                };
                
                recognition.onend = function() { 
                    btn.classList.remove('recording'); inputField.placeholder = "è¾“å…¥æˆ–ç‚¹å‡»å³ä¾§éº¦å…‹é£è¯­éŸ³è¾“å…¥...";
                    isRecording = false; 
                };
                
                recognition.onerror = function() { 
                    btn.classList.remove('recording'); inputField.placeholder = "è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨è¾“å…¥";
                    isRecording = false; 
                };
                isRecording = true;
            }
        }

        /* ==================== 1. VFT (è¯æ±‡æµç•…æ€§) é€»è¾‘ ==================== */
        let vftData = { module: "LAN_VFT", category: "Animal", words: [] };
        let vftTimerId = null, vftTimeLeft = 60;
        
        function startVFT() {
            vftTimeLeft = 60; vftData.words = []; 
            document.getElementById('vft-list').innerHTML = ''; document.getElementById('vft-input').value = '';
            document.getElementById('vft-timer').innerText = "60s";
            show('vft-area');
            
            vftTimerId = setInterval(() => {
                vftTimeLeft--; 
                document.getElementById('vft-timer').innerText = vftTimeLeft + 's';
                if(vftTimeLeft <= 0) { 
                    clearInterval(vftTimerId); 
                    CAS_Storage.saveModuleData('LAN_VFT', vftData); 
                    alert(`æ—¶é—´åˆ°ï¼å…±æå–æœ‰æ•ˆè¯æ±‡: ${vftData.words.length} ä¸ªã€‚\n\n*ä¸´åºŠæç¤º: åæœŸå¯å¯¹è¾“å‡ºçš„è¯è¡¨è¿›è¡Œè¯­ä¹‰èšç±»(Clustering)å’Œè½¬æ¢(Switching)çš„æ·±åº¦ NLP åˆ†æã€‚`); 
                    show('menu'); 
                }
            }, 1000);
        }

        function submitVFT() {
            if(vftTimeLeft <= 0) return;
            const input = document.getElementById('vft-input');
            const word = input.value.trim();
            if(word && !vftData.words.includes(word)) { // é˜²å¾¡é‡å¤è¾“å…¥
                vftData.words.push(word);
                const tag = document.createElement('span');
                tag.className = 'word-tag'; tag.innerText = word;
                document.getElementById('vft-list').appendChild(tag);
                input.value = '';
            } else if (vftData.words.includes(word)) {
                // ä¸´åºŠä¸Šï¼Œé‡å¤è¯æ±‡(Perseveration)ä¹Ÿæ˜¯é¢å¶å—æŸçš„é‡è¦æ ‡å¿—ï¼Œæ­£å¼ç‰ˆå¯å¼€è¾Ÿæ–°æ•°ç»„è®°å½•
                alert("å·²ç»è¯´è¿‡è¿™ä¸ªè¯å•¦ï¼"); input.value = '';
            }
        }

        /* ==================== 2. Naming (å›¾ç‰‡å‘½å) é€»è¾‘ ==================== */
        // åˆºæ¿€åº“ï¼šæ—¥å¸¸ç‰©ä½“ã€‚æ­¤å¤„ä½¿ç”¨é«˜å¯¹æ¯”åº¦ Emoji ä»£æ›¿å®é™…çº¿ç¨¿å›¾ (Line Drawings)
        const namingStims = [ { img: 'ğŸ˜', ans: 'å¤§è±¡' }, { img: 'âœ‚ï¸', ans: 'å‰ªåˆ€' }, { img: 'ğŸš', ans: 'ç›´å‡æœº' }, { img: 'ğŸ¦', ans: 'çŠ€ç‰›' }, { img: 'ğŸªš', ans: 'é”¯å­' } ];
        let namData = { module: "LAN_Naming", records: [] };
        let n_trial = 0, n_onset = 0;

        function startNaming() { n_trial = 0; namData.records = []; show('naming-area'); nextNaming(); }
        
        function nextNaming() {
            if (n_trial >= namingStims.length) { CAS_Storage.saveModuleData('LAN_Naming', namData); alert("å‘½åæµ‹è¯•å®Œæˆï¼æ•°æ®å·²ä¿å­˜ã€‚"); show('menu'); return; }
            document.getElementById('naming-prog').innerText = `${n_trial + 1}/${namingStims.length}`;
            document.getElementById('naming-stim').innerText = namingStims[n_trial].img;
            document.getElementById('naming-input').value = '';
            n_onset = performance.now();
        }

        function recordNaming() {
            const input = document.getElementById('naming-input').value.trim();
            if (!input) return alert("è¯·å‘Šè¯‰æˆ‘è¿™æ˜¯ä»€ä¹ˆï¼Ÿ");
            const rt = Math.round(performance.now() - n_onset);
            // è®°å½•åŸå§‹è¾“å…¥æ–‡æœ¬ï¼Œåç»­å¯é€šè¿‡ NLP è®¡ç®—ä¸æ ‡å‡†ç­”æ¡ˆçš„è¯å‘é‡ç›¸ä¼¼åº¦ (Cosine Similarity)
            namData.records.push({ trial: n_trial+1, stimulus: namingStims[n_trial].img, response: input, rt_ms: rt });
            n_trial++; nextNaming();
        }

        /* ==================== 3. Semantic (è¯­ä¹‰å…³è”) é€»è¾‘ ==================== */
        const semaStims = [
            { t: 'åŒ»ç”Ÿ', opts: ['åŒ»é™¢', 'è‹¹æœ', 'æ¡Œå­'], a: 'åŒ»é™¢' },
            { t: 'è½®èƒ', opts: ['æ±½è½¦', 'å¤©ç©º', 'è¡£æœ'], a: 'æ±½è½¦' },
            { t: 'å†¬å¤©', opts: ['é›ªèŠ±', 'æ²™æ¼ ', 'ç«ç„°'], a: 'é›ªèŠ±' },
            { t: 'é”®ç›˜', opts: ['é¼ æ ‡', 'æ°´æ¯', 'æ ‘æœ¨'], a: 'é¼ æ ‡' },
            { t: 'é”', opts: ['é’¥åŒ™', 'é‹å­', 'ç»ç’ƒ'], a: 'é’¥åŒ™' }
        ];
        let semaData = { module: "LAN_Semantic", records: [] };
        let sm_trial = 0, sm_onset = 0, sm_curr = null;

        function startSemantic() { sm_trial = 0; semaData.records = []; show('sema-area'); nextSemantic(); }
        
        function nextSemantic() {
            if (sm_trial >= semaStims.length) { CAS_Storage.saveModuleData('LAN_Semantic', semaData); alert("è¯­ä¹‰å…³è”æµ‹è¯•å®Œæˆï¼"); show('menu'); return; }
            document.getElementById('sema-prog').innerText = `${sm_trial + 1}/${semaStims.length}`;
            sm_curr = semaStims[sm_trial];
            document.getElementById('sema-target').innerText = sm_curr.t;
            
            const controls = document.getElementById('sema-controls'); controls.innerHTML = '';
            
            // æ‰“ä¹±é€‰é¡¹å‘ˆç°é¡ºåº
            let options = [...sm_curr.opts].sort(() => Math.random() - 0.5);
            options.forEach(opt => {
                let btn = document.createElement('button'); btn.className = 'btn-choice'; btn.innerText = opt;
                btn.onclick = () => recordSemantic(opt); controls.appendChild(btn);
            });
            sm_onset = performance.now();
        }

        function recordSemantic(choice) {
            const rt = Math.round(performance.now() - sm_onset);
            semaData.records.push({ target: sm_curr.t, response: choice, correct: choice === sm_curr.a, rt_ms: rt });
            sm_trial++; nextSemantic();
        }
    </script>
</body>
</html>
