<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-SEN | æ„Ÿè§‰ä¸çŸ¥è§‰ä¼ å¯¼</title>
    <style>
        /* ç§‘æŠ€æ¸©æƒ…é£ UI */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --yellow: #eab308; --slate: #64748b; }
        body { font-family: -apple-system, sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; touch-action: manipulation; user-select: none; }
        .container { max-width: 750px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--yellow); padding-left: 15px; margin-bottom: 30px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; }

        .sys-btn { width: 100%; padding: 18px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 15px; transition: 0.2s; display: flex; align-items: center; gap: 12px; }
        .btn-menu { background: #fefce8; color: #a16207; border: 1px solid #fef08a; }
        .btn-menu:hover { background: var(--yellow); color: white; transform: translateX(5px); box-shadow: 0 8px 15px rgba(234, 179, 8, 0.2); }

        /* RTä¸ååº”æµ‹è¯•é€šç”¨å…¨å±åˆºæ¿€åŒº */
        .rt-workspace { width: 100%; height: 350px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; cursor: pointer; transition: background 0.1s; margin-bottom: 20px; color: var(--slate); }
        
        /* Choice RT / Go-NoGo æ§åˆ¶å° */
        .btn-large { padding: 30px; font-size: 24px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 20px; color: var(--primary); cursor: pointer; font-weight: bold; width: 100%; transition: 0.1s;}
        .btn-large:active { background: var(--blue); color: white; border-color: var(--blue); transform: scale(0.96); }

        /* Visual Search ç‰¹å¾æ‰«æåŒº */
        #search-board { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin: 30px 0; }
        .search-item { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 35px; cursor: pointer; border-radius: 12px; transition: 0.1s; border: 1px solid transparent; }
        .search-item:active { background: var(--light-blue); border-color: var(--blue); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--yellow); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>âš¡ æ„Ÿè§‰ä¸çŸ¥è§‰ä¼ å¯¼ (CAS-SEN)</h2>
            <p>æå–çº¯ç²¹çš„æ„Ÿè§‰ä¼ å¯¼æ—¶é—´ã€åº•å±‚å†³ç­–å¼€é”€ä¸è‡ªä¸‹è€Œä¸Šçš„æ³¨æ„åŠ›æ‰«æã€‚</p>
        </div>
        <button class="sys-btn btn-menu" onclick="startSRT()">â±ï¸ 1. ç®€å•ååº”æ—¶ (Simple RT - ä¼ å¯¼åŸºçº¿)</button>
        <button class="sys-btn btn-menu" onclick="startCRT()">âš–ï¸ 2. é€‰æ‹©ååº”æ—¶ (Choice RT - å†³ç­–å¼€é”€)</button>
        <button class="sys-btn btn-menu" onclick="startGNG()">ğŸ›‘ 3. Go/No-Go æµ‹è¯• (åº•å±‚æ„Ÿè§‰æŠ‘åˆ¶)</button>
        <button class="sys-btn btn-menu" onclick="startSearch()">ğŸ” 4. è§†è§‰ç‰¹å¾æœç´¢ (Visual Search - é¡¶å¶ç½‘ç»œ)</button>
    </div>

    <div class="container hidden" id="srt-area">
        <div class="module-header"><h2>ç®€å•ååº”æ—¶ (SRT)</h2><p>ä¸´åºŠæ„ä¹‰: è·å–çº¯ç²¹çš„ç¥ç»ä¼ å¯¼å»¶è¿Ÿã€‚è¯·åœ¨æ–¹å—å˜é»„æ—¶ç«‹åˆ»ç‚¹å‡»ã€‚</p></div>
        <div class="rt-workspace" id="srt-box" onmousedown="clickSRT()">ç­‰å¾…å˜é»„...</div>
        <p style="text-align:center; color:var(--slate);" id="srt-msg">æµ‹è¯•è¿›è¡Œä¸­ (0/10)</p>
    </div>

    <div class="container hidden" id="crt-area">
        <div class="module-header"><h2>é€‰æ‹©ååº”æ—¶ (CRT)</h2><p>ä¸´åºŠè®¡ç®—: CRTè€—æ—¶å‡å»SRTè€—æ—¶ï¼Œå³ä¸ºçº¯ç²¹çš„è®¤çŸ¥å†³ç­–åŠ å·¥æ—¶é—´ã€‚</p></div>
        <div class="rt-workspace" id="crt-stim" style="font-size: 80px; background:white;">+</div>
        <div style="display:flex; gap:15px;" id="crt-controls" class="hidden">
            <button class="btn-large" onclick="recordCRT('L')">å·¦è¾¹ (L)</button>
            <button class="btn-large" onclick="recordCRT('R')">å³è¾¹ (R)</button>
        </div>
    </div>

    <div class="container hidden" id="gng-area">
        <div class="module-header"><h2>Go / No-Go (æ„Ÿè§‰æŠ‘åˆ¶æ§åˆ¶)</h2><p>è§„åˆ™: çœ‹åˆ°ç»¿è‰²åœ†åœˆè¯·ç‚¹å‡»ï¼Œçœ‹åˆ°çº¢è‰²äº¤å‰ã€ç»å¯¹ä¸è¦ã€‘ç‚¹å‡»ã€‚</p></div>
        <div class="rt-workspace" id="gng-stim" onclick="clickGNG()" style="font-size:100px; background:white;">+</div>
    </div>

    <div class="container hidden" id="search-area">
        <div class="module-header"><h2>è§†è§‰ç‰¹å¾æœç´¢ (Visual Search)</h2><p>ä¸´åºŠæ„ä¹‰: è¯„ä¼°é¡¶å¶æ§åˆ¶çš„è§†è§‰æ‰«æèŒƒå›´ã€‚è¯·åœ¨ä¼—å¤š 'O' ä¸­æ‰¾å‡ºå”¯ä¸€çš„ 'Q'ã€‚</p></div>
        <div id="search-board"></div>
    </div>

    <script>
        function show(id) {
            ['menu', 'srt-area', 'crt-area', 'gng-area', 'search-area'].forEach(d => {
                const el = document.getElementById(d); if(el) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0);
        }

        /* ==================== 1. SRT é€»è¾‘ ==================== */
        let srtData = { module: "SEN_SRT", records: [] };
        let srt_trial = 0, srt_onset = 0, srt_timeout = null, srt_active = false;

        function startSRT() { srt_trial = 0; srtData.records = []; show('srt-area'); nextSRT(); }
        
        function nextSRT() {
            if (srt_trial >= 10) { CAS_Storage.saveModuleData('SEN_SRT', srtData); alert("SRT æµ‹è¯•å®Œæˆ"); show('menu'); return; }
            document.getElementById('srt-msg').innerText = `æµ‹è¯•è¿›è¡Œä¸­ (${srt_trial}/10)`;
            const box = document.getElementById('srt-box');
            box.style.background = '#f8fafc'; box.innerText = "ç­‰å¾…å˜é»„..."; srt_active = false;
            
            // éšæœºå‰å†²æ—¶é—´ (Fore-period) 1000 - 3000msï¼Œé˜²æ­¢å—è¯•è€…é¢„åˆ¤èŠ‚å¥
            const delay = Math.random() * 2000 + 1000;
            srt_timeout = setTimeout(() => {
                box.style.background = 'var(--yellow)'; box.style.color = 'white'; box.innerText = "ç‚¹å‡»ï¼";
                srt_onset = performance.now(); srt_active = true;
            }, delay);
        }

        function clickSRT() {
            if (!srt_active) {
                // æå‰æŠ¢ç­”è®°ä¸ºè¿‡å¤± (Anticipation Error)
                clearTimeout(srt_timeout); alert("è¯·ä¸è¦æå‰ç‚¹å‡»ï¼"); nextSRT(); return;
            }
            const rt = Math.round(performance.now() - srt_onset);
            srtData.records.push({ trial: srt_trial+1, rt_ms: rt });
            srt_trial++; nextSRT();
        }

        /* ==================== 2. CRT é€»è¾‘ ==================== */
        let crtData = { module: "SEN_CRT", records: [] };
        let crt_trial = 0, crt_onset = 0, crt_target = '';

        function startCRT() { crt_trial = 0; crtData.records = []; show('crt-area'); nextCRT(); }
        
        function nextCRT() {
            if (crt_trial >= 10) { CAS_Storage.saveModuleData('SEN_CRT', crtData); alert("CRT æµ‹è¯•å®Œæˆ"); show('menu'); return; }
            document.getElementById('crt-controls').classList.add('hidden');
            document.getElementById('crt-stim').innerText = "+";
            
            setTimeout(() => {
                crt_target = Math.random() > 0.5 ? 'L' : 'R';
                document.getElementById('crt-stim').innerText = crt_target === 'L' ? 'â¬…ï¸' : 'â¡ï¸';
                document.getElementById('crt-controls').classList.remove('hidden');
                crt_onset = performance.now();
            }, Math.random() * 1000 + 500);
        }

        function recordCRT(choice) {
            crtData.records.push({ trial: crt_trial+1, correct: choice === crt_target, rt_ms: Math.round(performance.now() - crt_onset) });
            crt_trial++; nextCRT();
        }

        /* ==================== 3. Go/No-Go é€»è¾‘ ==================== */
        let gngData = { module: "SEN_GoNoGo", records: [] };
        let gng_trial = 0, gng_onset = 0, gng_isGo = true, gng_stimTimeout = null;

        function startGNG() { gng_trial = 0; gngData.records = []; show('gng-area'); nextGNG(); }
        
        function nextGNG() {
            if (gng_trial >= 15) { CAS_Storage.saveModuleData('SEN_GoNoGo', gngData); alert("Go/No-Go æµ‹è¯•å®Œæˆ"); show('menu'); return; }
            const box = document.getElementById('gng-stim'); box.innerText = "+";
            
            setTimeout(() => {
                // 70% Go (åˆºæ¿€å»ºç«‹ä¼˜åŠ¿ååº”), 30% No-Go (è€ƒå¯Ÿçªç„¶çš„æŠ‘åˆ¶èƒ½åŠ›)
                gng_isGo = Math.random() < 0.7; 
                box.innerText = gng_isGo ? 'ğŸŸ¢' : 'âŒ';
                gng_onset = performance.now();
                
                // åˆºæ¿€ä»…å‘ˆç° 800msï¼Œè¶…æ—¶æœªç‚¹å‡»è¿›å…¥ä¸‹ä¸€æ¬¡åˆ¤å®š
                gng_stimTimeout = setTimeout(() => {
                    // å¦‚æœè¶…æ—¶æœªç‚¹å‡»ï¼Œå¯¹äº Go æ˜¯æ¼æŠ¥ (Miss)ï¼Œå¯¹äº No-Go æ˜¯æ­£ç¡®æ‹’ç» (Correct Rejection)
                    gngData.records.push({ trial: gng_trial+1, type: gng_isGo?'Go':'NoGo', action: 'none', correct: !gng_isGo });
                    gng_trial++; nextGNG();
                }, 800);
            }, Math.random() * 1000 + 500);
        }

        function clickGNG() {
            if (document.getElementById('gng-stim').innerText === "+") return; // å¿½ç•¥åœ¨æ³¨è§†ç‚¹é˜¶æ®µçš„ç‚¹å‡»
            clearTimeout(gng_stimTimeout);
            const rt = Math.round(performance.now() - gng_onset);
            // å¯¹äº Go æ˜¯å‘½ä¸­ (Hit)ï¼Œå¯¹äº No-Go æ˜¯è™šæŠ¥/æŠ‘åˆ¶å¤±è´¥ (False Alarm)
            gngData.records.push({ trial: gng_trial+1, type: gng_isGo?'Go':'NoGo', action: 'clicked', correct: gng_isGo, rt_ms: rt });
            
            // é”™è¯¯åé¦ˆ
            if (!gng_isGo) { document.getElementById('gng-stim').innerText = "âš ï¸"; }
            
            setTimeout(() => { gng_trial++; nextGNG(); }, 300);
        }

        /* ==================== 4. Visual Search é€»è¾‘ ==================== */
        let vsData = { module: "SEN_VisualSearch", records: [] };
        let vs_trial = 0, vs_onset = 0;

        function startSearch() { vs_trial = 0; vsData.records = []; show('search-area'); nextSearch(); }
        
        function nextSearch() {
            if (vs_trial >= 5) { CAS_Storage.saveModuleData('SEN_VisualSearch', vsData); alert("è§†è§‰æœç´¢æµ‹è¯•å®Œæˆ"); show('menu'); return; }
            const board = document.getElementById('search-board'); board.innerHTML = '';
            
            const totalItems = 24; // 6x4 ç½‘æ ¼
            const targetIdx = Math.floor(Math.random() * totalItems); // éšæœºåŸ‹ç‚¹ Q
            
            for (let i = 0; i < totalItems; i++) {
                let node = document.createElement('div'); node.className = 'search-item';
                let isTarget = i === targetIdx;
                node.innerText = isTarget ? 'Q' : 'O';
                node.style.color = isTarget ? 'var(--blue)' : 'var(--slate)'; // å¾®å¾®æ”¹å˜é¢œè‰²å¢åŠ éš¾åº¦
                
                node.onclick = () => {
                    const rt = Math.round(performance.now() - vs_onset);
                    if (isTarget) {
                        vsData.records.push({ trial: vs_trial+1, target_pos: i, rt_ms: rt });
                        vs_trial++; nextSearch();
                    } else {
                        node.style.background = 'var(--red)'; node.style.color = 'white';
                        setTimeout(() => { node.style.background = 'transparent'; node.style.color = 'var(--slate)'; }, 200);
                    }
                };
                board.appendChild(node);
            }
            vs_onset = performance.now();
        }
    </script>
</body>
</html>
