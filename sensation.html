<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-SEN | æ„ŸçŸ¥è§‰ä¸æŒç»­è­¦è§‰æ€§è¯„ä¼° (ç§‘ç ”å®Œå…¨ä½“ v4.0)</title>
    <style>
        :root { --primary: #1e293b; --blue: #4f46e5; --yellow: #eab308; --amber: #d97706; --red: #f43f5e; --green: #10b981; --slate: #64748b; --bg: #fcfcfd; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); user-select: none; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--yellow); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .sys-btn { width: 100%; padding: 20px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 18px; transition: 0.2s; display: flex; align-items: center; gap: 12px; }
        .btn-menu { background: #fefce8; color: #854d0e; border: 1px solid #fef08a; }
        .btn-menu:hover { background: var(--yellow); color: white; transform: translateX(5px); }

        /* PVT å·¥ä½œåŒº */
        .pvt-workspace { width: 100%; height: 350px; background: #0f172a; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: crosshair; }
        .pvt-target { font-size: 80px; font-weight: bold; color: var(--red); font-family: monospace; display: none; text-shadow: 0 0 20px rgba(244, 63, 94, 0.8); }
        .pvt-instruction { color: #94a3b8; position: absolute; bottom: 30px; font-size: 14px; }
        .trial-counter { position: absolute; top: 20px; right: 20px; font-size: 14px; color: #475569; font-weight: bold; }

        /* Time Reproduction å·¥ä½œåŒº */
        .time-workspace { text-align: center; padding: 40px 20px; background: #f8fafc; border-radius: 20px; border: 2px dashed #cbd5e1; }
        .time-btn { width: 200px; height: 200px; border-radius: 50%; background: white; border: 8px solid var(--blue); margin: 30px auto; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: var(--blue); cursor: pointer; transition: 0.1s; box-shadow: 0 10px 30px rgba(79, 70, 229, 0.2); touch-action: none; }
        .time-btn:active, .time-btn.pressing { background: var(--blue); color: white; transform: scale(0.95); box-shadow: inset 0 10px 20px rgba(0,0,0,0.2); }
        .target-time-disp { font-size: 40px; font-weight: bold; color: var(--primary); margin-bottom: 10px; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--amber); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ‘ï¸ æ„ŸçŸ¥è§‰ä¸è­¦è§‰ç½‘ç»œ (Clinical V4.0)</h2>
            <p>åŸºäºå»ç”²è‚¾ä¸Šè…ºç´ (LC-NE)é€šè·¯çš„æŒç»­ä¸“æ³¨åŠ›åº•åº§ï¼Œä»¥åŠå°è„‘å†…éƒ¨æ—¶é’ŸèŠ‚å¾‹æµ‹ç®—ã€‚</p>
        </div>
        <button class="sys-btn btn-menu" onclick="startPVT()">â±ï¸ 1. PVT ç²¾ç¥è¿åŠ¨è­¦è§‰æ€§æµ‹éªŒ (20æ¬¡æŒç»­è­¦æˆ’)</button>
        <button class="sys-btn btn-menu" onclick="startTimeRep()">â³ 2. Time Rep å†…éƒ¨æ—¶é—´å¤åˆ¶æµ‹éªŒ (3ç§’æ„ŸçŸ¥å·®)</button>
    </div>

    <div class="container hidden" id="pvt-area">
        <div class="module-header">
            <h2>PVT æŒç»­è­¦è§‰ç½‘ç»œ</h2>
            <p>è¿™æ˜¯è¡¡é‡å¤§è„‘ç–²åŠ³ä¸ç¡çœ å‰¥å¤ºçš„é»„é‡‘æ ‡å‡†ã€‚è¯·ç´§ç›¯é»‘è‰²åŒºåŸŸï¼Œå½“çœ‹åˆ°çº¢è‰²æ¯«ç§’è®¡æ•°å™¨å‡ºç°æ—¶ï¼Œç«‹åˆ»ç‚¹å‡»å±å¹•æ‰“æ–­å®ƒã€‚</p>
        </div>
        <div class="pvt-workspace" id="pvt-box">
            <div class="trial-counter" id="pvt-counter"></div>
            <div class="pvt-target" id="pvt-counter-text">000</div>
            <div class="pvt-instruction" id="pvt-msg">ç‚¹å‡»é»‘æ¡†ä»»æ„åŒºåŸŸå¼€å§‹æµ‹è¯•</div>
        </div>
    </div>

    <div class="container hidden" id="time-area">
        <div class="module-header">
            <h2>å†…éƒ¨æ—¶é—´å¤åˆ¶ (Internal Clock)</h2>
            <p>è¯„ä¼°å°è„‘ä¸åŸºåº•èŠ‚æ„æˆçš„æ—¶é—´æ„ŸçŸ¥å›è·¯ã€‚è¯·åœ¨å¿ƒä¸­é»˜æ•°ï¼Œé•¿æŒ‰æŒ‰é’®ä»¥å®Œç¾é‡ç°ç›®æ ‡æ—¶é—´ã€‚</p>
        </div>
        <div class="time-workspace">
            <div style="font-size: 16px; color: var(--slate); font-weight:bold;">è¯·å°è¯•é•¿æŒ‰ä¸‹æ–¹æŒ‰é’®ï¼Œä½¿å…¶æŒç»­æ—¶é—´æ°å¥½ä¸ºï¼š</div>
            <div class="target-time-disp">3.00 ç§’</div>
            <div class="time-btn" id="time-btn">æŒ‰ä½æˆ‘</div>
            <div style="color: var(--slate); margin-top: 15px; font-size:14px;" id="time-msg">å‰©ä½™ 5 æ¬¡æœºä¼š</div>
        </div>
    </div>

    <script>
        function show(id) {
            ['menu', 'pvt-area', 'time-area'].forEach(d => document.getElementById(d).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        /* ===================================================================== */
        /* 1. PVT é€»è¾‘ï¼šé«˜ç²¾åº¦çš„ setTimeout éšæœºé—´éš”ï¼Œå®æ—¶æ¸²æŸ“ååº”æ—¶é—´é€’å¢åŠ¨ç”»
        /* ===================================================================== */
        const TOTAL_PVT_TRIALS = 20; // ä¸´åºŠä¸ºäº†èŠ‚çœæ—¶é—´ï¼Œç²¾ç®€è‡³20æ¬¡ã€‚æ ‡å‡†å®Œæ•´ç‰ˆé€šå¸¸ä¸º10åˆ†é’Ÿã€‚
        let pvtData = { module: "SEN_PVT", records: [], summary: {} };
        let pvtTrial = 0;
        let pvtState = 'init'; // init -> ISI -> running -> feedback
        let pvtOnset = 0;
        let pvtTimeout = null;
        let pvtRAF = null; // requestAnimationFrame ç”¨äºæ¸²æŸ“è®¡æ•°å™¨

        const pvtBox = document.getElementById('pvt-box');
        const pvtTarget = document.getElementById('pvt-counter-text');
        const pvtMsg = document.getElementById('pvt-msg');

        function startPVT() {
            pvtData.records = []; pvtTrial = 0; pvtState = 'init';
            pvtMsg.innerText = "ç‚¹å‡»é»‘æ¡†ä»»æ„åŒºåŸŸå¼€å§‹æµ‹è¯•";
            pvtTarget.style.display = 'none';
            document.getElementById('pvt-counter').innerText = "";
            show('pvt-area');
        }

        // æ ¸å¿ƒæ¸²æŸ“å¾ªç¯ï¼Œæ¨¡æ‹Ÿ PVT ç»å…¸çš„æ¯«ç§’æ•°å­—é£™å‡æ•ˆæœ
        function updatePVTCounter() {
            if (pvtState !== 'running') return;
            const currentRT = performance.now() - pvtOnset;
            pvtTarget.innerText = Math.round(currentRT).toString().padStart(3, '0');
            pvtRAF = requestAnimationFrame(updatePVTCounter);
        }

        pvtBox.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            if (pvtState === 'init') {
                runPVTTrial();
            } else if (pvtState === 'ISI') {
                // False Start (æŠ¢ç­”)
                clearTimeout(pvtTimeout);
                pvtData.records.push({ rt: null, is_false_start: true, is_lapse: false });
                pvtMsg.innerText = "âš ï¸ æŠ¢ç­”ï¼å¿…é¡»ç­‰æ•°å­—å‡ºç°ã€‚\n(ç‚¹å‡»ç»§ç»­)";
                pvtState = 'init';
            } else if (pvtState === 'running') {
                // åˆæ³•ååº”
                cancelAnimationFrame(pvtRAF);
                const rt = Math.round(performance.now() - pvtOnset);
                const isLapse = rt > 500; // æ ¸å¿ƒæŒ‡æ ‡ï¼šååº”æ—¶è¶…è¿‡ 500ms å®šä¹‰ä¸ºæ³¨æ„åŠ›è¡°é€€ (Lapse)
                
                pvtData.records.push({ rt: rt, is_false_start: false, is_lapse: isLapse });
                pvtTrial++;
                
                pvtTarget.style.color = isLapse ? "var(--amber)" : "var(--green)"; // å‘ç”Ÿ Lapse ç»™é»„ç¯è­¦å‘Š
                pvtMsg.innerText = isLapse ? "æ³¨æ„åŠ›è½»å¾®æ¸¸ç¦»" : "";
                
                pvtState = 'feedback';
                
                setTimeout(() => {
                    if (pvtTrial >= TOTAL_PVT_TRIALS) finishPVT();
                    else runPVTTrial();
                }, 1000); // 1ç§’åé¦ˆæ—¶é—´
            }
        });

        function runPVTTrial() {
            pvtState = 'ISI';
            pvtTarget.style.display = 'none';
            pvtTarget.style.color = 'var(--red)';
            pvtMsg.innerText = "æ³¨è§†å±å¹•ä¸­ç­‰å¾…...";
            document.getElementById('pvt-counter').innerText = `è­¦æˆ’æ¬¡æ•°: ${pvtTrial + 1} / ${TOTAL_PVT_TRIALS}`;

            // ISI: éšæœº 2 - 10 ç§’ï¼ˆæ¨¡æ‹Ÿä¸å¯é¢„æœŸçš„äº‹ä»¶å‘ç”Ÿï¼‰
            const delay = 2000 + Math.random() * 8000;
            pvtTimeout = setTimeout(() => {
                pvtState = 'running';
                pvtOnset = performance.now();
                pvtTarget.style.display = 'block';
                pvtRAF = requestAnimationFrame(updatePVTCounter);
            }, delay);
        }

        function finishPVT() {
            const validRTs = pvtData.records.filter(r => !r.is_false_start).map(r => r.rt);
            const lapses = pvtData.records.filter(r => r.is_lapse).length;
            const falseStarts = pvtData.records.filter(r => r.is_false_start).length;
            
            const meanRT = validRTs.length > 0 ? validRTs.reduce((a,b)=>a+b,0) / validRTs.length : 0;

            pvtData.summary = {
                mean_rt_ms: Math.round(meanRT),
                lapses: lapses,
                false_starts: falseStarts
            };

            CAS_Storage.saveModuleData('SEN_PVT', pvtData);
            alert(`âœ… PVT æŒç»­è­¦è§‰æ€§è¯„ä¼°å®Œæˆï¼\n\n- å¹³å‡è­¦è§‰ååº”æ—¶: ${Math.round(meanRT)} ms\n- æ¸¸ç¦»å¤±è¯¯ (Lapses >500ms): ${lapses} æ¬¡\n- å†²åŠ¨æŠ¢ç­”: ${falseStarts} æ¬¡\n\n*ä¸´åºŠæç¤º: Lapses æ•°é‡æ˜¯è¡¡é‡ç¡çœ è´¨é‡ã€ç–²åŠ³é©¾é©¶æˆ–ç¥ç»è¡°å¼±çš„é»„é‡‘æ•æ„ŸæŒ‡æ ‡ã€‚`);
            show('menu');
        }

        /* ===================================================================== */
        /* 2. Time Reproduction é€»è¾‘ï¼šå±è”½è§†è§‰ï¼Œè€ƒå¯Ÿå†…éƒ¨æ—¶é’Ÿ (Internal Clock)
        /* ===================================================================== */
        const TARGET_TIME_MS = 3000;
        const TOTAL_TIME_TRIALS = 5;
        let trData = { module: "SEN_TimeRep", records: [], summary: {} };
        let trOnset = 0;
        let trTrial = 0;
        
        const timeBtn = document.getElementById('time-btn');
        const timeMsg = document.getElementById('time-msg');

        function startTimeRep() {
            trData.records = []; trTrial = 0;
            timeBtn.innerText = "æŒ‰ä½æˆ‘";
            timeMsg.innerText = `å‰©ä½™ ${TOTAL_TIME_TRIALS} æ¬¡æœºä¼š`;
            show('time-area');
        }

        timeBtn.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            timeBtn.classList.add('pressing');
            timeBtn.innerText = "...";
            trOnset = performance.now();
        });

        timeBtn.addEventListener('pointerup', (e) => {
            e.preventDefault();
            if(!timeBtn.classList.contains('pressing')) return;
            timeBtn.classList.remove('pressing');
            
            const duration = performance.now() - trOnset;
            const errorAbs = Math.abs(duration - TARGET_TIME_MS);
            
            trData.records.push({
                reproduced_ms: Math.round(duration),
                error_ms: Math.round(errorAbs)
            });

            trTrial++;
            timeBtn.innerText = (duration / 1000).toFixed(2) + "s"; // ç»™äºˆè¿™ä¸€æ¬¡çš„åé¦ˆ
            timeMsg.innerText = `å‰©ä½™ ${TOTAL_TIME_TRIALS - trTrial} æ¬¡æœºä¼š`;

            setTimeout(() => {
                if (trTrial >= TOTAL_TIME_TRIALS) finishTimeRep();
                else timeBtn.innerText = "æŒ‰ä½æˆ‘";
            }, 1000);
        });

        // å¤„ç†æ‰‹åŠ¿æ»‘å‡ºæŒ‰é’®çš„è¾¹ç¼˜æƒ…å†µ
        timeBtn.addEventListener('pointerout', (e) => {
            if(timeBtn.classList.contains('pressing')) {
                // æ¨¡æ‹Ÿ pointerup å¤„ç†
                const ev = new PointerEvent('pointerup');
                timeBtn.dispatchEvent(ev);
            }
        });

        function finishTimeRep() {
            const errors = trData.records.map(r => r.error_ms);
            const meanError = errors.reduce((a,b)=>a+b,0) / errors.length;
            
            // éŸ¦ä¼¯åˆ†æ•° (Weber Fraction) = è¯¯å·®å‡å€¼ / ç›®æ ‡æ—¶é—´ï¼Œç”¨äºæ ‡å‡†åŒ–è¡¡é‡æ—¶é—´æ„ŸçŸ¥æ¼‚ç§»
            const weberFraction = meanError / TARGET_TIME_MS;

            trData.summary = {
                target_time_ms: TARGET_TIME_MS,
                mean_absolute_error_ms: Math.round(meanError),
                weber_fraction: parseFloat(weberFraction.toFixed(3))
            };

            CAS_Storage.saveModuleData('SEN_TimeRep', trData);
            alert(`âœ… å†…éƒ¨æ—¶é—´èŠ‚å¾‹è¯„ä¼°å®Œæˆï¼\n\n- ç›®æ ‡æ—¶é—´: 3.00 ç§’\n- å¹³å‡ç»å¯¹è¯¯å·®: ${Math.round(meanError)} ms\n- èŠ‚å¾‹åç¦»æŒ‡æ•°: ${weberFraction.toFixed(3)}\n\n*ä¸´åºŠæç¤º: å°è„‘æˆ–çº¹çŠ¶ä½“èç¼©ä¼šå¯¼è‡´æ—¶é—´ä¼°ç®—è¿‡å¿«æˆ–è¿‡æ…¢ï¼Œè¯¯å·®æ˜¾è‘—å¢å¤§ã€‚`);
            show('menu');
        }
    </script>
</body>
</html>
