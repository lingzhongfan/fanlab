<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>感觉与知觉组合</title>
    <style>
        body { font-family: sans-serif; background: #f8fafc; margin: 0; padding: 20px; text-align: center; touch-action: manipulation; user-select: none; }
        .container { max-width: 600px; margin: 20px auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .sys-btn { background: #0f172a; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; margin: 10px; }
        .hidden { display: none !important; }
        /* CRT */
        #crt-box { width: 100%; height: 200px; background: #e2e8f0; border-radius: 12px; margin: 20px 0; border: 4px solid #cbd5e1; }
        /* Search */
        #search-box { width: 100%; height: 350px; background: #fff; border: 2px solid #cbd5e1; position: relative; border-radius: 12px; margin-bottom: 20px; }
        .stim { position: absolute; font-size: 24px; font-weight: bold; font-family: sans-serif; cursor: pointer; padding: 10px; }
        #nav-back { display: block; text-align: left; text-decoration: none; color: #3b82f6; font-weight: bold; margin-bottom: 10px; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <a href="index.html" id="nav-back">← 返回主控台</a>
    <div class="container" id="menu">
        <h2>视觉感知组合</h2>
        <button class="sys-btn" onclick="startCRT()">1. 选择反应时 (Decision RT)</button>
        <button class="sys-btn" onclick="startSearch()">2. 特征视觉搜索 (Visual Search)</button>
    </div>

    <div class="container hidden" id="crt-area">
        <h3>变红按左，变蓝按右</h3>
        <div id="crt-box"></div>
        <button class="sys-btn" style="background:#ef4444;" onclick="recCRT('red')">红色</button>
        <button class="sys-btn" style="background:#3b82f6;" onclick="recCRT('blue')">蓝色</button>
        <p id="crt-res"></p>
        <br><button class="sys-btn" style="background:#64748b;" onclick="document.getElementById('crt-area').classList.add('hidden'); document.getElementById('menu').classList.remove('hidden');">返回菜单</button>
    </div>

    <div class="container hidden" id="search-area">
        <h3>请在干扰项中找出唯一的 <strong style="color:red">红色的 T</strong>，并点击它。</h3>
        <div id="search-box"></div>
        <p id="search-res"></p>
        <button class="sys-btn" style="background:#64748b;" onclick="document.getElementById('search-area').classList.add('hidden'); document.getElementById('menu').classList.remove('hidden');">返回菜单</button>
    </div>

    <script>
        // --- Choice RT ---
        let crtData = { records: [] }, crtTr=0, crtOnset=0, crtTar='', crtTo;
        function startCRT() { document.getElementById('menu').classList.add('hidden'); document.getElementById('crt-area').classList.remove('hidden'); crtTr=0; crtData.records=[]; nextCRT(); }
        function nextCRT() {
            if(crtTr>=5) { CAS_Storage.saveModuleData('Sensation_ChoiceRT', crtData); document.getElementById('crt-res').innerText="CRT 已保存"; return; }
            document.getElementById('crt-box').style.background = '#e2e8f0';
            crtTo = setTimeout(()=>{ crtTar = Math.random()>0.5?'red':'blue'; document.getElementById('crt-box').style.background = crtTar==='red'?'#ef4444':'#3b82f6'; crtOnset = performance.now(); }, Math.random()*1500+1000);
        }
        function recCRT(res) {
            if(document.getElementById('crt-box').style.background==='rgb(226, 232, 240)') return;
            let rt = performance.now() - crtOnset; crtData.records.push({tar:crtTar, res:res, rt:Math.round(rt)});
            crtTr++; clearTimeout(crtTo); nextCRT();
        }

        // --- Visual Search ---
        let sData = { records: [] }, sTr=0, sOnset=0;
        function startSearch() { document.getElementById('menu').classList.add('hidden'); document.getElementById('search-area').classList.remove('hidden'); sTr=0; sData.records=[]; nextSearch(); }
        function nextSearch() {
            if(sTr>=5) { CAS_Storage.saveModuleData('Sensation_VisualSearch', sData); document.getElementById('search-res').innerText="Visual Search 已保存"; return; }
            let box = document.getElementById('search-box'); box.innerHTML = '';
            let distractors = 20 + sTr*10; // 干扰项随 trial 增加
            
            // 生成干扰项 (蓝T, 红L)
            for(let i=0; i<distractors; i++) {
                let el = document.createElement('div'); el.className = 'stim';
                let isBlueT = Math.random() > 0.5;
                el.innerText = isBlueT ? 'T' : 'L'; el.style.color = isBlueT ? 'blue' : 'red';
                el.style.left = (Math.random()*90) + '%'; el.style.top = (Math.random()*90) + '%';
                box.appendChild(el);
            }
            // 生成目标 (红T)
            let tar = document.createElement('div'); tar.className = 'stim'; tar.innerText = 'T'; tar.style.color = 'red';
            tar.style.left = (Math.random()*90) + '%'; tar.style.top = (Math.random()*90) + '%';
            tar.ontouchstart = tar.onmousedown = (e) => { e.preventDefault();
                let rt = performance.now() - sOnset;
                sData.records.push({ distractors: distractors, rt: Math.round(rt) });
                sTr++; nextSearch();
            };
            box.appendChild(tar); sOnset = performance.now();
        }
    </script>
</body>
</html>
