<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroMap 1.0 -  ç¥ç»è¡Œä¸ºå¤šæ¨¡æ€è¯„ä¼°å›¾è°±ç³»ç»Ÿ</title>
    <style>
        /* ==================== UI ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #0f172a; --blue: #4f46e5; --green: #10b981; --slate: #64748b; --bg: #f8fafc; --amber: #f59e0b; --rose: #e11d48; --teal: #0d9488;}
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); }
        
        .header { text-align: center; margin-bottom: 30px; padding: 30px; background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); border-bottom: 4px solid var(--blue);}
        
        /* ä¸´åºŠåŸºçº¿ä¿¡æ¯é¢æ¿ (æ¢å¤çš„åŸç‰ˆè®¾è®¡) */
        .demo-panel { max-width: 1200px; margin: 0 auto 30px; background: white; border: 2px solid #e2e8f0; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); transition: 0.3s; }
        .demo-panel.locked { border-color: var(--green); background: #f0fdf4; box-shadow: 0 0 0 4px #d1fae5; }
        .demo-header { font-size: 20px; font-weight: bold; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;}
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 14px; font-weight: bold; color: var(--slate); }
        .form-input { padding: 12px 15px; border: 2px solid #cbd5e1; border-radius: 12px; font-size: 16px; outline: none; transition: 0.2s; color: var(--primary); font-weight: bold;}
        .form-input:focus { border-color: var(--blue); }
        .form-input:disabled { background: #e2e8f0; color: var(--slate); cursor: not-allowed; border-color: #cbd5e1; }
        .btn-save-demo { padding: 15px; background: var(--blue); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; width: 100%; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.2);}
        .btn-save-demo:hover { background: #4338ca; transform: translateY(-2px); }
        .btn-save-demo:disabled { background: var(--green); box-shadow: none; cursor: default; transform: none;}

        /* EMA ç–²åŠ³åº¦é¢æ¿ */
        .ema-panel { max-width: 1200px; margin: 0 auto 30px; background: #fffbeb; border: 2px dashed #fcd34d; padding: 20px; border-radius: 16px; text-align: center; }
        
        /* ä»»åŠ¡æ¨¡å—ç½‘æ ¼ */
        .section-title { max-width: 1200px; margin: 30px auto 15px; font-size: 20px; color: var(--slate); border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; font-weight: bold;}
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        
        .card { background: white; border-radius: 16px; padding: 20px; text-decoration: none; color: inherit; border: 2px solid #e2e8f0; transition: 0.3s; position: relative; display: flex; flex-direction: column;}
        .card:hover { border-color: var(--blue); transform: translateY(-3px); box-shadow: 0 10px 25px rgba(79,70,229,0.1); }
        .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .icon { font-size: 28px; }
        .card h2 { margin: 0; font-size: 18px; }
        .card p { color: var(--slate); font-size: 13px; margin: 0; flex-grow: 1; line-height: 1.5;}
        
        .status-badge { position: absolute; top: 15px; right: 15px; font-size: 12px; font-weight: bold; padding: 4px 8px; border-radius: 8px; background: #f1f5f9; color: var(--slate); transition: 0.3s;}
        .status-completed { background: #d1fae5; color: #059669; border: 1px solid #34d399;}

        /* ç³»ç»Ÿæ§åˆ¶æ  */
        .sys-bar { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin: 50px auto; max-width: 1200px;}
        .btn-sys { padding: 15px 30px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; text-decoration: none; transition: 0.2s;}
        .btn-sys:hover { transform: translateY(-2px); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div class="header">
        <h1 style="margin:0; font-size: 32px;">ç¥ç»è¡Œä¸ºå¤šæ¨¡æ€è¯„ä¼°å›¾è°±ç³»ç»Ÿ (NeuroMap)</h1>
        <p style="color:var(--slate); margin-top:10px; font-size:16px;">å¤šæ¨¡æ€æ•°å­—ç”Ÿç‰©æ ‡å¿—ç‰©æ•è·çŸ©é˜µ (Clinical-Grade Array)</p>
    </div>

    <div class="demo-panel" id="demo-panel">
        <div class="demo-header">
            <span>ğŸ“‹ Step 0: å—è¯•è€…å»ºæ¡£ (Demographics)</span>
            <span id="demo-status" style="font-size: 14px; color: var(--slate); font-weight: normal;">å¾…å½•å…¥</span>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label>å—è¯•è€…ç¼–å· (Subject ID)</label>
                <input type="text" id="sub-id" class="form-input" placeholder="ä¾‹å¦‚: SUBJ-001">
            </div>
            <div class="form-group">
                <label>æ€§åˆ« (Gender)</label>
                <select id="sub-gender" class="form-input">
                    <option value="Male">ç”· (Male)</option>
                    <option value="Female">å¥³ (Female)</option>
                </select>
            </div>
            <div class="form-group">
                <label>å‡ºç”Ÿå¹´ä»½ (Birth Year)</label>
                <input type="number" id="sub-dob" class="form-input" placeholder="ä¾‹å¦‚: 1956">
            </div>
            <div class="form-group">
                <label>å—æ•™è‚²å¹´é™ (Education Years)</label>
                <input type="number" id="sub-edu" class="form-input" placeholder="ä¾‹å¦‚: 12 (é«˜ä¸­)">
            </div>
        </div>
        <button class="btn-save-demo" id="btn-save-demo" onclick="saveDemographics()">ğŸ’¾ ä¿å­˜å¹¶é”å®šæ‚£è€…æ¡£æ¡ˆ</button>
    </div>

    <div class="ema-panel">
        <strong>ğŸ’¡ ä¸»è¯•å¹²é¢„ï¼šç”Ÿæ€ç¬æ—¶ç–²åŠ³è¯„ä¼° (EMA)</strong><br>
        <span style="font-size:13px; color:#b45309;">è¯·åœ¨å®Œæˆé«˜è´Ÿè·æ¨¡å—åï¼Œéšæ—¶æ‹–åŠ¨æ»‘å—è®°å½•å—è¯•è€…å½“ä¸‹çš„è®¤çŸ¥ç–²åŠ³åº¦ã€‚</span><br>
        <input type="range" id="fatigue-slider" min="0" max="100" value="0" style="width: 300px; margin: 15px 0;">
        <button onclick="CAS_Storage.recordFatigue(document.getElementById('fatigue-slider').value); alert('âœ… ä¸»è§‚ç–²åŠ³åº¦è¿½è¸ªå·²æ³¨å…¥æ—¶åºæ•°æ®åº“ï¼');" style="padding: 8px 20px; background: #d97706; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight:bold;">è®°å½•å…¥åº“</button>
    </div>

    <div class="section-title">ğŸ§  è®¤çŸ¥ã€è¯­è¨€ä¸æ‰§è¡Œç½‘ç»œ (Cognition & Language)</div>
    <div class="grid">
        <a href="cognition.html" class="card" id="card-cog">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">ğŸ§©</div><h2>ç»å…¸æ‰§è¡ŒåŠŸèƒ½ (COG)</h2></div>
            <p>é«˜å‹æµ‹è¯•åº“ï¼šTMT-B 25èŠ‚ç‚¹, é™æ—¶ DSST, ä¸å¹³è¡¡ Stroop ä¾§æŠ‘åˆ¶ä¸ Corsiã€‚</p>
        </a>
        <a href="language.html" class="card" id="card-lan">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">ğŸ—£ï¸</div><h2>è¨€è¯­æµç•…æ€§ (VFT)</h2></div>
            <p>60ç§’å¼ºåˆ¶é˜»æ–­ï¼šæå–é¦–è¯æ½œä¼æœŸä¸è¯é—´é—´éš”(IWI)åŠ¨åŠ›å­¦ç‰¹å¾ã€‚</p>
        </a>
        <a href="voice_biomarker.html" class="card" id="card-vbm">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">ğŸ™ï¸</div><h2>è¯­éŸ³ç”Ÿç‰©æ ‡è®° (VBM)</h2></div>
            <p>æ³¢å£«é¡¿å·é¥¼å›¾ï¼šå®æ—¶å£°å­¦ VADï¼Œæå–é™é»˜åœé¡¿æ¯”ä¾‹è¯†åˆ«å¤±è¯­ã€‚</p>
        </a>
    </div>

    <div class="section-title">ğŸ¯ ç²¾ç»†è¿åŠ¨ä¸åŠ¨åŠ›å­¦å›è·¯ (Motor Kinematics)</div>
    <div class="grid">
        <a href="motor.html" class="card" id="card-mot">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">ğŸ‘‡</div><h2>çº¯è¿åŠ¨èµ·åŠ¨ (MOT)</h2></div>
            <p>é¶å‘åŸºåº•èŠ‚ï¼šäº¤æ›¿æ•²å‡»(AFT)è¡°å‡æŒ‡æ•°ä¸ç®€å•è¿åŠ¨ååº”æ—¶(SRT)ã€‚</p>
        </a>
        <a href="keystroke.html" class="card" id="card-key">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">âŒ¨ï¸</div><h2>æŒ‰é”®å¾®è§‚åŠ¨åŠ›å­¦ (KEY)</h2></div>
            <p>ä¸´åºŠé•¿æ–‡æœ¬æ‰“å­—ï¼šæå–æ»ç•™æ—¶é—´(Dwell)å˜å¼‚ç³»æ•°æ•æ‰è‚Œè‚‰å¼ºç›´ã€‚</p>
        </a>
        <a href="dcdt.html" class="card" id="card-dcdt">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">âœï¸</div><h2>ç”»é’Ÿæ—¶ç©ºåˆ‡ç‰‡ (dCDT)</h2></div>
            <p>è§†ç©ºé—´ç»“æ„è¯„ä¼°ï¼šè®¡ç®—è½ç¬”æ—¶é—´ä¸ç©ºä¸­æ€è€ƒæ‚¬åœæ—¶é—´(In-air)ã€‚</p>
        </a>
        <a href="gait_imu.html" class="card" id="card-gait">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">ğŸš¶â€â™‚ï¸</div><h2>åŒé‡ä»»åŠ¡æ­¥æ€ (IMU)</h2></div>
            <p>åŸºäºæ‰‹æœºä¸‰è½´åŠ é€Ÿåº¦è®¡ï¼šæå–æ­¥é¢‘å˜å¼‚æ€§(CV)é¢„æµ‹è·Œå€’é£é™©ã€‚</p>
        </a>
    </div>

    <div class="section-title">ğŸ­ æƒ…æ„Ÿã€æ„ŸçŸ¥è§‰ä¸ç”Ÿç†æµ‹é‡ (Emotion, Sensation & Physiology)</div>
    <div class="grid">
        <a href="emotion.html" class="card" id="card-fer">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">ğŸ˜ƒ</div><h2>é¢å­”æƒ…ç»ªè¯†åˆ« (FER)</h2></div>
            <p>ç¤¾ä¼šè®¤çŸ¥è¯„ä¼°ï¼šER-60æ ‡å‡†ç‰ˆï¼Œè¾“å‡ºæƒ…ç»ªç‰¹å¼‚æ€§æ··æ·†çŸ©é˜µã€‚</p>
        </a>
        <a href="advanced_emotion.html" class="card" id="card-aemo">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">âš¡</div><h2>å†…éšä¸è°ƒèŠ‚ (AEMO)</h2></div>
            <p>è®¡ç®—ç²¾ç¥ç—…å­¦æ¨¡å—ï¼šIATå†…éšåç½®æµ‹é‡ä¸ERTè®¤çŸ¥é‡è¯„æŠ‘åˆ¶æµ‹éªŒã€‚</p>
        </a>
        <a href="sensation.html" class="card" id="card-sen">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">ğŸ‘ï¸</div><h2>è­¦è§‰ä¸æ„ŸçŸ¥ (SEN)</h2></div>
            <p>PVT æŒç»­ç²¾ç¥è¿åŠ¨è­¦è§‰æ€§æµ‹éªŒä¸å†…éƒ¨æ—¶é—´èŠ‚å¾‹(TimeRep)æµ‹ç®—ã€‚</p>
        </a>
        <a href="face_rppg.html" class="card" id="card-rppg">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">ğŸ¥</div><h2>é¢éƒ¨å½±åƒè¡€æµ (rPPG)</h2></div>
            <p>è¿œç«¯å…‰ç”µå®¹ç§¯æ³¢ï¼šéæ¥è§¦æå–é™æ¯å¿ƒç‡å˜å¼‚æ€§(RMSSD/è¿·èµ°å¼ åŠ›)ã€‚</p>
        </a>
        <a href="lifestyle.html" class="card" id="card-lif">
            <div class="status-badge">å¾…æµ‹</div>
            <div class="card-header"><div class="icon">ğŸ¥—</div><h2>åŠŸèƒ½ä¸èŠ‚å¾‹ (LIF)</h2></div>
            <p>å•é¢˜é«˜å‹é˜²è¿‡è½½UIï¼šè®°å½•å›ç­”æ—¥å¸¸åŠŸèƒ½é—®é¢˜çš„å†³ç­–è¿Ÿç–‘æ½œä¼æœŸã€‚</p>
        </a>
    </div>

    <div class="sys-bar">
        <button class="btn-sys" style="background:var(--rose);" onclick="CAS_Storage.clearSession()">ğŸ—‘ï¸ é”€æ¯å½“å‰å—è¯•è€…ç¼“å­˜ (é‡ç½®æ‰€æœ‰)</button>
        <a href="manual.html" class="btn-sys" style="background:var(--slate);">ğŸ“– æŸ¥é˜…ä¸»è¯•ä¸´åºŠ SOP æ‰‹å†Œ</a>
        <a href="report.html" class="btn-sys" style="background:var(--green); font-size: 18px; box-shadow: 0 5px 20px rgba(16,185,129,0.3);">ğŸ“Š ç»“æŸæµ‹è¯•ï¼šç”Ÿæˆå¤šæ¨¡æ€ä¸´åºŠæŠ¥å‘Š â”</a>
    </div>

    <script>
        window.onload = function() {
            // 1. åˆå§‹åŒ–å¹¶æ£€æŸ¥äººå£å­¦å»ºæ¡£çŠ¶æ€
            loadDemographics();

            // 2. æ£€æŸ¥æ‰€æœ‰ 12 ä¸ªä»»åŠ¡æ¨¡å—çš„å®ŒæˆçŠ¶æ€
            const checkStatus = (moduleKeys, domId) => {
                let isCompleted = Array.isArray(moduleKeys) 
                    ? moduleKeys.some(key => CAS_Storage.isModuleCompleted(key))
                    : CAS_Storage.isModuleCompleted(moduleKeys);

                if(isCompleted) {
                    const el = document.getElementById(domId);
                    if(el) {
                        const badge = el.querySelector('.status-badge');
                        badge.innerText = "âœ… å·²å®Œæˆ"; 
                        badge.classList.add('status-completed');
                        el.style.borderColor = "var(--green)";
                    }
                }
            };
            
            // ç»‘å®šæ¨¡å— Key ä¸ UI Card
            checkStatus(['COG_Stroop', 'COG_DSST', 'COG_TMT_B', 'COG_Corsi', 'COG_Pattern'], 'card-cog'); 
            checkStatus('Language_VFT', 'card-lan');
            checkStatus('Voice_Biomarkers', 'card-vbm');
            
            checkStatus(['MOT_AFT', 'MOT_SRT'], 'card-mot');
            checkStatus('MOT_Keystroke', 'card-key');
            checkStatus('MOT_dCDT', 'card-dcdt');
            checkStatus('MOT_DualTaskGait', 'card-gait');
            
            checkStatus('Emotion_FER', 'card-fer');
            checkStatus(['AEMO_IAT', 'AEMO_ERT', 'AEMO_LLM_Big5'], 'card-aemo');
            checkStatus(['SEN_PVT', 'SEN_TimeRep'], 'card-sen');
            checkStatus('PHY_Face_rPPG', 'card-rppg');
            checkStatus('LIF_Lifestyle', 'card-lif');
        };

        // ================= äººå£å­¦å»ºæ¡£æ ¸å¿ƒé€»è¾‘ =================
        function saveDemographics() {
            const subId = document.getElementById('sub-id').value.trim();
            const gender = document.getElementById('sub-gender').value;
            const dob = document.getElementById('sub-dob').value.trim();
            const edu = document.getElementById('sub-edu').value.trim();

            if (!subId || !dob || !edu) {
                return alert("âš ï¸ è¯·å®Œæ•´å¡«å†™å—è¯•è€…ç¼–å·ã€å‡ºç”Ÿå¹´ä»½å’Œå—æ•™è‚²å¹´é™ï¼");
            }

            let session = CAS_Storage.getSession();
            session.demographics = {
                subject_id: subId,
                gender: gender,
                dob: dob + '-01-01', // æ ‡å‡†åŒ–ä¸º BIDS æ—¥æœŸæ ¼å¼çš„ç¼ºçœå€¼
                education_years: parseInt(edu)
            };
            
            // è§¦å‘ä¿å­˜å¹¶æ›´æ–°ç¼“å­˜æ—¶é—´
            session.last_update = new Date().toISOString();
            localStorage.setItem(CAS_Storage.SESSION_KEY, JSON.stringify(session));

            alert("âœ… æ‚£è€…æ¡£æ¡ˆå·²å®‰å…¨å…¥åº“å¹¶é”å®šã€‚æ‚¨å¯ä»¥å¼€å§‹æ‰§è¡Œä¸‹æ–¹æµ‹è¯•äº†ï¼");
            lockDemographicsUI();
        }

        function loadDemographics() {
            let session = CAS_Storage.getSession();
            if (session.demographics && session.demographics.subject_id) {
                // å›å¡«æ•°æ®
                document.getElementById('sub-id').value = session.demographics.subject_id;
                document.getElementById('sub-gender').value = session.demographics.gender;
                document.getElementById('sub-dob').value = session.demographics.dob.split('-')[0];
                document.getElementById('sub-edu').value = session.demographics.education_years;
                
                // é”å®šç•Œé¢
                lockDemographicsUI();
            }
        }

        function lockDemographicsUI() {
            // ç¦ç”¨æ‰€æœ‰è¾“å…¥æ¡†
            document.querySelectorAll('.form-input').forEach(input => input.disabled = true);
            
            // æ›´æ”¹ä¿å­˜æŒ‰é’®çŠ¶æ€
            const btn = document.getElementById('btn-save-demo');
            btn.disabled = true;
            btn.innerText = "âœ… æ¡£æ¡ˆå·²é”å®š (å¦‚éœ€ä¿®æ”¹è¯·ç‚¹å‡»åº•éƒ¨é”€æ¯ç¼“å­˜)";
            
            // æ›´æ”¹é¢æ¿æ ·å¼
            const panel = document.getElementById('demo-panel');
            panel.classList.add('locked');
            
            // æ›´æ–°çŠ¶æ€å¾½ç« 
            const status = document.getElementById('demo-status');
            status.innerText = "âœ… å·²å»ºæ¡£";
            status.style.color = "var(--green)";
            status.style.fontWeight = "bold";
        }
    </script>
</body>
</html>
