<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-MOT | è¿åŠ¨æ§åˆ¶ä¸å…±æµåˆ†æ</title>
    <style>
        /* ==================== 1. ç§‘æŠ€æ¸©æƒ…é£ UI (Warm-Tech UI) ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --amber: #f59e0b; --slate: #64748b; }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; touch-action: none; user-select: none; }
        .container { max-width: 750px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--amber); padding-left: 15px; margin-bottom: 30px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; }

        .sys-btn { width: 100%; padding: 18px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 15px; transition: 0.2s; display: flex; align-items: center; gap: 12px; }
        .btn-menu { background: #fffbeb; color: #b45309; border: 1px solid #fef3c7; }
        .btn-menu:hover { background: var(--amber); color: white; transform: translateX(5px); box-shadow: 0 8px 15px rgba(245, 158, 11, 0.2); }
        .btn-action { background: var(--amber); color: white; justify-content: center; margin-top: 20px; }

        /* ==================== 2. ä¸“é¡¹å®éªŒ UI ==================== */
        /* [èŒƒå¼1] Tapping æ•²å‡»æ¿ */
        .tap-board { width: 100%; height: 250px; background: #f8fafc; border: 3px dashed #cbd5e1; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #94a3b8; cursor: pointer; transition: 0.1s; }
        .tap-board:active { background: var(--light-blue); border-color: var(--blue); color: var(--blue); transform: scale(0.98); }

        /* [èŒƒå¼2] Fitts' Law é¶å‘ç‚¹å‡»åŒº */
        #fitts-workspace { position: relative; width: 100%; height: 350px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 20px; overflow: hidden; margin-bottom: 20px; }
        .fitts-target { position: absolute; border-radius: 50%; background: var(--amber); cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: background 0.1s; }
        .fitts-target:active { background: #b45309; }

        /* [èŒƒå¼3] Spiral èºæ—‹çº¿ææ‘¹ç”»æ¿ */
        .canvas-wrapper { position: relative; display: flex; justify-content: center; margin: 20px 0; }
        #spiral-canvas { background: #f8fafc; border: 2px solid #cbd5e1; border-radius: 16px; touch-action: none; /* å¿…é¡»ç¦ç”¨æµè§ˆå™¨é»˜è®¤æ»‘åŠ¨ï¼Œç¡®ä¿ç”»ç¬”æµç•… */ }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--amber); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ¯ è¿åŠ¨ä¸å…±æµ (CAS-MOT)</h2>
            <p>é¶å‘è¿åŠ¨çš®å±‚ä¸åŸºåº•èŠ‚ï¼Œé‡åŒ–è¿åŠ¨è¿Ÿç¼“ã€ç²¾ç»†åè°ƒä¸å¾®å¼±éœ‡é¢¤ã€‚</p>
        </div>
        <button class="sys-btn btn-menu" onclick="startTapping()">â±ï¸ 1. Simple Tapping (è¿åŠ¨é€Ÿåº¦ä¸ç–²åŠ³åº¦)</button>
        <button class="sys-btn btn-menu" onclick="startFitts()">ğŸ¯ 2. Fitts' Law é¶å‘æµ‹è¯• (æ‰‹çœ¼åè°ƒä¸ç©ºé—´å®šä½)</button>
        <button class="sys-btn btn-menu" onclick="startSpiral()">ğŸŒ€ 3. Archimedean Spiral (é«˜é¢‘éœ‡é¢¤ä¸å…±æµå¤±è°ƒåˆ†æ)</button>
    </div>

    <div class="container hidden" id="tap-area">
        <div class="module-header"><h2>é£ŸæŒ‡å¿«é€Ÿæ•²å‡» (Index Finger Tapping)</h2>
        <p>ä¸´åºŠæ„ä¹‰: å¸•é‡‘æ£®ç—… (PD) æ—©æœŸè¿åŠ¨è¿Ÿç¼“ (Bradykinesia) ä¸ç¥ç»ä¼ å¯¼ç–²åŠ³åº¦è¯„ä¼°ã€‚</p></div>
        <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:bold; margin-bottom:15px; color:var(--primary);">
            <span>å€’è®¡æ—¶: <span id="tap-time" style="color:var(--red);">10s</span></span>
            <span>æ•²å‡»æ•°: <span id="tap-count" style="color:var(--blue);">0</span></span>
        </div>
        <div class="tap-board" id="tap-board" onclick="recordTap()">ğŸ‘‡ ç‚¹å‡»æ­¤å¤„å¼€å§‹</div>
    </div>

    <div class="container hidden" id="fitts-area">
        <div class="module-header"><h2>Fitts é¶å‘åè°ƒæµ‹è¯•</h2>
        <p>ä¸´åºŠæ„ä¹‰: è¿åŠ¨è§„åˆ’ã€å°è„‘å…±æµåŠŸèƒ½ã€‚é€šè¿‡â€œé€Ÿåº¦-å‡†ç¡®ç‡æƒè¡¡â€æå–è¿åŠ¨æ§åˆ¶æ¨¡å‹ã€‚</p></div>
        <div style="font-weight:bold; color:var(--amber); margin-bottom: 10px;">è¿›åº¦: <span id="fitts-prog">1/10</span></div>
        <div id="fitts-workspace"></div>
    </div>

    <div class="container hidden" id="spiral-area">
        <div class="module-header"><h2>é˜¿åŸºç±³å¾·èºæ—‹çº¿ (Archimedean Spiral)</h2>
        <p>ä¸´åºŠæ„ä¹‰: é‰´åˆ«ç‰¹å‘æ€§éœ‡é¢¤ (Essential Tremor, 4-12Hz) ä¸é™æ­¢æ€§éœ‡é¢¤ã€‚</p></div>
        <p style="text-align:center; color:var(--slate); font-size:14px;">è¯·ä½¿ç”¨é£ŸæŒ‡æˆ–è§¦æ§ç¬”ï¼Œæ²¿è™šçº¿å¹³ç¨³ç”»å‡ºèºæ—‹çº¿ (ä»å†…å‘å¤–)ã€‚</p>
        
        <div class="canvas-wrapper">
            <canvas id="spiral-canvas" width="300" height="300"></canvas>
        </div>
        
        <div style="display:flex; gap:15px;">
            <button class="sys-btn" style="background:#f1f5f9; color:var(--slate); justify-content:center;" onclick="clearCanvas()">é‡ç”»</button>
            <button class="sys-btn btn-action" style="margin-top:0;" onclick="saveSpiral()">ä¿å­˜è½¨è¿¹ç‰¹å¾</button>
        </div>
    </div>

    <script>
        function show(id) {
            ['menu', 'tap-area', 'fitts-area', 'spiral-area'].forEach(d => {
                const el = document.getElementById(d); if(el) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0);
        }

        /* ==================== 1. Simple Tapping (è¿åŠ¨ç–²åŠ³åº¦æµ‹ç®—) ==================== */
        let tapData = { module: "MOT_Tapping", total_taps: 0, timestamps: [] };
        let tapTimer = null, tapTimeLeft = 10, isTapping = false;

        function startTapping() {
            tapData.total_taps = 0; tapData.timestamps = []; tapTimeLeft = 10; isTapping = false;
            document.getElementById('tap-count').innerText = "0";
            document.getElementById('tap-time').innerText = "10s";
            document.getElementById('tap-board').innerText = "ğŸ‘‡ ç‚¹å‡»æ­¤å¤„å¼€å§‹";
            show('tap-area');
        }

        function recordTap() {
            if (tapTimeLeft <= 0) return; // æ—¶é—´åˆ°åœæ­¢è®°å½•
            
            // é¦–æ¬¡ç‚¹å‡»è§¦å‘è®¡æ—¶å™¨
            if (!isTapping) {
                isTapping = true;
                document.getElementById('tap-board').innerText = "ç»§ç»­å¿«é€Ÿç‚¹å‡»ï¼";
                tapTimer = setInterval(() => {
                    tapTimeLeft--;
                    document.getElementById('tap-time').innerText = tapTimeLeft + "s";
                    if (tapTimeLeft <= 0) {
                        clearInterval(tapTimer);
                        document.getElementById('tap-board').innerText = "æµ‹è¯•ç»“æŸ";
                        CAS_Storage.saveModuleData('MOT_Tapping', tapData);
                        // åæœŸæ•°æ®åˆ†æå»ºè®®ï¼šé€šè¿‡ timestamps æ•°ç»„è®¡ç®—å„é˜¶æ®µçš„ç‚¹å‡»é¢‘ç‡(Hz)ï¼Œä¸‹é™æ–œç‡å³ä¸ºç–²åŠ³æŒ‡æ•°(Fatigue Index)
                        alert(`æµ‹è¯•å®Œæˆï¼æ€»æ•²å‡»æ•°: ${tapData.total_taps} æ¬¡`); show('menu');
                    }
                }, 1000);
            }
            
            // è®°å½•æ¯æ¬¡ç‚¹å‡»çš„é«˜ç²¾åº¦æ—¶é—´æˆ³ (Performance API)
            tapData.timestamps.push(Math.round(performance.now()));
            tapData.total_taps++;
            document.getElementById('tap-count').innerText = tapData.total_taps;
        }

        /* ==================== 2. Fitts' Law (é¶å‘è¿åŠ¨åè°ƒ) ==================== */
        // æ ¹æ® Fitts' Law: Index of Difficulty (ID) = log2(2D/W)ã€‚Dä¸ºè·ç¦»ï¼ŒWä¸ºé¶å­å®½åº¦ã€‚
        let fittsData = { module: "MOT_Fitts", records: [] };
        let f_trial = 0, f_onset = 0, f_target = null;
        
        function startFitts() { f_trial = 0; fittsData.records = []; show('fitts-area'); nextFitts(); }
        
        function nextFitts() {
            const ws = document.getElementById('fitts-workspace');
            ws.innerHTML = ''; // æ¸…ç†ä¸Šä¸€è½®é¶å­
            
            if (f_trial >= 10) { 
                CAS_Storage.saveModuleData('MOT_Fitts', fittsData); 
                alert("é¶å‘æµ‹è¯•å®Œæˆï¼"); show('menu'); return; 
            }
            
            document.getElementById('fitts-prog').innerText = `${f_trial + 1}/10`;
            
            // éšæœºç”Ÿæˆé¶å­å¤§å° (å®½åº¦ W: 30px ~ 70px) å’Œä½ç½® (åæ ‡ X/Y)
            const w = Math.floor(Math.random() * 40) + 30; 
            const maxX = ws.clientWidth - w;
            const maxY = ws.clientHeight - w;
            const x = Math.floor(Math.random() * maxX);
            const y = Math.floor(Math.random() * maxY);

            let tgt = document.createElement('div');
            tgt.className = 'fitts-target';
            tgt.style.width = w + 'px'; tgt.style.height = w + 'px';
            tgt.style.left = x + 'px'; tgt.style.top = y + 'px';
            
            // å°†é¶å­å±æ€§ä¿å­˜åœ¨é—­åŒ…å¤–ï¼Œç”¨äºè®°å½•
            f_target = { width: w, x: x, y: y };
            
            tgt.onclick = () => {
                const rt = Math.round(performance.now() - f_onset);
                // è®°å½•æ¯ä¸€æ­¥çš„ RTã€é¶å¤§å°å’Œåæ ‡ï¼Œä¾›åç»­ç®—æ³•è®¡ç®—è¿åŠ¨æ–œç‡(Information Capacity)
                fittsData.records.push({ trial: f_trial+1, target_w: w, target_x: x, target_y: y, rt_ms: rt });
                f_trial++; nextFitts();
            };
            
            ws.appendChild(tgt);
            f_onset = performance.now();
        }

        /* ==================== 3. Archimedean Spiral (éœ‡é¢¤è½¨è¿¹å¼•æ“) ==================== */
        let spiralData = { module: "MOT_Spiral", trajectory: [] };
        const canvas = document.getElementById('spiral-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function startSpiral() { spiralData.trajectory = []; show('spiral-area'); drawTemplate(); }

        // ç»˜åˆ¶åº•å±‚é˜¿åŸºç±³å¾·èºæ—‹çº¿æ¨¡æ¿ (ç°è‰²è™šçº¿)
        function drawTemplate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            let a = 5; // èºæ—‹å¯†åº¦å‚æ•°
            for (let i = 0; i < 720; i++) {
                let angle = 0.1 * i;
                let x = canvas.width / 2 + (a * angle) * Math.cos(angle);
                let y = canvas.height / 2 + (a * angle) * Math.sin(angle);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 3; ctx.setLineDash([5, 5]); ctx.stroke();
            ctx.setLineDash([]); // æ¢å¤å®çº¿
        }

        function clearCanvas() { spiralData.trajectory = []; drawTemplate(); }

        function saveSpiral() {
            if(spiralData.trajectory.length < 10) return alert("è½¨è¿¹å¤ªçŸ­ï¼Œè¯·å……åˆ†ææ‘¹èºæ—‹çº¿ã€‚");
            CAS_Storage.saveModuleData('MOT_Spiral', spiralData);
            // ä¸´åºŠæå–ç‰¹å¾å»ºè®®ï¼šå¯¹ trajectory.x å’Œ y åºåˆ—è¿›è¡Œ FFT (å¿«é€Ÿå‚…é‡Œå¶å˜æ¢) æå–é¢‘æ®µç‰¹å¾ã€‚
            alert("é«˜é¢‘è½¨è¿¹æ•°æ®é‡‡é›†å®Œæˆï¼"); show('menu');
        }

        // æ ¸å¿ƒç»˜å›¾äº‹ä»¶ä¸è½¨è¿¹åæ ‡è®°å½• (å…¼å®¹ Mouse å’Œ Touch)
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            // åŒºåˆ†è§¦å±ä¸é¼ æ ‡äº‹ä»¶æå–åæ ‡
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top, t: Math.round(performance.now()) };
        }

        function startDraw(e) {
            e.preventDefault(); isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
            spiralData.trajectory.push(pos);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.strokeStyle = '#4f46e5'; ctx.lineWidth = 2; ctx.stroke(); // ç”¨è“è‰²å®çº¿è®°å½•å—è¯•è€…è½¨è¿¹
            spiralData.trajectory.push(pos); // è¿ç»­å‹å…¥æ—¶ç©ºæ•°ç»„
        }

        function endDraw() { isDrawing = false; ctx.closePath(); }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw); canvas.addEventListener('mouseleave', endDraw);
        canvas.addEventListener('touchstart', startDraw, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false});
        canvas.addEventListener('touchend', endDraw);
    </script>
</body>
</html>
