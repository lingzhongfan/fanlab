<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-MOT | ç²¾ç»†è¿åŠ¨ä¸å…±æµè¡¨å‹</title>
    <style>
        /* å…¨å±€é˜²åˆ’åŠ¨ä¸é˜²è¯¯è§¦é…ç½® (é’ˆå¯¹é«˜é¢‘è§¦æ‘¸ç”»å¸ƒä¼˜åŒ–) */
        body { 
            font-family: -apple-system, sans-serif; 
            background: #f8fafc; 
            margin: 0; 
            padding: 20px; 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior: none; 
        }
        .container { 
            max-width: 750px; 
            margin: 20px auto; 
            background: white; 
            padding: 35px 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }
        .module-header { 
            color: #0f172a; 
            margin-top: 0; 
            font-size: 24px; 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        
        .sys-btn { 
            background: #0f172a; 
            color: white; 
            border: none; 
            padding: 18px 30px; 
            font-size: 16px; 
            font-weight: bold; 
            border-radius: 12px; 
            cursor: pointer; 
            margin: 10px 0; 
            width: 100%; 
            transition: 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .sys-btn:active { transform: scale(0.98); } 
        .hidden { display: none !important; }
        
        #nav-back { 
            display: inline-flex; 
            align-items: center; 
            text-decoration: none; 
            color: #3b82f6; 
            font-weight: bold; 
            margin-bottom: 15px; 
            padding: 10px 18px; 
            background: #eff6ff; 
            border-radius: 10px; 
            transition: 0.2s; 
        } 
        #nav-back:active { background: #dbeafe; }
        
        /* 1. å•æŒ‡æ•²å‡» UI */
        #tap-pad { 
            width: 100%; 
            height: 280px; 
            background: #e2e8f0; 
            border: 4px dashed #94a3b8; 
            border-radius: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 50px; 
            font-weight: bold; 
            color: #334155; 
            margin: 20px 0; 
            transition: background 0.05s; 
            touch-action: none; 
        }
        #tap-pad:active { background: #cbd5e1; border-color: #64748b; }
        
        /* 2. Fitts é¶å‘ UI */
        #fitts-workspace { 
            width: 100%; 
            height: 400px; 
            background: #f1f5f9; 
            position: relative; 
            overflow: hidden; 
            border-radius: 16px; 
            border: 2px solid #cbd5e1; 
            touch-action: none; 
        }
        .target { 
            position: absolute; 
            background: #ef4444; 
            border-radius: 50%; 
            transform: translate(-50%, -50%); 
            cursor: pointer; 
            z-index: 10; 
            transition: background 0.1s, box-shadow 0.1s; 
        } 
        .target.active { background: #10b981; box-shadow: 0 0 20px rgba(16,185,129,0.6); } 
        .target:active { transform: translate(-50%, -50%) scale(0.9); }
        
        /* 3. Spiral Canvas UI */
        canvas { 
            border: 2px solid #cbd5e1; 
            background: #fff; 
            cursor: crosshair; 
            touch-action: none; 
            border-radius: 16px; 
            display: block; 
            margin: 0 auto; 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.03); 
            width: 400px; 
            height: 400px; 
        }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div style="text-align: left; max-width: 750px; margin: 0 auto;">
        <a href="index.html" id="nav-back">â† è¿”å›æ§åˆ¶å°</a>
    </div>
    
    <div class="container" id="menu">
        <h2 class="module-header">ğŸ¯ è¿åŠ¨ç¥ç»ä¸å…±æµç‰¹å¾</h2>
        <button class="sys-btn" onclick="show('tap-area'); startTapping();">1. å•æŒ‡å¿«é€Ÿæ•²å‡» (è¿åŠ¨è¿Ÿç¼“/ç–²åŠ³åº¦)</button>
        <button class="sys-btn" onclick="show('fitts-area'); startFitts();">2. Fitts äº¤æ›¿é¶å‘ (å°è„‘åè°ƒæ€§)</button>
        <button class="sys-btn" style="background:#3b82f6;" onclick="show('spiral-area'); startSpiral();">3. èºæ—‹çº¿ææ‘¹ (å¾®å†™ç—‡ä¸éœ‡é¢¤åˆ†æ)</button>
    </div>

    <div class="container hidden" id="tap-area">
        <h2 class="module-header">å•æŒ‡å¿«é€Ÿæ•²å‡»</h2>
        <p style="color:#ef4444; font-weight:bold; font-size:22px;" id="tap-timer">å‰©ä½™: 10.0 s</p>
        <p style="color:#64748b;">ä½¿ç”¨æƒ¯ç”¨æ‰‹é£ŸæŒ‡ï¼Œä»¥æœ€å¿«é€Ÿåº¦ç‚¹å‡»ä¸‹æ–¹åŒºåŸŸã€‚</p>
        <div id="tap-pad">TAP</div>
        <button class="sys-btn" style="background:#94a3b8;" onclick="show('menu')">æå‰ç»“æŸ</button>
    </div>

    <div class="container hidden" id="fitts-area">
        <h2 class="module-header">Fitts äº¤æ›¿é¶å‘</h2>
        <p style="color:#64748b;">å¿«é€Ÿäº¤æ›¿ç‚¹å‡»<strong>äº®èµ·ç»¿è‰²</strong>çš„åœ†åœˆã€‚</p>
        <div id="fitts-workspace"></div>
        <button class="sys-btn" style="background:#94a3b8; margin-top:20px;" onclick="show('menu')">å¼ºè¡Œç»ˆæ­¢</button>
    </div>

    <div class="container hidden" id="spiral-area" style="text-align:center;">
        <h2 class="module-header">èºæ—‹çº¿éœ‡é¢¤åˆ†æ</h2>
        <p style="color:#64748b; margin-bottom:20px;">è¯·ç”¨é£ŸæŒ‡å°½å¯èƒ½å¹³ç¨³åœ°æ²¿è™šçº¿ä»å†…å‘å¤–ææ‘¹ã€‚</p>
        <canvas id="spiral-canvas" width="800" height="800" style="width: 400px; height: 400px;"></canvas>
        <button class="sys-btn" style="background:#10b981; margin-top:25px;" onclick="saveSpiral()">âœ“ å®Œæˆææ‘¹å¹¶ä¿å­˜åºåˆ—</button>
    </div>

    <script>
        // è§†å›¾è·¯ç”±
        function show(id) { 
            ['menu', 'tap-area', 'fitts-area', 'spiral-area'].forEach(d => {
                document.getElementById(d).classList.add('hidden');
            }); 
            document.getElementById(id).classList.remove('hidden'); 
        }

        /* ==================== 1. Tapping (å•æŒ‡æ•²å‡») é€»è¾‘ ==================== */
        let tData = { module: "Motor_SimpleTapping", total_taps: 0, timestamps: [] };
        let tCount = 0, tTime = 10, tTesting = false, tTimerId; 
        const tapPad = document.getElementById('tap-pad');
        
        // ç»‘å®šè§¦æ‘¸ä¸é¼ æ ‡ç‚¹å‡»äº‹ä»¶ (å…¼å®¹å¤šç«¯)
        tapPad.ontouchstart = tapPad.onmousedown = (e) => { 
            e.preventDefault(); 
            if (tTime <= 0) return; 
            
            // é¦–æ¬¡ç‚¹å‡»æ¿€æ´»å®šæ—¶å™¨
            if (!tTesting) { 
                tTesting = true; 
                tTimerId = setInterval(updateTapTimer, 100); 
            } 
            
            tCount++; 
            // è®°å½•æ¯æ¬¡æ•²å‡»çš„æ¯«ç§’çº§ç›¸å¯¹æ—¶é—´æˆ³
            tData.timestamps.push(Math.round(performance.now())); 
            tapPad.innerText = tCount; 
        };

        function startTapping() { 
            tCount = 0; 
            tTime = 10; 
            tTesting = false; 
            tapPad.innerText = "TAP"; 
            document.getElementById('tap-timer').innerText = "å‰©ä½™: 10.0 s"; 
            tData.timestamps = []; 
        }

        function updateTapTimer() { 
            tTime -= 0.1; 
            document.getElementById('tap-timer').innerText = `å‰©ä½™: ${tTime.toFixed(1)} s`; 
            
            if (tTime <= 0.05) { 
                clearInterval(tTimerId); 
                tapPad.innerText = "DONE"; 
                tData.total_taps = tCount; 
                CAS_Storage.saveModuleData('Motor_SimpleTapping', tData); 
                alert(`æµ‹è¯•å®Œæ¯•ã€‚å…±æ•²å‡» ${tCount} æ¬¡ã€‚`); 
                show('menu'); 
            } 
        }

        /* ==================== 2. Fitts (äº¤æ›¿é¶å‘) é€»è¾‘ ==================== */
        let fData = { module: "Motor_Fitts", records: [] };
        let f_tr = 0, f_lastT = 0;
        let ws = document.getElementById('fitts-workspace');

        function startFitts() { 
            f_tr = 0; 
            fData.records = []; 
            nextFitts(); 
        }

        function nextFitts() { 
            if(f_tr >= 10) { 
                CAS_Storage.saveModuleData('Motor_Fitts', fData); 
                alert("Fitts è¿åŠ¨æ—¶ç©ºç‰¹å¾æ•æ‰å®Œæ¯•"); 
                show('menu'); 
                return; 
            } 
            
            ws.innerHTML = ''; 
            // éšæœºç”Ÿæˆç›®æ ‡ç›´å¾„ (40px åˆ° 90px ä¹‹é—´)
            let size = Math.random() * 50 + 40; 
            
            // åˆ›å»ºå·¦å³ä¸¤ä¸ªé¶ç‚¹
            let t1 = document.createElement('div'); 
            t1.className = 'target active'; 
            t1.style.width = t1.style.height = size + 'px'; 
            t1.style.left = '20%'; 
            t1.style.top = '50%'; 
            
            let t2 = document.createElement('div'); 
            t2.className = 'target'; 
            t2.style.width = t2.style.height = size + 'px'; 
            t2.style.left = '80%'; 
            t2.style.top = '50%'; 
            
            // äº¤äº’é€»è¾‘ï¼šç‚¹ç»¿çš„å˜çº¢ï¼Œçº¢çš„å˜ç»¿
            t1.ontouchstart = t1.onmousedown = (e) => { 
                e.preventDefault(); 
                if(f_tr > 0) fData.records.push({ mt_ms: Math.round(performance.now() - f_lastT) }); 
                f_lastT = performance.now(); 
                t1.classList.remove('active'); 
                t2.classList.add('active'); 
            }; 
            
            t2.ontouchstart = t2.onmousedown = (e) => { 
                e.preventDefault(); 
                fData.records.push({ mt_ms: Math.round(performance.now() - f_lastT) }); 
                f_lastT = performance.now(); 
                f_tr++; 
                nextFitts(); 
            }; 
            
            ws.appendChild(t1); 
            ws.appendChild(t2); 
            f_lastT = performance.now(); 
        }

        /* ==================== 3. Spiral (èºæ—‹çº¿ææ‘¹) é€»è¾‘ ==================== */
        const cvs = document.getElementById('spiral-canvas');
        const ctx = cvs.getContext('2d'); 
        ctx.scale(2, 2); // é€‚é… Retina é«˜åˆ†å± (800x800 ç”»å¸ƒç¼©æ”¾åˆ° 400x400 å®¹å™¨)
        
        let drawing = false;
        let spiralData = { module: "Motor_Spiral_Tracing", trajectory: [] };

        function startSpiral() { 
            spiralData.trajectory = []; 
            ctx.clearRect(0, 0, 400, 400); 
            drawTemplate(); 
        }

        function drawTemplate() { 
            ctx.beginPath(); 
            ctx.strokeStyle = "#e2e8f0"; 
            ctx.lineWidth = 15; 
            ctx.lineCap = "round"; 
            
            // ç»˜åˆ¶é˜¿åŸºç±³å¾·èºæ—‹çº¿æ¨¡æ¿
            for(let i = 0; i < 150; i++) { 
                let a = 0.1 * i; 
                let x = 200 + (1 + a) * 10 * Math.cos(a);
                let y = 200 + (1 + a) * 10 * Math.sin(a); 
                ctx.lineTo(x, y); 
            } 
            ctx.stroke(); 
        }

        // è·å–é¼ æ ‡æˆ–è§¦æ‘¸ç‚¹çš„ç›¸å¯¹åæ ‡
        function getPos(e) { 
            let r = cvs.getBoundingClientRect(); 
            let ev = e.touches ? e.touches[0] : e; 
            return { x: ev.clientX - r.left, y: ev.clientY - r.top }; 
        }

        // ç›‘å¬ç»˜åˆ¶äº‹ä»¶
        cvs.onmousedown = cvs.ontouchstart = (e) => { 
            e.preventDefault(); 
            drawing = true; 
            ctx.beginPath(); 
            ctx.strokeStyle = "#0f172a"; 
            ctx.lineWidth = 4; 
            ctx.lineCap = "round"; 
            
            let p = getPos(e); 
            ctx.moveTo(p.x, p.y); 
            spiralData.trajectory.push({x: Math.round(p.x), y: Math.round(p.y), t: Math.round(performance.now())}); 
        };
        
        cvs.onmousemove = cvs.ontouchmove = (e) => { 
            e.preventDefault(); 
            if(!drawing) return; 
            
            let p = getPos(e); 
            ctx.lineTo(p.x, p.y); 
            ctx.stroke(); 
            spiralData.trajectory.push({x: Math.round(p.x), y: Math.round(p.y), t: Math.round(performance.now())}); 
        };
        
        cvs.onmouseup = cvs.ontouchend = () => { drawing = false; };

        function saveSpiral() { 
            CAS_Storage.saveModuleData('Motor_Spiral_Tracing', spiralData); 
            alert("èºæ—‹çº¿æ—¶ç©ºåæ ‡åºåˆ—å·²å­˜å…¥æ•°æ®åº“ã€‚"); 
            show('menu'); 
        }
    </script>
</body>
</html>
