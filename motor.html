<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>运动学表型测试</title>
    <style>
        body { font-family: sans-serif; background: #f8fafc; margin: 0; padding: 20px; touch-action: none; user-select: none; }
        .container { max-width: 700px; margin: 20px auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .sys-btn { background: #0f172a; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; margin: 10px; }
        .hidden { display: none !important; }
        /* Fitts */
        #fitts-workspace { width: 100%; height: 300px; background: #e2e8f0; position: relative; overflow: hidden; border-radius: 12px; }
        .target { position: absolute; background: #ef4444; border-radius: 50%; transform: translate(-50%, -50%); }
        .target.active { background: #22c55e; }
        /* Spiral */
        canvas { border: 2px solid #cbd5e1; background: #fff; cursor: crosshair; touch-action: none; border-radius: 12px; }
        #nav-back { display: block; text-decoration: none; color: #3b82f6; font-weight: bold; margin-bottom: 10px; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <a href="index.html" id="nav-back">← 返回主控台</a>
    <div class="container" id="menu">
        <h2>精细运动组合</h2>
        <button class="sys-btn" onclick="startFitts()">1. Fitts 靶向运动 (运动迟缓)</button>
        <button class="sys-btn" onclick="startSpiral()">2. 螺旋线描摹 (震颤追踪)</button>
    </div>

    <div class="container hidden" id="fitts-area">
        <h3>点击绿色的圆</h3>
        <div id="fitts-workspace"></div>
        <p id="fitts-status"></p>
        <button class="sys-btn" onclick="endFitts()">返回菜单</button>
    </div>

    <div class="container hidden" id="spiral-area" style="text-align: center;">
        <h3>请用食指尽可能平稳地描摹螺旋线</h3>
        <canvas id="spiral-canvas" width="400" height="400"></canvas>
        <br>
        <button class="sys-btn" style="background:#10b981;" onclick="saveSpiral()">完成并保存坐标序列</button>
        <button class="sys-btn" onclick="document.getElementById('spiral-area').classList.add('hidden'); document.getElementById('menu').classList.remove('hidden');">返回菜单</button>
    </div>

    <script>
        // --- Fitts ---
        let fData = { module: "Motor_Fitts", records: [] }, f_tr=0, lastT=0, ws = document.getElementById('fitts-workspace');
        function startFitts() { document.getElementById('menu').classList.add('hidden'); document.getElementById('fitts-area').classList.remove('hidden'); f_tr=0; fData.records=[]; nextFitts(); }
        function nextFitts() {
            if(f_tr>=10) { CAS_Storage.saveModuleData('Motor_Fitts', fData); document.getElementById('fitts-status').innerText="Fitts已保存"; return; }
            ws.innerHTML=''; let size = Math.random()*30+30;
            let t1 = document.createElement('div'); t1.className='target active'; t1.style.width=t1.style.height=size+'px'; t1.style.left='20%'; t1.style.top='50%';
            let t2 = document.createElement('div'); t2.className='target'; t2.style.width=t2.style.height=size+'px'; t2.style.left='80%'; t2.style.top='50%';
            t1.ontouchstart = t1.onmousedown = (e)=>{ e.preventDefault(); let t=performance.now()-lastT; if(f_tr>0) fData.records.push({mt:Math.round(t)}); lastT=performance.now(); t1.classList.remove('active'); t2.classList.add('active'); };
            t2.ontouchstart = t2.onmousedown = (e)=>{ e.preventDefault(); let t=performance.now()-lastT; fData.records.push({mt:Math.round(t)}); lastT=performance.now(); f_tr++; nextFitts(); };
            ws.appendChild(t1); ws.appendChild(t2); lastT=performance.now();
        }
        function endFitts() { document.getElementById('fitts-area').classList.add('hidden'); document.getElementById('menu').classList.remove('hidden'); }

        // --- Spiral ---
        const cvs = document.getElementById('spiral-canvas'), ctx = cvs.getContext('2d');
        let drawing = false, spiralData = { module: "Motor_Spiral", trajectory: [] };
        
        function drawTemplate() {
            ctx.clearRect(0,0,400,400); ctx.beginPath(); ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 15;
            for(let i=0; i<150; i++) { let angle = 0.1 * i; let x = 200 + (1 + angle)*10 * Math.cos(angle); let y = 200 + (1 + angle)*10 * Math.sin(angle); ctx.lineTo(x, y); }
            ctx.stroke();
        }
        function startSpiral() { document.getElementById('menu').classList.add('hidden'); document.getElementById('spiral-area').classList.remove('hidden'); spiralData.trajectory=[]; drawTemplate(); }
        
        function getPos(e) { let r = cvs.getBoundingClientRect(); let ev = e.touches ? e.touches[0] : e; return { x: ev.clientX - r.left, y: ev.clientY - r.top }; }
        cvs.onmousedown = cvs.ontouchstart = (e) => { e.preventDefault(); drawing = true; ctx.beginPath(); ctx.strokeStyle = "#0f172a"; ctx.lineWidth = 4; let p = getPos(e); ctx.moveTo(p.x, p.y); spiralData.trajectory.push({x: Math.round(p.x), y: Math.round(p.y), t: Math.round(performance.now())}); };
        cvs.onmousemove = cvs.ontouchmove = (e) => { e.preventDefault(); if(!drawing) return; let p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); spiralData.trajectory.push({x: Math.round(p.x), y: Math.round(p.y), t: Math.round(performance.now())}); };
        cvs.onmouseup = cvs.ontouchend = () => drawing = false;

        function saveSpiral() { CAS_Storage.saveModuleData('Motor_Spiral_Tracing', spiralData); alert("螺旋线时空序列已保存"); }
    </script>
</body>
</html>
