<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>运动 - 菲茨交替点击</title>
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; background: #f8fafc; touch-action: none; user-select: none; }
        #workspace { width: 100%; height: 60vh; background: white; border: 2px solid #cbd5e1; border-radius: 12px; position: relative; overflow: hidden; margin-top: 20px; }
        .target { position: absolute; background: #ef4444; border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer; }
        .target.active { background: #22c55e; box-shadow: 0 0 15px rgba(34,197,94,0.5); z-index: 10;}
        #nav-back { text-decoration: none; color: #3b82f6; font-weight: bold; }
        .sys-btn { background: #0f172a; color: white; border: none; padding: 10px 20px; font-size: 16px; border-radius: 8px; cursor: pointer; margin-left: 20px; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div style="display: flex; align-items: center;">
        <a href="index.html" id="nav-back">← 返回</a>
        <button class="sys-btn" id="start-btn" onclick="startFitts()">开始运动学采集</button>
        <span id="counter" style="margin-left:20px; font-weight:bold; font-size:18px;">剩余: 10 次</span>
    </div>
    <div id="workspace"></div>

    <script>
        const workspace = document.getElementById('workspace');
        let trials = 10, current = 0;
        let lastClickTime = 0;
        let aiData = { module: "Motor_Fitts_Kinematics", records: [] };

        // 预设坐标对 (模拟不同难度指数 ID)
        const targetPairs = [
            { x1: 20, y1: 50, x2: 80, y2: 50, size: 60 },
            { x1: 10, y1: 20, x2: 90, y2: 80, size: 40 },
            { x1: 50, y1: 10, x2: 50, y2: 90, size: 30 }
        ];

        let t1, t2;
        let activeTarget = 1;

        function startFitts() {
            document.getElementById('start-btn').style.display = 'none';
            current = 0; nextPair();
        }

        function nextPair() {
            if (current >= trials) return finishTest();
            workspace.innerHTML = '';
            let pair = targetPairs[current % targetPairs.length];
            
            t1 = createTarget(pair.x1, pair.y1, pair.size, 1);
            t2 = createTarget(pair.x2, pair.y2, pair.size, 2);
            
            workspace.appendChild(t1);
            workspace.appendChild(t2);
            
            activeTarget = 1;
            t1.classList.add('active');
            document.getElementById('counter').innerText = `剩余: ${trials - current} 次`;
            lastClickTime = performance.now();
        }

        function createTarget(x_pct, y_pct, size, id) {
            let el = document.createElement('div');
            el.className = 'target';
            el.style.width = size + 'px'; el.style.height = size + 'px';
            el.style.left = x_pct + '%'; el.style.top = y_pct + '%';
            
            // 绑定触控与鼠标
            el.onmousedown = (e) => handleHit(id, e.clientX, e.clientY);
            el.ontouchstart = (e) => { e.preventDefault(); handleHit(id, e.touches[0].clientX, e.touches[0].clientY); };
            return el;
        }

        function handleHit(id, hitX, hitY) {
            if (id !== activeTarget) return; // 点错目标无效
            
            let timeTaken = performance.now() - lastClickTime;
            let pair = targetPairs[current % targetPairs.length];
            
            // 计算屏幕实际坐标与距离 (用于严格计算 Fitts定律特征)
            let rect1 = t1.getBoundingClientRect();
            let rect2 = t2.getBoundingClientRect();
            let dist = Math.hypot(rect1.left - rect2.left, rect1.top - rect2.top);

            if (current > 0) { // 忽略第一次初始化的点击
                aiData.records.push({
                    trial: current,
                    target_width_px: pair.size,
                    amplitude_distance_px: parseFloat(dist.toFixed(2)),
                    movement_time_ms: parseFloat(timeTaken.toFixed(2)),
                    hit_x: parseFloat(hitX.toFixed(2)),
                    hit_y: parseFloat(hitY.toFixed(2))
                });
            }

            lastClickTime = performance.now();
            t1.classList.toggle('active');
            t2.classList.toggle('active');
            activeTarget = activeTarget === 1 ? 2 : 1;
            
            if(id === 2) { current++; nextPair(); } // 每来回一次算一个 trial
        }

        function finishTest() {
            workspace.innerHTML = '<div style="padding:40px;text-align:center;font-size:24px;">运动学特征采集完成。</div>';
            CAS_Storage.saveModuleData('Motor_Fitts_Kinematics', aiData);
        }
    </script>
</body>
</html>
