<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-MOT | é”¥ä½“å¤–ç³»ä¸ç²¾ç»†è¿åŠ¨è¯„ä¼° (ç§‘ç ”å®Œå…¨ä½“ v4.0)</title>
    <style>
        :root { --primary: #1e293b; --blue: #4f46e5; --orange: #f59e0b; --amber: #fbbf24; --red: #f43f5e; --green: #10b981; --slate: #64748b; --bg: #fcfcfd; }
        /* å½»åº•é˜»æ–­è§¦æ§è®¾å¤‡çš„é»˜è®¤æ‰‹åŠ¿ï¼Œä¿è¯æ•²å‡»æµ‹è¯•çš„çº¯å‡€åº¦ */
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); touch-action: none; overscroll-behavior: none; user-select: none; -webkit-user-select: none; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--orange); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .sys-btn { width: 100%; padding: 20px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 18px; transition: 0.2s; display: flex; align-items: center; gap: 12px; }
        .btn-menu { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
        .btn-menu:hover { background: var(--orange); color: white; transform: translateX(5px); }

        /* AFT äº¤æ›¿æ•²å‡»æµ‹è¯•ä¸“å± UI */
        .timer-board { font-size: 40px; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 20px; font-family: monospace; }
        .tap-workspace { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 30px; height: 300px;}
        .tap-btn { flex: 1; border-radius: 24px; border: 4px solid var(--slate); background: #f8fafc; font-size: 24px; font-weight: bold; color: var(--slate); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.1s; box-shadow: 0 10px 0 #cbd5e1; touch-action: manipulation; }
        .tap-btn:active, .tap-btn.active-sim { transform: translateY(10px); box-shadow: 0 0 0 #cbd5e1; background: #fef3c7; border-color: var(--orange); color: var(--orange); }

        /* SRT ç®€å•ååº”æ—¶ä¸“å± UI */
        .srt-workspace { width: 100%; height: 350px; border-radius: 24px; background: #f8fafc; border: 4px dashed #cbd5e1; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.1s; position: relative; }
        .srt-workspace.waiting { background: var(--red); border-color: #be123c; }
        .srt-workspace.go { background: var(--green); border-color: #047857; }
        .srt-text { font-size: 32px; font-weight: bold; color: var(--primary); pointer-events: none;}
        .srt-workspace.waiting .srt-text, .srt-workspace.go .srt-text { color: white; }

        .trial-counter { position: absolute; top: 20px; right: 20px; font-size: 14px; color: var(--slate); font-weight: bold; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--orange); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ¯ è¿åŠ¨å…±æµä¸é”¥ä½“å¤–ç³»ç½‘ç»œ (Clinical V4.0)</h2>
            <p>åŸºäºå¾®è§‚åŠ¨åŠ›å­¦æå–ï¼Œé¶å‘åŸºåº•èŠ‚å¤šå·´èƒºèƒ½è¡°é€€å¼•èµ·çš„è¿åŠ¨è¿Ÿç¼“ã€åƒµç›´ä¸æ˜“ç–²åŠ³æ€§ã€‚</p>
        </div>
        <button class="sys-btn btn-menu" onclick="startAFT()">ğŸ‘‡ 1. AFT äº¤æ›¿æ‰‹æŒ‡æ•²å‡» (15ç§’é«˜é¢‘è´Ÿè·)</button>
        <button class="sys-btn btn-menu" onclick="startSRT()">âš¡ 2. SRT ç®€å•ååº”æ—¶ (å‰¥ç¦»è®¤çŸ¥è´Ÿè·çš„çº¯è¿åŠ¨èµ·åŠ¨)</button>
    </div>

    <div class="container hidden" id="aft-area">
        <div class="module-header">
            <h2>äº¤æ›¿æ‰‹æŒ‡æ•²å‡» (AFT - 15ç§’)</h2>
            <p>è¯·å°†è®¾å¤‡å¹³æ”¾ã€‚ä½¿ç”¨æ‚¨çš„é£ŸæŒ‡å’Œä¸­æŒ‡ï¼Œå°½å¯èƒ½å¿«åœ°<strong>äº¤æ›¿ç‚¹å‡»</strong>ä¸‹æ–¹ä¸¤ä¸ªæŒ‰é’®ã€‚åŒä¾§è¿å‡»æ— æ•ˆã€‚</p>
        </div>
        <div class="timer-board" id="aft-timer">15.0 s</div>
        
        <div class="tap-workspace">
            <div class="tap-btn" id="btn-left">å·¦ (é£ŸæŒ‡)</div>
            <div class="tap-btn" id="btn-right">å³ (ä¸­æŒ‡)</div>
        </div>
        <button class="sys-btn" id="btn-aft-start" onclick="initAFT()" style="background:var(--primary); color:white; justify-content:center;">å¼€å§‹æµ‹è¯•</button>
    </div>

    <div class="container hidden" id="srt-area">
        <div class="module-header">
            <h2>ç®€å•è¿åŠ¨ååº”æ—¶ (SRT - 10è¯•æ¬¡)</h2>
            <p>è¯·å°†æ‰‹æŒ‡æ‚¬åœåœ¨å±å¹•ä¸Šæ–¹ã€‚å½“å±å¹•å˜æˆ<strong>ç»¿è‰²</strong>æ—¶ï¼Œè¯·ä»¥æœ€å¿«é€Ÿåº¦ç‚¹å‡»å±å¹•ä»»ä½•ä½ç½®ã€‚æå‰æŠ¢ç­”å°†è¢«è®°å½•ã€‚</p>
        </div>
        
        <div class="srt-workspace" id="srt-box">
            <div class="trial-counter" id="srt-counter"></div>
            <div class="srt-text" id="srt-msg">ç‚¹å‡»æ­¤å¤„å¼€å§‹</div>
        </div>
    </div>

    <script>
        function show(id) {
            ['menu', 'aft-area', 'srt-area'].forEach(d => document.getElementById(d).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        /* ===================================================================== */
        /* 1. AFT é€»è¾‘ï¼šè¿½è¸ªæ¯ä¸€æ¬¡åˆæ³•äº¤æ›¿æ•²å‡»çš„æ¯«ç§’çº§æ—¶é—´æˆ³ï¼Œè®¡ç®—å˜å¼‚ç³»æ•°ä¸ç–²åŠ³æŒ‡æ•°
        /* ===================================================================== */
        let aftData = { module: "MOT_AFT", timestamps: [], summary: {} };
        let aftTimeLeft = 15.0;
        let aftInterval = null;
        let aftActive = false;
        let lastTapSide = null; // è®°å½•ä¸Šä¸€ä¾§ï¼Œå¼ºåˆ¶è¦æ±‚äº¤æ›¿ (0=å·¦, 1=å³)
        let tapOnset = 0;

        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');

        function initAFT() {
            aftData.timestamps = [];
            aftTimeLeft = 15.0;
            lastTapSide = null;
            document.getElementById('aft-timer').innerText = "15.0 s";
            document.getElementById('aft-timer').style.color = "var(--primary)";
            
            document.getElementById('btn-aft-start').style.display = 'none';
            aftActive = true;
            tapOnset = performance.now();

            aftInterval = setInterval(() => {
                aftTimeLeft -= 0.1;
                document.getElementById('aft-timer').innerText = aftTimeLeft.toFixed(1) + ' s';
                
                if (aftTimeLeft <= 0) {
                    endAFT();
                }
            }, 100);
        }

        function recordTap(side) {
            if (!aftActive) return;
            // æ ¸å¿ƒæœºåˆ¶ï¼šå¼ºåˆ¶äº¤æ›¿ã€‚å¦‚æœè¿ç»­æ•²å‡»åŒä¸€ä¾§ï¼Œä¸è®¡å…¥æœ‰æ•ˆæ—¶é—´æˆ³
            if (side === lastTapSide) return; 

            const t = performance.now() - tapOnset;
            aftData.timestamps.push(t);
            lastTapSide = side;

            // è§†è§‰åé¦ˆåŠ¨æ•ˆ
            const targetBtn = side === 0 ? btnLeft : btnRight;
            targetBtn.classList.add('active-sim');
            setTimeout(() => targetBtn.classList.remove('active-sim'), 50);
        }

        // Pointer äº‹ä»¶æ— è§†æµè§ˆå™¨çš„ 300ms è§¦æ‘¸å»¶è¿Ÿ
        btnLeft.addEventListener('pointerdown', (e) => { e.preventDefault(); recordTap(0); });
        btnRight.addEventListener('pointerdown', (e) => { e.preventDefault(); recordTap(1); });

        function endAFT() {
            clearInterval(aftInterval);
            aftActive = false;
            document.getElementById('aft-timer').innerText = "æ—¶é—´åˆ°ï¼";
            document.getElementById('aft-timer').style.color = "var(--red)";

            const n = aftData.timestamps.length;
            if (n < 5) {
                alert("æœ‰æ•ˆæ•²å‡»æ¬¡æ•°è¿‡å°‘ï¼Œæµ‹è¯•æ•°æ®æ— æ•ˆã€‚è¯·é‡è¯•å¹¶ç¡®ä¿äº¤æ›¿æ•²å‡»ã€‚");
                document.getElementById('btn-aft-start').style.display = 'flex';
                document.getElementById('btn-aft-start').innerText = "é‡æ–°æµ‹è¯•";
                return;
            }

            // è®¡ç®—æŒ‡æ ‡
            let itis = [];
            for (let i = 1; i < n; i++) itis.push(aftData.timestamps[i] - aftData.timestamps[i-1]);
            
            const meanITI = itis.reduce((a,b)=>a+b,0) / itis.length;
            const variance = itis.reduce((a,b)=>a+Math.pow(b-meanITI, 2), 0) / itis.length;
            const cv = (Math.sqrt(variance) / meanITI) * 100; // æ•²å‡»èŠ‚å¾‹çš„å˜å¼‚ç³»æ•°

            // ç–²åŠ³æŒ‡æ•°ï¼šå‰ 5 ç§’çš„é¢‘ç‡ vs å 5 ç§’çš„é¢‘ç‡
            const first5sCount = aftData.timestamps.filter(t => t <= 5000).length;
            const last5sCount = aftData.timestamps.filter(t => t >= 10000).length;
            const fatigueIndex = first5sCount > 0 ? ((first5sCount - last5sCount) / first5sCount) * 100 : 0;

            aftData.summary = {
                total_taps: n,
                mean_iti_ms: Math.round(meanITI),
                iti_cv_percent: parseFloat(cv.toFixed(2)),
                fatigue_index_percent: parseFloat(fatigueIndex.toFixed(2)) // è´Ÿæ•°ä»£è¡¨åæœŸåŠ é€Ÿï¼Œæ­£æ•°ä»£è¡¨åæœŸè¡°é€€
            };

            CAS_Storage.saveModuleData('MOT_AFT', aftData);
            alert(`âœ… AFT ä¸´åºŠåŠ¨åŠ›å­¦å·²å…¥åº“ï¼\n\n- äº¤æ›¿æ€»æ¬¡æ•°: ${n} æ¬¡\n- å¹³å‡æ•²å‡»é—´éš” (ITI): ${Math.round(meanITI)} ms\n- èŠ‚å¾‹å˜å¼‚ç³»æ•° (CV): ${cv.toFixed(1)}%\n- è¿åŠ¨ç–²åŠ³è¡°å‡æŒ‡æ•°: ${fatigueIndex.toFixed(1)}%\n\n*ä¸´åºŠæç¤ºï¼šCVå¼‚å¸¸å¢é«˜æç¤ºèŠ‚å¾‹å¤±è°ƒ(å¦‚å°è„‘æˆ–åŸºåº•èŠ‚ç—…å˜)ï¼›é«˜ç–²åŠ³æŒ‡æ•°æç¤ºå…¸å‹çš„å¸•é‡‘æ£®â€œå‰‚æœ«ç°è±¡â€æˆ–è¿åŠ¨è¡°å‡ã€‚`);
            show('menu');
        }

        /* ===================================================================== */
        /* 2. SRT é€»è¾‘ï¼šå‰¥ç¦»é€‰æ‹©è´Ÿè·çš„çº¯è¿åŠ¨èµ·åŠ¨æµ‹éªŒ (å«æŠ¢ç­”æƒ©ç½š)
        /* ===================================================================== */
        const TOTAL_SRT_TRIALS = 10;
        let srtData = { module: "MOT_SRT", records: [], summary: {} };
        let srtTrial = 0;
        let srtState = 'init'; // init -> waiting -> go -> done
        let srtTimeout = null;
        let srtOnset = 0;

        const srtBox = document.getElementById('srt-box');
        const srtMsg = document.getElementById('srt-msg');

        function startSRT() {
            srtData.records = [];
            srtTrial = 0;
            srtState = 'init';
            srtMsg.innerText = "ç‚¹å‡»æ­¤å¤„å¼€å§‹";
            srtBox.className = 'srt-workspace';
            document.getElementById('srt-counter').innerText = "";
            show('srt-area');
        }

        srtBox.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            if (srtState === 'init') {
                runSRTTrial();
            } else if (srtState === 'waiting') {
                // æŠ¢ç­”æƒ©ç½š (False Start)
                clearTimeout(srtTimeout);
                srtData.records.push({ type: 'false_start', rt: null });
                srtBox.className = 'srt-workspace';
                srtMsg.innerText = "âš ï¸ æŠ¢ç­”äº†ï¼\nè¯·ç­‰å±å¹•å˜ç»¿å†ç‚¹ã€‚\n(ç‚¹å‡»ç»§ç»­)";
                srtState = 'init';
            } else if (srtState === 'go') {
                // åˆæ³•ååº”
                const rt = performance.now() - srtOnset;
                srtData.records.push({ type: 'valid', rt: Math.round(rt) });
                srtTrial++;
                
                srtBox.className = 'srt-workspace';
                srtMsg.innerText = `${Math.round(rt)} ms`;
                srtState = 'done';
                
                setTimeout(() => {
                    if (srtTrial >= TOTAL_SRT_TRIALS) finishSRT();
                    else runSRTTrial();
                }, 1000);
            }
        });

        function runSRTTrial() {
            srtState = 'waiting';
            srtBox.className = 'srt-workspace waiting';
            srtMsg.innerText = "å‡†å¤‡...";
            document.getElementById('srt-counter').innerText = `è¿›åº¦: ${srtTrial + 1} / ${TOTAL_SRT_TRIALS}`;

            // éšæœºç­‰å¾… 2000ms åˆ° 5000msï¼Œé˜²æ­¢å—è¯•è€…å»ºç«‹æ—¶é—´èŠ‚å¾‹é¢„æœŸ
            const delay = 2000 + Math.random() * 3000;
            srtTimeout = setTimeout(() => {
                srtState = 'go';
                srtBox.className = 'srt-workspace go';
                srtMsg.innerText = "ç‚¹ï¼";
                srtOnset = performance.now();
            }, delay);
        }

        function finishSRT() {
            const validRecords = srtData.records.filter(r => r.type === 'valid');
            const falseStarts = srtData.records.filter(r => r.type === 'false_start').length;
            
            const rts = validRecords.map(r => r.rt);
            const meanRT = rts.length > 0 ? rts.reduce((a,b)=>a+b,0) / rts.length : 0;

            srtData.summary = {
                mean_rt_ms: Math.round(meanRT),
                false_starts: falseStarts
            };
            
            CAS_Storage.saveModuleData('MOT_SRT', srtData);
            alert(`âœ… SRT ç®€å•è¿åŠ¨ååº”å®Œæˆï¼\n\n- å¹³å‡ååº”æ—¶: ${Math.round(meanRT)} ms\n- æŠ¢ç­”æ¬¡æ•°: ${falseStarts} æ¬¡`);
            show('menu');
        }
    </script>
</body>
</html>
