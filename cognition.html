<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-COG | å…¨ç»´åº¦è®¤çŸ¥åŠŸèƒ½è¯„ä¼°</title>
    <style>
        /* ==================== 1. å…¨å±€ä¸ä¸»é¢˜å˜é‡ (Theme & Global Variables) ==================== */
        :root { 
            --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; 
            --green: #10b981; --red: #f43f5e; --amber: #f59e0b; --slate: #64748b; 
        }
        /* ç¦ç”¨åŒå‡»ç¼©æ”¾å’Œæ–‡å­—é€‰ä¸­ï¼Œé˜²æ­¢å—è¯•è€…åœ¨å¿«é€Ÿç‚¹å‡»æ—¶è§¦å‘æµè§ˆå™¨é»˜è®¤è¡Œä¸º */
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; touch-action: manipulation; user-select: none; }
        .container { max-width: 750px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; } /* æ ¸å¿ƒè·¯ç”±ç±»ï¼šç”¨äºåˆ‡æ¢ä¸åŒæµ‹è¯•é¢æ¿çš„æ˜¾ç¤º/éšè— */
        
        /* ==================== 2. é€šç”¨ç»„ä»¶æ ·å¼ (Common Components) ==================== */
        .module-header { border-left: 6px solid var(--blue); padding-left: 15px; margin-bottom: 30px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; }

        /* èœå•æŒ‰é’®æ ·å¼ */
        .sys-btn { width: 100%; padding: 18px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 15px; transition: 0.2s; display: flex; align-items: center; justify-content: flex-start; gap: 12px; }
        .btn-menu { background: var(--light-blue); color: var(--blue); border: 1px solid #e0e7ff; }
        .btn-menu:hover { background: var(--blue); color: white; transform: translateX(5px); box-shadow: 0 8px 15px rgba(79, 70, 229, 0.15); }
        .btn-action { background: var(--blue); color: white; justify-content: center; margin-top: 20px; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-action:active { transform: scale(0.98); }

        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        /* å®éªŒå†…çš„å¤§å·äº¤äº’æŒ‰é’® */
        .btn-large { padding: 25px; font-size: 20px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 20px; color: var(--primary); cursor: pointer; font-weight: bold; transition: 0.1s;}
        .btn-large:active { background: var(--blue); color: white; border-color: var(--blue); transform: scale(0.96); }

        /* ==================== 3. ä¸“é¡¹å®éªŒ UI æ ·å¼ (Specific Paradigms UI) ==================== */
        /* [èŒƒå¼1] Corsi ç©ºé—´æ–¹å—é˜µåˆ— */
        .corsi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 350px; margin: 30px auto; }
        .corsi-block { aspect-ratio: 1; background: #e2e8f0; border-radius: 16px; cursor: pointer; transition: 0.1s; }
        .corsi-block.active { background: var(--blue); transform: scale(0.95); box-shadow: 0 0 15px rgba(79, 70, 229, 0.5); }
        
        /* [èŒƒå¼2] Stroop åˆºæ¿€è¯ */
        .stroop-word { font-size: 80px; font-weight: bold; text-align: center; margin: 60px 0; letter-spacing: 5px; }
        
        /* [èŒƒå¼3] TMT-B è¿çº¿ç™½æ¿ä¸èŠ‚ç‚¹ */
        #tmt-board { position: relative; width: 100%; height: 350px; background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 20px; overflow: hidden; margin-top: 20px;}
        .tmt-node { position: absolute; width: 50px; height: 50px; background: white; border: 3px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s;}
        .tmt-node.clicked { background: var(--green); color: white; border-color: var(--green); } /* æ­£ç¡®ç‚¹å‡»å˜ç»¿ */
        .tmt-node.error { background: var(--red); color: white; border-color: var(--red); animation: shake 0.4s; } /* é”™è¯¯ç‚¹å‡»éœ‡åŠ¨å˜çº¢ */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* [èŒƒå¼4] DSST é¡¶éƒ¨çš„å¯†ç æœ¬æ˜ å°„è¡¨ */
        .dsst-key { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; background: #f1f5f9; padding: 15px; border-radius: 16px;}
        .dsst-pair { text-align: center; background: white; padding: 10px 20px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 24px; }
        .dsst-pair span { display: block; font-size: 16px; color: var(--blue); font-weight: bold; border-top: 1px solid #e2e8f0; margin-top: 5px; padding-top: 5px; }
        .dsst-target { font-size: 80px; text-align: center; margin: 40px 0; }

        /* [èŒƒå¼5] Flanker ä¾§æŠ‘åˆ¶é±¼éª¨ç®­å¤´ */
        .flanker-stim { font-size: 60px; font-weight: bold; letter-spacing: 15px; text-align: center; margin: 60px 0; color: var(--primary); font-family: monospace; }
        
        /* [èŒƒå¼6] DCCS ç»´åº¦å˜åŒ–å¡ç‰‡ */
        .dccs-rule { text-align: center; font-size: 24px; font-weight: bold; color: var(--red); margin-bottom: 20px; padding: 15px; background: #fff1f2; border-radius: 16px; border: 2px dashed #fecdd3; }
        .dccs-target { font-size: 80px; text-align: center; margin: 30px 0; }
        .dccs-card { background: white; border: 2px solid #e2e8f0; border-radius: 20px; padding: 30px; text-align: center; font-size: 60px; cursor: pointer; }
        .dccs-card:active { border-color: var(--blue); background: var(--light-blue); }

        /* [èŒƒå¼7] Pattern åŠ å·¥é€Ÿåº¦æ¯”è¾ƒé˜µåˆ— */
        .pattern-box { display: flex; justify-content: center; align-items: center; gap: 40px; margin: 50px 0; }
        .pattern-item { font-size: 70px; background: #f8fafc; padding: 30px; border-radius: 24px; border: 1px solid #e2e8f0; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>

    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ§  è®¤çŸ¥åŠŸèƒ½ (CAS-COG)</h2>
            <p>ç»å…¸ç¥ç»å¿ƒç†å­¦èŒƒå¼ä¸ NIH Toolbox æ•°å­—åŒ–èŒƒå¼å…¨é›†</p>
        </div>
        
        <h3 style="font-size: 15px; color: var(--slate); margin: 25px 0 10px;">ç»å…¸è®¤çŸ¥èŒƒå¼ (Classic Paradigms)</h3>
        <button class="sys-btn btn-menu" onclick="startCorsi()">ğŸ§© 1. Corsi è‡ªé€‚åº”ç©ºé—´å·¥ä½œè®°å¿†</button>
        <button class="sys-btn btn-menu" onclick="startStroop()">ğŸš¥ 2. Stroop ç»å…¸æ‰§è¡ŒæŠ‘åˆ¶æ§åˆ¶</button>
        <button class="sys-btn btn-menu" onclick="startTMT()">ğŸ”— 3. TMT-B è¿çº¿æµ‹è¯• (è®¤çŸ¥æŸ”æ€§)</button>
        <button class="sys-btn btn-menu" onclick="startDSST()">ğŸ”¢ 4. DSST æ•°å­—ç¬¦å·è½¬æ¢ (å¤„ç†é€Ÿåº¦)</button>

        <h3 style="font-size: 15px; color: var(--slate); margin: 30px 0 10px;">NIH å¯¹æ ‡èŒƒå¼ (Advanced Paradigms)</h3>
        <button class="sys-btn btn-menu" onclick="startFlanker()">ğŸ¯ 5. Flanker ä¾§æŠ‘åˆ¶æ³¨æ„åŠ›æµ‹è¯•</button>
        <button class="sys-btn btn-menu" onclick="startDCCS()">ğŸ”„ 6. DCCS ç»´åº¦å˜åŒ–å¡ç‰‡åˆ†ç±»</button>
        <button class="sys-btn btn-menu" onclick="startPattern()">âš¡ 7. Pattern æ¨¡å¼æ¯”è¾ƒåŠ å·¥é€Ÿåº¦</button>
    </div>

    <div class="container hidden" id="corsi-area">
        <div class="module-header"><h2>Corsi ç©ºé—´è·¨åº¦</h2><p>è®°ä½æ–¹å—é—ªçƒçš„é¡ºåºï¼Œç»“æŸåæŒ‰åŸé¡ºåºç‚¹å‡»ã€‚</p></div>
        <div style="text-align:center; font-weight:bold; color:var(--blue); font-size:18px;" id="corsi-level">å½“å‰å¹¿åº¦: 3</div>
        <div class="corsi-grid" id="corsi-grid"></div> <p style="text-align:center; color:var(--slate); font-size:14px; font-weight:bold;" id="corsi-msg">å‡†å¤‡å¼€å§‹...</p>
    </div>

    <div class="container hidden" id="stroop-area">
        <div class="module-header"><h2>Stroop æ‰§è¡ŒæŠ‘åˆ¶</h2><p>è¯·ç‚¹å‡»æ–‡å­—å®é™…æ˜¾ç¤ºçš„ã€ç‰©ç†é¢œè‰²ã€‘ï¼Œå¿½ç•¥æ–‡å­—å«ä¹‰ã€‚</p></div>
        <div class="stroop-word" id="stroop-word">+</div> <div class="grid-layout hidden" id="stroop-controls" style="grid-template-columns: 1fr 1fr 1fr;">
            <button class="btn-large" style="background:#fef2f2; color:var(--red); border-color:var(--red);" onclick="recordStroop('red')">çº¢</button>
            <button class="btn-large" style="background:#f0fdf4; color:var(--green); border-color:var(--green);" onclick="recordStroop('green')">ç»¿</button>
            <button class="btn-large" style="background:#eff6ff; color:var(--blue); border-color:var(--blue);" onclick="recordStroop('blue')">è“</button>
        </div>
    </div>

    <div class="container hidden" id="tmt-area">
        <div class="module-header"><h2>TMT-B ä»»åŠ¡åˆ‡æ¢</h2><p>è¯·æŒ‰ã€æ•°å­—-å­—æ¯ã€‘äº¤æ›¿é¡ºåºç‚¹å‡» (ä¾‹å¦‚: 1 â” A â” 2 â” B...)</p></div>
        <div style="font-weight:bold; color:var(--blue);">å¯»æ‰¾ç›®æ ‡: <span id="tmt-target" style="font-size:24px; color:var(--primary);">1</span></div>
        <div id="tmt-board"></div> </div>

    <div class="container hidden" id="dsst-area">
        <div class="module-header"><h2>DSST ç¬¦å·è½¬æ¢</h2><p>æ ¹æ®ä¸Šæ–¹å¯¹ç…§è¡¨ï¼Œä¸ºä¸­é—´çš„ç¬¦å·é€‰æ‹©å¯¹åº”çš„æ•°å­—ã€‚</p></div>
        <div class="dsst-key" id="dsst-key"></div> <div class="dsst-target" id="dsst-target">â˜…</div>
        <div class="grid-layout" id="dsst-controls" style="grid-template-columns: repeat(4, 1fr);">
            <button class="btn-large" onclick="recordDSST(1)">1</button>
            <button class="btn-large" onclick="recordDSST(2)">2</button>
            <button class="btn-large" onclick="recordDSST(3)">3</button>
            <button class="btn-large" onclick="recordDSST(4)">4</button>
        </div>
    </div>

    <div class="container hidden" id="flanker-area">
        <div class="module-header"><h2>Flanker ä¾§æŠ‘åˆ¶</h2><p>è¯·å¿½ç•¥ä¸¤è¾¹çš„ç®­å¤´ï¼Œåªåˆ¤æ–­**æœ€ä¸­é—´ç®­å¤´**çš„æ–¹å‘ã€‚</p></div>
        <div class="flanker-stim" id="flanker-stim">+</div>
        <div class="grid-layout hidden" id="flanker-controls">
            <button class="btn-large" onclick="recordFlanker('left')">â† å·¦</button>
            <button class="btn-large" onclick="recordFlanker('right')">å³ â†’</button>
        </div>
    </div>

    <div class="container hidden" id="dccs-area">
        <div class="module-header"><h2>DCCS è®¤çŸ¥æŸ”æ€§</h2><p>è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šæ–¹çº¢æ¡†å†…çš„ã€è§„åˆ™ã€‘é€‰æ‹©åŒ¹é…çš„å¡ç‰‡ã€‚</p></div>
        <div class="dccs-rule" id="dccs-rule">æŒ‰ã€é¢œè‰²ã€‘åŒ¹é…</div>
        <div class="dccs-target" id="dccs-target">ğŸ°</div>
        <div class="grid-layout" id="dccs-controls">
            <div class="dccs-card" onclick="recordDCCS(0)" id="dccs-opt1"></div>
            <div class="dccs-card" onclick="recordDCCS(1)" id="dccs-opt2"></div>
        </div>
    </div>

    <div class="container hidden" id="pattern-area">
        <div class="module-header"><h2>Pattern åŠ å·¥é€Ÿåº¦</h2><p>è¯·åˆ¤æ–­å·¦å³ä¸¤ä¸ªå›¾æ¡ˆæ˜¯å¦ã€å®Œå…¨ç›¸åŒã€‘ã€‚</p></div>
        <div class="pattern-box" id="pattern-stim">
            <div class="pattern-item" id="pat-left">A</div>
            <div class="pattern-item" id="pat-right">A</div>
        </div>
        <div class="grid-layout hidden" id="pattern-controls">
            <button class="btn-large" style="color:var(--green); border-color:var(--green);" onclick="recordPattern(true)">ç›¸åŒ (Yes)</button>
            <button class="btn-large" style="color:var(--red); border-color:var(--red);" onclick="recordPattern(false)">ä¸åŒ (No)</button>
        </div>
    </div>

    <script>
        /**
         * é€šç”¨å•é¡µé¢è·¯ç”±æ§åˆ¶å‡½æ•°
         * @param {string} id - éœ€è¦æ˜¾ç¤ºçš„å®¹å™¨IDã€‚éšè—å…¶ä»–æ‰€æœ‰å®¹å™¨ã€‚
         */
        function show(id) {
            ['menu', 'corsi-area', 'stroop-area', 'tmt-area', 'dsst-area', 'flanker-area', 'dccs-area', 'pattern-area'].forEach(d => {
                const el = document.getElementById(d); if(el) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0);
        }

        /* ==================== 1. Corsi é€»è¾‘ (è‡ªé€‚åº”å¹¿åº¦æµ‹è¯• Adaptive Span) ==================== */
        // æ•°æ®ç»“æ„ï¼šå­˜å‚¨æ¯ä¸€æ¬¡ Trial çš„å¹¿åº¦æ°´å¹³(span)åŠå¯¹é”™æƒ…å†µ
        let corsiData = { module: "COG_Corsi", max_span: 0, trials: [] };
        let c_seq = [];      // æœºå™¨ç”Ÿæˆçš„æ­£ç¡®é—ªçƒåºåˆ—
        let c_userSeq = [];  // å—è¯•è€…å®é™…ç‚¹å‡»çš„åºåˆ—
        let c_span = 3;      // åˆå§‹è®°å¿†å¹¿åº¦èµ·ç‚¹ (NIH æ¨èèµ·å§‹éš¾åº¦)
        let c_fails = 0;     // è¿ç»­é”™è¯¯è®¡æ•°å™¨ï¼Œç”¨äºè§¦å‘ç»ˆæ­¢æ¡ä»¶
        
        function startCorsi() {
            c_span = 3; c_fails = 0; corsiData.trials = []; corsiData.max_span = 0;
            const grid = document.getElementById('corsi-grid'); grid.innerHTML = '';
            // åŠ¨æ€ç”Ÿæˆ 3x3 ä¹å®«æ ¼ (ç´¢å¼• 0-8)
            for(let i=0; i<9; i++) {
                let box = document.createElement('div'); box.className = 'corsi-block'; box.id = 'cb-'+i;
                box.onclick = () => userClickCorsi(i); grid.appendChild(box);
            }
            show('corsi-area'); setTimeout(playCorsiSeq, 800);
        }

        // æ’­æ”¾æœºå™¨åºåˆ—åŠ¨ç”»
        function playCorsiSeq() {
            document.getElementById('corsi-level').innerText = `å½“å‰å¹¿åº¦: ${c_span}`;
            document.getElementById('corsi-msg').innerText = "ğŸ‘€ è¯·è§‚å¯Ÿé—ªçƒé¡ºåº...";
            c_seq = []; c_userSeq = [];
            // ç”Ÿæˆé•¿åº¦ä¸ºå½“å‰å¹¿åº¦çš„éšæœºåºåˆ—
            for(let i=0; i<c_span; i++) c_seq.push(Math.floor(Math.random() * 9));
            
            let i = 0;
            let interval = setInterval(() => {
                // ç†„ç­ä¸Šä¸€ä¸ªäº®èµ·çš„æ–¹å—
                if(i > 0) document.getElementById('cb-'+c_seq[i-1]).classList.remove('active');
                if(i < c_span) {
                    // å»¶è¿Ÿ100msç‚¹äº®ï¼Œç¡®ä¿å¦‚æœè¿ç»­ä¸¤æ¬¡é—ªçƒåŒä¸€ä¸ªæ–¹å—ï¼Œè‚‰çœ¼èƒ½çœ‹åˆ°ä¸­é—´çš„ç†„ç­è¿‡ç¨‹
                    setTimeout(() => document.getElementById('cb-'+c_seq[i]).classList.add('active'), 100); 
                    i++;
                } else {
                    // åºåˆ—æ’­æ”¾å®Œæ¯•ï¼Œé‡Šæ”¾æ§åˆ¶æƒç»™å—è¯•è€…
                    clearInterval(interval); document.getElementById('corsi-msg').innerText = "ğŸ‘† ç°åœ¨è¯·æŒ‰åŸé¡ºåºç‚¹å‡»";
                }
            }, 800); // æ¯ä¸ªæ–¹å—é—ªçƒé—´éš” 800ms
        }

        // å¤„ç†å—è¯•è€…ç‚¹å‡»åé¦ˆ
        function userClickCorsi(idx) {
            if(c_userSeq.length >= c_span) return; // åºåˆ—å·²æ»¡ï¼Œå¿½ç•¥å¤šä½™ç‚¹å‡»
            const box = document.getElementById('cb-'+idx);
            
            // ç‚¹å‡»è§†è§‰åé¦ˆ
            box.classList.add('active'); setTimeout(() => box.classList.remove('active'), 200);
            c_userSeq.push(idx);
            
            // åˆ¤æ–­æ˜¯å¦ç‚¹å®Œäº†ä¸€æ•´è½®
            if(c_userSeq.length === c_span) {
                // å°†æ•°ç»„è½¬ä¸ºå­—ç¬¦ä¸²æ¯”å¯¹æ˜¯å¦å®Œå…¨ä¸€è‡´
                let isCorrect = JSON.stringify(c_seq) === JSON.stringify(c_userSeq);
                corsiData.trials.push({ span: c_span, correct: isCorrect });
                
                if(isCorrect) { 
                    // ç­”å¯¹ï¼šæ›´æ–°æœ€å¤§å¹¿åº¦ï¼Œå¢åŠ éš¾åº¦ï¼Œæ¸…é›¶å¤±è´¥è®¡æ•°
                    corsiData.max_span = c_span; c_span++; c_fails = 0; 
                    document.getElementById('corsi-msg').innerText = "âœ… æ­£ç¡®ï¼éš¾åº¦å¢åŠ ..."; 
                } else { 
                    // ç­”é”™ï¼šå¤±è´¥è®¡æ•°+1
                    c_fails++; document.getElementById('corsi-msg').innerText = "âŒ é”™è¯¯ï¼"; 
                }
                
                // ç»ˆæ­¢é€»è¾‘ï¼šè¿ç»­é”™2æ¬¡ æˆ– è¶…è¿‡9ä¸ªæ¨¡å—æé™
                if(c_fails >= 2 || c_span > 9) {
                    setTimeout(() => { 
                        CAS_Storage.saveModuleData('COG_Corsi', corsiData); 
                        alert(`æµ‹è¯•ç»“æŸã€‚æ‚¨çš„ç©ºé—´è®°å¿†æé™å¹¿åº¦: ${corsiData.max_span}`); 
                        show('menu'); 
                    }, 1000);
                } else { 
                    setTimeout(playCorsiSeq, 1500); 
                }
            }
        }

        /* ==================== 2. Stroop é€»è¾‘ ==================== */
        // åˆºæ¿€é›†ï¼šw(æ–‡å­—æ¶µä¹‰), c(ç‰©ç†é¢œè‰²)ã€‚åŒ…å«ä¸€è‡´ä¸ä¸ä¸€è‡´çš„è¯•éªŒ
        const stroopStims = [ {w:'çº¢', c:'blue'}, {w:'ç»¿', c:'red'}, {w:'è“', c:'green'}, {w:'çº¢', c:'red'}, {w:'è“', c:'blue'} ];
        let stroopData = { module: "COG_Stroop", records: [] };
        let s_trial = 0, s_onset = 0, s_curr = null;
        
        function startStroop() { s_trial = 0; stroopData.records = []; show('stroop-area'); nextStroop(); }
        
        function nextStroop() {
            // ä¸´åºŠå»ºè®®ï¼šæ­£å¼æµ‹è¯•éœ€ 20-40 trialï¼Œæ­¤å¤„æ¼”ç¤ºè®¾ä¸º 10
            if(s_trial >= 10) { CAS_Storage.saveModuleData('COG_Stroop', stroopData); alert("Stroop æµ‹è¯•å®Œæˆ"); show('menu'); return; }
            
            // å‘ˆç°æ³¨è§†ç‚¹ (+) ä¸ ITI (Inter-Trial Interval)
            document.getElementById('stroop-controls').classList.add('hidden');
            document.getElementById('stroop-word').innerText = "+"; document.getElementById('stroop-word').style.color = "#cbd5e1";
            
            setTimeout(() => {
                // å‘ˆç°ç›®æ ‡åˆºæ¿€å¹¶è®°å½•æ¯«ç§’çº§æ—¶é—´æˆ³
                s_curr = stroopStims[Math.floor(Math.random() * stroopStims.length)];
                document.getElementById('stroop-word').innerText = s_curr.w; 
                document.getElementById('stroop-word').style.color = s_curr.c;
                document.getElementById('stroop-controls').classList.remove('hidden');
                s_onset = performance.now();
            }, 600);
        }
        
        // è®°å½•ååº”ä¸æ—¶é•¿
        function recordStroop(color) {
            stroopData.records.push({ trial: s_trial, correct: color === s_curr.c, rt: Math.round(performance.now() - s_onset) });
            s_trial++; nextStroop();
        }

        /* ==================== 3. TMT-B é€»è¾‘ (Trail Making Test - B) ==================== */
        const tmtSeq = ['1', 'A', '2', 'B', '3', 'C', '4', 'D']; // ä¸´åºŠ TMT-B çš„äº¤æ›¿åºåˆ—ç¼©ç•¥ç‰ˆ
        let tmtData = { module: "COG_TMT_B", total_time_ms: 0, errors: 0 };
        let t_idx = 0, t_onset = 0;
        
        function startTMT() {
            t_idx = 0; tmtData.errors = 0; show('tmt-area');
            document.getElementById('tmt-target').innerText = tmtSeq[0];
            const board = document.getElementById('tmt-board'); board.innerHTML = '';
            
            // é¢„è®¾èŠ‚ç‚¹çš„ç›¸å¯¹åæ ‡ç™¾åˆ†æ¯”ï¼Œç¡®ä¿åœ¨ä¸åŒå±å¹•ä¸‹åˆ†å¸ƒå‡åŒ€ä½†ä¸é‡å 
            const pos = [ {x:10,y:10}, {x:70,y:20}, {x:20,y:70}, {x:80,y:70}, {x:40,y:40}, {x:15,y:45}, {x:85,y:40}, {x:50,y:80} ];
            pos.sort(() => Math.random() - 0.5); // æ¯æ¬¡æµ‹è¯•éšæœºæ‰“ä¹±ä½ç½®
            
            tmtSeq.forEach((item, i) => {
                let node = document.createElement('div'); node.className = 'tmt-node';
                node.innerText = item;
                node.style.left = pos[i].x + '%'; node.style.top = pos[i].y + '%';
                node.onclick = () => clickTMT(node, item);
                board.appendChild(node);
            });
            t_onset = performance.now(); // å¼€å§‹æ€»è®¡æ—¶
        }
        
        function clickTMT(node, item) {
            if(node.classList.contains('clicked')) return; // é˜²æ­¢é‡å¤ç‚¹å‡»å·²æ¿€æ´»çš„èŠ‚ç‚¹
            
            if(item === tmtSeq[t_idx]) {
                // æ­£ç¡®é€»è¾‘ï¼šéªŒè¯é€šè¿‡ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªç›®æ ‡
                node.classList.add('clicked'); 
                t_idx++;
                if(t_idx >= tmtSeq.length) {
                    // å…¨éƒ¨è¿çº¿å®Œæˆï¼Œç»“ç®—æ€»ç”¨æ—¶
                    tmtData.total_time_ms = Math.round(performance.now() - t_onset);
                    CAS_Storage.saveModuleData('COG_TMT_B', tmtData);
                    alert(`TMT-B å®Œæˆï¼è€—æ—¶: ${tmtData.total_time_ms}ms, çº é”™æ¬¡æ•°: ${tmtData.errors}`); show('menu');
                } else { 
                    document.getElementById('tmt-target').innerText = tmtSeq[t_idx]; 
                }
            } else {
                // é˜²å‘†å®¹é”™ï¼šç‚¹å‡»é”™è¯¯é¡ºåºèŠ‚ç‚¹ï¼Œè§¦å‘CSSçº¢è‰²éœ‡åŠ¨ï¼Œè®°å½•é”™è¯¯æ¬¡æ•°
                node.classList.add('error'); tmtData.errors++;
                setTimeout(() => node.classList.remove('error'), 400);
            }
        }

        /* ==================== 4. DSST é€»è¾‘ (Digital Symbol Substitution Test) ==================== */
        const dsstSymbols = ['â˜…', 'â–²', 'â—', 'â—†'];
        let dsstData = { module: "COG_DSST", records: [] };
        let ds_trial = 0, ds_onset = 0, ds_currIdx = 0;
        
        function startDSST() {
            ds_trial = 0; dsstData.records = []; show('dsst-area');
            const keyBoard = document.getElementById('dsst-key'); keyBoard.innerHTML = '';
            // åŠ¨æ€æ„å»ºé¡¶éƒ¨çš„æ•°å­—-ç¬¦å·å¯¹ç…§æ˜ å°„è¡¨
            dsstSymbols.forEach((sym, i) => { keyBoard.innerHTML += `<div class="dsst-pair">${sym}<span>${i+1}</span></div>`; });
            nextDSST();
        }
        
        function nextDSST() {
            if(ds_trial >= 10) { CAS_Storage.saveModuleData('COG_DSST', dsstData); alert("DSST å®Œæˆ"); show('menu'); return; }
            ds_currIdx = Math.floor(Math.random() * 4); // éšæœºæŠ½å–ä¸€ä¸ªç¬¦å·ä½œä¸ºå½“å‰é¶åˆºæ¿€
            document.getElementById('dsst-target').innerText = dsstSymbols[ds_currIdx];
            ds_onset = performance.now();
        }
        
        function recordDSST(num) {
            // éªŒè¯å—è¯•è€…æŒ‰ä¸‹çš„æ•°å­—æ˜¯å¦ç­‰åŒäºå½“å‰é¶ç¬¦å·åœ¨å¯¹ç…§è¡¨ä¸­çš„ç´¢å¼•(+1)
            dsstData.records.push({ trial: ds_trial, correct: num === (ds_currIdx+1), rt: Math.round(performance.now() - ds_onset) });
            ds_trial++; nextDSST();
        }

        /* ==================== 5. Flanker é€»è¾‘ (Eriksen Flanker Task) ==================== */
        // s: å¹²æ‰°é˜µåˆ—, a: ä¸­å¿ƒé¶ç®­å¤´çš„æ­£ç¡®ç­”æ¡ˆ (è€ƒé‡å‰æ‰£å¸¦å›å†²çªè§£å†³èƒ½åŠ›)
        const flStims = [{s:'<<<<<',a:'left'}, {s:'>>>>>',a:'right'}, {s:'<<><<',a:'right'}, {s:'>><>>',a:'left'}];
        let flData = { module: "COG_Flanker", records: [] }; let fl_trial=0, fl_onset=0, fl_curr=null;
        
        function startFlanker() { fl_trial = 0; flData.records = []; show('flanker-area'); nextFlanker(); }
        
        function nextFlanker() {
            if(fl_trial >= 10) { CAS_Storage.saveModuleData('COG_Flanker', flData); alert("Flanker å®Œæˆ"); show('menu'); return; }
            document.getElementById('flanker-controls').classList.add('hidden'); document.getElementById('flanker-stim').innerText = "+";
            setTimeout(() => {
                fl_curr = flStims[Math.floor(Math.random() * 4)]; document.getElementById('flanker-stim').innerText = fl_curr.s;
                document.getElementById('flanker-controls').classList.remove('hidden'); fl_onset = performance.now();
            }, 600);
        }
        function recordFlanker(ans) { flData.records.push({ correct: ans === fl_curr.a, rt: Math.round(performance.now()-fl_onset) }); fl_trial++; nextFlanker(); }

        /* ==================== 6. DCCS é€»è¾‘ (Dimensional Change Card Sort) ==================== */
        // è®¤çŸ¥æŸ”æ€§æ ¸å¿ƒï¼šc(é¢œè‰²å±æ€§), s(å½¢çŠ¶å±æ€§)
        const dccsT = [{e:'ğŸ”´ğŸ°',c:'red',s:'rb'}, {e:'ğŸ”µğŸ°',c:'blue',s:'rb'}, {e:'ğŸ”´â›µ',c:'red',s:'bt'}, {e:'ğŸ”µâ›µ',c:'blue',s:'bt'}];
        let dccsData = { module: "COG_DCCS", records: [] }; let d_trial=0, d_onset=0, d_rule='', d_curr=null;
        
        function startDCCS() { d_trial = 0; dccsData.records = []; show('dccs-area'); nextDCCS(); }
        
        function nextDCCS() {
            if(d_trial >= 10) { CAS_Storage.saveModuleData('COG_DCCS', dccsData); alert("DCCS å®Œæˆ"); show('menu'); return; }
            
            // éšæœºåˆ‡æ¢åˆ¤å®šè§„åˆ™ï¼šå¼ºåˆ¶å¤§è„‘åœ¨ä¸¤å¥—æ‰§è¡Œæ³•åˆ™ä¸­é¢‘ç¹åˆ‡æ¢ (Switch Cost)
            d_rule = Math.random() > 0.5 ? 'color' : 'shape';
            document.getElementById('dccs-rule').innerText = d_rule === 'color' ? "æŒ‰ã€é¢œè‰²ã€‘åŒ¹é…" : "æŒ‰ã€å½¢çŠ¶ã€‘åŒ¹é…";
            
            d_curr = dccsT[Math.floor(Math.random() * 4)]; document.getElementById('dccs-target').innerText = d_curr.e;
            // å›ºå®šä¸¤ä¸ªé€‰é¡¹å¡
            document.getElementById('dccs-opt1').innerText = 'ğŸ”´â›µ'; document.getElementById('dccs-opt2').innerText = 'ğŸ”µğŸ°';
            d_onset = performance.now();
        }
        
        function recordDCCS(opt) {
            // è§£æå—è¯•è€…é€‰æ‹©çš„å¡ç‰‡å±æ€§
            const sel = opt === 0 ? {c:'red',s:'bt'} : {c:'blue',s:'rb'};
            let isC = false;
            // æ ¸å¿ƒä»²è£é€»è¾‘ï¼šå¦‚æœå½“å‰è§„åˆ™æ˜¯çœ‹é¢œè‰²ï¼Œå°±æ¯”å¯¹é¢œè‰²å­—æ®µï¼›å¦åˆ™æ¯”å¯¹å½¢çŠ¶å­—æ®µ
            if(d_rule === 'color' && d_curr.c === sel.c) isC = true;
            if(d_rule === 'shape' && d_curr.s === sel.s) isC = true;

            dccsData.records.push({ rule: d_rule, correct: isC, rt: Math.round(performance.now()-d_onset) }); d_trial++; nextDCCS();
        }

        /* ==================== 7. Pattern Comparison é€»è¾‘ (Processing Speed) ==================== */
        const patStims = ['A', 'B', 'M', 'W', 'p', 'q', 'ğŸ¶', 'ğŸ±']; // åŒ…å«å­—æ¯ä¸ç®€å•å›¾å½¢ï¼Œæ¶ˆé™¤æ•™è‚²åå·®
        let patData = { module: "COG_Pattern", records: [] }; let p_trial=0, p_onset=0, p_same=false;
        
        function startPattern() { p_trial = 0; patData.records = []; show('pattern-area'); nextPattern(); }
        
        function nextPattern() {
            if(p_trial >= 10) { CAS_Storage.saveModuleData('COG_Pattern', patData); alert("Pattern å®Œæˆ"); show('menu'); return; }
            document.getElementById('pattern-controls').classList.add('hidden');
            document.getElementById('pat-left').innerText = ""; document.getElementById('pat-right').innerText = "";
            
            setTimeout(() => {
                let i1 = patStims[Math.floor(Math.random() * patStims.length)]; 
                p_same = Math.random() > 0.5; // 50% çš„æ¦‚ç‡å‘ˆç°å®Œå…¨ç›¸åŒçš„å›¾æ¡ˆ
                let i2 = p_same ? i1 : patStims[Math.floor(Math.random() * patStims.length)];
                
                // é˜²æŠ–é€»è¾‘ï¼šå¦‚æœè®¾å®šä¸ºä¸ç›¸åŒï¼Œä½†éšæœºæŠ½å–ç¢°å·§æŠ½åˆ°äº†åŒä¸€ä¸ªï¼Œå°±é‡æŠ½ç›´åˆ°ä¸åŒä¸ºæ­¢
                while(!p_same && i1 === i2) { i2 = patStims[Math.floor(Math.random() * patStims.length)]; }
                
                document.getElementById('pat-left').innerText = i1; document.getElementById('pat-right').innerText = i2;
                document.getElementById('pattern-controls').classList.remove('hidden'); p_onset = performance.now();
            }, 500);
        }
        function recordPattern(ans) { patData.records.push({ correct: ans === p_same, rt: Math.round(performance.now()-p_onset) }); p_trial++; nextPattern(); }
    </script>
</body>
</html>
