<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>认知 - 空间工作记忆</title>
    <style>
        body { font-family: sans-serif; background: #f8fafc; text-align: center; margin: 0; padding: 20px; touch-action: none; user-select: none; }
        .container { max-width: 600px; margin: 0 auto; }
        #grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 40px auto; width: 300px; height: 300px; }
        .block { background: #e2e8f0; border-radius: 12px; transition: background 0.2s, transform 0.1s; cursor: pointer; }
        .block.active { background: #3b82f6 !important; transform: scale(0.95); }
        .sys-btn { background: #0f172a; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; }
        #nav-back { display: block; text-align: left; text-decoration: none; color: #3b82f6; font-weight: bold; margin-bottom: 20px; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <a href="index.html" id="nav-back">← 返回主控台</a>
    <div class="container" id="intro">
        <h2>空间工作记忆测试</h2>
        <p style="color:#64748b;">方块会按特定顺序闪烁。请在闪烁结束后，<strong>按相同顺序点击这些方块</strong>。序列长度会逐渐增加。</p>
        <button class="sys-btn" onclick="startTest()">开始测试</button>
    </div>

    <div class="container" id="test-area" style="display:none;">
        <h3 id="status" style="color:#334155;">注意观察...</h3>
        <div id="grid"></div>
    </div>

    <script>
        let sequence = [], userSequence = [];
        let currentSpan = 2, maxTrials = 5, currentTrial = 0;
        let aiData = { module: "Cognition_Corsi", max_span: 0, trials: [] };
        let allowInput = false, trialStartTime = 0;
        
        const grid = document.getElementById('grid');
        for(let i=0; i<9; i++) {
            let div = document.createElement('div');
            div.className = 'block'; div.dataset.id = i;
            div.onmousedown = () => handleTap(i);
            div.ontouchstart = (e) => { e.preventDefault(); handleTap(i); };
            grid.appendChild(div);
        }
        const blocks = document.querySelectorAll('.block');

        function startTest() {
            document.getElementById('intro').style.display = 'none';
            document.getElementById('test-area').style.display = 'block';
            nextTrial();
        }

        function nextTrial() {
            if (currentTrial >= maxTrials) return finishTest();
            userSequence = [];
            allowInput = false;
            document.getElementById('status').innerText = `广度: ${currentSpan} | 注意观察...`;
            
            // 生成不重复的随机序列
            sequence = [];
            let pool = [0,1,2,3,4,5,6,7,8];
            for(let i=0; i<currentSpan; i++) {
                let idx = Math.floor(Math.random() * pool.length);
                sequence.push(pool.splice(idx, 1)[0]);
            }

            // 闪烁序列
            let step = 0;
            let interval = setInterval(() => {
                blocks.forEach(b => b.classList.remove('active'));
                if (step < sequence.length) {
                    blocks[sequence[step]].classList.add('active');
                    setTimeout(() => blocks[sequence[step]].classList.remove('active'), 400); // 亮400ms
                    step++;
                } else {
                    clearInterval(interval);
                    document.getElementById('status').innerText = "请复现序列！";
                    allowInput = true;
                    trialStartTime = performance.now();
                }
            }, 800); // 间隔800ms
        }

        function handleTap(id) {
            if (!allowInput) return;
            blocks[id].classList.add('active');
            setTimeout(() => blocks[id].classList.remove('active'), 150);
            
            userSequence.push(id);
            const isCorrectSoFar = userSequence[userSequence.length-1] === sequence[userSequence.length-1];

            if (!isCorrectSoFar) {
                // 错误
                recordTrial(false);
                document.getElementById('status').innerText = "错误！序列结束。";
                setTimeout(finishTest, 1000);
            } else if (userSequence.length === sequence.length) {
                // 正确完成该轮
                recordTrial(true);
                aiData.max_span = currentSpan;
                currentSpan++;
                currentTrial++;
                document.getElementById('status').innerText = "正确！准备下一轮...";
                allowInput = false;
                setTimeout(nextTrial, 1500);
            }
        }

        function recordTrial(isCorrect) {
            aiData.trials.push({
                trial_index: currentTrial + 1,
                target_sequence: [...sequence],
                user_sequence: [...userSequence],
                is_correct: isCorrect,
                recall_duration_ms: parseFloat((performance.now() - trialStartTime).toFixed(2))
            });
        }

        function finishTest() {
            CAS_Storage.saveModuleData('Cognition_Corsi', aiData);
            document.getElementById('test-area').innerHTML = `<h2>测试结束</h2><p style="font-size:20px;">您的空间记忆广度为: <strong>${aiData.max_span}</strong></p><a href="index.html" class="sys-btn" style="text-decoration:none;">返回主控台</a>`;
        }
    </script>
</body>
</html>
