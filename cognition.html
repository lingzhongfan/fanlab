<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap -COG | å…¨ç»´åº¦è®¤çŸ¥åŠŸèƒ½è¯„ä¼°</title>
    <style>
        /* ==================== UI åŸºç¡€ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --slate: #64748b; }
        /* ç¦ç”¨åŒå‡»æ”¾å¤§ä¸æ–‡æœ¬é€‰ä¸­ï¼Œé˜²æ­¢è€å¹´äººè¯¯è§¦æ‰“æ–­æµ‹è¯• */
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; touch-action: manipulation; user-select: none; }
        .container { max-width: 750px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        /* æ¨¡å—æ ‡é¢˜ä¸æŒ‰é’®é€šç”¨æ ·å¼ */
        .module-header { border-left: 6px solid var(--blue); padding-left: 15px; margin-bottom: 30px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; }
        .sys-btn { width: 100%; padding: 18px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 15px; transition: 0.2s; display: flex; align-items: center; gap: 12px; }
        .btn-menu { background: var(--light-blue); color: var(--blue); border: 1px solid #e0e7ff; }
        .btn-menu:hover { background: var(--blue); color: white; transform: translateX(5px); }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-large { padding: 25px; font-size: 20px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 20px; color: var(--primary); cursor: pointer; font-weight: bold; transition: 0.1s;}
        .btn-large:active { background: var(--blue); color: white; border-color: var(--blue); transform: scale(0.96); }

        /* ==================== å„èŒƒå¼ä¸“å± UI è®¾è®¡ ==================== */
        
        /* 1. Corsi ç©ºé—´è®°å¿†è·¨åº¦ */
        .corsi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 350px; margin: 30px auto; }
        .corsi-block { aspect-ratio: 1; background: #e2e8f0; border-radius: 16px; cursor: pointer; transition: 0.1s; }
        .corsi-block.active { background: var(--blue); transform: scale(0.95); box-shadow: 0 0 15px rgba(79, 70, 229, 0.5); }
        
        /* 2. Stroop / 5. Flanker ä¸­å¤®åˆºæ¿€åŒº */
        .stim-large { font-size: 80px; font-weight: bold; text-align: center; margin: 60px 0; letter-spacing: 5px; }
        .flanker-stim { font-size: 60px; font-weight: bold; letter-spacing: 15px; text-align: center; margin: 60px 0; font-family: monospace; }
        
        /* 3. TMT-B è¿çº¿æµ‹è¯•ç”»å¸ƒ */
        #tmt-board { position: relative; width: 100%; height: 350px; background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 20px; overflow: hidden; margin-top: 20px;}
        .tmt-node { position: absolute; width: 50px; height: 50px; background: white; border: 3px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.2s;}
        .tmt-node.clicked { background: var(--green); color: white; border-color: var(--green); }
        .tmt-node.error { background: var(--red); color: white; border-color: var(--red); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* 4. DSST / 6. DCCS / 7. Pattern */
        .dsst-key { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; background: #f1f5f9; padding: 15px; border-radius: 16px;}
        .dsst-pair { text-align: center; background: white; padding: 10px 20px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 24px; }
        .dsst-pair span { display: block; font-size: 16px; color: var(--blue); font-weight: bold; border-top: 1px solid #e2e8f0; margin-top: 5px; padding-top: 5px; }
        .dccs-rule { text-align: center; font-size: 24px; font-weight: bold; color: var(--red); margin-bottom: 20px; padding: 15px; background: #fff1f2; border-radius: 16px; border: 2px dashed #fecdd3; }
        .dccs-card { background: white; border: 2px solid #e2e8f0; border-radius: 20px; padding: 30px; text-align: center; font-size: 60px; cursor: pointer; }
        .pattern-box { display: flex; justify-content: center; gap: 40px; margin: 50px 0; }
        .pattern-item { font-size: 70px; background: #f8fafc; padding: 30px; border-radius: 24px; border: 1px solid #e2e8f0; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ§  è®¤çŸ¥åŠŸèƒ½ (CAS-COG)</h2>
            <p>åŸºäºç»å…¸ç¥ç»å¿ƒç†å­¦èŒƒå¼ä¸ NIH Toolbox æ•°å­—åŒ–æ„å»ºï¼Œæ˜ å°„å‰é¢å¶-é¡¶å¶æ‰§è¡Œæ§åˆ¶ç½‘ç»œã€‚</p>
        </div>
        
        <h3 style="font-size: 15px; color: var(--slate);">ç»å…¸è®¤çŸ¥èŒƒå¼</h3>
        <button class="sys-btn btn-menu" onclick="startCorsi()">ğŸ§© 1. Corsi è‡ªé€‚åº”ç©ºé—´å·¥ä½œè®°å¿†</button>
        <button class="sys-btn btn-menu" onclick="startStroop()">ğŸš¥ 2. Stroop ç»å…¸æ‰§è¡ŒæŠ‘åˆ¶æ§åˆ¶</button>
        <button class="sys-btn btn-menu" onclick="startTMT()">ğŸ”— 3. TMT-B è¿çº¿æµ‹è¯• (ä»»åŠ¡åˆ‡æ¢)</button>
        <button class="sys-btn btn-menu" onclick="startDSST()">ğŸ”¢ 4. DSST æ•°å­—ç¬¦å·è½¬æ¢</button>
        
        <h3 style="font-size: 15px; color: var(--slate); margin-top:20px;">NIH å¯¹æ ‡èŒƒå¼</h3>
        <button class="sys-btn btn-menu" onclick="startFlanker()">ğŸ¯ 5. Flanker ä¾§æŠ‘åˆ¶æ³¨æ„åŠ›æµ‹è¯•</button>
        <button class="sys-btn btn-menu" onclick="startDCCS()">ğŸ”„ 6. DCCS ç»´åº¦å˜åŒ–å¡ç‰‡åˆ†ç±»</button>
        <button class="sys-btn btn-menu" onclick="startPattern()">âš¡ 7. Pattern æ¨¡å¼æ¯”è¾ƒåŠ å·¥é€Ÿåº¦</button>
    </div>

    <div class="container hidden" id="corsi-area">
        <div class="module-header"><h2>Corsi ç©ºé—´è·¨åº¦</h2><p>æµ‹è¯•è§†ç©ºé—´å·¥ä½œè®°å¿†å®¹é‡ã€‚è¯·è®°ä½æ–¹å—é—ªçƒçš„é¡ºåºï¼Œå¹¶åœ¨é—ªçƒç»“æŸåæŒ‰åŸé¡ºåºç‚¹å‡»ã€‚</p></div>
        <div style="text-align:center; font-weight:bold; color:var(--blue); font-size:18px;" id="corsi-level">å½“å‰å¹¿åº¦: 3</div>
        <div class="corsi-grid" id="corsi-grid"></div>
        <p style="text-align:center; color:var(--slate); font-size:15px; font-weight:bold;" id="corsi-msg">å‡†å¤‡å¼€å§‹...</p>
    </div>

    <div class="container hidden" id="stroop-area">
        <div class="module-header"><h2>Stroop æ‰§è¡ŒæŠ‘åˆ¶</h2><p>æµ‹è¯•æŠ—å¹²æ‰°èƒ½åŠ›ã€‚è¯·å¿½ç•¥æ–‡å­—æœ¬èº«çš„å«ä¹‰ï¼Œç‚¹å‡»æ–‡å­—å®é™…æ˜¾ç¤ºçš„ã€é¢œè‰²ã€‘ã€‚</p></div>
        <div class="stim-large" id="stroop-word">+</div>
        <div class="grid-layout hidden" id="stroop-controls" style="grid-template-columns: 1fr 1fr 1fr;">
            <button class="btn-large" style="color:var(--red);" onclick="recordStroop('red')">çº¢</button>
            <button class="btn-large" style="color:var(--green);" onclick="recordStroop('green')">ç»¿</button>
            <button class="btn-large" style="color:var(--blue);" onclick="recordStroop('blue')">è“</button>
        </div>
    </div>

    <div class="container hidden" id="tmt-area">
        <div class="module-header"><h2>TMT-B ä»»åŠ¡åˆ‡æ¢</h2><p>æµ‹è¯•è®¤çŸ¥æŸ”æ€§ä¸ä»»åŠ¡é›†åˆ‡æ¢èƒ½åŠ›ã€‚è¯·æŒ‰æ•°å­—ä¸å­—æ¯äº¤æ›¿çš„é¡ºåºç‚¹å‡» (1 â” A â” 2 â” B...)</p></div>
        <div style="font-weight:bold; color:var(--blue);">å¯»æ‰¾ç›®æ ‡: <span id="tmt-target" style="font-size:24px;">1</span></div>
        <div id="tmt-board"></div>
    </div>

    <div class="container hidden" id="dsst-area">
        <div class="module-header"><h2>DSST ç¬¦å·è½¬æ¢</h2><p>æµ‹è¯•è§†è§‰-è¿åŠ¨åè°ƒä¸åŠ å·¥é€Ÿåº¦ã€‚è¯·æ ¹æ®ä¸Šæ–¹å¯¹åº”è§„åˆ™ï¼Œä¸ºä¸­é—´çš„ç¬¦å·é€‰æ‹©æ­£ç¡®çš„æ•°å­—ã€‚</p></div>
        <div class="dsst-key" id="dsst-key"></div>
        <div class="stim-large" id="dsst-target">â˜…</div>
        <div class="grid-layout" id="dsst-controls" style="grid-template-columns: repeat(4, 1fr);">
            <button class="btn-large" onclick="recordDSST(1)">1</button>
            <button class="btn-large" onclick="recordDSST(2)">2</button>
            <button class="btn-large" onclick="recordDSST(3)">3</button>
            <button class="btn-large" onclick="recordDSST(4)">4</button>
        </div>
    </div>

    <div class="container hidden" id="flanker-area">
        <div class="module-header"><h2>Flanker ä¾§æŠ‘åˆ¶</h2><p>æµ‹è¯•é€‰æ‹©æ€§æ³¨æ„ç½‘ç»œã€‚è¯·åªåˆ¤æ–­ã€æœ€ä¸­é—´ç®­å¤´ã€‘çš„æ–¹å‘ï¼Œå¿½ç•¥ä¸¤è¾¹çš„å¹²æ‰°ç®­å¤´ã€‚</p></div>
        <div class="flanker-stim" id="flanker-stim">+</div>
        <div class="grid-layout hidden" id="flanker-controls">
            <button class="btn-large" onclick="recordFlanker('left')">â† å·¦</button>
            <button class="btn-large" onclick="recordFlanker('right')">å³ â†’</button>
        </div>
    </div>

    <div class="container hidden" id="dccs-area">
        <div class="module-header"><h2>DCCS è®¤çŸ¥æŸ”æ€§</h2><p>æµ‹è¯•è§„åˆ™åˆ‡æ¢ä¸æ‰§è¡Œæ§åˆ¶ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šæ–¹çš„æç¤ºè§„åˆ™ï¼ˆé¢œè‰²æˆ–å½¢çŠ¶ï¼‰å¯¹å¡ç‰‡è¿›è¡ŒåŒ¹é…ã€‚</p></div>
        <div class="dccs-rule" id="dccs-rule">æŒ‰ã€é¢œè‰²ã€‘åŒ¹é…</div>
        <div class="stim-large" id="dccs-target">ğŸ°</div>
        <div class="grid-layout" id="dccs-controls">
            <div class="dccs-card" onclick="recordDCCS(0)" id="dccs-opt1"></div>
            <div class="dccs-card" onclick="recordDCCS(1)" id="dccs-opt2"></div>
        </div>
    </div>

    <div class="container hidden" id="pattern-area">
        <div class="module-header"><h2>Pattern åŠ å·¥é€Ÿåº¦</h2><p>æµ‹è¯•è§†è§‰ä¿¡æ¯æå–ä¸æ¯”å¯¹é€Ÿåº¦ã€‚è¯·ä»¥æœ€å¿«é€Ÿåº¦åˆ¤æ–­ä¸¤ä¸ªå›¾æ¡ˆæ˜¯å¦ã€å®Œå…¨ç›¸åŒã€‘ã€‚</p></div>
        <div class="pattern-box" id="pattern-stim">
            <div class="pattern-item" id="pat-left">A</div>
            <div class="pattern-item" id="pat-right">A</div>
        </div>
        <div class="grid-layout hidden" id="pattern-controls">
            <button class="btn-large" style="color:var(--green);" onclick="recordPattern(true)">ç›¸åŒ</button>
            <button class="btn-large" style="color:var(--red);" onclick="recordPattern(false)">ä¸åŒ</button>
        </div>
    </div>

    <script>
        // DOM è§†çª—è·¯ç”±æ§åˆ¶
        function show(id) {
            ['menu','corsi-area','stroop-area','tmt-area','dsst-area','flanker-area','dccs-area','pattern-area'].forEach(d => {
                const el = document.getElementById(d); if(el) el.classList.add('hidden');
            }); 
            document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0);
        }

        /* ===================================================================== */
        /* 1. Corsi ç©ºé—´è®°å¿†è·¨åº¦ (Spatial Working Memory)
           ã€ä¸´åºŠé¶å‘ã€‘: è¯„ä¼°é¡¶å¶åéƒ¨ä¸èƒŒå¤–ä¾§å‰é¢å¶(dlPFC)ä»‹å¯¼çš„è§†ç©ºé—´å·¥ä½œè®°å¿†ã€‚
           ã€å·¥ç¨‹æ›´æ–°ã€‘: å¼•å…¥ async/await æ—¶åºé”ï¼Œå½»åº•ä¿®å¤æŠ¢ç­”ä¸æ‰å¸§å¯¼è‡´çš„ä¿¡åº¦æ±¡æŸ“ã€‚
        /* ===================================================================== */
        let corsiData = { module: "COG_Corsi", max_span: 0, trials: [] };
        let c_seq = [], c_userSeq = [], c_span = 3, c_fails = 0;
        let c_isClickable = false; // çŠ¶æ€é”ï¼šåˆºæ¿€å‘ˆç°æœŸä¸¥ç¦ç‚¹å‡»

        function startCorsi() {
            c_span = 3; c_fails = 0; corsiData.trials = []; corsiData.max_span = 0;
            const grid = document.getElementById('corsi-grid'); 
            grid.innerHTML = '';
            for(let i=0; i<9; i++) { 
                let box = document.createElement('div'); 
                box.className = 'corsi-block'; 
                box.id = 'cb-'+i; 
                box.onclick = () => userClickCorsi(i); 
                grid.appendChild(box); 
            }
            show('corsi-area'); 
            setTimeout(playCorsiSeq, 800);
        }

        async function playCorsiSeq() {
            c_isClickable = false; 
            document.getElementById('corsi-level').innerText = `å½“å‰å¹¿åº¦: ${c_span}`; 
            document.getElementById('corsi-msg').innerText = "ğŸ‘€ è¯·è§‚å¯Ÿé—ªçƒé¡ºåº...";
            document.getElementById('corsi-msg').style.color = "var(--slate)";
            
            c_seq = []; c_userSeq = []; 
            let prevBlock = -1;

            // ç”Ÿæˆåºåˆ—ï¼Œç¡®ä¿æ²¡æœ‰è¿ç»­ç›¸é‚»çš„é‡å¤ç‚¹ï¼Œé™ä½è§†è§‰è¾¨è¯†å™ªéŸ³
            for(let i=0; i<c_span; i++) {
                let nextBlock;
                do {
                    nextBlock = Math.floor(Math.random() * 9);
                } while (nextBlock === prevBlock); 
                c_seq.push(nextBlock);
                prevBlock = nextBlock;
            }

            // ä½¿ç”¨ async/await ç¡®ä¿æ—¶é—´è½´(ITIä¸å‘ˆç°æ—¶é—´)çš„ç»å¯¹ç²¾ç¡®
            for(let i=0; i<c_span; i++) {
                await new Promise(r => setTimeout(r, 400)); // åˆºæ¿€é—´éš” ISI: 400ms
                const box = document.getElementById('cb-'+c_seq[i]);
                box.classList.add('active');
                await new Promise(r => setTimeout(r, 600)); // åˆºæ¿€å‘ˆç°æ—¶é•¿: 600ms
                box.classList.remove('active');
            }

            document.getElementById('corsi-msg').innerText = "ğŸ‘† ç°åœ¨è¯·æŒ‰åŸé¡ºåºç‚¹å‡»";
            document.getElementById('corsi-msg').style.color = "var(--blue)";
            c_isClickable = true; // è§£é”ç‚¹å‡»
        }

        function userClickCorsi(idx) {
            // é˜²æŠ¢ç­”æœºåˆ¶ï¼šé”å®šæœŸæˆ–å·²è¾¾åˆ°å½“å‰è·¨åº¦æœ€å¤§å€¼æ—¶ï¼Œæ‹¦æˆªæ— æ•ˆç‚¹å‡»
            if(!c_isClickable || c_userSeq.length >= c_span) return; 

            const box = document.getElementById('cb-'+idx); 
            box.classList.add('active'); 
            setTimeout(() => box.classList.remove('active'), 200); 
            
            c_userSeq.push(idx);

            if(c_userSeq.length === c_span) {
                c_isClickable = false; // ç­”å®Œç«‹å³é”ä½
                let isC = JSON.stringify(c_seq) === JSON.stringify(c_userSeq); 
                corsiData.trials.push({ span: c_span, correct: isC });
                
                if(isC) { 
                    corsiData.max_span = c_span; 
                    c_span++; 
                    c_fails = 0; 
                    document.getElementById('corsi-msg').innerText = "âœ… æ­£ç¡®ï¼éš¾åº¦å¢åŠ ..."; 
                    document.getElementById('corsi-msg').style.color = "var(--green)";
                } else { 
                    c_fails++; 
                    document.getElementById('corsi-msg').innerText = "âŒ é”™è¯¯ï¼"; 
                    document.getElementById('corsi-msg').style.color = "var(--red)";
                }
                
                // ç»ˆæ­¢æ¡ä»¶ï¼šè¿ç»­é”™è¯¯2æ¬¡(ä»£è¡¨åˆ°è¾¾èƒ½åŠ›è¾¹ç•Œ)ï¼Œæˆ–å®Œæˆæœ€é«˜è·¨åº¦9
                if(c_fails >= 2 || c_span > 9) { 
                    setTimeout(() => { 
                        CAS_Storage.saveModuleData('COG_Corsi', corsiData); 
                        alert(`è®°å¿†å¹¿åº¦æµ‹è¯•ç»“æŸã€‚\næ‚¨çš„æœ€å¤§è®°å¿†è·¨åº¦ä¸º: ${corsiData.max_span}`); 
                        show('menu'); 
                    }, 1000); 
                } else { 
                    setTimeout(playCorsiSeq, 1500); 
                }
            }
        }

        /* ===================================================================== */
        /* 2. Stroop æ‰§è¡ŒæŠ‘åˆ¶æ§åˆ¶ (Executive Inhibition)
           ã€ä¸´åºŠé¶å‘ã€‘: è¯„ä¼°å‰æ‰£å¸¦å›(ACC)ä¸»å¯¼çš„å†²çªæ£€æµ‹ä¸ä¼˜åŠ¿ååº”æŠ‘åˆ¶ã€‚
        /* ===================================================================== */
        const stroopStims = [ {w:'çº¢', c:'blue'}, {w:'ç»¿', c:'red'}, {w:'è“', c:'green'}, {w:'çº¢', c:'red'}, {w:'è“', c:'blue'} ];
        let stroopData = { module: "COG_Stroop", records: [] }; let s_trial=0, s_onset=0, s_curr=null;
        
        function startStroop() { s_trial = 0; stroopData.records = []; show('stroop-area'); nextStroop(); }
        function nextStroop() {
            if(s_trial >= 10) { CAS_Storage.saveModuleData('COG_Stroop', stroopData); alert("Stroop æµ‹éªŒå®Œæˆï¼"); show('menu'); return; }
            document.getElementById('stroop-controls').classList.add('hidden'); 
            document.getElementById('stroop-word').innerText = "+"; 
            document.getElementById('stroop-word').style.color = "#cbd5e1";
            setTimeout(() => { 
                s_curr = stroopStims[Math.floor(Math.random() * stroopStims.length)]; 
                document.getElementById('stroop-word').innerText = s_curr.w; 
                document.getElementById('stroop-word').style.color = s_curr.c; 
                document.getElementById('stroop-controls').classList.remove('hidden'); 
                s_onset = performance.now(); // è®°å½•åˆºæ¿€å‘ˆç°çš„ç¡®åˆ‡é«˜ç²¾åº¦æ—¶é—´æˆ³
            }, 600);
        }
        function recordStroop(c) { 
            stroopData.records.push({ correct: c === s_curr.c, rt: Math.round(performance.now() - s_onset) }); 
            s_trial++; 
            nextStroop(); 
        }

        /* ===================================================================== */
        /* 3. TMT-B è¿çº¿æµ‹è¯• (Trail Making Test - Part B)
           ã€ä¸´åºŠé¶å‘ã€‘: è¯„ä¼°æ‰§è¡Œæ§åˆ¶ç½‘ç»œ(ECN)ï¼Œç‰¹åˆ«æ˜¯ä»»åŠ¡é›†åˆ‡æ¢(Set-shifting)ä¸è®¤çŸ¥æŸ”æ€§ã€‚
        /* ===================================================================== */
        const tmtSeq = ['1','A','2','B','3','C','4','D']; 
        let tmtData = { module: "COG_TMT_B", total_time_ms: 0, errors: 0 }; 
        let t_idx=0, t_onset=0;
        
        function startTMT() {
            t_idx=0; tmtData.errors=0; show('tmt-area'); document.getElementById('tmt-target').innerText = tmtSeq[0];
            const board = document.getElementById('tmt-board'); board.innerHTML='';
            // æ¯æ¬¡ç”Ÿæˆéšæœºä½†ç›¸å¯¹å‡åŒ€çš„äºŒç»´åæ ‡åˆ†å¸ƒ
            const pos = [{x:10,y:10},{x:70,y:20},{x:20,y:70},{x:80,y:70},{x:40,y:40},{x:15,y:45},{x:85,y:40},{x:50,y:80}].sort(() => Math.random() - 0.5);
            tmtSeq.forEach((item, i) => { 
                let n = document.createElement('div'); n.className='tmt-node'; n.innerText=item; 
                n.style.left=pos[i].x+'%'; n.style.top=pos[i].y+'%'; 
                n.onclick=()=>clickTMT(n,item); board.appendChild(n); 
            }); 
            t_onset = performance.now();
        }
        function clickTMT(n, item) {
            if(n.classList.contains('clicked')) return;
            if(item === tmtSeq[t_idx]) { 
                n.classList.add('clicked'); t_idx++; 
                if(t_idx >= tmtSeq.length) { 
                    tmtData.total_time_ms = Math.round(performance.now()-t_onset); 
                    CAS_Storage.saveModuleData('COG_TMT_B', tmtData); 
                    alert("TMT-B æµ‹éªŒå®Œæˆï¼"); show('menu'); 
                } else { 
                    document.getElementById('tmt-target').innerText = tmtSeq[t_idx]; 
                } 
            } else { 
                // é”™è¯¯ç‚¹å‡»ä¸è®¡å…¥è¿›åº¦ï¼Œä½†å¢åŠ æƒ©ç½šè®¡æ¬¡ï¼ŒUI ç»™äºˆçº¢è‰²éœ‡åŠ¨åé¦ˆ
                n.classList.add('error'); tmtData.errors++; 
                setTimeout(() => n.classList.remove('error'), 400); 
            }
        }

        /* ===================================================================== */
        /* 4. DSST æ•°å­—ç¬¦å·è½¬æ¢ (Digit Symbol Substitution Test)
           ã€ä¸´åºŠé¶å‘ã€‘: è¯„ä¼°è§†è§‰æ‰«æã€å·¥ä½œè®°å¿†æ›´æ–°ä¸è§†è§‰-è¿åŠ¨åè°ƒåŠ å·¥é€Ÿåº¦ã€‚
        /* ===================================================================== */
        const dsstSymbols = ['â˜…','â–²','â—','â—†']; 
        let dsstData = { module: "COG_DSST", records: [] }; let ds_trial=0, ds_onset=0, ds_currIdx=0;
        
        function startDSST() { 
            ds_trial=0; dsstData.records=[]; show('dsst-area'); 
            const keyBoard=document.getElementById('dsst-key'); keyBoard.innerHTML=''; 
            dsstSymbols.forEach((sym, i) => { keyBoard.innerHTML += `<div class="dsst-pair">${sym}<span>${i+1}</span></div>`; }); 
            nextDSST(); 
        }
        function nextDSST() { 
            if(ds_trial >= 10) { CAS_Storage.saveModuleData('COG_DSST', dsstData); alert("DSST æµ‹éªŒå®Œæˆï¼"); show('menu'); return; } 
            ds_currIdx = Math.floor(Math.random() * 4); 
            document.getElementById('dsst-target').innerText = dsstSymbols[ds_currIdx]; 
            ds_onset = performance.now(); 
        }
        function recordDSST(num) { 
            dsstData.records.push({ correct: num === (ds_currIdx+1), rt: Math.round(performance.now() - ds_onset) }); 
            ds_trial++; nextDSST(); 
        }

        /* ===================================================================== */
        /* 5. Flanker ä¾§æŠ‘åˆ¶æ³¨æ„åŠ› (Eriksen Flanker Task)
           ã€ä¸´åºŠé¶å‘ã€‘: è¯„ä¼°é€‰æ‹©æ€§æ³¨æ„(Selective Attention)è¿‡æ»¤å™ªéŸ³ä¸å†²çªè§£å†³çš„èƒ½åŠ›ã€‚
        /* ===================================================================== */
        const flStims = [{s:'<<<<<',a:'left'},{s:'>>>>>',a:'right'},{s:'<<><<',a:'right'},{s:'>><>>',a:'left'}]; 
        let flData = { module: "COG_Flanker", records: [] }; let fl_trial=0, fl_onset=0, fl_curr=null;
        
        function startFlanker() { fl_trial=0; flData.records=[]; show('flanker-area'); nextFlanker(); }
        function nextFlanker() { 
            if(fl_trial >= 10) { CAS_Storage.saveModuleData('COG_Flanker', flData); alert("Flanker æµ‹éªŒå®Œæˆï¼"); show('menu'); return; } 
            document.getElementById('flanker-controls').classList.add('hidden'); 
            document.getElementById('flanker-stim').innerText = "+"; 
            setTimeout(() => { 
                fl_curr = flStims[Math.floor(Math.random() * 4)]; 
                document.getElementById('flanker-stim').innerText = fl_curr.s; 
                document.getElementById('flanker-controls').classList.remove('hidden'); 
                fl_onset = performance.now(); 
            }, 600); 
        }
        function recordFlanker(ans) { 
            flData.records.push({ correct: ans === fl_curr.a, rt: Math.round(performance.now()-fl_onset) }); 
            fl_trial++; nextFlanker(); 
        }

        /* ===================================================================== */
        /* 6. DCCS ç»´åº¦å˜åŒ–å¡ç‰‡åˆ†ç±» (Dimensional Change Card Sort)
           ã€ä¸´åºŠé¶å‘ã€‘: è¯„ä¼°æ‰§è¡ŒåŠŸèƒ½ä¸­çš„è®¤çŸ¥æŸ”æ€§ï¼Œå—è¯•è€…éœ€åœ¨é¢œè‰²å’Œå½¢çŠ¶ä¸¤ä¸ªç»´åº¦é—´åŠ¨æ€åˆ‡æ¢ã€‚
        /* ===================================================================== */
        const dccsT = [{e:'ğŸ”´ğŸ°',c:'red',s:'rb'},{e:'ğŸ”µğŸ°',c:'blue',s:'rb'},{e:'ğŸ”´â›µ',c:'red',s:'bt'},{e:'ğŸ”µâ›µ',c:'blue',s:'bt'}]; 
        let dccsData = { module: "COG_DCCS", records: [] }; let d_trial=0, d_onset=0, d_rule='', d_curr=null;
        
        function startDCCS() { d_trial=0; dccsData.records=[]; show('dccs-area'); nextDCCS(); }
        function nextDCCS() { 
            if(d_trial >= 10) { CAS_Storage.saveModuleData('COG_DCCS', dccsData); alert("DCCS æµ‹éªŒå®Œæˆï¼"); show('menu'); return; } 
            // éšæœºåˆ‡æ¢ç»´åº¦è§„åˆ™ï¼šé¢œè‰²æˆ–å½¢çŠ¶
            d_rule = Math.random() > 0.5 ? 'color' : 'shape'; 
            document.getElementById('dccs-rule').innerText = d_rule === 'color' ? "æŒ‰ã€é¢œè‰²ã€‘åŒ¹é…" : "æŒ‰ã€å½¢çŠ¶ã€‘åŒ¹é…"; 
            d_curr = dccsT[Math.floor(Math.random() * 4)]; 
            document.getElementById('dccs-target').innerText = d_curr.e; 
            document.getElementById('dccs-opt1').innerText = 'ğŸ”´â›µ'; 
            document.getElementById('dccs-opt2').innerText = 'ğŸ”µğŸ°'; 
            d_onset = performance.now(); 
        }
        function recordDCCS(opt) { 
            const sel = opt===0 ? {c:'red',s:'bt'} : {c:'blue',s:'rb'}; 
            let isC = (d_rule==='color' && d_curr.c===sel.c) || (d_rule==='shape' && d_curr.s===sel.s); 
            dccsData.records.push({ correct: isC, rt: Math.round(performance.now()-d_onset) }); 
            d_trial++; nextDCCS(); 
        }

        /* ===================================================================== */
        /* 7. Pattern æ¨¡å¼æ¯”è¾ƒåŠ å·¥é€Ÿåº¦ (Pattern Comparison Processing Speed)
           ã€ä¸´åºŠé¶å‘ã€‘: è¯„ä¼°åˆçº§è§†è§‰çš®å±‚ä¸è”åˆçš®å±‚å¯¹è§†è§‰ä¿¡æ¯çš„å¿«é€Ÿç‰¹å¾æå–ä¸è¾¨æèƒ½åŠ›ã€‚
        /* ===================================================================== */
        const patStims = ['A','B','M','W','p','q','ğŸ¶','ğŸ±']; 
        let patData = { module: "COG_Pattern", records: [] }; let p_trial=0, p_onset=0, p_same=false;
        
        function startPattern() { p_trial=0; patData.records=[]; show('pattern-area'); nextPattern(); }
        function nextPattern() { 
            if(p_trial >= 10) { CAS_Storage.saveModuleData('COG_Pattern', patData); alert("Pattern æµ‹éªŒå®Œæˆï¼"); show('menu'); return; } 
            document.getElementById('pattern-controls').classList.add('hidden'); 
            document.getElementById('pat-left').innerText = ""; 
            document.getElementById('pat-right').innerText = ""; 
            setTimeout(() => { 
                let i1 = patStims[Math.floor(Math.random() * patStims.length)]; 
                p_same = Math.random() > 0.5; 
                let i2 = p_same ? i1 : patStims[Math.floor(Math.random() * patStims.length)]; 
                while(!p_same && i1===i2) i2 = patStims[Math.floor(Math.random() * patStims.length)]; 
                
                document.getElementById('pat-left').innerText = i1; 
                document.getElementById('pat-right').innerText = i2; 
                document.getElementById('pattern-controls').classList.remove('hidden'); 
                p_onset = performance.now(); 
            }, 500); 
        }
        function recordPattern(ans) { 
            patData.records.push({ correct: ans === p_same, rt: Math.round(performance.now()-p_onset) }); 
            p_trial++; nextPattern(); 
        }
    </script>
</body>
</html>
