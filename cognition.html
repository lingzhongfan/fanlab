<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-COG | è®¤çŸ¥åŠŸèƒ½ä¸æ‰§è¡Œæ§åˆ¶</title>
    <style>
        /* å…¨å±€ä¸é‡ç½®æ ·å¼ */
        body { 
            font-family: -apple-system, sans-serif; 
            background: #f8fafc; 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
            touch-action: manipulation; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        .container { 
            max-width: 650px; 
            margin: 20px auto; 
            background: white; 
            padding: 35px 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }
        .module-header { 
            color: #0f172a; 
            margin-top: 0; 
            font-size: 24px; 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        
        /* æŒ‰é’®ä¸å¯¼èˆª */
        .sys-btn { 
            background: #0f172a; 
            color: white; 
            border: none; 
            padding: 18px 30px; 
            font-size: 16px; 
            font-weight: bold; 
            border-radius: 12px; 
            cursor: pointer; 
            margin: 10px auto; 
            width: 85%; 
            display: block; 
            transition: 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .sys-btn:active { transform: scale(0.98); }
        .hidden { display: none !important; }
        
        #nav-back { 
            display: inline-flex; 
            align-items: center; 
            text-decoration: none; 
            color: #3b82f6; 
            font-weight: bold; 
            margin-bottom: 15px; 
            padding: 10px 18px; 
            background: #eff6ff; 
            border-radius: 10px; 
            transition: 0.2s; 
        }
        #nav-back:active { background: #dbeafe; }

        /* ================= 1. Corsi ç©ºé—´å·¥ä½œè®°å¿† UI ================= */
        #grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            margin: 30px auto; 
            width: 320px; 
            height: 320px; 
        }
        .block { 
            background: #e2e8f0; 
            border-radius: 16px; 
            cursor: pointer; 
            transition: 0.1s; 
        }
        .block:active { background: #cbd5e1; }
        .block.active { 
            background: #3b82f6 !important; 
            transform: scale(0.92); 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1); 
        }

        /* ================= 2. Stroop æ‰§è¡ŒæŠ‘åˆ¶ UI ================= */
        #stroop-word { 
            font-size: 90px; 
            font-weight: bold; 
            margin: 50px 0; 
            min-height: 120px; 
            letter-spacing: 5px; 
        }
        .stroop-btn { 
            flex: 1; 
            padding: 25px 0; 
            font-size: 24px; 
            border-radius: 16px; 
            border: 2px solid #e2e8f0; 
            background: white; 
            cursor: pointer; 
            margin: 0 10px; 
            font-weight: bold; 
            transition: 0.1s; 
        }
        .stroop-btn:active { background: #f1f5f9; transform: scale(0.98); }

        /* ================= 3. TMT è¿çº¿æµ‹è¯• UI ================= */
        #tmt-workspace { 
            position: relative; 
            width: 100%; 
            height: 420px; 
            background: #f1f5f9; 
            border-radius: 16px; 
            border: 2px solid #cbd5e1; 
            overflow: hidden; 
            margin: 20px 0; 
        }
        .tmt-node { 
            position: absolute; 
            width: 50px; 
            height: 50px; 
            background: white; 
            border: 3px solid #0f172a; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 22px; 
            font-weight: bold; 
            cursor: pointer; 
            transform: translate(-50%, -50%); 
            transition: 0.1s; 
            z-index: 10; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .tmt-node:active { transform: translate(-50%, -50%) scale(0.9); }
        .tmt-node.active { background: #10b981; color: white; border-color: #065f46; }
        .tmt-node.error { background: #ef4444; color: white; border-color: #991b1b; animation: shake 0.3s; }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        
        @keyframes shake { 
            0%,100%{transform: translate(-50%,-50%) translateX(0);} 
            25%{transform: translate(-50%,-50%) translateX(-5px);} 
            75%{transform: translate(-50%,-50%) translateX(5px);} 
        }

        /* ================= 4. DSST å¤„ç†é€Ÿåº¦ UI ================= */
        .dsst-key { 
            display: flex; 
            justify-content: center; 
            gap: 12px; 
            margin-bottom: 30px; 
            padding: 20px; 
            background: #f1f5f9; 
            border-radius: 16px; 
        }
        .dsst-pair { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: white; 
            padding: 12px 22px; 
            border-radius: 12px; 
            border: 2px solid #cbd5e1; 
            font-size: 26px; 
            font-weight: bold; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        #dsst-target { 
            font-size: 70px; 
            margin: 40px 0; 
            font-weight: bold; 
            color: #0f172a; 
        }
        .dsst-controls { display: flex; justify-content: center; gap: 12px; }
        .dsst-btn { 
            flex: 1; 
            padding: 22px 0; 
            font-size: 26px; 
            font-weight: bold; 
            border-radius: 16px; 
            border: 3px solid #3b82f6; 
            background: white; 
            color: #3b82f6; 
            cursor: pointer; 
            transition: 0.1s; 
        }
        .dsst-btn:active { background: #3b82f6; color: white; transform: scale(0.95); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div style="text-align: left; max-width: 650px; margin: 0 auto;">
        <a href="index.html" id="nav-back">â† è¿”å›æ§åˆ¶å°</a>
    </div>
    
    <div class="container" id="menu">
        <h2 class="module-header">ğŸ§  è®¤çŸ¥åŠŸèƒ½æ ¸å¿ƒèŒƒå¼</h2>
        <button class="sys-btn" onclick="show('corsi-area'); startCorsi();">1. Corsi ç©ºé—´å·¥ä½œè®°å¿†</button>
        <button class="sys-btn" onclick="show('stroop-area'); startStroop();">2. Stroop æ‰§è¡ŒæŠ‘åˆ¶æ§åˆ¶</button>
        <button class="sys-btn" style="background:#3b82f6;" onclick="show('tmt-area'); startTMT();">3. TMT-B è®¤çŸ¥æŸ”æ€§è¿çº¿</button>
        <button class="sys-btn" style="background:#3b82f6;" onclick="show('dsst-area'); startDSST();">4. DSST æ•°å­—ç¬¦å·å¤„ç†é€Ÿåº¦</button>
    </div>

    <div class="container hidden" id="corsi-area">
        <h2 class="module-header">ç©ºé—´å·¥ä½œè®°å¿† (Corsi)</h2>
        <p id="corsi-status" style="color:#64748b; font-size:16px;">è¯·æ³¨æ„è§‚å¯Ÿæ–¹å—äº®èµ·çš„é¡ºåº...</p>
        <div id="grid"></div>
        <button class="sys-btn" style="background:#94a3b8; width:60%;" onclick="show('menu')">å¼ºè¡Œç»ˆæ­¢å¹¶è¿”å›</button>
    </div>

    <div class="container hidden" id="stroop-area">
        <h2 class="module-header">æ‰§è¡Œæ§åˆ¶ (Stroop)</h2>
        <p style="color:#64748b; font-size:18px;">å¿½ç•¥æ–‡å­—çš„å«ä¹‰ï¼Œè¯·ç‚¹å‡»æ–‡å­—å®é™…æ˜¾ç¤ºçš„<strong style="color:red;">ç‰©ç†é¢œè‰²</strong>ã€‚</p>
        <div id="stroop-word">+</div>
        <div id="stroop-controls" class="hidden" style="display:flex; justify-content:center;">
            <button class="stroop-btn" style="color:#ef4444;" onclick="recordStroop('red')">çº¢è‰² (Red)</button>
            <button class="stroop-btn" style="color:#3b82f6;" onclick="recordStroop('blue')">è“è‰² (Blue)</button>
        </div>
    </div>

    <div class="container hidden" id="tmt-area">
        <h2 class="module-header">è®¤çŸ¥æŸ”æ€§ (TMT-B)</h2>
        <p style="font-size:16px; color:#64748b;">è¯·ä¸¥æ ¼æŒ‰ <strong>1 â†’ A â†’ 2 â†’ B â†’ 3 â†’ C</strong> çš„äº¤æ›¿é¡ºåºç‚¹å‡»åœ†åœˆã€‚</p>
        <div id="tmt-workspace">
            <svg id="tmt-lines"></svg>
            <div id="tmt-nodes"></div>
        </div>
        <p id="tmt-timer" style="font-weight:bold; font-size:20px; color:#ef4444;"></p>
    </div>

    <div class="container hidden" id="dsst-area">
        <h2 class="module-header">å¤„ç†é€Ÿåº¦ (DSST)</h2>
        <div class="dsst-key">
            <div class="dsst-pair"><span>â˜…</span><span>1</span></div>
            <div class="dsst-pair"><span>â–²</span><span>2</span></div>
            <div class="dsst-pair"><span>â—</span><span>3</span></div>
            <div class="dsst-pair"><span>â– </span><span>4</span></div>
            <div class="dsst-pair"><span>âœ¦</span><span>5</span></div>
        </div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:18px; padding:0 10px;">
            <span id="dsst-score" style="color:#10b981;">å¾—åˆ†: 0</span>
            <span id="dsst-time" style="color:#ef4444;">å‰©ä½™: 60 s</span>
        </div>
        <div id="dsst-target">â˜…</div>
        <div class="dsst-controls">
            <button class="dsst-btn" onclick="recordDSST(1)">1</button>
            <button class="dsst-btn" onclick="recordDSST(2)">2</button>
            <button class="dsst-btn" onclick="recordDSST(3)">3</button>
            <button class="dsst-btn" onclick="recordDSST(4)">4</button>
            <button class="dsst-btn" onclick="recordDSST(5)">5</button>
        </div>
    </div>

    <script>
        // é¡µé¢è·¯ç”±åˆ‡æ¢
        function show(id) { 
            ['menu', 'corsi-area', 'stroop-area', 'tmt-area', 'dsst-area'].forEach(d => {
                document.getElementById(d).classList.add('hidden');
            }); 
            document.getElementById(id).classList.remove('hidden'); 
        }

        /* ==================== 1. Corsi é€»è¾‘ ==================== */
        let corsiData = { module: "Cognition_Corsi", span: 0, trials: [] }; 
        let seq = [], userSeq = [], cSpan = 2, cTrials = 0, allow = false;
        let grid = document.getElementById('grid');
        
        // åˆå§‹åŒ– 3x3 çŸ©é˜µæ ¼å­
        for(let i=0; i<9; i++) { 
            let d = document.createElement('div'); 
            d.className = 'block'; 
            d.ontouchstart = d.onmousedown = (e) => { 
                e.preventDefault(); 
                if(!allow) return; 
                
                d.classList.add('active'); 
                setTimeout(()=>d.classList.remove('active'), 150); 
                userSeq.push(i); 
                
                // åˆ¤æ–­é€»è¾‘
                if(userSeq[userSeq.length-1] !== seq[userSeq.length-1]) { 
                    allow = false; 
                    alert(`é”™è¯¯ï¼æµ‹è¯•ç»“æŸã€‚æ‚¨çš„æœ€å¤§ç©ºé—´è®°å¿†å¹¿åº¦ä¸ºï¼š${cSpan-1}`); 
                    finishCorsi(); 
                } else if(userSeq.length === seq.length) { 
                    allow = false; 
                    corsiData.span = cSpan; 
                    cSpan++; 
                    cTrials++; 
                    document.getElementById('corsi-status').innerHTML = `<span style='color:#10b981;font-weight:bold;'>æ­£ç¡®ï¼è¿›å…¥ç­‰çº§ ${cSpan}</span>`; 
                    setTimeout(runCorsi, 1000); 
                } 
            }; 
            grid.appendChild(d); 
        }

        function startCorsi() { 
            cSpan = 2; 
            cTrials = 0; 
            runCorsi(); 
        }

        function runCorsi() { 
            if(cTrials > 5) return finishCorsi(); // è®¾å®šæœ€å¤§æµ‹è¯•æ¬¡æ•°
            
            seq = []; 
            userSeq = []; 
            allow = false; 
            document.getElementById('corsi-status').innerText = `å½“å‰ç­‰çº§: ${cSpan} | ä»”ç»†è§‚å¯Ÿ`; 
            
            // éšæœºç”Ÿæˆæ— é‡å¤åºåˆ—
            let p = [0,1,2,3,4,5,6,7,8]; 
            for(let i=0; i<cSpan; i++) {
                seq.push(p.splice(Math.floor(Math.random()*p.length), 1)[0]);
            }
            
            let st = 0;
            let it = setInterval(() => { 
                document.querySelectorAll('.block').forEach(b => b.classList.remove('active')); 
                if(st < seq.length) { 
                    grid.children[seq[st]].classList.add('active'); 
                    setTimeout(() => grid.children[seq[st-1]].classList.remove('active'), 400); 
                    st++; 
                } else { 
                    clearInterval(it); 
                    document.getElementById('corsi-status').innerText = "ğŸ‘‰ ç°åœ¨è¯·å¤ç°åºåˆ—"; 
                    allow = true; 
                } 
            }, 850); 
        }

        function finishCorsi() { 
            CAS_Storage.saveModuleData('Cognition_Corsi', corsiData); 
            show('menu'); 
        }

        /* ==================== 2. Stroop é€»è¾‘ ==================== */
        const s_stim = [
            {w:'çº¢', c:'red', t:'congruent'},
            {w:'è“', c:'blue', t:'congruent'},
            {w:'çº¢', c:'blue', t:'incongruent'},
            {w:'è“', c:'red', t:'incongruent'}
        ]; 
        let stroopData = { module: "Cognition_Stroop", records: [] };
        let s_tr = 0, s_onset = 0;

        function startStroop() { 
            stroopData.records = []; 
            s_tr = 0; 
            nextStroop(); 
        }

        function nextStroop() { 
            if(s_tr >= 10) { 
                CAS_Storage.saveModuleData('Cognition_Stroop', stroopData); 
                alert("Stroop æµ‹è¯•å®Œæˆï¼æ•°æ®å·²å…¥åº“ã€‚"); 
                show('menu'); 
                return; 
            } 
            document.getElementById('stroop-controls').classList.add('hidden'); 
            document.getElementById('stroop-word').innerText = "+"; 
            document.getElementById('stroop-word').style.color = "#333"; 
            
            setTimeout(() => { 
                let stim = s_stim[Math.floor(Math.random() * 4)]; 
                document.getElementById('stroop-word').innerText = stim.w; 
                document.getElementById('stroop-word').style.color = stim.c; 
                document.getElementById('stroop-word').dataset.t = stim.c; 
                document.getElementById('stroop-word').dataset.type = stim.t; 
                document.getElementById('stroop-controls').classList.remove('hidden'); 
                s_onset = performance.now(); 
            }, 600); 
        }

        function recordStroop(res) { 
            let rt = performance.now() - s_onset; 
            let tar = document.getElementById('stroop-word').dataset.t; 
            stroopData.records.push({ 
                trial: s_tr + 1, 
                condition: document.getElementById('stroop-word').dataset.type, 
                correct: res === tar, 
                rt_ms: Math.round(rt) 
            }); 
            s_tr++; 
            nextStroop(); 
        }

        /* ==================== 3. TMT è¿çº¿é€»è¾‘ ==================== */
        const tmtSequence = [ 
            {id:1, lbl:'1', x:15, y:20}, 
            {id:2, lbl:'A', x:40, y:80}, 
            {id:3, lbl:'2', x:80, y:30}, 
            {id:4, lbl:'B', x:85, y:85}, 
            {id:5, lbl:'3', x:15, y:70}, 
            {id:6, lbl:'C', x:50, y:45} 
        ]; 
        let tmtData = { module: "Cognition_TMT_B", total_time_ms: 0, path: [] };
        let tmtCurrent = 0, tmtStartTime = 0, tmtTimerId, tmtLastNode = null;

        function startTMT() { 
            tmtData.path = []; 
            tmtCurrent = 0; 
            tmtLastNode = null; 
            document.getElementById('tmt-lines').innerHTML = ''; 
            
            let container = document.getElementById('tmt-nodes'); 
            container.innerHTML = ''; 
            
            // æ¸²æŸ“èŠ‚ç‚¹
            tmtSequence.forEach((node, idx) => { 
                let el = document.createElement('div'); 
                el.className = 'tmt-node'; 
                el.innerText = node.lbl; 
                el.style.left = node.x + '%'; 
                el.style.top = node.y + '%'; 
                el.ontouchstart = el.onmousedown = (e) => { 
                    e.preventDefault(); 
                    hitTMTNode(idx, el, node); 
                }; 
                container.appendChild(el); 
            }); 
            
            tmtStartTime = performance.now(); 
            tmtTimerId = setInterval(() => { 
                document.getElementById('tmt-timer').innerText = `è€—æ—¶: ${((performance.now() - tmtStartTime)/1000).toFixed(1)} s`; 
            }, 100); 
        }

        function hitTMTNode(idx, el, nodeData) { 
            if (idx === tmtCurrent) { 
                // ç‚¹å‡»æ­£ç¡®
                el.classList.add('active'); 
                tmtData.path.push({ 
                    node: nodeData.lbl, 
                    rt_ms: Math.round(performance.now() - tmtStartTime) 
                }); 
                
                // ç»˜åˆ¶è¿çº¿ SVG
                if (tmtLastNode) { 
                    let svg = document.getElementById('tmt-lines'); 
                    let line = document.createElementNS('http://www.w3.org/2000/svg','line'); 
                    line.setAttribute('x1', tmtLastNode.x + '%'); 
                    line.setAttribute('y1', tmtLastNode.y + '%'); 
                    line.setAttribute('x2', nodeData.x + '%'); 
                    line.setAttribute('y2', nodeData.y + '%'); 
                    line.setAttribute('stroke', '#10b981'); 
                    line.setAttribute('stroke-width', '5'); 
                    line.setAttribute('stroke-linecap', 'round'); 
                    svg.appendChild(line); 
                } 
                
                tmtLastNode = nodeData; 
                tmtCurrent++; 
                
                if (tmtCurrent === tmtSequence.length) { 
                    clearInterval(tmtTimerId); 
                    tmtData.total_time_ms = Math.round(performance.now() - tmtStartTime); 
                    CAS_Storage.saveModuleData('Cognition_TMT_B', tmtData); 
                    setTimeout(() => { 
                        alert(`è¿çº¿å®Œæˆï¼æ€»è€—æ—¶ ${tmtData.total_time_ms} ms`); 
                        show('menu'); 
                    }, 600); 
                } 
            } else if (idx > tmtCurrent) { 
                // ç‚¹å‡»é”™è¯¯ï¼Œè§¦å‘çº¢è‰²éœ‡åŠ¨åŠ¨ç”»
                el.classList.add('error'); 
                setTimeout(() => el.classList.remove('error'), 300); 
            } 
        }

        /* ==================== 4. DSST é€»è¾‘ ==================== */
        const dsstMap = { 'â˜…': 1, 'â–²': 2, 'â—': 3, 'â– ': 4, 'âœ¦': 5 };
        const dsstSymbols = Object.keys(dsstMap); 
        let dsstData = { module: "Cognition_DSST", correct_count: 0, total_trials: 0, records: [] };
        let dsstTimeLeft = 60, dsstTimerId, dsstOnset = 0, currentDsstTarget = '';

        function startDSST() { 
            dsstData.correct_count = 0; 
            dsstData.total_trials = 0; 
            dsstData.records = []; 
            dsstTimeLeft = 60; 
            
            document.getElementById('dsst-score').innerText = 'å¾—åˆ†: 0'; 
            document.getElementById('dsst-time').style.color = '#ef4444'; 
            
            dsstTimerId = setInterval(() => { 
                dsstTimeLeft--; 
                document.getElementById('dsst-time').innerText = `å‰©ä½™: ${dsstTimeLeft} s`; 
                // å€’æ•°10ç§’æ—¶è­¦å‘ŠåŠ¨ç”»
                if (dsstTimeLeft <= 10) {
                    document.getElementById('dsst-time').style.transform = 'scale(1.1)'; 
                }
                if (dsstTimeLeft <= 0) finishDSST(); 
            }, 1000); 
            nextDSST(); 
        }

        function nextDSST() { 
            currentDsstTarget = dsstSymbols[Math.floor(Math.random() * dsstSymbols.length)]; 
            document.getElementById('dsst-target').innerText = currentDsstTarget; 
            dsstOnset = performance.now(); 
        }

        function recordDSST(num) { 
            if (dsstTimeLeft <= 0) return; 
            
            let rt = performance.now() - dsstOnset; 
            let isCorrect = dsstMap[currentDsstTarget] === num; 
            dsstData.total_trials++; 
            
            if (isCorrect) { 
                dsstData.correct_count++; 
                document.getElementById('dsst-score').innerText = `å¾—åˆ†: ${dsstData.correct_count}`; 
            } 
            
            dsstData.records.push({ 
                symbol: currentDsstTarget, 
                response: num, 
                correct: isCorrect, 
                rt_ms: Math.round(rt) 
            }); 
            nextDSST(); 
        }

        function finishDSST() { 
            clearInterval(dsstTimerId); 
            document.getElementById('dsst-time').style.transform = 'scale(1)'; 
            CAS_Storage.saveModuleData('Cognition_DSST', dsstData); 
            alert(`æ—¶é—´åˆ°ï¼æ‚¨åœ¨60ç§’å†…æ­£ç¡®åŒ¹é…äº† ${dsstData.correct_count} ä¸ªç¬¦å·ã€‚`); 
            show('menu'); 
        }
    </script>
</body>
</html>
