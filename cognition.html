<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-COG | å…¨ç»´åº¦è®¤çŸ¥åŠŸèƒ½è¯„ä¼° (ç§‘ç ”ä¸´åºŠç‰ˆ v4.0)</title>
    <style>
        /* ==================== UI åŸºç¡€ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --orange: #f59e0b; --slate: #64748b; }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; touch-action: manipulation; user-select: none; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--blue); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.5; }
        
        .sys-btn { width: 100%; padding: 18px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; display: flex; align-items: center; gap: 12px; }
        .btn-menu { background: var(--light-blue); color: var(--blue); border: 1px solid #e0e7ff; }
        .btn-menu:hover { background: var(--blue); color: white; transform: translateX(5px); }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-large { padding: 25px; font-size: 22px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 20px; color: var(--primary); cursor: pointer; font-weight: bold; transition: 0.1s;}
        .btn-large:active { background: var(--blue); color: white; border-color: var(--blue); transform: scale(0.96); }

        /* ==================== ä¸´åºŠèŒƒå¼ä¸“å±è§†å›¾ ==================== */
        
        /* å€’è®¡æ—¶é¢æ¿ (ç”¨äº DSST, Pattern ç­‰é™æ—¶ä»»åŠ¡) */
        .timer-board { background: #fff1f2; color: var(--red); font-size: 24px; font-weight: bold; text-align: center; padding: 10px; border-radius: 12px; border: 2px dashed #fecdd3; margin-bottom: 20px; font-family: monospace;}
        
        /* Corsi */
        .corsi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 350px; margin: 30px auto; }
        .corsi-block { aspect-ratio: 1; background: #e2e8f0; border-radius: 16px; cursor: pointer; transition: 0.1s; }
        .corsi-block.active { background: var(--blue); transform: scale(0.95); box-shadow: 0 0 15px rgba(79, 70, 229, 0.5); }
        
        /* Stroop / Flanker / DCCS ä¸­å¤®åˆºæ¿€ */
        .stim-large { font-size: 80px; font-weight: bold; text-align: center; margin: 50px 0; letter-spacing: 5px; }
        .flanker-stim { font-size: 65px; font-weight: bold; letter-spacing: 12px; text-align: center; margin: 50px 0; font-family: monospace; }
        
        /* TMT-B (25èŠ‚ç‚¹ä¸´åºŠç‰ˆ) */
        #tmt-board { position: relative; width: 100%; height: 500px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 20px; overflow: hidden; margin-top: 15px;}
        .tmt-node { position: absolute; width: 40px; height: 40px; background: white; border: 3px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05);}
        .tmt-node.clicked { background: var(--green); color: white; border-color: var(--green); box-shadow: 0 0 10px rgba(16,185,129,0.5);}
        .tmt-node.error { background: var(--red); color: white; border-color: var(--red); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* DSST / Pattern */
        .dsst-key { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; background: #f1f5f9; padding: 15px; border-radius: 16px; flex-wrap: wrap;}
        .dsst-pair { text-align: center; background: white; padding: 8px 15px; border-radius: 10px; border: 1px solid #cbd5e1; font-size: 22px; }
        .dsst-pair span { display: block; font-size: 14px; color: var(--blue); font-weight: bold; border-top: 1px dashed #cbd5e1; margin-top: 5px; padding-top: 5px; }
        
        .dccs-rule { text-align: center; font-size: 24px; font-weight: bold; color: var(--red); margin-bottom: 20px; padding: 15px; background: #fff1f2; border-radius: 16px; border: 2px dashed #fecdd3; }
        .dccs-card { background: white; border: 2px solid #cbd5e1; border-radius: 20px; padding: 30px; text-align: center; font-size: 60px; cursor: pointer; }
        
        .pattern-box { display: flex; justify-content: center; gap: 40px; margin: 30px 0; }
        .pattern-item { font-size: 80px; background: #f8fafc; padding: 30px; border-radius: 24px; border: 2px solid #cbd5e1; }
        
        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .trial-counter { text-align: center; font-size: 14px; color: var(--slate); font-weight: bold; margin-bottom: 10px; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ§  è®¤çŸ¥ä¸æ‰§è¡Œæ§åˆ¶ (Clinical V4.0)</h2>
            <p>åŸºäº NIH Toolbox æ ‡å‡†ã€‚å·²å‡çº§ä¸ºä¸´åºŠçº§å‚æ•°ï¼šå¤§å®¹é‡è¯•æ¬¡ã€ä¸å¹³è¡¡å†²çªè®¾è®¡ä¸é«˜å‹é™æ—¶æµ‹é‡ã€‚</p>
        </div>
        
        <h3 style="font-size: 14px; color: var(--slate); text-transform: uppercase;">â–¶ è®°å¿†ä¸æ‰§è¡Œç½‘ç»œ (Memory & Executive)</h3>
        <button class="sys-btn btn-menu" onclick="startCorsi()">ğŸ§© 1. Corsi ç©ºé—´å·¥ä½œè®°å¿† (è‡ªé€‚åº”è¾¹ç•Œ)</button>
        <button class="sys-btn btn-menu" onclick="startTMT()">ğŸ”— 2. TMT-B è¿çº¿æµ‹è¯• (ä¸´åºŠæ ‡å‡† 25èŠ‚ç‚¹)</button>
        <button class="sys-btn btn-menu" onclick="startStroop()">ğŸš¥ 3. Stroop è¯è‰²å¹²æ‰° (30è¯•æ¬¡ 7:3å†²çªæ¯”)</button>
        <button class="sys-btn btn-menu" onclick="startFlanker()">ğŸ¯ 4. Flanker ä¾§æŠ‘åˆ¶ (30è¯•æ¬¡ 7:3å†²çªæ¯”)</button>
        <button class="sys-btn btn-menu" onclick="startDCCS()">ğŸ”„ 5. DCCS ç»´åº¦å˜åŒ–æŸ”æ€§ (30è¯•æ¬¡)</button>
        
        <h3 style="font-size: 14px; color: var(--slate); margin-top:25px; text-transform: uppercase;">â–¶ åŠ å·¥é€Ÿåº¦ä¸æ•é”åº¦ (Processing Speed)</h3>
        <button class="sys-btn btn-menu" onclick="startDSST()">ğŸ”¢ 6. DSST æ•°å­—ç¬¦å·è½¬æ¢ (90ç§’é«˜å‹é™æ—¶)</button>
        <button class="sys-btn btn-menu" onclick="startPattern()">âš¡ 7. Pattern æ¨¡å¼æ¯”è¾ƒåŠ å·¥ (90ç§’é«˜å‹é™æ—¶)</button>
    </div>

    <div class="container hidden" id="corsi-area">
        <div class="module-header"><h2>Corsi ç©ºé—´è·¨åº¦</h2><p>æµ‹è¯•è§†ç©ºé—´å·¥ä½œè®°å¿†å®¹é‡ã€‚è¯·è®°ä½æ–¹å—é—ªçƒçš„é¡ºåºï¼Œé—ªçƒç»“æŸåæŒ‰åŸé¡ºåºç‚¹å‡»ã€‚</p></div>
        <div style="text-align:center; font-weight:bold; color:var(--blue); font-size:18px;" id="corsi-level">å½“å‰å¹¿åº¦: 3</div>
        <div class="corsi-grid" id="corsi-grid"></div>
        <p style="text-align:center; color:var(--slate); font-size:15px; font-weight:bold;" id="corsi-msg">å‡†å¤‡å¼€å§‹...</p>
    </div>

    <div class="container hidden" id="tmt-area">
        <div class="module-header"><h2>TMT-B (25 èŠ‚ç‚¹ä¸´åºŠç‰ˆ)</h2><p>æµ‹è¯•è®¤çŸ¥æŸ”æ€§ä¸ä»»åŠ¡é›†åˆ‡æ¢èƒ½åŠ›ã€‚è¯·æŒ‰ã€æ•°å­—-å­—æ¯ã€‘äº¤æ›¿é¡ºåºç‚¹å‡» (1 â” A â” 2 â” B... 12 â” L â” 13)</p></div>
        <div style="font-weight:bold; color:var(--blue); display:flex; justify-content:space-between; align-items:center;">
            <span>å¯»æ‰¾ç›®æ ‡: <span id="tmt-target" style="font-size:28px; color:var(--red);">1</span></span>
            <span id="tmt-timer" style="font-family:monospace; font-size:20px; color:var(--slate);">0.0s</span>
        </div>
        <div id="tmt-board"></div>
    </div>

    <div class="container hidden" id="stroop-area">
        <div class="module-header"><h2>Stroop æ‰§è¡ŒæŠ‘åˆ¶</h2><p>æµ‹è¯•å‰æ‰£å¸¦å›(ACC)çš„å†²çªç›‘æµ‹ä¸ä¼˜åŠ¿ååº”æŠ‘åˆ¶ã€‚è¯·å¿½ç•¥æ–‡å­—å«ä¹‰ï¼Œç‚¹å‡»æ–‡å­—å®é™…æ˜¾ç¤ºçš„ã€é¢œè‰²ã€‘ã€‚</p></div>
        <div class="trial-counter" id="stroop-counter">è¿›åº¦: 1 / 30</div>
        <div class="stim-large" id="stroop-word">+</div>
        <div class="grid-layout hidden" id="stroop-controls" style="grid-template-columns: 1fr 1fr 1fr;">
            <button class="btn-large" style="color:var(--red);" onclick="recordStroop('red')">çº¢</button>
            <button class="btn-large" style="color:var(--green);" onclick="recordStroop('green')">ç»¿</button>
            <button class="btn-large" style="color:var(--blue);" onclick="recordStroop('blue')">è“</button>
        </div>
    </div>

    <div class="container hidden" id="flanker-area">
        <div class="module-header"><h2>Flanker ä¾§æŠ‘åˆ¶</h2><p>æµ‹è¯•é€‰æ‹©æ€§æ³¨æ„ç½‘ç»œã€‚è¯·åªåˆ¤æ–­ã€æœ€ä¸­é—´ç®­å¤´ã€‘çš„æ–¹å‘ï¼Œå¿½ç•¥ä¸¤è¾¹çš„å¹²æ‰°ç®­å¤´ã€‚</p></div>
        <div class="trial-counter" id="flanker-counter">è¿›åº¦: 1 / 30</div>
        <div class="flanker-stim" id="flanker-stim">+</div>
        <div class="grid-layout hidden" id="flanker-controls">
            <button class="btn-large" onclick="recordFlanker('left')">â† å·¦</button>
            <button class="btn-large" onclick="recordFlanker('right')">å³ â†’</button>
        </div>
    </div>

    <div class="container hidden" id="dccs-area">
        <div class="module-header"><h2>DCCS ç»´åº¦å˜åŒ–å¡ç‰‡</h2><p>æµ‹è¯•è§„åˆ™åˆ‡æ¢æ§åˆ¶ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šæ–¹æç¤ºçš„è§„åˆ™ï¼ˆé¢œè‰²æˆ–å½¢çŠ¶ï¼‰å¯¹å¡ç‰‡è¿›è¡ŒåŒ¹é…ã€‚</p></div>
        <div class="trial-counter" id="dccs-counter">è¿›åº¦: 1 / 30</div>
        <div class="dccs-rule" id="dccs-rule">æŒ‰ã€é¢œè‰²ã€‘åŒ¹é…</div>
        <div class="stim-large" id="dccs-target">ğŸ°</div>
        <div class="grid-layout" id="dccs-controls">
            <div class="dccs-card" onclick="recordDCCS(0)" id="dccs-opt1">ğŸ”´â›µ</div>
            <div class="dccs-card" onclick="recordDCCS(1)" id="dccs-opt2">ğŸ”µğŸ°</div>
        </div>
    </div>

    <div class="container hidden" id="dsst-area">
        <div class="module-header"><h2>DSST ç¬¦å·è½¬æ¢ (90ç§’é™æ—¶)</h2><p>æµ‹è¯•è§†è§‰-è¿åŠ¨åè°ƒåŠ å·¥é€Ÿåº¦ã€‚è¯·æ ¹æ®ä¸Šæ–¹å¯¹åº”è§„åˆ™ï¼Œç”¨æœ€å¿«é€Ÿåº¦ä¸ºä¸­é—´ç¬¦å·é€‰æ‹©æ­£ç¡®æ•°å­—ã€‚</p></div>
        <div class="timer-board" id="dsst-timer">â³ å‰©ä½™æ—¶é—´: 90 ç§’</div>
        <div class="dsst-key" id="dsst-key"></div>
        <div class="stim-large" id="dsst-target" style="margin: 30px 0;">â˜…</div>
        <div class="grid-layout" id="dsst-controls" style="grid-template-columns: repeat(5, 1fr);">
            <button class="btn-large" onclick="recordDSST(1)">1</button>
            <button class="btn-large" onclick="recordDSST(2)">2</button>
            <button class="btn-large" onclick="recordDSST(3)">3</button>
            <button class="btn-large" onclick="recordDSST(4)">4</button>
            <button class="btn-large" onclick="recordDSST(5)">5</button>
        </div>
    </div>

    <div class="container hidden" id="pattern-area">
        <div class="module-header"><h2>Pattern åŠ å·¥é€Ÿåº¦ (90ç§’é™æ—¶)</h2><p>æµ‹è¯•åˆçº§è§†è§‰ä¿¡æ¯æå–é€Ÿåº¦ã€‚è¯·ä»¥æœ€å¿«é€Ÿåº¦åˆ¤æ–­ä¸¤ä¸ªå›¾æ¡ˆæ˜¯å¦ã€å®Œå…¨ç›¸åŒã€‘ã€‚</p></div>
        <div class="timer-board" id="pattern-timer">â³ å‰©ä½™æ—¶é—´: 90 ç§’</div>
        <div class="pattern-box" id="pattern-stim">
            <div class="pattern-item" id="pat-left">A</div>
            <div class="pattern-item" id="pat-right">A</div>
        </div>
        <div class="grid-layout hidden" id="pattern-controls">
            <button class="btn-large" style="color:var(--green);" onclick="recordPattern(true)">ç›¸åŒ</button>
            <button class="btn-large" style="color:var(--red);" onclick="recordPattern(false)">ä¸åŒ</button>
        </div>
    </div>

    <script>
        // DOM è§†çª—è·¯ç”±
        function show(id) {
            ['menu','corsi-area','stroop-area','tmt-area','dsst-area','flanker-area','dccs-area','pattern-area'].forEach(d => {
                const el = document.getElementById(d); if(el) el.classList.add('hidden');
            }); 
            document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0);
        }

        // é€šç”¨æ‰“ä¹±æ•°ç»„ç®—æ³• (Fisher-Yates)
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /* ================= 1. Corsi ç©ºé—´å·¥ä½œè®°å¿† (åŸæ ·ä¿ç•™é«˜ç²¾åº¦æ—¶åºé”) ================= */
        let corsiData = { module: "COG_Corsi", max_span: 0, trials: [] };
        let c_seq = [], c_userSeq = [], c_span = 3, c_fails = 0, c_isClickable = false;

        function startCorsi() {
            c_span = 3; c_fails = 0; corsiData.trials = []; corsiData.max_span = 0;
            const grid = document.getElementById('corsi-grid'); grid.innerHTML = '';
            for(let i=0; i<9; i++) { 
                let box = document.createElement('div'); box.className = 'corsi-block'; 
                box.id = 'cb-'+i; box.onclick = () => userClickCorsi(i); grid.appendChild(box); 
            }
            show('corsi-area'); setTimeout(playCorsiSeq, 800);
        }

        async function playCorsiSeq() {
            c_isClickable = false; 
            document.getElementById('corsi-level').innerText = `å½“å‰å¹¿åº¦: ${c_span}`; 
            document.getElementById('corsi-msg').innerText = "ğŸ‘€ è¯·è§‚å¯Ÿé—ªçƒé¡ºåº..."; document.getElementById('corsi-msg').style.color = "var(--slate)";
            c_seq = []; c_userSeq = []; let prevBlock = -1;

            for(let i=0; i<c_span; i++) {
                let nextBlock;
                do { nextBlock = Math.floor(Math.random() * 9); } while (nextBlock === prevBlock); 
                c_seq.push(nextBlock); prevBlock = nextBlock;
            }

            for(let i=0; i<c_span; i++) {
                await new Promise(r => setTimeout(r, 400)); 
                const box = document.getElementById('cb-'+c_seq[i]); box.classList.add('active');
                await new Promise(r => setTimeout(r, 600)); 
                box.classList.remove('active');
            }

            document.getElementById('corsi-msg').innerText = "ğŸ‘† ç°åœ¨è¯·æŒ‰åŸé¡ºåºç‚¹å‡»"; document.getElementById('corsi-msg').style.color = "var(--blue)";
            c_isClickable = true;
        }

        function userClickCorsi(idx) {
            if(!c_isClickable || c_userSeq.length >= c_span) return; 
            const box = document.getElementById('cb-'+idx); box.classList.add('active'); setTimeout(() => box.classList.remove('active'), 200); 
            c_userSeq.push(idx);

            if(c_userSeq.length === c_span) {
                c_isClickable = false; 
                let isC = JSON.stringify(c_seq) === JSON.stringify(c_userSeq); 
                corsiData.trials.push({ span: c_span, correct: isC });
                
                if(isC) { 
                    corsiData.max_span = c_span; c_span++; c_fails = 0; 
                    document.getElementById('corsi-msg').innerText = "âœ… æ­£ç¡®ï¼éš¾åº¦å¢åŠ ..."; document.getElementById('corsi-msg').style.color = "var(--green)";
                } else { 
                    c_fails++; document.getElementById('corsi-msg').innerText = "âŒ é”™è¯¯ï¼"; document.getElementById('corsi-msg').style.color = "var(--red)";
                }
                
                if(c_fails >= 2 || c_span > 9) { 
                    setTimeout(() => { CAS_Storage.saveModuleData('COG_Corsi', corsiData); alert(`è®°å¿†å¹¿åº¦æµ‹éªŒç»“æŸã€‚\næœ€å¤§è·¨åº¦: ${corsiData.max_span}`); show('menu'); }, 1000); 
                } else { setTimeout(playCorsiSeq, 1500); }
            }
        }

        /* ================= 2. TMT-B (25 èŠ‚ç‚¹ä¸´åºŠæ ‡å‡†ç‰ˆ) ================= */
        // åºåˆ—: 1 åˆ° 13ï¼ŒA åˆ° L
        const tmtSeq = ['1','A','2','B','3','C','4','D','5','E','6','F','7','G','8','H','9','I','10','J','11','K','12','L','13']; 
        let tmtData = { module: "COG_TMT_B", total_time_ms: 0, errors: 0 }; 
        let t_idx = 0, t_onset = 0, tmtTimerInterval = null;
        
        // é¢„è®¾ 25 ä¸ªé˜²é‡å æ‰“æ•£çš„ä¼ªéšæœºåæ ‡ (ç™¾åˆ†æ¯”è¡¨ç¤º)
        const tmtCoords = [
            {x:5,y:5}, {x:25,y:8}, {x:50,y:5}, {x:75,y:10}, {x:90,y:8},
            {x:12,y:25}, {x:35,y:28}, {x:60,y:22}, {x:85,y:26}, {x:5,y:45},
            {x:25,y:48}, {x:48,y:40}, {x:70,y:45}, {x:92,y:42}, {x:15,y:65},
            {x:38,y:60}, {x:58,y:68}, {x:80,y:62}, {x:8,y:85}, {x:28,y:82},
            {x:52,y:88}, {x:75,y:85}, {x:92,y:80}, {x:45,y:15}, {x:65,y:55}
        ];

        function startTMT() {
            t_idx=0; tmtData.errors=0; show('tmt-area'); document.getElementById('tmt-target').innerText = tmtSeq[0];
            const board = document.getElementById('tmt-board'); board.innerHTML='';
            
            let pos = shuffle([...tmtCoords]); // æ¯æ¬¡æ‰“ä¹±è¿™25ä¸ªç»å¯¹é˜²é‡å çš„åæ ‡
            
            tmtSeq.forEach((item, i) => { 
                let n = document.createElement('div'); n.className='tmt-node'; n.innerText=item; 
                n.style.left=pos[i].x+'%'; n.style.top=pos[i].y+'%'; 
                n.onclick=()=>clickTMT(n,item); board.appendChild(n); 
            }); 
            
            t_onset = performance.now();
            tmtTimerInterval = setInterval(() => {
                document.getElementById('tmt-timer').innerText = ((performance.now() - t_onset) / 1000).toFixed(1) + 's';
            }, 100);
        }
        function clickTMT(n, item) {
            if(n.classList.contains('clicked')) return;
            if(item === tmtSeq[t_idx]) { 
                n.classList.add('clicked'); t_idx++; 
                if(t_idx >= tmtSeq.length) { 
                    clearInterval(tmtTimerInterval);
                    tmtData.total_time_ms = Math.round(performance.now()-t_onset); 
                    CAS_Storage.saveModuleData('COG_TMT_B', tmtData); 
                    alert(`TMT-B æµ‹éªŒå®Œæˆï¼\n\næ€»è€—æ—¶: ${(tmtData.total_time_ms/1000).toFixed(1)} ç§’\né”™è¯¯æ¬¡æ•°: ${tmtData.errors}`); show('menu'); 
                } else { 
                    document.getElementById('tmt-target').innerText = tmtSeq[t_idx]; 
                } 
            } else { 
                n.classList.add('error'); tmtData.errors++; 
                setTimeout(() => n.classList.remove('error'), 400); 
            }
        }

        /* ================= 3. Stroop (30 è¯•æ¬¡ï¼Œ7:3 å†²çªè®¾è®¡) ================= */
        const TOTAL_STROOP = 30;
        let stroopData = { module: "COG_Stroop", records: [] }; let s_trial=0, s_onset=0, s_curr=null;
        let stroopSequence = [];

        function generateStroopSequence() {
            // ç”Ÿæˆ 21ä¸ªç›¸å®¹(Congruent)ï¼Œ9ä¸ªä¸ç›¸å®¹(Incongruent)
            let seq = [];
            const colors = ['red', 'green', 'blue'];
            const wMap = { 'red': 'çº¢', 'green': 'ç»¿', 'blue': 'è“' };
            for(let i=0; i<21; i++) { let c = colors[i%3]; seq.push({w: wMap[c], c: c, type: 'congruent'}); }
            for(let i=0; i<9; i++) { 
                let c = colors[i%3]; let wColor = colors[(i+1)%3];
                seq.push({w: wMap[wColor], c: c, type: 'incongruent'}); 
            }
            return shuffle(seq);
        }

        function startStroop() { s_trial = 0; stroopData.records = []; stroopSequence = generateStroopSequence(); show('stroop-area'); nextStroop(); }
        
        function nextStroop() {
            if(s_trial >= TOTAL_STROOP) { CAS_Storage.saveModuleData('COG_Stroop', stroopData); alert("Stroop æµ‹éªŒå®Œæˆï¼"); show('menu'); return; }
            document.getElementById('stroop-counter').innerText = `è¿›åº¦: ${s_trial + 1} / ${TOTAL_STROOP}`;
            document.getElementById('stroop-controls').classList.add('hidden'); 
            document.getElementById('stroop-word').innerText = "+"; document.getElementById('stroop-word').style.color = "#cbd5e1";
            
            setTimeout(() => { 
                s_curr = stroopSequence[s_trial]; 
                document.getElementById('stroop-word').innerText = s_curr.w; document.getElementById('stroop-word').style.color = s_curr.c; 
                document.getElementById('stroop-controls').classList.remove('hidden'); 
                s_onset = performance.now(); 
            }, 500);
        }
        function recordStroop(c) { 
            stroopData.records.push({ trial_type: s_curr.type, correct: c === s_curr.c, rt: Math.round(performance.now() - s_onset) }); 
            s_trial++; nextStroop(); 
        }

        /* ================= 4. Flanker (30 è¯•æ¬¡ï¼Œ7:3 å†²çªè®¾è®¡) ================= */
        const TOTAL_FLANKER = 30;
        let flData = { module: "COG_Flanker", records: [] }; let fl_trial=0, fl_onset=0, fl_curr=null;
        let flankerSequence = [];

        function generateFlankerSequence() {
            let seq = [];
            for(let i=0; i<11; i++) seq.push({s:'<<<<<',a:'left', type:'congruent'});
            for(let i=0; i<10; i++) seq.push({s:'>>>>>',a:'right', type:'congruent'});
            for(let i=0; i<5; i++) seq.push({s:'<<><<',a:'right', type:'incongruent'});
            for(let i=0; i<4; i++) seq.push({s:'>><>>',a:'left', type:'incongruent'});
            return shuffle(seq);
        }

        function startFlanker() { fl_trial=0; flData.records=[]; flankerSequence = generateFlankerSequence(); show('flanker-area'); nextFlanker(); }
        
        function nextFlanker() { 
            if(fl_trial >= TOTAL_FLANKER) { CAS_Storage.saveModuleData('COG_Flanker', flData); alert("Flanker æµ‹éªŒå®Œæˆï¼"); show('menu'); return; } 
            document.getElementById('flanker-counter').innerText = `è¿›åº¦: ${fl_trial + 1} / ${TOTAL_FLANKER}`;
            document.getElementById('flanker-controls').classList.add('hidden'); 
            document.getElementById('flanker-stim').innerText = "+"; 
            
            setTimeout(() => { 
                fl_curr = flankerSequence[fl_trial]; 
                document.getElementById('flanker-stim').innerText = fl_curr.s; 
                document.getElementById('flanker-controls').classList.remove('hidden'); 
                fl_onset = performance.now(); 
            }, 500); 
        }
        function recordFlanker(ans) { 
            flData.records.push({ trial_type: fl_curr.type, correct: ans === fl_curr.a, rt: Math.round(performance.now()-fl_onset) }); 
            fl_trial++; nextFlanker(); 
        }

        /* ================= 5. DCCS (30 è¯•æ¬¡ï¼Œè®¡ç®—åˆ‡æ¢æŸè€—) ================= */
        const TOTAL_DCCS = 30;
        const dccsT = [{e:'ğŸ”´ğŸ°',c:'red',s:'rb'},{e:'ğŸ”µğŸ°',c:'blue',s:'rb'},{e:'ğŸ”´â›µ',c:'red',s:'bt'},{e:'ğŸ”µâ›µ',c:'blue',s:'bt'}]; 
        let dccsData = { module: "COG_DCCS", records: [] }; let d_trial=0, d_onset=0, d_rule='', d_curr=null, prev_rule='';
        
        function startDCCS() { d_trial=0; dccsData.records=[]; prev_rule=''; show('dccs-area'); nextDCCS(); }
        
        function nextDCCS() { 
            if(d_trial >= TOTAL_DCCS) { CAS_Storage.saveModuleData('COG_DCCS', dccsData); alert("DCCS æµ‹éªŒå®Œæˆï¼"); show('menu'); return; } 
            document.getElementById('dccs-counter').innerText = `è¿›åº¦: ${d_trial + 1} / ${TOTAL_DCCS}`;
            
            // ç¡®ä¿æœ‰ä¸€å®šæ¦‚ç‡å‘ç”Ÿè§„åˆ™ Switch
            if (d_trial === 0) d_rule = Math.random() > 0.5 ? 'color' : 'shape';
            else d_rule = Math.random() > 0.65 ? (prev_rule === 'color' ? 'shape' : 'color') : prev_rule;

            document.getElementById('dccs-rule').innerText = d_rule === 'color' ? "æŒ‰ã€é¢œè‰²ã€‘åŒ¹é…" : "æŒ‰ã€å½¢çŠ¶ã€‘åŒ¹é…"; 
            d_curr = dccsT[Math.floor(Math.random() * 4)]; 
            document.getElementById('dccs-target').innerText = d_curr.e; 
            d_onset = performance.now(); 
        }
        function recordDCCS(opt) { 
            const sel = opt===0 ? {c:'red',s:'bt'} : {c:'blue',s:'rb'}; 
            let isC = (d_rule==='color' && d_curr.c===sel.c) || (d_rule==='shape' && d_curr.s===sel.s); 
            dccsData.records.push({ rule_type: d_rule === prev_rule ? 'repeat' : 'switch', correct: isC, rt: Math.round(performance.now()-d_onset) }); 
            prev_rule = d_rule; d_trial++; nextDCCS(); 
        }

        /* ================= 6. DSST (90 ç§’é™æ—¶é«˜å‹èŒƒå¼) ================= */
        const DSST_TIME_LIMIT = 90; 
        const dsstSymbols = ['â˜…','â–²','â—','â—†','â™£']; // å¢åŠ åˆ°5ä¸ªç¬¦å·ï¼Œæå‡è§†è§‰æœç´¢è´Ÿè·
        let dsstData = { module: "COG_DSST", correct_count: 0, errors: 0, records: [] }; 
        let ds_onset=0, ds_currIdx=0, ds_timer = null, ds_timeLeft = DSST_TIME_LIMIT;
        
        function startDSST() { 
            dsstData = { module: "COG_DSST", correct_count: 0, errors: 0, records: [] }; 
            ds_timeLeft = DSST_TIME_LIMIT; show('dsst-area'); 
            const keyBoard=document.getElementById('dsst-key'); keyBoard.innerHTML=''; 
            dsstSymbols.forEach((sym, i) => { keyBoard.innerHTML += `<div class="dsst-pair">${sym}<span>${i+1}</span></div>`; }); 
            
            document.getElementById('dsst-timer').innerText = `â³ å‰©ä½™æ—¶é—´: ${ds_timeLeft} ç§’`;
            ds_timer = setInterval(() => {
                ds_timeLeft--; document.getElementById('dsst-timer').innerText = `â³ å‰©ä½™æ—¶é—´: ${ds_timeLeft} ç§’`;
                if(ds_timeLeft <= 0) finishDSST();
            }, 1000);
            nextDSST(); 
        }
        function nextDSST() { 
            ds_currIdx = Math.floor(Math.random() * 5); 
            document.getElementById('dsst-target').innerText = dsstSymbols[ds_currIdx]; 
            ds_onset = performance.now(); 
        }
        function recordDSST(num) { 
            let isC = num === (ds_currIdx+1);
            if(isC) dsstData.correct_count++; else dsstData.errors++;
            dsstData.records.push({ correct: isC, rt: Math.round(performance.now() - ds_onset) }); 
            nextDSST(); 
        }
        function finishDSST() {
            clearInterval(ds_timer); CAS_Storage.saveModuleData('COG_DSST', dsstData); 
            alert(`DSST é™æ—¶æµ‹éªŒç»“æŸï¼\n\n90ç§’å†…æ­£ç¡®è½¬æ¢: ${dsstData.correct_count} ä¸ª`); show('menu'); 
        }

        /* ================= 7. Pattern (90 ç§’é™æ—¶é«˜å‹èŒƒå¼) ================= */
        const PATTERN_TIME_LIMIT = 90;
        const patStims = ['A','B','M','W','p','q','ğŸ¶','ğŸ±','â­•','âŒ','â™ ','â™£']; 
        let patData = { module: "COG_Pattern", correct_count: 0, errors: 0, records: [] }; 
        let p_onset=0, p_same=false, p_timer = null, p_timeLeft = PATTERN_TIME_LIMIT;
        
        function startPattern() { 
            patData = { module: "COG_Pattern", correct_count: 0, errors: 0, records: [] }; 
            p_timeLeft = PATTERN_TIME_LIMIT; show('pattern-area'); 
            
            document.getElementById('pattern-timer').innerText = `â³ å‰©ä½™æ—¶é—´: ${p_timeLeft} ç§’`;
            p_timer = setInterval(() => {
                p_timeLeft--; document.getElementById('pattern-timer').innerText = `â³ å‰©ä½™æ—¶é—´: ${p_timeLeft} ç§’`;
                if(p_timeLeft <= 0) finishPattern();
            }, 1000);
            nextPattern(); 
        }
        function nextPattern() { 
            document.getElementById('pattern-controls').classList.add('hidden'); 
            document.getElementById('pat-left').innerText = ""; document.getElementById('pat-right').innerText = ""; 
            setTimeout(() => { 
                let i1 = patStims[Math.floor(Math.random() * patStims.length)]; 
                p_same = Math.random() > 0.5; 
                let i2 = p_same ? i1 : patStims[Math.floor(Math.random() * patStims.length)]; 
                while(!p_same && i1===i2) i2 = patStims[Math.floor(Math.random() * patStims.length)]; 
                
                document.getElementById('pat-left').innerText = i1; document.getElementById('pat-right').innerText = i2; 
                document.getElementById('pattern-controls').classList.remove('hidden'); 
                p_onset = performance.now(); 
            }, 300); // å‡å°‘åˆ·æ–°é—´éš”ï¼Œæ–½åŠ é«˜å‹
        }
        function recordPattern(ans) { 
            let isC = ans === p_same;
            if(isC) patData.correct_count++; else patData.errors++;
            patData.records.push({ correct: isC, rt: Math.round(performance.now()-p_onset) }); 
            nextPattern(); 
        }
        function finishPattern() {
            clearInterval(p_timer); CAS_Storage.saveModuleData('COG_Pattern', patData); 
            alert(`Pattern é™æ—¶æµ‹éªŒç»“æŸï¼\n\n90ç§’å†…æ­£ç¡®åˆ¤æ–­: ${patData.correct_count} ä¸ª`); show('menu'); 
        }
    </script>
</body>
</html>
