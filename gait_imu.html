<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-MOT | åŒé‡ä»»åŠ¡æ­¥æ€åˆ†æ</title>
    <style>
        /* ==================== 1. ç§‘æŠ€æ¸©æƒ…é£ UI ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --amber: #f59e0b; --slate: #64748b; }
        body { font-family: -apple-system, sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--amber); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        /* ä¸´åºŠæŒ‡å¯¼è¯­é¢æ¿ */
        .instruction-box { background: #fffbeb; border: 2px dashed #fcd34d; padding: 20px; border-radius: 16px; margin-bottom: 25px; font-size: 16px; color: #b45309; }
        .instruction-box strong { font-size: 18px; color: #92400e; display: block; margin-bottom: 8px;}

        /* å®æ—¶æ•°æ®æ³¢å½¢ä¸ä»ªè¡¨ç›˜ */
        .sensor-dashboard { background: #0f172a; border-radius: 16px; padding: 20px; margin-bottom: 25px; position: relative; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        .live-data { display: flex; justify-content: space-between; color: var(--green); font-family: monospace; font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .live-data span { flex: 1; text-align: center; }
        canvas { width: 100%; height: 120px; display: block; }

        .metrics-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .metric-card { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .metric-card span { display: block; font-size: 12px; color: var(--slate); font-weight: bold; margin-bottom: 5px; }
        .metric-card strong { font-size: 24px; color: var(--amber); font-family: monospace; }

        /* æ§åˆ¶åŒº */
        .controls { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .btn { padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-auth { background: var(--blue); color: white; }
        .btn-record { background: var(--green); color: white; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2); }
        .btn-record:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        .btn-stop { background: var(--red); color: white; }

        /* å½•éŸ³è„‰å†²åŠ¨ç”» (è§†è§‰åé¦ˆ) */
        .recording-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--amber); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="module-header">
            <h2>ğŸš¶â€â™‚ï¸ è®¤çŸ¥-è¿åŠ¨åŒé‡ä»»åŠ¡æ­¥æ€åˆ†æ</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>æ•æ‰é¢å¶èµ„æºè€—ç«­å¯¼è‡´çš„æ­¥æ€ä¸ç¨³ã€‚æ—©æœŸ AD/PD åœ¨è¿›è¡ŒåŒé‡ä»»åŠ¡æ—¶ï¼Œæ­¥é¢‘ä¸‹é™ä¸åŠ é€Ÿåº¦å˜å¼‚æ€§ï¼ˆVariabilityï¼‰ä¼šæ˜¾è‘—æ”¾å¤§ã€‚</p>
        </div>

        <div class="instruction-box">
            <strong>ğŸ“‹ ä¸»è¯•æ ‡å‡†åŒ–æŒ‡å¯¼è¯­ (SOP)ï¼š</strong>
            1. è¯·å°†æ‰‹æœºæ”¾å…¥å—è¯•è€…è£¤å­å£è¢‹ï¼Œæˆ–ç”¨ç»‘å¸¦å›ºå®šäºè…°éƒ¨ã€‚<br>
            2. ç‚¹å‡»â€œè¯·æ±‚ä¼ æ„Ÿå™¨æƒé™â€å¹¶å…è®¸ã€‚<br>
            3. å‘Šè¯‰å—è¯•è€…ï¼šâ€œè¯·æ‚¨ç”¨å¹³æ—¶ä¹ æƒ¯çš„é€Ÿåº¦å‘å‰èµ° 10 ç±³ã€‚åœ¨èµ°è·¯çš„åŒæ—¶ï¼Œè¯·æ‚¨å¤§å£°åœ°ä» 100 å¼€å§‹ï¼Œæ¯æ¬¡å‡å» 7ï¼ˆå³ 100, 93, 86...ï¼‰â€ã€‚<br>
            4. ç‚¹å‡»â€œå¼€å§‹è®°å½•â€ï¼Œå—è¯•è€…èµ·æ­¥ã€‚èµ°åˆ°ç»ˆç‚¹åç‚¹å‡»â€œåœæ­¢â€ã€‚
        </div>

        <button class="btn btn-auth" id="btn-auth" onclick="requestDeviceMotion()">ğŸ”“ ç¬¬ 1 æ­¥ï¼šæˆæƒè°ƒç”¨æ‰‹æœºè¿åŠ¨ä¼ æ„Ÿå™¨</button>

        <div id="test-workspace" class="hidden" style="margin-top: 20px;">
            <div class="sensor-dashboard">
                <div class="live-data">
                    <span id="live-x">X: 0.00</span>
                    <span id="live-y">Y: 0.00</span>
                    <span id="live-z">Z: 0.00</span>
                </div>
                <canvas id="gait-canvas"></canvas>
            </div>

            <div class="metrics-board">
                <div class="metric-card"><span>æ€»è€—æ—¶ (s)</span><strong id="m-time">0.0</strong></div>
                <div class="metric-card"><span>æ£€å‡ºæ­¥æ•° (Steps)</span><strong id="m-steps">0</strong></div>
                <div class="metric-card"><span>é¢„ä¼°æ­¥é¢‘ (æ­¥/åˆ†)</span><strong id="m-cadence">0</strong></div>
            </div>

            <div class="controls" style="grid-template-columns: 1fr 1fr;">
                <button class="btn btn-record" id="btn-start" onclick="startGaitRecord()">â–¶ï¸ ç¬¬ 2 æ­¥ï¼šå¼€å§‹è®°å½•</button>
                <button class="btn btn-stop" id="btn-stop" onclick="stopGaitRecord()" disabled>â¹ åœæ­¢å¹¶æå–</button>
            </div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒå˜é‡
        let isRecording = false;
        let startTime = 0;
        let gaitData = { module: "MOT_DualTaskGait", time_series: [], summary: {} };
        
        // å‰ç«¯æ­¥æ€è¯†åˆ«ç®—æ³•å˜é‡
        let stepCount = 0;
        let lastPeakTime = 0;
        let isPeak = false;
        const STEP_THRESHOLD = 11.5; // åŠ é€Ÿåº¦å¹…å€¼é˜ˆå€¼ (éœ€åŒ…å«é‡åŠ›9.81)ï¼Œæ ¹æ®å®é™…æƒ…å†µå¾®è°ƒ
        const MIN_STEP_DELAY = 300;  // æœ€å°æ­¥æ€é—´éš”(ms)ï¼Œé˜²æŠ–åŠ¨

        // Canvas é…ç½®
        const canvas = document.getElementById('gait-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.clientWidth - 40;
        canvas.height = 120;
        let drawX = 0;

        /* ==================== 1. æƒé™è¯·æ±‚ (iOS 13+ å¿…ç»ä¹‹è·¯) ==================== */
        function requestDeviceMotion() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            enableWorkspace();
                        } else {
                            alert("âš ï¸ å¿…é¡»å…è®¸åŠ¨ä½œä¸æ–¹å‘æƒé™æ‰èƒ½è¿›è¡Œæ­¥æ€æµ‹è¯•ï¼");
                        }
                    })
                    .catch(console.error);
            } else {
                // é iOS è®¾å¤‡æˆ–æ—§ç‰ˆç³»ç»Ÿï¼Œç›´æ¥å¼€å¯
                enableWorkspace();
            }
        }

        function enableWorkspace() {
            document.getElementById('btn-auth').classList.add('hidden');
            document.getElementById('test-workspace').classList.remove('hidden');
            // æ·»åŠ ç›‘å¬å™¨ï¼Œä½†ä¸è®°å½•ï¼Œä»…ç”¨äº UI é¢„è§ˆ
            window.addEventListener('devicemotion', handleMotion);
        }

        /* ==================== 2. æ•°æ®å¤„ç†ä¸æ­¥æ€ç‰¹å¾æå– ==================== */
        function handleMotion(event) {
            // è·å–å«é‡åŠ›çš„åŠ é€Ÿåº¦ (æ›´é€šç”¨)
            const acc = event.accelerationIncludingGravity;
            if (!acc || acc.x === null) return;

            const x = acc.x; const y = acc.y; const z = acc.z;
            
            // UI å®æ—¶æ˜¾ç¤º
            document.getElementById('live-x').innerText = `X: ${x.toFixed(2)}`;
            document.getElementById('live-y').innerText = `Y: ${y.toFixed(2)}`;
            document.getElementById('live-z').innerText = `Z: ${z.toFixed(2)}`;

            // æ ¸å¿ƒå…¬å¼ï¼šè®¡ç®— 3D åŠ é€Ÿåº¦çš„æ¨¡é•¿ (Magnitude)
            const magnitude = Math.sqrt(x*x + y*y + z*z);

            if (isRecording) {
                const now = performance.now();
                const t = Math.round(now - startTime);
                
                // å­˜å…¥é«˜é¢‘æ—¶åºæ•°ç»„ä¾›æœºå™¨å­¦ä¹ 
                gaitData.time_series.push({ t: t, x: x, y: y, z: z, mag: magnitude });

                // ========== æç®€çš„å‰ç«¯â€œæ­¥æ•°æ£€æµ‹å™¨ (Step Counter)â€ ==========
                if (magnitude > STEP_THRESHOLD && !isPeak && (now - lastPeakTime > MIN_STEP_DELAY)) {
                    isPeak = true;
                    stepCount++;
                    lastPeakTime = now;
                    document.getElementById('m-steps').innerText = stepCount;
                    
                    // å®æ—¶è®¡ç®—æ­¥é¢‘ (Cadence) = æ­¥æ•° / åˆ†é’Ÿ
                    const timeElapsedMin = (now - startTime) / 60000;
                    if(timeElapsedMin > 0) {
                        const cadence = Math.round(stepCount / timeElapsedMin);
                        document.getElementById('m-cadence').innerText = cadence;
                    }
                } else if (magnitude < STEP_THRESHOLD - 1.0) {
                    isPeak = false; // è·Œè½å›åŸºçº¿ï¼Œå‡†å¤‡æ£€æµ‹ä¸‹ä¸€æ­¥
                }

                // ç»˜åˆ¶åŠ¨æ€æ³¢å½¢
                drawWaveform(magnitude);
                
                // æ›´æ–°æ€»æ—¶é—´ UI
                document.getElementById('m-time').innerText = (t / 1000).toFixed(1);
            }
        }

        /* ==================== 3. å¯è§†åŒ–å¼•æ“ ==================== */
        function drawWaveform(mag) {
            if (drawX === 0) { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.beginPath(); ctx.moveTo(0, canvas.height / 2); }
            
            // å°†æ¨¡é•¿æ˜ å°„åˆ° Canvas é«˜åº¦ (åŸºçº¿é‡åŠ›çº¦ 9.8ï¼Œæ˜ å°„åˆ°ä¸­é—´)
            const y = canvas.height - ((mag - 5) / 10) * canvas.height; 
            ctx.lineTo(drawX, y);
            ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 2; ctx.stroke();
            
            drawX += 2; // æ³¢å½¢æ»šåŠ¨é€Ÿåº¦
            if (drawX >= canvas.width) { drawX = 0; }
        }

        /* ==================== 4. æµ‹è¯•æµç¨‹æ§åˆ¶ ==================== */
        function startGaitRecord() {
            isRecording = true;
            startTime = performance.now();
            gaitData.time_series = [];
            stepCount = 0; drawX = 0;

            document.getElementById('btn-start').innerText = "è®°å½•ä¸­...";
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-start').classList.add('recording-pulse');
            document.getElementById('btn-stop').disabled = false;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function stopGaitRecord() {
            isRecording = false;
            window.removeEventListener('devicemotion', handleMotion);

            document.getElementById('btn-start').classList.remove('recording-pulse');
            document.getElementById('btn-stop').disabled = true;

            // ===== è®¡ç®—é«˜çº§ä¸´åºŠæ­¥æ€æŒ‡æ ‡ (å˜å¼‚æ€§ Variability) =====
            const totalDurationSec = parseFloat(document.getElementById('m-time').innerText);
            const finalCadence = parseInt(document.getElementById('m-cadence').innerText);
            
            // è®¡ç®—åŠ é€Ÿåº¦å˜å¼‚ç³»æ•° (Coefficient of Variation, CV) ä½œä¸ºå¹³ç¨³åº¦æŒ‡æ ‡
            let magSum = 0;
            gaitData.time_series.forEach(d => magSum += d.mag);
            const magMean = magSum / gaitData.time_series.length;
            
            let varSum = 0;
            gaitData.time_series.forEach(d => varSum += Math.pow(d.mag - magMean, 2));
            const magStdDev = Math.sqrt(varSum / gaitData.time_series.length);
            const gaitVariability = (magStdDev / magMean) * 100; // å˜å¼‚ç³»æ•° %

            gaitData.summary = {
                duration_sec: totalDurationSec,
                total_steps: stepCount,
                cadence_spm: finalCadence,
                variability_cv: parseFloat(gaitVariability.toFixed(2))
            };

            CAS_Storage.saveModuleData('MOT_DualTaskGait', gaitData);
            
            // ä¸´åºŠåé¦ˆæç¤º
            let alertMsg = `âœ… åŒé‡ä»»åŠ¡æ­¥æ€æå–æˆåŠŸï¼\n\n- æ€»æ­¥æ•°: ${stepCount} æ­¥\n- æ­¥é¢‘ (Cadence): ${finalCadence} æ­¥/åˆ†\n- æ­¥æ€å˜å¼‚ç³»æ•° (Variability): ${gaitData.summary.variability_cv}%\n`;
            
            // AD/PD é«˜å±å˜å¼‚æ€§é¢„è­¦é€»è¾‘ (é˜ˆå€¼ä»…ä½œç¤ºä¾‹ï¼Œéœ€æ ¹æ®å¸¸æ¨¡è°ƒæ•´)
            if(gaitData.summary.variability_cv > 25.0) {
                alertMsg += `\nâš ï¸ ä¸´åºŠé¢„è­¦ï¼šåœ¨ç®—æœ¯åŒé‡ä»»åŠ¡ä¸‹ï¼Œå—è¯•è€…çš„æ­¥æ€å˜å¼‚æ€§æ˜¾è‘—å¢é«˜ã€‚æç¤ºé¢å¶æ‰§è¡ŒåŠŸèƒ½å¯¹è¿åŠ¨çš®å±‚çš„ä»£å¿èƒ½åŠ›å¯èƒ½æ­£åœ¨è¡°é€€ã€‚`;
            }

            alert(alertMsg);
            setTimeout(() => { location.href = 'index.html'; }, 1000);
        }
    </script>
</body>
</html>
