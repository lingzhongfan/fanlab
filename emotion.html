<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-EMO | æƒ…æ„Ÿä¸å†³ç­–</title>
    <style>
        :root { --primary: #0f172a; --blue: #3b82f6; --green: #10b981; --red: #ef4444; --slate: #64748b; }
        body { font-family: -apple-system, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; touch-action: manipulation; }
        .container { max-width: 650px; margin: 0 auto; background: white; padding: 35px 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        
        /* æ ‡é¢˜æ ·å¼ */
        .module-header { border-left: 6px solid var(--blue); padding-left: 15px; margin-bottom: 30px; }
        .module-header h2 { margin: 0; font-size: 22px; }

        /* æŒ‰é’®ç³»ç»Ÿ */
        .sys-btn { width: 100%; padding: 18px; margin-bottom: 15px; border: none; border-radius: 14px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-dark { background: var(--primary); color: white; }
        .btn-blue { background: var(--blue); color: white; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
        .btn-green { background: var(--green); color: white; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        .sys-btn:active { transform: scale(0.96); opacity: 0.9; }
        .sys-btn:disabled { background: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; box-shadow: none; }

        /* ä¼˜åŒ–åçš„æ»‘å—äº¤äº’ */
        .slider-box { margin-bottom: 40px; position: relative; padding-top: 30px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .slider-header label { font-weight: bold; color: var(--primary); font-size: 15px; }
        .val-badge { background: var(--blue); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; height: 12px; background: #e2e8f0; border-radius: 10px; outline: none; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 28px; height: 28px; background: white; 
            border: 4px solid var(--blue); border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }

        /* BART æ°”çƒæ•ˆæœ */
        #bart-workspace { width: 100%; height: 320px; background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 20px; display: flex; align-items: flex-end; justify-content: center; position: relative; margin-bottom: 25px; }
        #balloon { 
            width: 50px; height: 60px; background: radial-gradient(circle at 30% 30%, #f87171, #dc2626); 
            border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%; transition: all 0.15s cubic-bezier(0.17, 0.67, 0.83, 0.67); 
            position: relative; bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; 
        }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>

    <div style="margin-bottom: 15px;"><button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer; font-size:16px;">â† è¿”å›æ§åˆ¶å°</button></div>

    <div class="container" id="menu">
        <div class="module-header"><h2>â¤ï¸ æƒ…æ„Ÿä¸å†³ç­–è¯„ä¼°</h2></div>
        <button class="sys-btn btn-dark" onclick="show('ema-area')">ğŸ“Š 1. å®æ—¶çŠ¶æ€è¯„ä¼° (EMA)</button>
        <button class="sys-btn btn-dark" onclick="show('b5-area')">ğŸ§  2. äººæ ¼ç‰¹è´¨å€¾å‘é‡è¡¨ (Big 5)</button>
        <button class="sys-btn btn-blue" onclick="startBART()">ğŸˆ 3. BART æ°”çƒé£é™©å†³ç­–ä»»åŠ¡</button>
        <button class="sys-btn btn-blue" onclick="startEmoStroop()">âš¡ 4. æƒ…ç»ª Stroop æ³¨æ„åå‘</button>
    </div>

    <div class="container hidden" id="ema-area">
        <div class="module-header"><h2>EMA å®æ—¶çŠ¶æ€</h2></div>
        
        <div class="slider-box">
            <div class="slider-header"><label>æ­¤åˆ»æ„Ÿåˆ°ã€ç´§å¼ /ç„¦è™‘ã€‘çš„ç¨‹åº¦</label><span class="val-badge" id="v1">0%</span></div>
            <input type="range" id="ema-1" min="0" max="100" value="0" oninput="updateVal('ema-1','v1')">
        </div>

        <div class="slider-box">
            <div class="slider-header"><label>æ­¤åˆ»æ„Ÿåˆ°ã€æƒ…ç»ªä½è½ã€‘çš„ç¨‹åº¦</label><span class="val-badge" id="v2">0%</span></div>
            <input type="range" id="ema-2" min="0" max="100" value="0" oninput="updateVal('ema-2','v2')">
        </div>

        <button class="sys-btn btn-green" onclick="saveEMA()">å®Œæˆå¹¶ä¿å­˜</button>
    </div>

    <div class="container hidden" id="b5-area">
        <div class="module-header"><h2>äººæ ¼ç‰¹è´¨æ¨¡å‹ (ç®€ç‰ˆ)</h2></div>
        
        <div class="slider-box">
            <div class="slider-header"><label>å¤–å‘æ€§ (E): å–œçˆ±ç¤¾äº¤ã€æ´»è·ƒ</label><span class="val-badge" id="ve">50%</span></div>
            <input type="range" id="b5-e" min="0" max="100" value="50" oninput="updateVal('b5-e','ve')">
        </div>

        <div class="slider-box">
            <div class="slider-header"><label>ç¥ç»è´¨ (N): æƒ…ç»ªæ³¢åŠ¨ã€æ•æ„Ÿ</label><span class="val-badge" id="vn">50%</span></div>
            <input type="range" id="b5-n" min="0" max="100" value="50" oninput="updateVal('b5-n','vn')">
        </div>

        <button class="sys-btn btn-green" onclick="saveB5()">ç¡®è®¤äººæ ¼ç”»åƒ</button>
    </div>

    <div class="container hidden" id="bart-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <div style="font-size:18px; font-weight:bold;">è½®æ¬¡: <span id="bart-round" style="color:var(--blue);">1/5</span></div>
            <div style="font-size:18px; font-weight:bold;">æœ¬è½®ç§¯ç´¯: <span id="bart-pot" style="color:var(--red); font-size:24px;">$0</span></div>
        </div>
        
        <div id="bart-workspace"><div id="balloon"></div></div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <button class="sys-btn btn-blue" id="btn-pump" onclick="pumpBalloon()">ğŸˆ å……æ°” (+1)</button>
            <button class="sys-btn btn-green" id="btn-collect" onclick="collectMoney()">ğŸ’° æ”¶é›†æ”¶ç›Š</button>
        </div>
        <p style="text-align:center; color:var(--slate); font-size:13px; margin-top:15px;">æç¤ºï¼šæ°”çƒç‚¸è£‚åˆ™æœ¬è½®æ”¶ç›Šæ¸…é›¶</p>
    </div>

    <div class="container hidden" id="emo-area">
        <div id="emo-word" style="font-size: 80px; margin: 80px 0; font-weight: bold; text-align: center;">+</div>
        <div id="emo-controls" class="hidden" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px;">
            <button class="sys-btn" style="background:var(--red); height:80px;" onclick="recordES('red')"></button>
            <button class="sys-btn" style="background:var(--green); height:80px;" onclick="recordES('green')"></button>
            <button class="sys-btn" style="background:var(--blue); height:80px;" onclick="recordES('blue')"></button>
        </div>
    </div>

    <script>
        // ç•Œé¢åˆ‡æ¢
        function show(id) {
            ['menu', 'ema-area', 'b5-area', 'bart-area', 'emo-area'].forEach(d => {
                const el = document.getElementById(d);
                if(el) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // æ»‘å—æ•°å€¼åŒæ­¥
        function updateVal(inputID, spanID) {
            const val = document.getElementById(inputID).value;
            document.getElementById(spanID).innerText = val + "%";
        }

        function saveEMA() { 
            CAS_Storage.saveModuleData('Emotion_EMA', { anxiety: document.getElementById('ema-1').value }); 
            alert("æ•°æ®å·²åŒæ­¥"); show('menu'); 
        }
        
        function saveB5() { 
            CAS_Storage.saveModuleData('Emotion_Big5', { E: document.getElementById('b5-e').value }); 
            alert("äººæ ¼æ¨¡å‹å·²æ›´æ–°"); show('menu'); 
        }

        /* ================= BART æ ¸å¿ƒé€»è¾‘ (ä¿®å¤ç‰ˆ) ================= */
        let bartData = { module: "BART_Risk", trials: [] };
        let b_round = 1, b_pumps = 0, b_popLimit = 0;

        function startBART() {
            b_round = 1;
            bartData.trials = [];
            show('bart-area');
            nextRound();
        }

        function nextRound() {
            if(b_round > 5) {
                CAS_Storage.saveModuleData('BART_Risk', bartData);
                alert("BARTä»»åŠ¡ç»“æŸï¼Œæ€»æ”¶ç›Šå·²ç»“ç®—ã€‚");
                show('menu');
                return;
            }
            // é‡ç½®çŠ¶æ€
            b_pumps = 0;
            b_popLimit = Math.floor(Math.random() * 12) + 2; 
            document.getElementById('bart-round').innerText = `${b_round} / 5`;
            document.getElementById('bart-pot').innerText = `$0`;
            
            const b = document.getElementById('balloon');
            b.innerText = "";
            b.style.width = '50px'; b.style.height = '60px';
            b.style.background = 'radial-gradient(circle at 30% 30%, #f87171, #dc2626)';
            
            // ğŸŒŸ å¯ç”¨æŒ‰é’®
            document.getElementById('btn-pump').disabled = false;
            document.getElementById('btn-collect').disabled = false;
        }

        function pumpBalloon() {
            b_pumps++;
            if(b_pumps >= b_popLimit) {
                // çˆ†ç‚¸
                document.getElementById('btn-pump').disabled = true;
                document.getElementById('btn-collect').disabled = true;
                const b = document.getElementById('balloon');
                b.style.background = 'transparent';
                b.innerText = "ğŸ’¥";
                bartData.trials.push({ round: b_round, pumps: b_pumps, status: 'popped', gain: 0 });
                setTimeout(() => { b_round++; nextRound(); }, 1500);
            } else {
                // å……æ°”
                const b = document.getElementById('balloon');
                b.style.width = (50 + b_pumps * 15) + 'px';
                b.style.height = (60 + b_pumps * 18) + 'px';
                document.getElementById('bart-pot').innerText = `$${b_pumps}`;
            }
        }

        // ğŸŒŸ ä¿®å¤æ”¶é›†é€»è¾‘
        function collectMoney() {
            // å¿…é¡»åœ¨æœªçˆ†ç‚¸å‰è°ƒç”¨
            if(b_pumps === 0) { alert("å½“å‰æ²¡æœ‰ç§¯ç´¯æ”¶ç›Šå“¦"); return; }
            
            // ä¿å­˜æ•°æ®
            bartData.trials.push({ round: b_round, pumps: b_pumps, status: 'saved', gain: b_pumps });
            
            // UI åé¦ˆ
            document.getElementById('btn-pump').disabled = true;
            document.getElementById('btn-collect').disabled = true;
            alert(`âœ… æˆåŠŸæ”¶é›†: $${b_pumps}`);
            
            b_round++;
            setTimeout(nextRound, 500);
        }

        /* ================= Stroop é€»è¾‘ ================= */
        function startEmoStroop() { show('emo-area'); setTimeout(() => {
            document.getElementById('emo-word').innerText = "ç„¦è™‘";
            document.getElementById('emo-word').style.color = "red";
            document.getElementById('emo-controls').classList.remove('hidden');
        }, 1000); }
        function recordES(c) { show('menu'); }
    </script>
</body>
</html>
