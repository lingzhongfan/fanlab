<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-EMO | ç¤¾ä¼šè®¤çŸ¥ä¸é¢å­”æƒ…ç»ªè¯†åˆ« (ä¸´åºŠæ ‡å‡† ER-60 ç‰ˆ)</title>
    <style>
        /* ==================== UI ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --teal: #0d9488; --rose: #e11d48; --slate: #64748b; --green: #10b981; --amber: #f59e0b; --bg: #fcfcfd; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); user-select: none; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--rose); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .sys-btn { width: 100%; padding: 20px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 18px; transition: 0.2s; background: var(--rose); color: white; box-shadow: 0 8px 20px rgba(225, 29, 72, 0.2);}
        .sys-btn:hover { background: #be123c; transform: translateY(-2px); }

        /* åˆºæ¿€å‘ˆç°åŒº */
        .stimulus-workspace { position: relative; width: 100%; height: 350px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 20px; display: flex; align-items: center; justify-content: center; flex-direction: column; margin-bottom: 30px; transition: 0.3s;}
        
        /* ä¸´åºŠæ›¿æ¢æç¤ºï¼šçœŸå®ç§‘ç ”æ—¶ï¼Œå°†è¿™é‡Œçš„è¡¨æƒ…ç¬¦å·æ›¿æ¢ä¸ºå›¾ç‰‡åº“ */
        .face-placeholder { font-size: 130px; line-height: 1; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); transition: 0.2s; }
        .fixation-cross { font-size: 60px; color: var(--slate); font-weight: bold; }

        .trial-counter { position: absolute; top: 15px; right: 20px; font-size: 14px; color: var(--slate); font-weight: bold; }
        .phase-badge { position: absolute; top: 15px; left: 20px; font-size: 14px; font-weight: bold; padding: 4px 10px; border-radius: 8px; }
        .badge-practice { background: var(--amber); color: white; }
        .badge-formal { background: var(--rose); color: white; }

        /* ç­”é¢˜åé¦ˆ (ä»…ç»ƒä¹ é˜¶æ®µ) */
        .feedback-overlay { position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; color: white; z-index: 10; opacity: 0; transition: 0.2s; pointer-events: none;}
        .feedback-correct { background: rgba(16, 185, 129, 0.9); }
        .feedback-error { background: rgba(244, 63, 94, 0.9); }

        /* ä¸­åœºä¼‘æ¯ç•Œé¢ */
        .rest-screen { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background: var(--primary); border-radius: 18px; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 20; color: white; text-align: center; padding: 20px; box-sizing: border-box;}
        .rest-timer { font-size: 60px; font-weight: bold; color: var(--teal); font-family: monospace; margin: 15px 0;}

        /* ç­”é¢˜é¢æ¿ */
        .response-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .btn-emotion { padding: 20px; background: white; border: 2px solid #e2e8f0; border-radius: 16px; font-size: 20px; font-weight: bold; color: var(--primary); cursor: pointer; transition: 0.1s; }
        .btn-emotion:active { background: var(--rose); color: white; border-color: var(--rose); transform: scale(0.96); }
        .btn-emotion:disabled { background: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; cursor: not-allowed; transform: none; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--rose); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ˜ƒ é¢å­”æƒ…ç»ªè¯†åˆ« (ER-60 ä¸´åºŠæ ‡å‡†ç‰ˆ)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>è¯„ä¼°ç¤¾ä¼šè®¤çŸ¥èƒ½åŠ›ä¸æä»æ ¸/å²›å¶ç½‘ç»œæ•æ„Ÿåº¦ã€‚æ—©æœŸé¢é¢å¶ç—´å‘†(bvFTD)ã€æŠ‘éƒç—‡ä¸ç²¾ç¥åˆ†è£‚ç—‡æ‚£è€…ï¼Œå¸¸ä¼´æœ‰ç‰¹å®šæƒ…ç»ª(å¦‚ææƒ§ã€åŒæ¶)çš„ç‰¹å¼‚æ€§è¯†åˆ«éšœç¢ã€‚<br>
            *åŒ…å« 3 æ¬¡åŸºçº¿ç»ƒä¹ ï¼Œ60 æ¬¡çº¯éšæœºæ­£å¼è¯•æ¬¡ï¼Œä¸­åœºé˜²ç–²åŠ³ä¼‘æ¯ï¼Œå¹¶æå–æƒ…ç»ªç‰¹å¼‚æ€§æ··æ·†çŸ©é˜µã€‚</p>
        </div>
        <button class="sys-btn" onclick="startPractice()">â–¶ å¯åŠ¨æ ‡å‡†æµ‹è¯•ç¨‹åº</button>
    </div>

    <div class="container hidden" id="task-area">
        <div class="module-header" id="task-header">
            <h2 id="task-title">ç»ƒä¹ é˜¶æ®µ</h2>
            <p id="task-desc">è¯·ç†Ÿæ‚‰æ“ä½œã€‚å°½å¯èƒ½å¿«ä¸”å‡†ç¡®åœ°åˆ¤æ–­å±å¹•ä¸­äººç‰©çš„æƒ…ç»ªã€‚ç»ƒä¹ é˜¶æ®µä¼šæç¤ºå¯¹é”™ã€‚</p>
        </div>

        <div class="stimulus-workspace" id="stimulus-workspace">
            <div class="phase-badge badge-practice" id="phase-badge">ç»ƒä¹ è¯•æ¬¡</div>
            <div class="trial-counter" id="fer-counter">è¿›åº¦: 1 / 3</div>
            
            <div id="stimulus-container">
                <div class="fixation-cross">+</div>
            </div>

            <div class="feedback-overlay" id="feedback-layer">æ­£ç¡®</div>
            
            <div class="rest-screen hidden" id="rest-screen">
                <div style="font-size:24px; font-weight:bold;">ä¸­åœºä¼‘æ¯</div>
                <div style="color:#94a3b8; margin-top:10px;">è¯·é—­ä¸Šçœ¼ç›ï¼Œæ·±å‘¼å¸ï¼Œæ”¾æ¾çœ¼éƒ¨è‚Œè‚‰ã€‚</div>
                <div class="rest-timer" id="rest-timer">10</div>
                <div style="color:#94a3b8;">ç§’åè‡ªåŠ¨è¿›å…¥ä¸‹åŠåœº</div>
            </div>
        </div>

        <div class="response-board" id="response-board">
            <button class="btn-emotion" onclick="recordResponse('happy')">é«˜å…´</button>
            <button class="btn-emotion" onclick="recordResponse('sad')">æ‚²ä¼¤</button>
            <button class="btn-emotion" onclick="recordResponse('angry')">æ„¤æ€’</button>
            <button class="btn-emotion" onclick="recordResponse('fear')">ææƒ§</button>
            <button class="btn-emotion" onclick="recordResponse('disgust')">åŒæ¶</button>
            <button class="btn-emotion" onclick="recordResponse('neutral')">ä¸­æ€§</button>
        </div>
    </div>

    <script>
        // ================= æ•°æ®ç»“æ„ä¸æ ¸å¿ƒå˜é‡ =================
        const TOTAL_FORMAL_TRIALS = 60; // å›½é™…é‡‘æ ‡å‡†: 6ç§æƒ…ç»ª * 10å¼ å›¾ç‰‡
        const REST_AT_TRIAL = 30; // ä¸­åœºä¼‘æ¯é”šç‚¹
        const TIMEOUT_MS = 5000; // 5ç§’ä¸ä½œç­”è®°ä¸ºå¤±è¯¯
        const ISI_MS = 500; // åå­—æ³¨è§†ç‚¹å‘ˆç°æ—¶é—´

        let ferData = { module: "Emotion_FER", records: [], summary: {} };
        let currentSequence = [];
        let currentTrial = 0;
        let trialOnset = 0;
        let responseTimeout = null;
        let isPracticePhase = true;

        // æƒ…ç»ªåˆºæ¿€åº“ (ç§‘ç ”éƒ¨ç½²æ—¶å¯å°† icon æ›¿æ¢ä¸º Ekman æˆ– Penn ER40 å›¾ç‰‡)
        // ç¤ºä¾‹: { id: 'happy', icon: '<img src="img/happy_01.jpg" width="300">' }
        const emotionStimuli = [
            { id: 'happy', icon: 'ğŸ˜€' }, { id: 'sad', icon: 'ğŸ˜¢' },
            { id: 'angry', icon: 'ğŸ˜¡' }, { id: 'fear', icon: 'ğŸ˜¨' },
            { id: 'disgust', icon: 'ğŸ¤¢' }, { id: 'neutral', icon: 'ğŸ˜' }
        ];

        // ç•Œé¢è·¯ç”±
        function show(id) {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('task-area').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // æ‰“ä¹±ç®—æ³• (Fisher-Yates)
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ================= é˜¶æ®µ 1: ç»ƒä¹ é˜¶æ®µ (Practice Phase) =================
        function startPractice() {
            isPracticePhase = true;
            currentTrial = 0;
            
            // ç”Ÿæˆ 3 ä¸ªä¸é‡å¤çš„éšæœºç»ƒä¹ é¢˜
            let shuffledEmotions = shuffle([...emotionStimuli]);
            currentSequence = shuffledEmotions.slice(0, 3).map(emo => ({ targetEmotion: emo.id, visual: emo.icon }));
            
            // UI é…ç½®
            document.getElementById('task-title').innerText = "ç»ƒä¹ é˜¶æ®µ";
            document.getElementById('task-desc').innerText = "è¯·ç†Ÿæ‚‰æ“ä½œã€‚å°½å¯èƒ½å¿«ä¸”å‡†ç¡®åœ°åˆ¤æ–­äººç‰©çš„æƒ…ç»ªã€‚ç»ƒä¹ é˜¶æ®µä¼šæç¤ºå¯¹é”™ã€‚";
            
            const badge = document.getElementById('phase-badge');
            badge.className = "phase-badge badge-practice";
            badge.innerText = "ç»ƒä¹ è¯•æ¬¡";

            show('task-area');
            runTrial();
        }

        // ================= é˜¶æ®µ 2: æ­£å¼é˜¶æ®µ (Formal Phase) =================
        function startFormal() {
            isPracticePhase = false;
            currentTrial = 0;
            ferData.records = []; // æ¸…ç©ºå¯èƒ½æ®‹ç•™çš„æ•°æ®

            // ç”Ÿæˆ 60 ä¸ªæ­£å¼è¯•æ¬¡ (6ç§ * 10æ¬¡)
            let seq = [];
            emotionStimuli.forEach(emo => {
                for(let i=0; i< (TOTAL_FORMAL_TRIALS / 6); i++) {
                    seq.push({ targetEmotion: emo.id, visual: emo.icon });
                }
            });
            currentSequence = shuffle(seq);

            // UI é…ç½®
            document.getElementById('task-title').innerText = "æ­£å¼æµ‹è¯•";
            document.getElementById('task-desc').innerText = "æµ‹è¯•æ­£å¼å¼€å§‹ã€‚å±å¹•ä¸å†æç¤ºå¯¹é”™ï¼Œå¦‚æœé•¿æ—¶é—´æœªä½œç­”å°†è‡ªåŠ¨åˆ¤é”™ã€‚";
            
            const badge = document.getElementById('phase-badge');
            badge.className = "phase-badge badge-formal";
            badge.innerText = "æ­£å¼è¯•æ¬¡";

            alert("ç»ƒä¹ ç»“æŸï¼Œæ‚¨å·²ç»æŒæ¡äº†è§„åˆ™ï¼\n\nç‚¹å‡»ã€ç¡®å®šã€‘ç«‹å³è¿›å…¥æ­£å¼æµ‹è¯•ã€‚");
            runTrial();
        }

        // ================= æ ¸å¿ƒè¯•æ¬¡å‘ˆç°å¼•æ“ =================
        function runTrial() {
            const totalInThisPhase = currentSequence.length;
            
            // æ‹¦æˆªï¼šæ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ­£å¼æµ‹è¯•çš„ä¸­åœºä¼‘æ¯ç‚¹
            if (!isPracticePhase && currentTrial === REST_AT_TRIAL) {
                triggerRestScreen();
                return;
            }

            // æ‹¦æˆªï¼šæ£€æŸ¥å½“å‰é˜¶æ®µæ˜¯å¦å…¨éƒ¨å®Œæˆ
            if (currentTrial >= totalInThisPhase) {
                if (isPracticePhase) {
                    startFormal();
                } else {
                    finishFER();
                }
                return;
            }

            document.getElementById('fer-counter').innerText = `è¿›åº¦: ${currentTrial + 1} / ${totalInThisPhase}`;
            lockButtons(true); // é”å®šæŒ‰é”®åŒº

            const container = document.getElementById('stimulus-container');
            
            // æ­¥éª¤ 1: å‘ˆç°åå­—æ³¨è§†ç‚¹ (ISI = 500ms)
            container.innerHTML = '<div class="fixation-cross">+</div>';

            setTimeout(() => {
                // æ­¥éª¤ 2: å‘ˆç°ç›®æ ‡åˆºæ¿€
                const stim = currentSequence[currentTrial];
                container.innerHTML = `<div class="face-placeholder">${stim.visual}</div>`;
                
                lockButtons(false); // è§£é”æŒ‰é”®åŒº
                trialOnset = performance.now();

                // æ­¥éª¤ 3: è¶…æ—¶æƒ©ç½šæœºåˆ¶ (æ­£å¼é˜¶æ®µå¯ç”¨)
                if (!isPracticePhase) {
                    responseTimeout = setTimeout(() => {
                        recordResponse('TIMEOUT');
                    }, TIMEOUT_MS);
                }
            }, ISI_MS); 
        }

        // ================= ååº”è®°å½•ä¸åé¦ˆæœºåˆ¶ =================
        function lockButtons(locked) {
            const buttons = document.getElementById('response-board').querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = locked;
            });
            document.getElementById('response-board').style.opacity = locked ? '0.5' : '1';
        }

        function recordResponse(selectedEmotion) {
            clearTimeout(responseTimeout);
            lockButtons(true); // ç«‹å³é”å®šï¼Œé˜²å¤šç‚¹

            const rt = Math.round(performance.now() - trialOnset);
            const target = currentSequence[currentTrial].targetEmotion;
            const isCorrect = (selectedEmotion === target);

            // å¦‚æœæ˜¯ç»ƒä¹ é˜¶æ®µï¼Œæä¾›å³æ—¶è§†è§‰åé¦ˆï¼Œä½†ä¸å­˜å…¥æ­£å¼æ•°æ®
            if (isPracticePhase) {
                showFeedback(isCorrect);
            } else {
                // æ­£å¼é˜¶æ®µè®°å½•æ•°æ®
                ferData.records.push({
                    target: target,
                    response: selectedEmotion,
                    correct: isCorrect,
                    rt_ms: selectedEmotion === 'TIMEOUT' ? TIMEOUT_MS : rt
                });
                proceedToNextTrial(250); // æ— åé¦ˆï¼ŒçŸ­é—´éš”è¿›å…¥ä¸‹ä¸€é¢˜
            }
        }

        function showFeedback(isCorrect) {
            const layer = document.getElementById('feedback-layer');
            layer.className = "feedback-overlay " + (isCorrect ? "feedback-correct" : "feedback-error");
            layer.innerText = isCorrect ? "âœ… æ­£ç¡®" : "âŒ é”™è¯¯";
            layer.style.opacity = '1';

            setTimeout(() => {
                layer.style.opacity = '0';
                proceedToNextTrial(200);
            }, 800); // å‘ˆç° 800ms çš„åé¦ˆ
        }

        function proceedToNextTrial(delay) {
            currentTrial++;
            document.getElementById('stimulus-container').innerHTML = ''; // æ¸…ç©ºç”»é¢
            setTimeout(runTrial, delay);
        }

        // ================= å¼ºåˆ¶é˜²ç–²åŠ³ä¼‘æ¯æœºåˆ¶ =================
        function triggerRestScreen() {
            const restScreen = document.getElementById('rest-screen');
            const timerEl = document.getElementById('rest-timer');
            restScreen.classList.remove('hidden');
            
            let restTimeLeft = 10;
            timerEl.innerText = restTimeLeft;

            const restInterval = setInterval(() => {
                restTimeLeft--;
                timerEl.innerText = restTimeLeft;
                
                if (restTimeLeft <= 0) {
                    clearInterval(restInterval);
                    restScreen.classList.add('hidden');
                    currentTrial++; // è·³è¿‡é”šç‚¹ï¼Œé˜²æ­¢æ­»å¾ªç¯
                    runTrial(); // æ¢å¤æµ‹è¯•
                }
            }, 1000);
        }

        // ================= ä¸´åºŠé«˜ç»´æ•°æ®è§£æçŸ©é˜µ =================
        function finishFER() {
            // æ€»ä½“ç»Ÿè®¡
            const validRecords = ferData.records.filter(r => r.response !== 'TIMEOUT');
            const correctTrials = validRecords.filter(r => r.correct);
            
            const totalAccuracy = Math.round((correctTrials.length / TOTAL_FORMAL_TRIALS) * 100);
            const overallMeanRt = correctTrials.length > 0 
                ? Math.round(correctTrials.reduce((sum, r) => sum + r.rt_ms, 0) / correctTrials.length) 
                : 0;
            
            const timeoutCount = ferData.records.filter(r => r.response === 'TIMEOUT').length;

            // æƒ…ç»ªç‰¹å¼‚æ€§æ··æ·†çŸ©é˜µå¼•æ“ (Emotion-Specific Matrix)
            let specificMatrix = {};
            emotionStimuli.forEach(emo => {
                const trialsOfThisEmotion = ferData.records.filter(r => r.target === emo.id);
                const correctOfThisEmotion = trialsOfThisEmotion.filter(r => r.correct);
                const validRtOfThisEmotion = correctOfThisEmotion.map(r => r.rt_ms);
                
                specificMatrix[emo.id] = {
                    accuracy_percent: Math.round((correctOfThisEmotion.length / trialsOfThisEmotion.length) * 100) || 0,
                    mean_rt_ms: validRtOfThisEmotion.length > 0 ? Math.round(validRtOfThisEmotion.reduce((a,b)=>a+b,0) / validRtOfThisEmotion.length) : 0
                };
            });

            ferData.summary = {
                overall_accuracy_percent: totalAccuracy,
                overall_mean_correct_rt_ms: overallMeanRt,
                timeout_count: timeoutCount,
                emotion_specific_matrix: specificMatrix
            };

            CAS_Storage.saveModuleData('Emotion_FER', ferData);
            
            let alertMsg = `âœ… ER-60 é¢å­”æƒ…ç»ªè¯†åˆ«æµ‹éªŒå®Œæˆï¼\n\n- æ€»ä½“å‡†ç¡®ç‡: ${totalAccuracy}%\n- æ€»ä½“å¹³å‡ååº”æ—¶: ${overallMeanRt} ms\n- è¶…æ—¶æœªç­”: ${timeoutCount} æ¬¡\n\n[æƒ…ç»ªç‰¹å¼‚æ€§è¯†åˆ«ç‡]\n`;
            
            // æ ¼å¼åŒ–è¾“å‡ºç‰¹å¼‚æ€§çŸ©é˜µä¾›ä¸»è¯•å‚è€ƒ
            const nameMap = {'happy':'å¿«ä¹', 'sad':'æ‚²ä¼¤', 'angry':'æ„¤æ€’', 'fear':'ææƒ§', 'disgust':'åŒæ¶', 'neutral':'ä¸­æ€§'};
            for (let key in specificMatrix) {
                alertMsg += `- ${nameMap[key]}: ${specificMatrix[key].accuracy_percent}%\n`;
            }

            // ä¸´åºŠé¢„è­¦æç¤º
            if (specificMatrix['fear'].accuracy_percent < 50 || specificMatrix['disgust'].accuracy_percent < 50) {
                alertMsg += "\nâš ï¸ ä¸´åºŠæç¤ºï¼šå—è¯•è€…å¯¹ã€ææƒ§ã€‘æˆ–ã€åŒæ¶ã€‘é¢å­”çš„è¯†åˆ«ç‡å¼‚å¸¸åä½ã€‚æ­¤ç‰¹å¾å¸¸ä½œä¸ºè¡Œä¸ºå˜å¼‚å‹é¢é¢å¶ç—´å‘†(bvFTD)æˆ–é‡åº¦æŠ‘éƒç—‡(MDD)çš„æ—©æœŸè¡¨å‹çº¿ç´¢ã€‚";
            }

            alert(alertMsg);
            location.href = 'index.html';
        }
    </script>
</body>
</html>
