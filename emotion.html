<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-EMO | æƒ…æ„Ÿä¸å†³ç­–</title>
    <style>
        :root { --primary: #0f172a; --blue: #3b82f6; --green: #10b981; --red: #ef4444; }
        body { font-family: -apple-system, sans-serif; background: #f8fafc; margin: 0; padding: 20px; touch-action: manipulation; }
        .container { max-width: 650px; margin: 20px auto; background: white; padding: 35px 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        .sys-btn { width: 100%; padding: 18px; margin-bottom: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-dark { background: var(--primary); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .sys-btn:active:not(:disabled) { transform: scale(0.98); opacity: 0.9; }
        
        /* é‡è¡¨æ»‘å—æ ·å¼ */
        .q-group { margin-bottom: 30px; border-bottom: 1px solid #f1f5f9; padding-bottom: 20px; }
        .q-group label { display: block; font-weight: bold; margin-bottom: 15px; color: #1e293b; }
        input[type=range] { width: 100%; height: 8px; border-radius: 5px; background: #e2e8f0; outline: none; -webkit-appearance: none; }
        .labels { display: flex; justify-content: space-between; font-size: 13px; color: #64748b; margin-top: 10px; }

        /* BART æ°”çƒæ•ˆæœ */
        #bart-workspace { width: 100%; height: 300px; background: #f1f5f9; border-radius: 16px; display: flex; align-items: flex-end; justify-content: center; position: relative; margin-bottom: 20px; overflow: hidden; }
        #balloon { width: 40px; height: 50px; background: radial-gradient(circle at 30% 30%, #f87171, #dc2626); border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%; transition: all 0.1s ease-out; position: relative; bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 30px; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div style="margin-bottom: 15px;"><button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer;">â† è¿”å›æ§åˆ¶å°</button></div>

    <div class="container" id="menu">
        <h2 style="margin-top:0;">â¤ï¸ æƒ…æ„Ÿå€¾å‘ä¸å†³ç­–é‡è¡¨</h2>
        <p style="color:#64748b; font-size: 14px;">è¯·é€‰æ‹©æµ‹è¯•æ¨¡å—å¼€å§‹è¯„ä¼°ï¼š</p>
        <button class="sys-btn btn-dark" onclick="show('ema-area')">1. å®æ—¶çŠ¶æ€è¯„ä¼° (EMA)</button>
        <button class="sys-btn btn-dark" onclick="show('b5-area')">2. äººæ ¼ç‰¹è´¨å€¾å‘é‡è¡¨ (Big 5)</button>
        <button class="sys-btn btn-blue" onclick="startBART()">3. BART æ°”çƒé£é™©å†³ç­–ä»»åŠ¡</button>
        <button class="sys-btn btn-blue" onclick="startEmoStroop()">4. æƒ…ç»ª Stroop æ³¨æ„åå‘æå–</button>
    </div>

    <div class="container hidden" id="ema-area">
        <h2 class="module-header">EMA ç¬æ—¶æƒ…ç»ªè¯„ä¼°</h2>
        <div class="q-group">
            <label>1. æ­¤æ—¶æ­¤åˆ»ï¼Œæ‚¨æ„Ÿåˆ°ã€ç„¦è™‘/ç´§å¼ ã€‘çš„ç¨‹åº¦ï¼Ÿ</label>
            <input type="range" id="ema-1" min="0" max="10" step="1" value="0">
            <div class="labels"><span>å®Œå…¨æ²¡æœ‰</span><span>ä¸­ç­‰</span><span>æåº¦å¼ºçƒˆ</span></div>
        </div>
        <div class="q-group">
            <label>2. æ­¤æ—¶æ­¤åˆ»ï¼Œæ‚¨æ„Ÿåˆ°ã€å¿§éƒ/ä½è½ã€‘çš„ç¨‹åº¦ï¼Ÿ</label>
            <input type="range" id="ema-2" min="0" max="10" step="1" value="0">
            <div class="labels"><span>å®Œå…¨æ²¡æœ‰</span><span>ä¸­ç­‰</span><span>æåº¦å¼ºçƒˆ</span></div>
        </div>
        <button class="sys-btn btn-green" onclick="saveEMA()">âœ“ ä¿å­˜çŠ¶æ€æ•°æ®</button>
    </div>

    <div class="container hidden" id="b5-area">
        <h2 class="module-header">å¤§äº”äººæ ¼ (ç®€ç‰ˆ)</h2>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px;">è¯·è¯„ä¼°æ‚¨åœ¨ä¸€èˆ¬æƒ…å†µä¸‹çš„è¡¨ç° (1=å¾ˆä¸ç¬¦åˆ, 5=éå¸¸ç¬¦åˆ)ï¼š</p>
        <div class="q-group"><label>O - å¼€æ”¾æ€§ (ä¹äºæ¥å—æ–°æƒ³æ³•ã€æ–°äº‹ç‰©)</label>
            <input type="range" id="b5-o" min="1" max="5" step="1" value="3">
        </div>
        <div class="q-group"><label>C - å°½è´£æ€§ (åšäº‹å¯é ã€è‡ªå¾‹ä¸”æœ‰æ¡ç†)</label>
            <input type="range" id="b5-c" min="1" max="5" step="1" value="3">
        </div>
        <div class="q-group"><label>E - å¤–å‘æ€§ (å–œçˆ±ç¤¾äº¤ã€å……æ»¡æ´»åŠ›)</label>
            <input type="range" id="b5-e" min="1" max="5" step="1" value="3">
        </div>
        <div class="q-group"><label>A - å®œäººæ€§ (å¯Œæœ‰åŒæƒ…å¿ƒã€ä¹äºåŠ©äºº)</label>
            <input type="range" id="b5-a" min="1" max="5" step="1" value="3">
        </div>
        <div class="q-group"><label>N - ç¥ç»è´¨ (æƒ…ç»ªæ˜“æ³¢åŠ¨ã€æ˜“æ„Ÿåˆ°å‹åŠ›)</label>
            <input type="range" id="b5-n" min="1" max="5" step="1" value="3">
        </div>
        <button class="sys-btn btn-green" onclick="saveB5()">âœ“ ä¿å­˜äººæ ¼æ¨¡å‹</button>
    </div>

    <div class="container hidden" id="bart-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold;">
            <span id="bart-round">ç¬¬ 1 / 5 è½®</span>
            <span id="bart-pot" style="color:var(--red);">æ°”çƒå†…: $0</span>
        </div>
        <div id="bart-workspace"><div id="balloon"></div></div>
        <div style="display:flex; gap:15px;">
            <button class="sys-btn btn-blue" id="btn-pump" onclick="pumpBalloon()">ğŸˆ å……æ°”</button>
            <button class="sys-btn btn-green" id="btn-collect" onclick="collectMoney()">ğŸ’° æ”¶é›†</button>
        </div>
    </div>

    <div class="container hidden" id="emo-area">
        <div id="emo-word" style="font-size: 70px; margin: 60px 0; font-weight: bold;">+</div>
        <div id="emo-controls" class="hidden" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
            <button class="sys-btn" style="background:red;" onclick="recordEmoStroop('red')"></button>
            <button class="sys-btn" style="background:green;" onclick="recordEmoStroop('green')"></button>
            <button class="sys-btn" style="background:blue;" onclick="recordEmoStroop('blue')"></button>
        </div>
    </div>

    <script>
        function show(id) {
            ['menu', 'ema-area', 'b5-area', 'bart-area', 'emo-area'].forEach(d => document.getElementById(d).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // ä¿å­˜ EMA
        function saveEMA() {
            CAS_Storage.saveModuleData('Emotion_EMA', { 
                anxiety: document.getElementById('ema-1').value,
                depression: document.getElementById('ema-2').value 
            });
            alert("çŠ¶æ€è¯„ä¼°å·²ä¿å­˜"); show('menu');
        }

        // ä¿å­˜ Big 5
        function saveB5() {
            CAS_Storage.saveModuleData('Emotion_Big5', { 
                O: document.getElementById('b5-o').value,
                C: document.getElementById('b5-c').value,
                E: document.getElementById('b5-e').value,
                A: document.getElementById('b5-a').value,
                N: document.getElementById('b5-n').value 
            });
            alert("äººæ ¼é‡è¡¨å·²ä¿å­˜"); show('menu');
        }

        /* BART é€»è¾‘ (ä¿®å¤ç‰ˆæœ¬) */
        let bartData = { module: "Emotion_BART", trials: [] };
        let b_round = 1, b_pumps = 0, b_popLimit = 0;

        function startBART() { b_round = 1; bartData.trials = []; show('bart-area'); initRound(); }

        function initRound() {
            if(b_round > 5) { CAS_Storage.saveModuleData('Emotion_BART', bartData); alert("BART å®Œæˆ"); show('menu'); return; }
            b_pumps = 0; b_popLimit = Math.floor(Math.random() * 10) + 3;
            document.getElementById('bart-round').innerText = `ç¬¬ ${b_round} / 5 è½®`;
            document.getElementById('bart-pot').innerText = `æ°”çƒå†…: $0`;
            const b = document.getElementById('balloon');
            b.innerText = ""; b.style.width = '40px'; b.style.height = '50px'; b.style.background = 'red';
            document.getElementById('btn-pump').disabled = false;
            document.getElementById('btn-collect').disabled = false;
        }

        function pumpBalloon() {
            b_pumps++;
            if(b_pumps >= b_popLimit) {
                document.getElementById('btn-pump').disabled = true;
                document.getElementById('btn-collect').disabled = true;
                document.getElementById('balloon').innerText = "ğŸ’¥";
                bartData.trials.push({ round: b_round, result: 'exploded' });
                setTimeout(() => { b_round++; initRound(); }, 1200);
            } else {
                const b = document.getElementById('balloon');
                b.style.width = (40 + b_pumps * 12) + 'px';
                b.style.height = (50 + b_pumps * 15) + 'px';
                document.getElementById('bart-pot').innerText = `æ°”çƒå†…: $${b_pumps}`;
            }
        }

        function collectMoney() {
            bartData.trials.push({ round: b_round, result: 'collected', earned: b_pumps });
            alert(`æ”¶é›†æˆåŠŸï¼š$${b_pumps}`); b_round++; initRound();
        }

        /* EmoStroop é€»è¾‘ */
        let es_trial = 0, es_onset = 0;
        function startEmoStroop() { es_trial = 0; show('emo-area'); nextES(); }
        function nextES() {
            if(es_trial >= 10) { show('menu'); return; }
            document.getElementById('emo-controls').classList.add('hidden');
            document.getElementById('emo-word').innerText = "+";
            setTimeout(() => {
                document.getElementById('emo-word').innerText = "ç–¾ç—…";
                document.getElementById('emo-word').style.color = "blue";
                document.getElementById('emo-controls').classList.remove('hidden');
                es_onset = performance.now();
            }, 800);
        }
        function recordEmoStroop(color) {
            CAS_Storage.saveModuleData('Emotion_Stroop', { rt: Math.round(performance.now() - es_onset) });
            es_trial++; nextES();
        }
    </script>
</body>
</html>
