<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-EMO | ç¤¾ä¼šè®¤çŸ¥ä¸é¢å­”æƒ…ç»ªè¯†åˆ« (ä¸´åºŠæ ‡å‡†ç‰ˆ)</title>
    <style>
        /* ==================== UI ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --teal: #0d9488; --rose: #e11d48; --slate: #64748b; --bg: #fcfcfd; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); user-select: none; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--rose); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .sys-btn { width: 100%; padding: 20px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 18px; transition: 0.2s; background: var(--rose); color: white; box-shadow: 0 8px 20px rgba(225, 29, 72, 0.2);}
        .sys-btn:hover { background: #be123c; transform: translateY(-2px); }

        /* åˆºæ¿€å‘ˆç°åŒº */
        .stimulus-workspace { position: relative; width: 100%; height: 350px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
        
        /* ä¸´åºŠæ›¿æ¢æç¤ºï¼š
           å¦‚æœæ˜¯çœŸå®çš„ç§‘ç ”é¡¹ç›®ï¼Œè¯·å°† .face-placeholder é‡Œçš„ emoji æ›¿æ¢ä¸º <img src="..."> 
           æŒ‡å‘æœ¬åœ°çš„ Ekman æˆ– KDEF æ ‡å‡†é¢å­”å›¾ç‰‡ 
        */
        .face-placeholder { font-size: 120px; line-height: 1; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }
        .fixation-cross { font-size: 60px; color: var(--slate); font-weight: bold; }

        .trial-counter { position: absolute; top: 15px; right: 20px; font-size: 14px; color: var(--slate); font-weight: bold; }

        /* ç­”é¢˜é¢æ¿ */
        .response-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .btn-emotion { padding: 20px; background: white; border: 2px solid #e2e8f0; border-radius: 16px; font-size: 20px; font-weight: bold; color: var(--primary); cursor: pointer; transition: 0.1s; }
        .btn-emotion:active { background: var(--rose); color: white; border-color: var(--rose); transform: scale(0.96); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--rose); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ˜ƒ é¢å­”æƒ…ç»ªè¯†åˆ« (Social Cognition)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>è¯„ä¼°ç¤¾ä¼šè®¤çŸ¥èƒ½åŠ›ä¸æä»æ ¸/æ¢­çŠ¶å›é¢å­”åŒºç½‘ç»œã€‚æ—©æœŸé¢é¢å¶ç—´å‘† (bvFTD) ä¸ç²¾ç¥åˆ†è£‚ç—‡æ‚£è€…å¾€å¾€åœ¨æ­¤é¡¹æµ‹è¯•ä¸­å‡ºç°ç‰¹å¼‚æ€§çš„â€œææƒ§/åŒæ¶â€è¯†åˆ«éšœç¢ã€‚<br>
            *åŒ…å« 30 ä¸ªéšæœºè¯•æ¬¡ï¼Œæµ‹é‡è¯†åˆ«å‡†ç¡®ç‡ä¸ååº”æ—¶ã€‚</p>
        </div>
        <button class="sys-btn" onclick="startFER()">â–¶ å¼€å§‹æµ‹è¯• (30 è¯•æ¬¡)</button>
    </div>

    <div class="container hidden" id="task-area">
        <div class="module-header">
            <h2>æƒ…ç»ªè¯†åˆ«</h2>
            <p>è¯·ä»¥æœ€å¿«é€Ÿåº¦å‡†ç¡®åˆ¤æ–­å±å¹•ä¸­äººç‰©çš„æƒ…ç»ªã€‚å¦‚æœé•¿æ—¶é—´æœªæ“ä½œå°†è‡ªåŠ¨è®°ä¸ºé”™è¯¯ã€‚</p>
        </div>

        <div class="stimulus-workspace">
            <div class="trial-counter" id="fer-counter">è¿›åº¦: 1 / 30</div>
            <div id="stimulus-container">
                </div>
        </div>

        <div class="response-board" id="response-board">
            <button class="btn-emotion" onclick="recordResponse('happy')">é«˜å…´</button>
            <button class="btn-emotion" onclick="recordResponse('sad')">æ‚²ä¼¤</button>
            <button class="btn-emotion" onclick="recordResponse('angry')">æ„¤æ€’</button>
            <button class="btn-emotion" onclick="recordResponse('fear')">ææƒ§</button>
            <button class="btn-emotion" onclick="recordResponse('disgust')">åŒæ¶</button>
            <button class="btn-emotion" onclick="recordResponse('neutral')">ä¸­æ€§</button>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒæ•°æ®ç»“æ„
        let ferData = { module: "Emotion_FER", correct_count: 0, errors: 0, records: [], summary: {} };
        const TOTAL_TRIALS = 30;
        let ferSequence = [];
        let currentTrial = 0;
        let trialOnset = 0;
        let responseTimeout = null;

        // æƒ…ç»ªåˆºæ¿€åº“ (ç§‘ç ”éƒ¨ç½²æ—¶å¯æ›¿æ¢ä¸ºæ ‡å‡†å›¾ç‰‡ URL)
        const emotionStimuli = [
            { id: 'happy', icon: 'ğŸ˜€' }, { id: 'sad', icon: 'ğŸ˜¢' },
            { id: 'angry', icon: 'ğŸ˜¡' }, { id: 'fear', icon: 'ğŸ˜¨' },
            { id: 'disgust', icon: 'ğŸ¤¢' }, { id: 'neutral', icon: 'ğŸ˜' }
        ];

        // ç•Œé¢è·¯ç”±
        function show(id) {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('task-area').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // ç”Ÿæˆéšæœºæµ‹è¯•åºåˆ— (æ¯ç§æƒ…ç»ª 5 æ¬¡)
        function generateSequence() {
            let seq = [];
            emotionStimuli.forEach(emo => {
                for(let i=0; i<5; i++) {
                    seq.push({ targetEmotion: emo.id, visual: emo.icon });
                }
            });
            // Fisher-Yates æ‰“ä¹±ç®—æ³•
            for (let i = seq.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [seq[i], seq[j]] = [seq[j], seq[i]];
            }
            return seq;
        }

        function startFER() {
            ferData = { module: "Emotion_FER", correct_count: 0, errors: 0, records: [], summary: {} };
            ferSequence = generateSequence();
            currentTrial = 0;
            show('task-area');
            nextTrial();
        }

        function nextTrial() {
            if (currentTrial >= TOTAL_TRIALS) {
                finishFER();
                return;
            }

            document.getElementById('fer-counter').innerText = `è¿›åº¦: ${currentTrial + 1} / ${TOTAL_TRIALS}`;
            document.getElementById('response-board').style.pointerEvents = 'none'; // é”å®šä½œç­”åŒº
            document.getElementById('response-board').style.opacity = '0.5';

            const container = document.getElementById('stimulus-container');
            
            // æ­¥éª¤ 1: å‘ˆç°æ³¨è§†ç‚¹ (500ms)ï¼Œè®©å—è¯•è€…æ³¨æ„åŠ›é›†ä¸­åˆ°å±å¹•ä¸­å¤®
            container.innerHTML = '<div class="fixation-cross">+</div>';

            setTimeout(() => {
                // æ­¥éª¤ 2: å‘ˆç°ç›®æ ‡æƒ…ç»ªé¢å­”
                const stim = ferSequence[currentTrial];
                
                // ã€ç§‘ç ”æ›¿æ¢ç‚¹ã€‘å¦‚æœæ˜¯çœŸå®å›¾ç‰‡ï¼Œè¯·æ›¿æ¢ä¸º `<img src="${stim.visual}" alt="face">`
                container.innerHTML = `<div class="face-placeholder">${stim.visual}</div>`;
                
                document.getElementById('response-board').style.pointerEvents = 'auto'; // è§£é”ä½œç­”åŒº
                document.getElementById('response-board').style.opacity = '1';
                
                trialOnset = performance.now();

                // æ­¥éª¤ 3: 5000ms è¶…æ—¶æƒ©ç½šæœºåˆ¶ (é˜²æ­¢å‘å‘†)
                responseTimeout = setTimeout(() => {
                    recordResponse('TIMEOUT');
                }, 5000);

            }, 500); // ISI = 500ms
        }

        function recordResponse(selectedEmotion) {
            clearTimeout(responseTimeout); // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
            document.getElementById('response-board').style.pointerEvents = 'none'; // ç«‹å³é”å®šï¼Œé˜²æ­¢è¿å‡»

            const rt = Math.round(performance.now() - trialOnset);
            const target = ferSequence[currentTrial].targetEmotion;
            const isCorrect = (selectedEmotion === target);

            if (isCorrect) ferData.correct_count++;
            else ferData.errors++;

            ferData.records.push({
                target: target,
                response: selectedEmotion,
                correct: isCorrect,
                rt_ms: selectedEmotion === 'TIMEOUT' ? 5000 : rt
            });

            currentTrial++;
            
            // æ¸…ç©ºå±å¹•ï¼Œç»™äºˆæçŸ­çš„è§†è§‰é—´éš”åè¿›å…¥ä¸‹ä¸€é¢˜
            document.getElementById('stimulus-container').innerHTML = '';
            setTimeout(nextTrial, 250); 
        }

        function finishFER() {
            // è®¡ç®—å¹³å‡ååº”æ—¶ (ä»…è®¡ç®—ä½œç­”æ­£ç¡®çš„è¯•æ¬¡)
            const correctTrials = ferData.records.filter(r => r.correct);
            const avgRt = correctTrials.length > 0 
                ? Math.round(correctTrials.reduce((sum, r) => sum + r.rt_ms, 0) / correctTrials.length) 
                : 0;
            
            // è®¡ç®—æ€»ä½“å‡†ç¡®ç‡
            const accuracy = Math.round((ferData.correct_count / TOTAL_TRIALS) * 100);

            ferData.summary = {
                accuracy_percent: accuracy,
                avg_correct_rt_ms: avgRt,
                total_trials: TOTAL_TRIALS,
                timeout_count: ferData.records.filter(r => r.response === 'TIMEOUT').length
            };

            CAS_Storage.saveModuleData('Emotion_FER', ferData);
            
            alert(`âœ… FER é¢å­”è¯†åˆ«æµ‹éªŒå®Œæˆï¼\n\n- å‡†ç¡®ç‡: ${accuracy}%\n- å¹³å‡ååº”æ—¶: ${avgRt} ms\n- è¶…æ—¶æœªç­”: ${ferData.summary.timeout_count} æ¬¡`);
            location.href = 'index.html';
        }
    </script>
</body>
</html>
