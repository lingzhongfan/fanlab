<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-EMO | æƒ…æ„ŸçŠ¶æ€ä¸å†³ç­–å€¾å‘</title>
    <style>
        /* å…¨å±€æ ·å¼ä¸é˜²è¯¯è§¦ */
        body { 
            font-family: -apple-system, sans-serif; 
            background: #f8fafc; 
            margin: 0; 
            padding: 20px; 
            touch-action: manipulation; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        .container { 
            max-width: 650px; 
            margin: 20px auto; 
            background: white; 
            padding: 35px 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }
        .module-header { 
            color: #0f172a; 
            margin-top: 0; 
            font-size: 24px; 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        
        /* é€šç”¨æŒ‰é’® */
        .sys-btn { 
            background: #0f172a; 
            color: white; 
            border: none; 
            padding: 18px 30px; 
            font-size: 16px; 
            font-weight: bold; 
            border-radius: 12px; 
            cursor: pointer; 
            width: 100%; 
            margin-bottom: 15px; 
            transition: 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .sys-btn:active { transform: scale(0.98); } 
        .hidden { display: none !important; }
        
        #nav-back { 
            display: inline-flex; 
            align-items: center; 
            text-decoration: none; 
            color: #3b82f6; 
            font-weight: bold; 
            margin-bottom: 15px; 
            padding: 10px 18px; 
            background: #eff6ff; 
            border-radius: 10px; 
            transition: 0.2s; 
        } 
        #nav-back:active { background: #dbeafe; }
        
        /* 1 & 2. é‡è¡¨æ»‘å—æ ·å¼ä¼˜åŒ– */
        .slider-group { margin-bottom: 30px; } 
        .slider-group label { 
            display: block; 
            font-weight: bold; 
            margin-bottom: 12px; 
            color: #1e293b; 
            font-size: 15px; 
        }
        input[type=range] { 
            -webkit-appearance: none; 
            width: 100%; 
            height: 8px; 
            background: #e2e8f0; 
            border-radius: 4px; 
            outline: none; 
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 28px; 
            height: 28px; 
            border-radius: 50%; 
            background: #3b82f6; 
            cursor: pointer; 
            border: 4px solid white; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
        }
        .labels { 
            display: flex; 
            justify-content: space-between; 
            font-size: 13px; 
            color: #64748b; 
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* 3. BART æ°”çƒæ ·å¼ */
        #bart-workspace { 
            width: 100%; 
            height: 320px; 
            background: #f1f5f9; 
            border-radius: 16px; 
            display: flex; 
            align-items: flex-end; 
            justify-content: center; 
            overflow: hidden; 
            position: relative; 
            border: 2px solid #cbd5e1; 
            margin-bottom: 20px; 
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.05); 
        }
        #balloon { 
            width: 40px; 
            height: 50px; 
            background: radial-gradient(circle at 30% 30%, #f87171, #dc2626); 
            border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%; 
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; 
            bottom: 25px; 
            box-shadow: -5px -5px 15px rgba(0,0,0,0.1) inset, 0 10px 10px rgba(0,0,0,0.1); 
        }
        .bart-controls { display: flex; gap: 15px; } 
        .bart-btn { 
            flex: 1; 
            padding: 18px; 
            font-size: 18px; 
            font-weight: bold; 
            border: none; 
            border-radius: 12px; 
            color: white; 
            cursor: pointer; 
            transition: 0.1s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        } 
        .bart-btn:active:not(:disabled) { transform: scale(0.96); } 
        .bart-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* 4. æƒ…ç»ª Stroop æ ·å¼ */
        #emo-word { 
            font-size: 80px; 
            font-weight: bold; 
            margin: 60px 0; 
            min-height: 100px; 
            text-align: center; 
            letter-spacing: 5px; 
        }
        .color-btn-group { display: flex; gap: 20px; justify-content: center; } 
        .color-btn { 
            width: 90px; 
            height: 70px; 
            border-radius: 16px; 
            border: none; 
            cursor: pointer; 
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); 
            transition: 0.1s; 
        } 
        .color-btn:active { transform: scale(0.92); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div style="text-align: left; max-width: 650px; margin: 0 auto;">
        <a href="index.html" id="nav-back">â† è¿”å›æ§åˆ¶å°</a>
    </div>
    
    <div class="container" id="menu">
        <h2 class="module-header">â¤ï¸ æƒ…æ„Ÿå€¾å‘ä¸å†³ç­–é‡è¡¨</h2>
        
        <h3 style="color:#64748b; font-size:15px; margin-bottom:15px;">é‡è¡¨éƒ¨åˆ† (Self-Report)</h3>
        <button class="sys-btn" onclick="show('ema-area')">1. å®æ—¶çŠ¶æ€è¯„ä¼° (EMA)</button>
        <button class="sys-btn" onclick="show('b5-area')">2. äººæ ¼ç‰¹è´¨å€¾å‘é‡è¡¨ (Big 5)</button>
        
        <h3 style="color:#64748b; font-size:15px; margin-top:30px; margin-bottom:15px;">è¡Œä¸ºå­¦èŒƒå¼ (Behavioral)</h3>
        <button class="sys-btn" onclick="startBART()" style="background:#3b82f6;">3. BART æ°”çƒé£é™©å†³ç­–ä»»åŠ¡</button>
        <button class="sys-btn" onclick="startEmoStroop()" style="background:#3b82f6;">4. æƒ…ç»ª Stroop æ³¨æ„åå‘æå–</button>
    </div>

    <div class="container hidden" id="ema-area">
        <h2 class="module-header">ç¬æ—¶çŠ¶æ€è¯„ä¼° (EMA)</h2>
        <div class="slider-group">
            <label>æ„Ÿå—ï¼šæ‚¨å½“ä¸‹çš„ã€æƒ…ç»ªä½è½/æŠ‘éƒã€‘ç¨‹åº¦</label>
            <input type="range" id="e1" value="0">
            <div class="labels"><span>å®Œå…¨æ²¡æœ‰</span><span>æåº¦å¼ºçƒˆ</span></div>
        </div>
        <div class="slider-group">
            <label>æ„Ÿå—ï¼šæ‚¨å½“ä¸‹çš„ã€ç´§å¼ ä¸å®‰/ç„¦è™‘ã€‘ç¨‹åº¦</label>
            <input type="range" id="e2" value="0">
            <div class="labels"><span>å®Œå…¨æ²¡æœ‰</span><span>æåº¦å¼ºçƒˆ</span></div>
        </div>
        <button class="sys-btn" style="margin-top:20px; background:#10b981;" onclick="saveEMA()">âœ“ ä¿å­˜çŠ¶æ€æ•°æ®</button>
    </div>

    <div class="container hidden" id="b5-area">
        <h2 class="module-header">å¤§äº”äººæ ¼ (Big 5)</h2>
        <p style="color:#64748b; font-size:14px; margin-bottom:25px;">è¯·è¯„ä¼°æ‚¨é•¿æœŸçš„æ€§æ ¼ç‰¹å¾å€¾å‘ã€‚</p>
        <div class="slider-group"><label>O - å¼€æ”¾æ€§ (ä¹äºæ¥å—æ–°äº‹ç‰©)</label><input type="range" id="b1"></div>
        <div class="slider-group"><label>C - å°½è´£æ€§ (ä¸¥è°¨ç»†è‡´ã€è‡ªå¾‹)</label><input type="range" id="b2"></div>
        <div class="slider-group"><label>E - å¤–å‘æ€§ (å–œçˆ±äº¤é™…ã€å……æ»¡æ´»åŠ›)</label><input type="range" id="b3"></div>
        <div class="slider-group"><label>A - å®œäººæ€§ (å¯Œæœ‰åŒæƒ…å¿ƒã€ä¹äºåˆä½œ)</label><input type="range" id="b4"></div>
        <div class="slider-group"><label>N - ç¥ç»è´¨ (æƒ…ç»ªæ˜“æ³¢åŠ¨ã€æ•æ„Ÿ)</label><input type="range" id="b5"></div>
        <button class="sys-btn" style="margin-top:15px; background:#10b981;" onclick="saveB5()">âœ“ ä¿å­˜äººæ ¼ç‰¹è´¨</button>
    </div>

    <div class="container hidden" id="bart-area">
        <h2 class="module-header">BART é£é™©å†³ç­–</h2>
        <p style="font-size:14px; color:#64748b; margin-top:-10px;">ä¸æ–­å……æ°”å¯èµšå–ç§¯åˆ†ï¼Œä½†æ°”çƒéšæ—¶å¯èƒ½çˆ†ç‚¸å¯¼è‡´æœ¬è½®ç§¯åˆ†æ¸…é›¶ã€‚è¯·åœ¨åˆé€‚æ—¶æœºæ”¶é›†ç§¯åˆ†ã€‚(å…±5è½®)</p>
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold; font-size:18px; padding:0 5px;">
            <span id="bart-round" style="color:#0f172a;">ç¬¬ 1 / 5 è½®</span>
            <span id="bart-pot" style="color:#ef4444;">æ°”çƒå†…: $0</span>
            <span id="bart-total" style="color:#10b981;">æ€»é“¶è¡Œ: $0</span>
        </div>
        <div id="bart-workspace"><div id="balloon"></div></div>
        <div class="bart-controls">
            <button class="bart-btn" style="background:#ef4444;" id="btn-pump" onclick="pumpBalloon()">ğŸˆ å……æ°” (+ $1)</button>
            <button class="bart-btn" style="background:#10b981;" id="btn-collect" onclick="collectMoney()">ğŸ’° æ”¶é›†å…¥åº“</button>
        </div>
    </div>

    <div class="container hidden" id="emo-stroop-area">
        <h2 class="module-header">æƒ…ç»ªæ³¨æ„åå‘æå–</h2>
        <p style="font-size:15px; color:#64748b;">è¯·ä»¥æœ€å¿«é€Ÿåº¦è¯†åˆ«ï¼Œå¹¶ç‚¹å‡»æ–‡å­—å®é™…æ˜¾ç¤ºçš„<strong>é¢œè‰²</strong>ã€‚</p>
        <div id="emo-word">+</div>
        <div class="color-btn-group hidden" id="emo-controls">
            <button class="color-btn" style="background:#ef4444;" onclick="recordEmoStroop('red')"></button>
            <button class="color-btn" style="background:#22c55e;" onclick="recordEmoStroop('green')"></button>
            <button class="color-btn" style="background:#3b82f6;" onclick="recordEmoStroop('blue')"></button>
        </div>
    </div>

    <script>
        // è§†å›¾è·¯ç”±å‡½æ•°
        function show(id) { 
            ['menu', 'ema-area', 'b5-area', 'bart-area', 'emo-stroop-area'].forEach(d => {
                document.getElementById(d).classList.add('hidden');
            }); 
            document.getElementById(id).classList.remove('hidden'); 
            window.scrollTo(0,0); 
        }

        /* ==================== 1 & 2. é‡è¡¨ä¿å­˜é€»è¾‘ ==================== */
        function saveEMA() { 
            CAS_Storage.saveModuleData('Emotion_State_EMA', { 
                depression: document.getElementById('e1').value, 
                anxiety: document.getElementById('e2').value 
            }); 
            alert("ç¬æ—¶çŠ¶æ€æ•°æ®å·²æˆåŠŸå½•å…¥ç³»ç»Ÿã€‚"); 
            show('menu'); 
        }

        function saveB5() { 
            CAS_Storage.saveModuleData('Emotion_Trait_Big5', { 
                O: document.getElementById('b1').value, 
                C: document.getElementById('b2').value, 
                E: document.getElementById('b3').value, 
                A: document.getElementById('b4').value, 
                N: document.getElementById('b5').value 
            }); 
            alert("å¤§äº”äººæ ¼ç‰¹è´¨æ•°æ®å·²å½•å…¥ã€‚"); 
            show('menu'); 
        }
        
        /* ==================== 3. BART (æ°”çƒé£é™©å†³ç­–) é€»è¾‘ ==================== */
        let bartData = { module: "Emotion_Risk_BART", total_earned: 0, trials: [] };
        let b_trial = 1, b_maxTrials = 5, b_pumps = 0, b_total = 0;
        let b_popLimit = 0, b_lastPumpT = 0, b_pumpRTs = [];

        function startBART() { 
            b_trial = 1; 
            b_total = 0; 
            bartData.trials = []; 
            initBalloon(); 
        }

        function initBalloon() { 
            // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰è½®æ¬¡
            if(b_trial > b_maxTrials) { 
                bartData.total_earned = b_total; 
                CAS_Storage.saveModuleData('Emotion_Risk_BART', bartData); 
                alert(`ä»»åŠ¡å®Œæˆï¼æ‚¨çš„é£é™©å†³ç­–æ€»æ”¶ç›Š: $${b_total}`); 
                show('menu'); 
                return; 
            } 
            
            b_pumps = 0; 
            b_pumpRTs = []; 
            // è®¾å®šå½“å‰æ°”çƒçš„çˆ†ç‚¸é˜ˆå€¼ (5 åˆ° 30 ä¹‹é—´éšæœº)
            b_popLimit = Math.floor(Math.random() * 25) + 5; 
            
            // é‡ç½®æ°”çƒ UI
            document.getElementById('balloon').style.width = '40px'; 
            document.getElementById('balloon').style.height = '50px'; 
            document.getElementById('balloon').style.background = 'radial-gradient(circle at 30% 30%, #f87171, #dc2626)'; 
            document.getElementById('balloon').innerText = ""; 
            
            // æ›´æ–°çœ‹æ¿
            document.getElementById('bart-round').innerText = `ç¬¬ ${b_trial} / ${b_maxTrials} è½®`; 
            document.getElementById('bart-pot').innerText = `æ°”çƒå†…: $0`; 
            document.getElementById('bart-total').innerText = `æ€»é“¶è¡Œ: $${b_total}`; 
            
            // å¯ç”¨æŒ‰é’®
            document.getElementById('btn-pump').disabled = false; 
            document.getElementById('btn-collect').disabled = false; 
            b_lastPumpT = performance.now(); 
        }

        function pumpBalloon() { 
            // è®°å½•æ¯æ¬¡å……æ°”çš„ååº”æ—¶é—´ (å†³ç­–çŠ¹è±«åº¦)
            let rt = performance.now() - b_lastPumpT; 
            b_pumpRTs.push(Math.round(rt)); 
            b_lastPumpT = performance.now(); 
            b_pumps++; 
            
            // åˆ¤æ–­æ˜¯å¦çˆ†ç‚¸
            if (b_pumps >= b_popLimit) { 
                // çˆ†ç‚¸è§†è§‰æ•ˆæœ
                document.getElementById('balloon').style.background = 'transparent'; 
                document.getElementById('balloon').innerText = "ğŸ’¥"; 
                document.getElementById('balloon').style.fontSize = "40px"; 
                
                // ç¦ç”¨æ“ä½œ
                document.getElementById('btn-pump').disabled = true; 
                document.getElementById('btn-collect').disabled = true; 
                
                // è®°å½•æ•°æ®ï¼šçˆ†ç‚¸å¯¼è‡´æœ¬è½®æ”¶ç›Šä¸º 0
                bartData.trials.push({ 
                    trial: b_trial, 
                    pumps: b_pumps, 
                    exploded: true, 
                    earned: 0, 
                    rt_array: [...b_pumpRTs] 
                }); 
                
                // å»¶è¿Ÿè¿›å…¥ä¸‹ä¸€è½®
                setTimeout(() => { 
                    b_trial++; 
                    initBalloon(); 
                }, 1200); 
            } else { 
                // æ°”çƒè†¨èƒ€
                let w = 40 + b_pumps * 6; 
                let h = 50 + b_pumps * 7; 
                document.getElementById('balloon').style.width = w + 'px'; 
                document.getElementById('balloon').style.height = h + 'px'; 
                document.getElementById('bart-pot').innerText = `æ°”çƒå†…: $${b_pumps}`; 
            } 
        }

        function collectMoney() { 
            // æˆåŠŸæ”¶é›†ï¼Œæœ¬è½®ç§¯åˆ†è®¡å…¥æ€»é“¶è¡Œ
            b_total += b_pumps; 
            bartData.trials.push({ 
                trial: b_trial, 
                pumps: b_pumps, 
                exploded: false, 
                earned: b_pumps, 
                rt_array: [...b_pumpRTs] 
            }); 
            b_trial++; 
            initBalloon(); 
        }
        
        /* ==================== 4. EmoStroop (æƒ…ç»ª Stroop) é€»è¾‘ ==================== */
        const emoWords = [ 
            { w: 'ç–¾ç—…', val: 'negative' }, 
            { w: 'å¤±è´¥', val: 'negative' }, 
            { w: 'ç—›è‹¦', val: 'negative' }, 
            { w: 'æ¤…å­', val: 'neutral' }, 
            { w: 'ä¹¦æœ¬', val: 'neutral' }, 
            { w: 'æ°´æ¯', val: 'neutral' }, 
            { w: 'å¿«ä¹', val: 'positive' }, 
            { w: 'æˆåŠŸ', val: 'positive' }, 
            { w: 'å¸Œæœ›', val: 'positive'} 
        ]; 
        const colors = ['red', 'green', 'blue']; 
        let esData = { module: "Emotion_Affective_Stroop", records: [] };
        let es_trial = 0, es_max = 15, es_onset = 0, es_targetColor = '';

        function startEmoStroop() { 
            es_trial = 0; 
            esData.records = []; 
            nextEmoStroop(); 
        }

        function nextEmoStroop() { 
            if(es_trial >= es_max) { 
                CAS_Storage.saveModuleData('Emotion_Affective_Stroop', esData); 
                alert("åå‘æå–å®Œæˆ"); 
                show('menu'); 
                return; 
            } 
            
            // éšè—æ§åˆ¶æŒ‰é’®ï¼Œå±•ç¤ºæ³¨è§†ç‚¹
            document.getElementById('emo-controls').classList.add('hidden'); 
            document.getElementById('emo-word').innerText = "+"; 
            document.getElementById('emo-word').style.color = "#94a3b8"; 
            
            // åˆºæ¿€å‘ˆç°å»¶è¿Ÿ (ITI)
            setTimeout(() => { 
                let wordObj = emoWords[Math.floor(Math.random() * emoWords.length)]; 
                es_targetColor = colors[Math.floor(Math.random() * colors.length)]; 
                
                document.getElementById('emo-word').innerText = wordObj.w; 
                document.getElementById('emo-word').style.color = es_targetColor; 
                document.getElementById('emo-word').dataset.val = wordObj.val; 
                
                document.getElementById('emo-controls').classList.remove('hidden'); 
                es_onset = performance.now(); 
            }, 800); 
        }

        function recordEmoStroop(sel) { 
            let rt = performance.now() - es_onset; 
            let val = document.getElementById('emo-word').dataset.val; 
            
            esData.records.push({ 
                trial: es_trial + 1, 
                word_valence: val, 
                correct: sel === es_targetColor, 
                rt_ms: Math.round(rt) 
            }); 
            
            es_trial++; 
            nextEmoStroop(); 
        }
    </script>
</body>
</html>
