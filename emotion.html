<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-EMO | æƒ…ç»ªä¸ç¤¾ä¼šè®¤çŸ¥è¯„ä¼°</title>
    <style>
        /* ç§‘æŠ€æ¸©æƒ…é£ CSS */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --slate: #64748b; }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; touch-action: manipulation; }
        .container { max-width: 700px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--blue); padding-left: 15px; margin-bottom: 30px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; }

        /* æŒ‰é’®ç³»ç»Ÿ */
        .sys-btn { width: 100%; padding: 18px; margin-bottom: 15px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; display: flex; align-items: center; justify-content: flex-start; gap: 12px; }
        .btn-menu { background: var(--light-blue); color: var(--blue); border: 1px solid #e0e7ff; }
        .btn-menu:hover { background: var(--blue); color: white; transform: translateY(-2px); box-shadow: 0 8px 15px rgba(79, 70, 229, 0.2); }
        .btn-action { background: var(--blue); color: white; justify-content: center; margin-top: 20px; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-action:active { transform: scale(0.98); }
        .btn-action:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        /* ä¼˜åŒ–çš„é‡è¡¨æ»‘å— */
        .slider-box { margin-bottom: 35px; background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px dashed #e2e8f0; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .slider-header label { font-weight: bold; color: var(--primary); font-size: 15px; }
        .val-badge { background: var(--blue); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 28px; height: 28px; background: white; border: 4px solid var(--blue); border-radius: 50%; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .labels { display: flex; justify-content: space-between; font-size: 13px; color: var(--slate); margin-top: 12px; font-weight: 500; }

        /* BART æ°”çƒ */
        #bart-workspace { width: 100%; height: 300px; background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 20px; display: flex; align-items: flex-end; justify-content: center; position: relative; margin-bottom: 25px; overflow: hidden; }
        #balloon { width: 40px; height: 50px; background: radial-gradient(circle at 30% 30%, #fb7185, #e11d48); border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%; transition: all 0.15s ease-out; position: relative; bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 35px; }

        /* FER é¢å­”ä¸ Stroop */
        .stimulus-box { font-size: 90px; margin: 50px 0; font-weight: bold; text-align: center; display: flex; justify-content: center; align-items: center; height: 120px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .btn-choice { background: #f1f5f9; color: var(--primary); border: 2px solid #e2e8f0; border-radius: 16px; padding: 25px 0; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-choice:active { background: var(--blue); color: white; border-color: var(--blue); transform: scale(0.95); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>

    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>â¤ï¸ æƒ…æ„Ÿä¸ç¤¾ä¼šè®¤çŸ¥ (CAS-EMO)</h2>
            <p>å¯¹æ ‡ NIH Toolbox: åŒ…å«æƒ…ç»ªçŠ¶æ€ã€å¿ƒç†å¹¸ç¦æ„Ÿã€ç¤¾ä¼šæ”¯æŒä¸è¡Œä¸ºå†³ç­–ã€‚</p>
        </div>
        
        <h3 style="font-size: 15px; color: var(--slate); margin-top: 30px;">ä¸»è§‚é‡è¡¨ (Self-Report)</h3>
        <button class="sys-btn btn-menu" onclick="show('ema-area')">ğŸ“Š 1. ç¬æ—¶çŠ¶æ€ä¸å¹¸ç¦æ„Ÿ (EMA+)</button>
        <button class="sys-btn btn-menu" onclick="show('social-area')">ğŸ¤ 2. ç¤¾ä¼šæ”¯æŒä¸å­¤ç‹¬æ„Ÿç­›æŸ¥</button>
        <button class="sys-btn btn-menu" onclick="show('b5-area')">ğŸ§  3. å¤§äº”äººæ ¼ç‰¹è´¨ç”»åƒ (Big 5)</button>
        
        <h3 style="font-size: 15px; color: var(--slate); margin-top: 30px;">è¡Œä¸ºä¸ç¤¾ä¼šè®¤çŸ¥ (Behavioral)</h3>
        <button class="sys-btn btn-menu" onclick="startFER()">ğŸ˜ƒ 4. é¢å­”æƒ…ç»ªè¯†åˆ«ä»»åŠ¡ (FER) <span style="font-size:12px; background:#f43f5e; color:white; padding:2px 8px; border-radius:10px; margin-left:auto;">NEW</span></button>
        <button class="sys-btn btn-menu" onclick="startBART()">ğŸˆ 5. BART æ°”çƒé£é™©å†³ç­–ä»»åŠ¡</button>
        <button class="sys-btn btn-menu" onclick="startEmoStroop()">âš¡ 6. æƒ…ç»ª Stroop æ³¨æ„åå‘</button>
    </div>

    <div class="container hidden" id="ema-area">
        <div class="module-header"><h2>ç¬æ—¶çŠ¶æ€ä¸å¹¸ç¦æ„Ÿ</h2><p>è¯·æ ¹æ®æ‚¨æ­¤æ—¶æ­¤åˆ»çš„æ„Ÿå—æ‹–åŠ¨æ»‘å—ã€‚</p></div>
        <div class="slider-box"><div class="slider-header"><label>1. æ„Ÿåˆ°ã€ç´§å¼ /ç„¦è™‘ã€‘ (è´Ÿæ€§)</label><span class="val-badge" id="v1">0%</span></div><input type="range" id="ema-1" min="0" max="100" value="0" oninput="updateVal('ema-1','v1')"><div class="labels"><span>å®Œå…¨æ²¡æœ‰</span><span>æåº¦å¼ºçƒˆ</span></div></div>
        <div class="slider-box"><div class="slider-header"><label>2. æ„Ÿåˆ°ã€æƒ…ç»ªä½è½ã€‘ (è´Ÿæ€§)</label><span class="val-badge" id="v2">0%</span></div><input type="range" id="ema-2" min="0" max="100" value="0" oninput="updateVal('ema-2','v2')"><div class="labels"><span>å®Œå…¨æ²¡æœ‰</span><span>æåº¦å¼ºçƒˆ</span></div></div>
        <div class="slider-box"><div class="slider-header"><label>3. æ„Ÿåˆ°ã€ç²¾åŠ›å……æ²›/æ„‰æ‚¦ã€‘ (ç§¯æ/å¹¸ç¦æ„Ÿ)</label><span class="val-badge" id="v3" style="background:var(--green);">0%</span></div><input type="range" id="ema-3" min="0" max="100" value="0" oninput="updateVal('ema-3','v3')"><div class="labels"><span>å®Œå…¨æ²¡æœ‰</span><span>æåº¦å¼ºçƒˆ</span></div></div>
        <button class="sys-btn btn-action" onclick="saveEMA()">è®¡ç®—å¾—åˆ†å¹¶å…¥åº“</button>
    </div>

    <div class="container hidden" id="social-area">
        <div class="module-header"><h2>ç¤¾ä¼šå…³ç³»ä¸å­¤ç‹¬æ„Ÿ</h2><p>ç¤¾ä¼šç½‘ç»œé€€åŒ–æ˜¯è®¤çŸ¥éšœç¢çš„ææ—©æœŸé¢„è­¦ä¿¡å·ã€‚</p></div>
        <div class="slider-box"><div class="slider-header"><label>1. æ„Ÿåˆ°è¢«å‘¨å›´äººå­¤ç«‹/ç¼ºä¹é™ªä¼´</label><span class="val-badge" id="s1">0%</span></div><input type="range" id="soc-1" min="0" max="100" value="0" oninput="updateVal('soc-1','s1')"><div class="labels"><span>ä»ä¸</span><span>æ€»æ˜¯</span></div></div>
        <div class="slider-box"><div class="slider-header"><label>2. é‡åˆ°å›°éš¾æ—¶ï¼Œèƒ½å¾—åˆ°å®¶äººçš„æƒ…æ„Ÿæ”¯æŒ</label><span class="val-badge" id="s2" style="background:var(--green);">0%</span></div><input type="range" id="soc-2" min="0" max="100" value="0" oninput="updateVal('soc-2','s2')"><div class="labels"><span>ä»ä¸</span><span>æ€»æ˜¯</span></div></div>
        <button class="sys-btn btn-action" onclick="saveSocial()">ä¿å­˜ç¤¾ä¼šå…³ç³»æ•°æ®</button>
    </div>

    <div class="container hidden" id="b5-area">
        <div class="module-header"><h2>å¤§äº”äººæ ¼ (Big 5)</h2><p>ç‰¹è´¨è¯„ä¼° (0=æä¸ç¬¦åˆ, 100=éå¸¸ç¬¦åˆ)</p></div>
        <div class="slider-box"><div class="slider-header"><label>O. å¼€æ”¾æ¥å—æ–°äº‹ç‰©</label><span class="val-badge" id="b1">50%</span></div><input type="range" id="b5-o" min="0" max="100" value="50" oninput="updateVal('b5-o','b1')"></div>
        <div class="slider-box"><div class="slider-header"><label>N. æƒ…ç»ªæ•æ„Ÿã€æ˜“æ³¢åŠ¨</label><span class="val-badge" id="b2">50%</span></div><input type="range" id="b5-n" min="0" max="100" value="50" oninput="updateVal('b5-n','b2')"></div>
        <button class="sys-btn btn-action" onclick="saveB5()">ä¿å­˜äººæ ¼ç‰¹è´¨</button>
    </div>

    <div class="container hidden" id="fer-area">
        <div class="module-header"><h2>é¢å­”æƒ…ç»ªè¯†åˆ« (FER)</h2><p>è¯·ä»¥æœ€å¿«é€Ÿåº¦æŒ‡å‡ºä¸Šæ–¹è¡¨æƒ…æ‰€ä»£è¡¨çš„æƒ…ç»ªã€‚</p></div>
        <div style="font-weight:bold; color:var(--blue); margin-bottom: 10px;">è¿›åº¦: <span id="fer-prog">1/8</span></div>
        <div class="stimulus-box" id="fer-face">ğŸ˜</div>
        <div class="grid-3" id="fer-controls">
            <button class="btn-choice" onclick="recordFER('æ„¤æ€’')">æ„¤æ€’</button>
            <button class="btn-choice" onclick="recordFER('å¼€å¿ƒ')">å¼€å¿ƒ</button>
            <button class="btn-choice" onclick="recordFER('æ‚²ä¼¤')">æ‚²ä¼¤</button>
            <button class="btn-choice" onclick="recordFER('ææƒ§')">ææƒ§</button>
            <button class="btn-choice" onclick="recordFER('ä¸­æ€§')">ä¸­æ€§</button>
            <button class="btn-choice" onclick="recordFER('åŒæ¶')">åŒæ¶</button>
        </div>
    </div>

    <div class="container hidden" id="bart-area">
        <div class="module-header"><h2>BART é£é™©å†³ç­–</h2></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <div style="font-size:16px; font-weight:bold; color:var(--slate);">è½®æ¬¡: <span id="bart-round" style="color:var(--blue);">1/5</span></div>
            <div style="font-size:18px; font-weight:bold;">æœ¬è½®ç§¯ç´¯: <span id="bart-pot" style="color:var(--red); font-size:24px;">$0</span></div>
        </div>
        <div id="bart-workspace"><div id="balloon"></div></div>
        <div class="grid-3" style="grid-template-columns: 1fr 1fr;">
            <button class="sys-btn btn-action" id="btn-pump" onclick="pumpBalloon()" style="margin:0; box-shadow:none;">ğŸˆ å……æ°” (+1)</button>
            <button class="sys-btn" style="background:var(--green); color:white; margin:0;" id="btn-collect" onclick="collectMoney()">ğŸ’° æ”¶é›†æ”¶ç›Š</button>
        </div>
    </div>

    <div class="container hidden" id="emo-area">
        <div class="module-header"><h2>æƒ…ç»ª Stroop æ³¨æ„åå‘</h2><p>è¯·ç‚¹å‡»æ–‡å­—å®é™…æ˜¾ç¤ºçš„ç‰©ç†é¢œè‰²ï¼Œå¿½ç•¥æ–‡å­—å«ä¹‰ã€‚</p></div>
        <div class="stimulus-box" id="emo-word">+</div>
        <div class="grid-3 hidden" id="emo-controls">
            <button class="btn-choice" style="background:var(--red); color:white; border:none;" onclick="recordES('red')">çº¢</button>
            <button class="btn-choice" style="background:var(--green); color:white; border:none;" onclick="recordES('green')">ç»¿</button>
            <button class="btn-choice" style="background:var(--blue); color:white; border:none;" onclick="recordES('blue')">è“</button>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒ UI åˆ‡æ¢
        function show(id) {
            ['menu', 'ema-area', 'social-area', 'b5-area', 'fer-area', 'bart-area', 'emo-area'].forEach(d => {
                const el = document.getElementById(d); if(el) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0);
        }

        function updateVal(inputID, spanID) { document.getElementById(spanID).innerText = document.getElementById(inputID).value + "%"; }

        // é‡è¡¨ä¿å­˜è®¡ç®—é€»è¾‘
        function saveEMA() {
            const neg1 = parseInt(document.getElementById('ema-1').value);
            const neg2 = parseInt(document.getElementById('ema-2').value);
            const pos1 = parseInt(document.getElementById('ema-3').value);
            CAS_Storage.saveModuleData('Emotion_EMA_Wellbeing', { 
                negative_affect: (neg1 + neg2) / 2, positive_affect: pos1 
            });
            alert("çŠ¶æ€ä¸å¹¸ç¦æ„Ÿä¿å­˜æˆåŠŸï¼"); show('menu');
        }
        function saveSocial() {
            CAS_Storage.saveModuleData('Emotion_Social', { loneliness: document.getElementById('soc-1').value, support: document.getElementById('soc-2').value });
            alert("ç¤¾ä¼šæ”¯æŒè¯„åˆ†ä¿å­˜æˆåŠŸï¼"); show('menu');
        }
        function saveB5() {
            CAS_Storage.saveModuleData('Emotion_Big5', { O: document.getElementById('b5-o').value, N: document.getElementById('b5-n').value });
            alert("äººæ ¼ç”»åƒä¿å­˜æˆåŠŸï¼"); show('menu');
        }

        /* ================= 4. FER é¢å­”æƒ…ç»ªè¯†åˆ«é€»è¾‘ (NEW) ================= */
        const ferStimuli = [
            { face: 'ğŸ˜ ', ans: 'æ„¤æ€’' }, { face: 'ğŸ˜Š', ans: 'å¼€å¿ƒ' }, 
            { face: 'ğŸ˜¨', ans: 'ææƒ§' }, { face: 'ğŸ˜¢', ans: 'æ‚²ä¼¤' },
            { face: 'ğŸ˜', ans: 'ä¸­æ€§' }, { face: 'ğŸ¤¢', ans: 'åŒæ¶' }
        ];
        let ferData = { module: "Emotion_FER", records: [] };
        let fer_trial = 0, fer_onset = 0, fer_current = null;

        function startFER() {
            fer_trial = 0; ferData.records = []; show('fer-area'); nextFER();
        }
        function nextFER() {
            if(fer_trial >= ferStimuli.length) {
                CAS_Storage.saveModuleData('Emotion_FER', ferData);
                alert("é¢å­”è¯†åˆ«æµ‹è¯•å®Œæˆï¼æ•°æ®å·²åˆ†æå…¥åº“ã€‚"); show('menu'); return;
            }
            document.getElementById('fer-prog').innerText = `${fer_trial + 1}/${ferStimuli.length}`;
            fer_current = ferStimuli[fer_trial];
            document.getElementById('fer-face').innerText = '+';
            
            setTimeout(() => {
                document.getElementById('fer-face').innerText = fer_current.face;
                fer_onset = performance.now();
            }, 600);
        }
        function recordFER(choice) {
            if(document.getElementById('fer-face').innerText === '+') return; // é˜²æ­¢æå‰æŠ¢ç­”
            const rt = Math.round(performance.now() - fer_onset);
            ferData.records.push({ face: fer_current.face, response: choice, correct: choice === fer_current.ans, rt_ms: rt });
            fer_trial++; nextFER();
        }

        /* ================= 5. BART æ ¸å¿ƒé€»è¾‘ (ä¿®å¤å®Œç¾æ”¶é›†ç‰ˆ) ================= */
        let bartData = { module: "Emotion_BART", trials: [], total_gain: 0 };
        let b_round = 1, b_pumps = 0, b_popLimit = 0;

        function startBART() { b_round = 1; bartData.trials = []; bartData.total_gain = 0; show('bart-area'); nextBRound(); }
        function nextBRound() {
            if(b_round > 5) { CAS_Storage.saveModuleData('Emotion_BART', bartData); alert(`BARTç»“æŸï¼Œæ€»èµšå–: $${bartData.total_gain}`); show('menu'); return; }
            b_pumps = 0; b_popLimit = Math.floor(Math.random() * 12) + 3; 
            document.getElementById('bart-round').innerText = `${b_round}/5`; document.getElementById('bart-pot').innerText = `$0`;
            const b = document.getElementById('balloon'); b.innerText = ""; b.style.width = '50px'; b.style.height = '60px'; b.style.background = 'radial-gradient(circle at 30% 30%, #fb7185, #e11d48)';
            document.getElementById('btn-pump').disabled = false; document.getElementById('btn-collect').disabled = false;
        }
        function pumpBalloon() {
            b_pumps++;
            if(b_pumps >= b_popLimit) {
                document.getElementById('btn-pump').disabled = true; document.getElementById('btn-collect').disabled = true;
                const b = document.getElementById('balloon'); b.style.background = 'transparent'; b.innerText = "ğŸ’¥";
                bartData.trials.push({ round: b_round, pumps: b_pumps, status: 'popped', gain: 0 });
                setTimeout(() => { b_round++; nextBRound(); }, 1200);
            } else {
                const b = document.getElementById('balloon'); b.style.width = (50 + b_pumps * 12) + 'px'; b.style.height = (60 + b_pumps * 15) + 'px';
                document.getElementById('bart-pot').innerText = `$${b_pumps}`;
            }
        }
        function collectMoney() {
            if(b_pumps === 0) return alert("è¯·å…ˆå……æ°”è·å–æ”¶ç›Šï¼");
            document.getElementById('btn-pump').disabled = true; document.getElementById('btn-collect').disabled = true;
            bartData.total_gain += b_pumps;
            bartData.trials.push({ round: b_round, pumps: b_pumps, status: 'collected', gain: b_pumps });
            alert(`âœ… æˆåŠŸæ”¶é›†: $${b_pumps}`); b_round++; nextBRound();
        }

        /* ================= 6. Stroop é€»è¾‘ ================= */
        let es_onset = 0, es_trial = 0;
        function startEmoStroop() { es_trial = 0; show('emo-area'); nextES(); }
        function nextES() {
            if(es_trial >= 5) { alert("æµ‹è¯•å®Œæˆ"); show('menu'); return; }
            document.getElementById('emo-controls').classList.add('hidden'); document.getElementById('emo-word').innerText = "+"; document.getElementById('emo-word').style.color = "#cbd5e1";
            setTimeout(() => {
                document.getElementById('emo-word').innerText = "å¤±è´¥"; document.getElementById('emo-word').style.color = "#ef4444";
                document.getElementById('emo-controls').classList.remove('hidden'); es_onset = performance.now();
            }, 800);
        }
        function recordES(c) { es_trial++; nextES(); }
    </script>
</body>
</html>
