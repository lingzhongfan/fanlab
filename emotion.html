<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-EMO | æƒ…æ„Ÿä¸å†³ç­–</title>
    <style>
        :root { --primary: #0f172a; --blue: #3b82f6; --green: #10b981; --red: #ef4444; }
        body { font-family: -apple-system, sans-serif; background: #f8fafc; margin: 0; padding: 20px; touch-action: manipulation; }
        .container { max-width: 650px; margin: 20px auto; background: white; padding: 35px 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        .sys-btn { width: 100%; padding: 18px; margin-bottom: 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-dark { background: var(--primary); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .sys-btn:active:not(:disabled) { transform: scale(0.98); opacity: 0.9; }
        .sys-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* BART æ°”çƒæ•ˆæœ */
        #bart-workspace { width: 100%; height: 300px; background: #f1f5f9; border-radius: 16px; display: flex; align-items: flex-end; justify-content: center; position: relative; margin-bottom: 20px; overflow: hidden; }
        #balloon { width: 40px; height: 50px; background: radial-gradient(circle at 30% 30%, #f87171, #dc2626); border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%; transition: all 0.1s ease-out; position: relative; bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 30px; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div style="margin-bottom: 15px;"><button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer;">â† è¿”å›æ§åˆ¶å°</button></div>

    <div class="container" id="menu">
        <h2 style="margin-top:0;">â¤ï¸ æƒ…æ„Ÿå€¾å‘ä¸å†³ç­–é‡è¡¨</h2>
        <p style="color:#64748b;">è¡Œä¸ºå­¦èŒƒå¼ (Behavioral)</p>
        <button class="sys-btn btn-blue" onclick="startBART()">3. BART æ°”çƒé£é™©å†³ç­–ä»»åŠ¡</button>
        <button class="sys-btn btn-blue" onclick="startEmoStroop()">4. æƒ…ç»ª Stroop æ³¨æ„åå‘æå–</button>
    </div>

    <div class="container hidden" id="bart-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold;">
            <span id="bart-round">ç¬¬ 1 / 5 è½®</span>
            <span id="bart-pot" style="color:var(--red);">æ°”çƒå†…: $0</span>
        </div>
        <div id="bart-workspace"><div id="balloon"></div></div>
        <div style="display:flex; gap:15px;">
            <button class="sys-btn btn-blue" id="btn-pump" onclick="pumpBalloon()">ğŸˆ å……æ°”</button>
            <button class="sys-btn btn-green" id="btn-collect" onclick="collectMoney()">ğŸ’° æ”¶é›†</button>
        </div>
    </div>

    <div class="container hidden" id="emo-area">
        <h2 id="emo-word" style="font-size: 70px; margin: 60px 0;">+</h2>
        <div id="emo-controls" class="hidden" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
            <button class="sys-btn" style="background:red;" onclick="recordEmoStroop('red')"></button>
            <button class="sys-btn" style="background:green;" onclick="recordEmoStroop('green')"></button>
            <button class="sys-btn" style="background:blue;" onclick="recordEmoStroop('blue')"></button>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒæ˜¾ç¤ºåˆ‡æ¢é€»è¾‘
        function show(id) {
            ['menu', 'bart-area', 'emo-area'].forEach(d => document.getElementById(d).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        /* ==================== 3. BART é€»è¾‘ (ä¿®å¤æ”¶é›†ç‚¹å‡») ==================== */
        let bartData = { module: "Emotion_BART", trials: [] };
        let b_round = 1, b_pumps = 0, b_popLimit = 0;

        function startBART() {
            b_round = 1;
            bartData.trials = [];
            show('bart-area');
            initRound();
        }

        function initRound() {
            if(b_round > 5) {
                CAS_Storage.saveModuleData('Emotion_BART', bartData);
                alert("BART æµ‹è¯•å®Œæˆï¼Œæ•°æ®å·²åŒæ­¥ã€‚");
                show('menu');
                return;
            }
            b_pumps = 0;
            b_popLimit = Math.floor(Math.random() * 12) + 2; // éšæœºçˆ†ç‚¸ç‚¹
            document.getElementById('bart-round').innerText = `ç¬¬ ${b_round} / 5 è½®`;
            document.getElementById('bart-pot').innerText = `æ°”çƒå†…: $0`;
            
            const b = document.getElementById('balloon');
            b.innerText = "";
            b.style.width = '40px'; b.style.height = '50px';
            b.style.background = 'radial-gradient(circle at 30% 30%, #f87171, #dc2626)';
            
            // ğŸŒŸ æ ¸å¿ƒä¿®å¤ï¼šé‡ç½®æŒ‰é’®çŠ¶æ€ï¼Œç¡®ä¿æ”¶é›†å¯ç‚¹
            document.getElementById('btn-pump').disabled = false;
            document.getElementById('btn-collect').disabled = false;
        }

        function pumpBalloon() {
            b_pumps++;
            if(b_pumps >= b_popLimit) {
                // çˆ†ç‚¸é€»è¾‘
                document.getElementById('btn-pump').disabled = true;
                document.getElementById('btn-collect').disabled = true;
                const b = document.getElementById('balloon');
                b.style.background = 'transparent';
                b.innerText = "ğŸ’¥";
                bartData.trials.push({ round: b_round, pumps: b_pumps, status: 'exploded', earned: 0 });
                setTimeout(() => { b_round++; initRound(); }, 1200);
            } else {
                const b = document.getElementById('balloon');
                b.style.width = (40 + b_pumps * 12) + 'px';
                b.style.height = (50 + b_pumps * 15) + 'px';
                document.getElementById('bart-pot').innerText = `æ°”çƒå†…: $${b_pumps}`;
            }
        }

        function collectMoney() {
            // ğŸŒŸ æ ¸å¿ƒä¿®å¤ï¼šç‚¹å‡»æ”¶é›†åç«‹å³ä¿å­˜æœ¬è½®æ•°æ®
            bartData.trials.push({ round: b_round, pumps: b_pumps, status: 'collected', earned: b_pumps });
            alert(`æœ¬è½®è·å¾—: $${b_pumps}`);
            b_round++;
            initRound();
        }

        /* ==================== 4. EmoStroop é€»è¾‘ ==================== */
        let es_trial = 0, es_onset = 0;
        function startEmoStroop() { es_trial = 0; show('emo-area'); nextES(); }
        function nextES() {
            if(es_trial >= 10) { show('menu'); return; }
            document.getElementById('emo-controls').classList.add('hidden');
            document.getElementById('emo-word').innerText = "+";
            document.getElementById('emo-word').style.color = "#ccc";
            setTimeout(() => {
                document.getElementById('emo-word').innerText = "å¤±è´¥";
                document.getElementById('emo-word').style.color = "red";
                document.getElementById('emo-controls').classList.remove('hidden');
                es_onset = performance.now();
            }, 800);
        }
        function recordEmoStroop(color) {
            const rt = Math.round(performance.now() - es_onset);
            CAS_Storage.saveModuleData('Emotion_Stroop', { trial: es_trial, rt: rt });
            es_trial++;
            nextES();
        }
    </script>
</body>
</html>
