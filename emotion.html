<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…æ„Ÿã€äººæ ¼ä¸å†³ç­–è¯„ä¼°</title>
    <style>
        body { font-family: sans-serif; background: #f8fafc; margin: 0; padding: 20px; touch-action: manipulation; user-select: none; }
        .container { max-width: 650px; margin: 20px auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .sys-btn { background: #0f172a; color: white; border: none; padding: 15px 25px; font-size: 16px; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 12px; transition: background 0.1s; }
        .sys-btn:active { background: #334155; }
        .hidden { display: none !important; }
        #nav-back { display: block; text-decoration: none; color: #3b82f6; font-weight: bold; margin-bottom: 10px; }
        
        /* è‡ªè¯„é‡è¡¨ UI */
        .slider-group { margin-bottom: 25px; }
        .slider-group label { display: block; font-weight: bold; margin-bottom: 10px; color: #1e293b; }
        input[type=range] { width: 100%; height: 6px; background: #e2e8f0; border-radius: 4px; outline: none; }
        .labels { display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-top: 5px; }

        /* BART æ°”çƒ UI */
        #bart-workspace { width: 100%; height: 300px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: flex-end; justify-content: center; overflow: hidden; position: relative; border: 2px solid #cbd5e1; margin-bottom: 20px; }
        #balloon { width: 40px; height: 50px; background: #ef4444; border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%; transition: all 0.1s; position: relative; bottom: 20px; box-shadow: inset -5px -5px 15px rgba(0,0,0,0.2); }
        .bart-controls { display: flex; gap: 15px; }
        .bart-btn { flex: 1; padding: 15px; font-size: 18px; font-weight: bold; border: none; border-radius: 8px; color: white; cursor: pointer; }

        /* æƒ…ç»ª Stroop UI */
        #emo-word { font-size: 70px; font-weight: bold; margin: 50px 0; min-height: 90px; text-align: center; letter-spacing: 5px; }
        .color-btn-group { display: flex; gap: 15px; justify-content: center; }
        .color-btn { width: 80px; height: 60px; border-radius: 12px; border: none; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <a href="index.html" id="nav-back">â† è¿”å›ä¸»æ§å°</a>
    <div class="container" id="menu">
        <h2>å¤šç»´æƒ…æ„Ÿä¸å†³ç­–è¯„ä¼°ç»„åˆ</h2>
        <h3 style="color:#64748b; font-size:16px;">ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸»è§‚è‡ªè¯„ (Self-Report)</h3>
        <button class="sys-btn" onclick="show('ema-area')">1. ç¬æ—¶æƒ…ç»ªçŠ¶æ€è¯„ä¼° (EMA)</button>
        <button class="sys-btn" onclick="show('b5-area')">2. å¤§äº”äººæ ¼ç‰¹è´¨é‡è¡¨ (Big 5)</button>
        
        <h3 style="color:#64748b; font-size:16px; margin-top:25px;">ç¬¬äºŒéƒ¨åˆ†ï¼šå®¢è§‚è¡Œä¸º (Behavioral)</h3>
        <button class="sys-btn" onclick="startBART()" style="background:#3b82f6;">3. æ°”çƒæ¨¡æ‹Ÿé£é™©å†³ç­– (BART)</button>
        <button class="sys-btn" onclick="startEmoStroop()" style="background:#3b82f6;">4. æƒ…ç»ªæ³¨æ„åå‘æµ‹è¯• (Emotional Stroop)</button>
    </div>

    <div class="container hidden" id="ema-area">
        <h3>å½“å‰ç¬æ—¶çŠ¶æ€ (State)</h3>
        <div class="slider-group"><label>æ­¤æ—¶æ­¤åˆ»çš„æŠ‘éƒæ„Ÿ/ä½è½æ„Ÿ</label><input type="range" id="e1"><div class="labels"><span>æ— </span><span>æå¼º</span></div></div>
        <div class="slider-group"><label>æ­¤æ—¶æ­¤åˆ»çš„ç„¦è™‘æ„Ÿ/ç´§å¼ æ„Ÿ</label><input type="range" id="e2"><div class="labels"><span>æ— </span><span>æå¼º</span></div></div>
        <button class="sys-btn" onclick="saveEMA()">ä¿å­˜çŠ¶æ€æ•°æ®</button>
        <button class="sys-btn" style="background:#94a3b8;" onclick="show('menu')">è¿”å›èœå•</button>
    </div>

    <div class="container hidden" id="b5-area">
        <h3>å¤§äº”äººæ ¼ç®€ç‰ˆ (Trait)</h3>
        <div class="slider-group"><label>å¼€æ”¾æ€§ (ä¹äºå°è¯•æ–°äº‹ç‰©)</label><input type="range" id="b1"></div>
        <div class="slider-group"><label>å°½è´£æ€§ (ä¸¥è°¨ã€è‡ªå¾‹)</label><input type="range" id="b2"></div>
        <div class="slider-group"><label>å¤–å‘æ€§ (å–œæ¬¢äº¤é™…)</label><input type="range" id="b3"></div>
        <div class="slider-group"><label>å®œäººæ€§ (åŒæƒ…ã€åˆä½œ)</label><input type="range" id="b4"></div>
        <div class="slider-group"><label>ç¥ç»è´¨ (æƒ…ç»ªæ˜“æ³¢åŠ¨ã€æ•æ„Ÿ)</label><input type="range" id="b5"></div>
        <button class="sys-btn" onclick="saveB5()">ä¿å­˜äººæ ¼æ•°æ®</button>
        <button class="sys-btn" style="background:#94a3b8;" onclick="show('menu')">è¿”å›èœå•</button>
    </div>

    <div class="container hidden" id="bart-area">
        <h3>æ°”çƒé£é™©ä»»åŠ¡ (BART)</h3>
        <p style="font-size:14px; color:#64748b; margin-top:0;">ç‚¹å‡»â€œå……æ°”â€ä½¿æ°”çƒå˜å¤§å¹¶ç´¯ç§¯ç§¯åˆ†ã€‚å¦‚æœæ°”çƒçˆ†ç‚¸ï¼Œè¯¥è½®ç§¯åˆ†ä¸º0ã€‚è¯·åœ¨çˆ†ç‚¸å‰ç‚¹å‡»â€œæ”¶é›†ç§¯åˆ†â€ã€‚ï¼ˆå…±5è½®ï¼‰</p>
        
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold;">
            <span id="bart-round">ç¬¬ 1 / 5 è½®</span>
            <span id="bart-pot" style="color:#ef4444;">å½“å‰æ°”çƒ: $0</span>
            <span id="bart-total" style="color:#10b981;">æ€»é“¶è¡Œ: $0</span>
        </div>
        
        <div id="bart-workspace"><div id="balloon"></div></div>
        
        <div class="bart-controls">
            <button class="bart-btn" style="background:#ef4444;" id="btn-pump" onclick="pumpBalloon()">ğŸˆ å……æ°” (+ $1)</button>
            <button class="bart-btn" style="background:#10b981;" id="btn-collect" onclick="collectMoney()">ğŸ’° æ”¶é›†ç§¯åˆ†</button>
        </div>
    </div>

    <div class="container hidden" id="emo-stroop-area">
        <h3>æƒ…ç»ªæ³¨æ„åå‘</h3>
        <p style="font-size:14px; color:#64748b;">è¯·å¿½ç•¥è¯è¯­çš„æ„æ€ï¼Œå°½å¯èƒ½å¿«åœ°ç‚¹å‡»æ–‡å­—å¯¹åº”çš„<strong>é¢œè‰²</strong>ã€‚</p>
        
        <div id="emo-word">+</div>
        <div class="color-btn-group hidden" id="emo-controls">
            <button class="color-btn" style="background:#ef4444;" onclick="recordEmoStroop('red')"></button>
            <button class="color-btn" style="background:#22c55e;" onclick="recordEmoStroop('green')"></button>
            <button class="color-btn" style="background:#3b82f6;" onclick="recordEmoStroop('blue')"></button>
        </div>
    </div>

    <script>
        function show(id) { 
            ['menu', 'ema-area', 'b5-area', 'bart-area', 'emo-stroop-area'].forEach(div => document.getElementById(div).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden'); 
        }

        // --- 1 & 2. é—®å·ä¿å­˜é€»è¾‘ ---
        function saveEMA() { CAS_Storage.saveModuleData('Emotion_State_EMA', { depression: document.getElementById('e1').value, anxiety: document.getElementById('e2').value }); alert("EMA å·²ä¿å­˜"); show('menu'); }
        function saveB5() { CAS_Storage.saveModuleData('Emotion_Trait_Big5', { O: document.getElementById('b1').value, C: document.getElementById('b2').value, E: document.getElementById('b3').value, A: document.getElementById('b4').value, N: document.getElementById('b5').value }); alert("Big5 å·²ä¿å­˜"); show('menu'); }

        // --- 3. BART æ°”çƒä»»åŠ¡é€»è¾‘ ---
        let bartData = { module: "Emotion_Risk_BART", total_earned: 0, trials: [] };
        let b_trial = 1, b_maxTrials = 5, b_pumps = 0, b_total = 0, b_popLimit = 0, b_lastPumpT = 0;
        let b_pumpRTs = []; // è®°å½•æ¯æ¬¡æŒ‰å……æ°”é”®çš„é—´éš”ï¼Œåæ˜ çŠ¹è±«åº¦
        
        function startBART() { show('bart-area'); b_trial = 1; b_total = 0; bartData.trials = []; initBalloon(); }
        function initBalloon() {
            if(b_trial > b_maxTrials) {
                bartData.total_earned = b_total;
                CAS_Storage.saveModuleData('Emotion_Risk_BART', bartData);
                alert(`BART æµ‹è¯•å®Œæˆï¼æ€»æ”¶ç›Š: $${b_total}`);
                show('menu'); return;
            }
            b_pumps = 0; b_pumpRTs = [];
            b_popLimit = Math.floor(Math.random() * 25) + 5; // éšæœºåœ¨ 5 åˆ° 30 ä¸‹ä¹‹é—´çˆ†ç‚¸
            
            document.getElementById('balloon').style.width = '40px';
            document.getElementById('balloon').style.height = '50px';
            document.getElementById('balloon').style.background = '#ef4444';
            document.getElementById('bart-round').innerText = `ç¬¬ ${b_trial} / ${b_maxTrials} è½®`;
            document.getElementById('bart-pot').innerText = `å½“å‰æ°”çƒ: $0`;
            document.getElementById('bart-total').innerText = `æ€»é“¶è¡Œ: $${b_total}`;
            
            document.getElementById('btn-pump').disabled = false;
            document.getElementById('btn-collect').disabled = false;
            b_lastPumpT = performance.now();
        }
        function pumpBalloon() {
            let rt = performance.now() - b_lastPumpT; b_pumpRTs.push(Math.round(rt)); b_lastPumpT = performance.now();
            b_pumps++;
            if (b_pumps >= b_popLimit) {
                // çˆ†ç‚¸
                document.getElementById('balloon').style.background = 'transparent';
                document.getElementById('balloon').innerText = "ğŸ’¥";
                document.getElementById('btn-pump').disabled = true;
                document.getElementById('btn-collect').disabled = true;
                
                bartData.trials.push({ trial: b_trial, pumps: b_pumps, exploded: true, earned: 0, rt_array: [...b_pumpRTs] });
                setTimeout(() => { document.getElementById('balloon').innerText = ""; b_trial++; initBalloon(); }, 1500);
            } else {
                // å®‰å…¨è†¨èƒ€
                let w = 40 + b_pumps * 6; let h = 50 + b_pumps * 7;
                document.getElementById('balloon').style.width = w + 'px';
                document.getElementById('balloon').style.height = h + 'px';
                document.getElementById('bart-pot').innerText = `å½“å‰æ°”çƒ: $${b_pumps}`;
            }
        }
        function collectMoney() {
            b_total += b_pumps;
            bartData.trials.push({ trial: b_trial, pumps: b_pumps, exploded: false, earned: b_pumps, rt_array: [...b_pumpRTs] });
            b_trial++; initBalloon();
        }

        // --- 4. æƒ…ç»ª Stroop ä»»åŠ¡é€»è¾‘ ---
        const emoWords = [
            { w: 'ç–¾ç—…', val: 'negative' }, { w: 'å¤±è´¥', val: 'negative' }, { w: 'æ­»äº¡', val: 'negative' },
            { w: 'æ¤…å­', val: 'neutral' }, { w: 'æ¡Œå­', val: 'neutral' }, { w: 'ä¹¦æœ¬', val: 'neutral' },
            { w: 'å¿«ä¹', val: 'positive' }, { w: 'æˆåŠŸ', val: 'positive' }, { w: 'å¸Œæœ›', val: 'positive' }
        ];
        const colors = ['red', 'green', 'blue'];
        let esData = { module: "Emotion_Affective_Stroop", records: [] };
        let es_trial = 0, es_max = 12, es_onset = 0, es_targetColor = '';

        function startEmoStroop() { show('emo-stroop-area'); es_trial = 0; esData.records = []; nextEmoStroop(); }
        function nextEmoStroop() {
            if(es_trial >= es_max) {
                CAS_Storage.saveModuleData('Emotion_Affective_Stroop', esData);
                alert("æƒ…ç»ª Stroop æ•°æ®å·²ä¿å­˜"); show('menu'); return;
            }
            document.getElementById('emo-controls').classList.add('hidden');
            document.getElementById('emo-word').innerText = "+";
            document.getElementById('emo-word').style.color = "#333";
            
            setTimeout(() => {
                let wordObj = emoWords[Math.floor(Math.random() * emoWords.length)];
                es_targetColor = colors[Math.floor(Math.random() * colors.length)];
                
                document.getElementById('emo-word').innerText = wordObj.w;
                document.getElementById('emo-word').style.color = es_targetColor;
                document.getElementById('emo-word').dataset.val = wordObj.val; // éšè—å­˜å‚¨æƒ…ç»ªæ•ˆä»·
                
                document.getElementById('emo-controls').classList.remove('hidden');
                es_onset = performance.now();
            }, 600);
        }
        function recordEmoStroop(selectedColor) {
            let rt = performance.now() - es_onset;
            let val = document.getElementById('emo-word').dataset.val;
            
            esData.records.push({
                trial: es_trial + 1,
                word_valence: val,  // è®°å½•æ˜¯è´Ÿæ€§ã€ä¸­æ€§è¿˜æ˜¯æ­£æ€§è¯
                is_correct: selectedColor === es_targetColor,
                rt_ms: Math.round(rt)
            });
            es_trial++; nextEmoStroop();
        }
    </script>
</body>
</html>
