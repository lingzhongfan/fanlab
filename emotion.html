<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAS-EMO | æƒ…æ„Ÿä¸å†³ç­–</title>
    <style>
        /* ==================== 1. æ ·å¼è¡¨ ==================== */
        body { 
            font-family: -apple-system, sans-serif; 
            background: #f8fafc; 
            margin: 0; 
            padding: 20px; 
            touch-action: manipulation; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        .container { 
            max-width: 650px; 
            margin: 20px auto; 
            background: white; 
            padding: 35px 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }
        .module-header { 
            color: #0f172a; 
            margin-top: 0; 
            font-size: 24px; 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        .sys-btn { 
            background: #0f172a; 
            color: white; 
            border: none; 
            padding: 18px 30px; 
            font-size: 16px; 
            font-weight: bold; 
            border-radius: 12px; 
            cursor: pointer; 
            width: 100%; 
            margin-bottom: 15px; 
            transition: 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .sys-btn:active:not(:disabled) { transform: scale(0.98); } 
        .hidden { display: none !important; }
        #nav-back { 
            display: inline-flex; 
            align-items: center; 
            text-decoration: none; 
            color: #3b82f6; 
            font-weight: bold; 
            margin-bottom: 15px; 
            padding: 10px 18px; 
            background: #eff6ff; 
            border-radius: 10px; 
            transition: 0.2s; 
        } 

        /* BART æ°”çƒæ ·å¼ */
        #bart-workspace { 
            width: 100%; height: 320px; background: #f1f5f9; border-radius: 16px; 
            display: flex; align-items: flex-end; justify-content: center; 
            overflow: hidden; position: relative; border: 2px solid #cbd5e1; margin-bottom: 20px; 
        }
        #balloon { 
            width: 40px; height: 50px; 
            background: radial-gradient(circle at 30% 30%, #f87171, #dc2626); 
            border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%; 
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; bottom: 25px; 
            box-shadow: -5px -5px 15px rgba(0,0,0,0.1) inset, 0 10px 10px rgba(0,0,0,0.1); 
        }

        /* æƒ…ç»ª Stroop æ ·å¼ */
        #emo-word { font-size: 80px; font-weight: bold; margin: 60px 0; min-height: 100px; text-align: center; }
        .color-btn-group { display: flex; gap: 20px; justify-content: center; } 
        .color-btn { width: 90px; height: 70px; border-radius: 16px; border: none; cursor: pointer; box-shadow: 0 6px 12px rgba(0,0,0,0.15); transition: 0.1s; } 
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div style="text-align: left; max-width: 650px; margin: 0 auto;">
        <a href="index.html" id="nav-back">â† è¿”å›æ§åˆ¶å°</a>
    </div>
    
    <div class="container" id="menu">
        <h2 class="module-header">â¤ï¸ æƒ…æ„Ÿå€¾å‘ä¸å†³ç­–é‡è¡¨</h2>
        <h3 style="color:#64748b; font-size:15px; margin-bottom:15px;">é‡è¡¨éƒ¨åˆ† (Self-Report)</h3>
        <button class="sys-btn" onclick="show('ema-area')">1. å®æ—¶çŠ¶æ€è¯„ä¼° (EMA)</button>
        <button class="sys-btn" onclick="show('b5-area')">2. äººæ ¼ç‰¹è´¨å€¾å‘é‡è¡¨ (Big 5)</button>
        
        <h3 style="color:#64748b; font-size:15px; margin-top:30px; margin-bottom:15px;">è¡Œä¸ºå­¦èŒƒå¼ (Behavioral)</h3>
        <button class="sys-btn" onclick="startBART()" style="background:#3b82f6;">3. BART æ°”çƒé£é™©å†³ç­–ä»»åŠ¡</button>
        <button class="sys-btn" onclick="startEmoStroop()" style="background:#3b82f6;">4. æƒ…ç»ª Stroop æ³¨æ„åå‘æå–</button>
    </div>

    <div class="container hidden" id="ema-area">
        <h2 class="module-header">EMA çŠ¶æ€è¯„ä¼°</h2>
        <button class="sys-btn" onclick="show('menu')">ä¿å­˜å¹¶è¿”å›</button>
    </div>

    <div class="container hidden" id="b5-area">
        <h2 class="module-header">å¤§äº”äººæ ¼è¯„ä¼°</h2>
        <button class="sys-btn" onclick="show('menu')">ä¿å­˜å¹¶è¿”å›</button>
    </div>

    <div class="container hidden" id="bart-area">
        <h2 class="module-header">BART é£é™©å†³ç­–</h2>
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold; font-size:18px;">
            <span id="bart-round">ç¬¬ 1 / 5 è½®</span>
            <span id="bart-pot" style="color:#ef4444;">æ°”çƒå†…: $0</span>
        </div>
        <div id="bart-workspace"><div id="balloon"></div></div>
        <div style="display:flex; gap:15px;">
            <button class="sys-btn" style="background:#ef4444;" id="btn-pump" onclick="pumpBalloon()">ğŸˆ å……æ°”</button>
            <button class="sys-btn" style="background:#10b981;" id="btn-collect" onclick="collectMoney()">ğŸ’° æ”¶é›†</button>
        </div>
    </div>

    <div class="container hidden" id="emo-stroop-area">
        <h2 class="module-header">æƒ…ç»ªæ³¨æ„åå‘</h2>
        <div id="emo-word">+</div>
        <div class="color-btn-group hidden" id="emo-controls">
            <button class="color-btn" style="background:#ef4444;" onclick="recordEmoStroop('red')"></button>
            <button class="color-btn" style="background:#22c55e;" onclick="recordEmoStroop('green')"></button>
            <button class="color-btn" style="background:#3b82f6;" onclick="recordEmoStroop('blue')"></button>
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒé€»è¾‘è„šæœ¬ ====================

        /**
         * è§†å›¾åˆ‡æ¢å‡½æ•°
         * @param {string} id - ç›®æ ‡å®¹å™¨çš„ ID
         */
        function show(id) { 
            const sections = ['menu', 'ema-area', 'b5-area', 'bart-area', 'emo-stroop-area'];
            sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) element.classList.add('hidden');
            }); 
            
            const targetElement = document.getElementById(id);
            if (targetElement) {
                targetElement.classList.remove('hidden');
                window.scrollTo(0,0); 
            }
        }

        /* -------------------- 3. BART é€»è¾‘ -------------------- */
        let bartData = { module: "Emotion_Risk_BART", trials: [] };
        let b_trial = 1, b_pumps = 0, b_popLimit = 0;

        function startBART() {
            b_trial = 1;
            bartData.trials = [];
            show('bart-area'); // ğŸŒŸ å¿…é¡»å…ˆè°ƒç”¨ show åˆ‡æ¢è§†å›¾
            resetBalloon();
        }

        function resetBalloon() {
            if (b_trial > 5) {
                CAS_Storage.saveModuleData('Emotion_Risk_BART', bartData);
                alert("BART æµ‹è¯•å®Œæˆ");
                show('menu');
                return;
            }
            b_pumps = 0;
            b_popLimit = Math.floor(Math.random() * 15) + 3; // éšæœºçˆ†ç‚¸é˜ˆå€¼
            document.getElementById('bart-round').innerText = `ç¬¬ ${b_trial} / 5 è½®`;
            document.getElementById('bart-pot').innerText = `æ°”çƒå†…: $0`;
            const b = document.getElementById('balloon');
            b.style.width = '40px'; b.style.height = '50px';
            b.style.background = 'radial-gradient(circle at 30% 30%, #f87171, #dc2626)';
            b.innerText = "";
            document.getElementById('btn-pump').disabled = false;
            document.getElementById('btn-collect').disabled = false;
        }

        function pumpBalloon() {
            b_pumps++;
            if (b_pumps >= b_popLimit) {
                // çˆ†ç‚¸
                document.getElementById('btn-pump').disabled = true;
                document.getElementById('btn-collect').disabled = true;
                const b = document.getElementById('balloon');
                b.style.background = 'transparent';
                b.innerText = "ğŸ’¥"; b.style.fontSize = "40px";
                bartData.trials.push({ trial: b_trial, pumps: b_pumps, result: "exploded" });
                setTimeout(() => { b_trial++; resetBalloon(); }, 1200);
            } else {
                // è†¨èƒ€
                const b = document.getElementById('balloon');
                b.style.width = (40 + b_pumps * 8) + 'px';
                b.style.height = (50 + b_pumps * 10) + 'px';
                document.getElementById('bart-pot').innerText = `æ°”çƒå†…: $${b_pumps}`;
            }
        }

        function collectMoney() {
            bartData.trials.push({ trial: b_trial, pumps: b_pumps, result: "collected", earned: b_pumps });
            b_trial++;
            resetBalloon();
        }

        /* -------------------- 4. EmoStroop é€»è¾‘ -------------------- */
        let esData = { module: "Emotion_Affective_Stroop", records: [] };
        let es_trial = 0, es_onset = 0, es_targetColor = '';
        const emoWords = [{w:'ç—›è‹¦', v:'neg'}, {w:'å¿«ä¹', v:'pos'}, {w:'æ¡Œå­', v:'neu'}];
        const colors = ['red', 'green', 'blue'];

        function startEmoStroop() {
            es_trial = 0;
            esData.records = [];
            show('emo-stroop-area'); // ğŸŒŸ åˆ‡æ¢è§†å›¾
            nextEmoStroop();
        }

        function nextEmoStroop() {
            if (es_trial >= 10) {
                CAS_Storage.saveModuleData('Emotion_Affective_Stroop', esData);
                alert("æƒ…ç»ªæ³¨æ„åå‘æµ‹è¯•å®Œæˆ");
                show('menu');
                return;
            }
            document.getElementById('emo-controls').classList.add('hidden');
            document.getElementById('emo-word').innerText = "+";
            document.getElementById('emo-word').style.color = "#64748b";
            
            setTimeout(() => {
                const word = emoWords[Math.floor(Math.random() * emoWords.length)];
                es_targetColor = colors[Math.floor(Math.random() * colors.length)];
                const el = document.getElementById('emo-word');
                el.innerText = word.w;
                el.style.color = es_targetColor;
                document.getElementById('emo-controls').classList.remove('hidden');
                es_onset = performance.now();
            }, 800);
        }

        function recordEmoStroop(color) {
            const rt = Math.round(performance.now() - es_onset);
            esData.records.push({ trial: es_trial, rt: rt, correct: color === es_targetColor });
            es_trial++;
            nextEmoStroop();
        }
    </script>
</body>
</html>
