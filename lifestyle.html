<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-LIF | æ—¥å¸¸åŠŸèƒ½ä¸ç”Ÿç‰©èŠ‚å¾‹è¯„ä¼° (ç§‘ç ”ä¸´åºŠç‰ˆ v4.0)</title>
    <style>
        /* ==================== UI ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --green: #10b981; --light-green: #d1fae5; --emerald: #059669; --red: #f43f5e; --slate: #64748b; --bg: #fcfcfd; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); user-select: none; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; position: relative; overflow: hidden; min-height: 500px;}
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--green); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .sys-btn { width: 100%; padding: 20px; margin-bottom: 12px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 18px; transition: 0.2s; background: var(--green); color: white; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);}
        .sys-btn:hover { background: var(--emerald); transform: translateY(-2px); }

        /* è¿›åº¦æ¡ */
        .progress-bar-container { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; margin-bottom: 30px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.4s ease; }
        .progress-text { text-align: right; font-size: 13px; color: var(--slate); font-weight: bold; margin-top: -20px; margin-bottom: 20px;}

        /* å•é¢˜å‘ˆç°åŒº (Single-item UI) */
        .question-card { animation: fadeInRight 0.4s ease-out; }
        @keyframes fadeInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        
        .q-title { font-size: 26px; font-weight: bold; color: var(--primary); margin-bottom: 10px; line-height: 1.4; }
        .q-desc { font-size: 16px; color: var(--slate); margin-bottom: 30px; line-height: 1.5; }

        /* é€‰é¡¹æŒ‰é’® (å¤§å·é˜²æŠ–è®¾è®¡) */
        .options-grid { display: grid; gap: 15px; }
        .btn-option { padding: 25px 20px; text-align: left; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 16px; font-size: 20px; font-weight: bold; color: var(--primary); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .btn-option:hover { border-color: var(--green); background: var(--light-green); }
        .btn-option:active { transform: scale(0.98); }

        /* è¿ç»­å˜é‡æ»‘åŠ¨æ¡ (VAS) */
        .vas-container { background: #f8fafc; padding: 30px; border-radius: 16px; border: 2px dashed #cbd5e1; margin-bottom: 20px; }
        .vas-labels { display: flex; justify-content: space-between; font-weight: bold; color: var(--slate); font-size: 14px; margin-bottom: 15px; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 35px; height: 35px; background: white; border: 5px solid var(--green); border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .vas-value-display { text-align: center; font-size: 32px; font-weight: bold; color: var(--emerald); margin-top: 20px; font-family: monospace; }

        /* èŠ‚å¾‹æ›²çº¿å›¾ç‰ˆ */
        .circadian-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .circadian-col { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .circadian-label { font-size: 16px; font-weight: bold; color: var(--slate); }
        .circadian-col input[type=range] { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 20px; height: 200px; padding: 0; }

        /* å¯¼èˆªæ§åˆ¶ */
        .nav-controls { display: flex; justify-content: space-between; margin-top: 40px; border-top: 2px solid #f1f5f9; padding-top: 20px;}
        .btn-nav { padding: 15px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; border: none; }
        .btn-prev { background: #f1f5f9; color: var(--slate); }
        .btn-prev:hover { background: #e2e8f0; color: var(--primary); }
        .btn-next { background: var(--green); color: white; }
        .btn-next:hover { background: var(--emerald); }
        .btn-next:disabled { background: #cbd5e1; cursor: not-allowed; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--green); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu-area">
        <div class="module-header">
            <h2>ğŸ¥— æ—¥å¸¸åŠŸèƒ½ä¸ç”Ÿç‰©èŠ‚å¾‹ (LIF)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>è¯„ä¼°å·¥å…·æ€§æ—¥å¸¸ç”Ÿæ´»èƒ½åŠ› (IADL) çš„ç‹¬ç«‹æ€§ã€ç¡çœ è´¨é‡ä»¥åŠ 24 å°æ—¶ç”Ÿç‰©èƒ½é‡èŠ‚å¾‹ã€‚<br>
            *ç³»ç»Ÿå°†è‡ªåŠ¨è¿½è¸ªå—è¯•è€…å›ç­”æ¯ä¸€é“é¢˜ç›®çš„â€œå†³ç­–æ½œä¼æœŸ(Hesitation RT)â€ï¼Œè¯†åˆ«éšæ€§å¤±è®¤ç—‡æˆ–è®¤çŸ¥è´Ÿè·ã€‚</p>
        </div>
        <div style="background: var(--light-green); padding: 20px; border-radius: 16px; color: var(--emerald); font-weight: bold; margin-bottom: 30px;">
            âš ï¸ ä¸»è¯•æ³¨æ„ï¼šè¯·å°†å¹³æ¿äº¤ç”±å—è¯•è€…æœ¬äººæ“ä½œã€‚å¦‚æœå—è¯•è€…å­˜åœ¨ä¸¥é‡è¿åŠ¨éšœç¢ï¼Œå¯ç”±ä¸»è¯•ä»£ä¸ºç‚¹å‡»ï¼Œä½†éœ€ç¡®ä¿æ˜¯å—è¯•è€…åšå‡ºçš„å†³å®šã€‚
        </div>
        <button class="sys-btn" onclick="startAssessment()">â–¶ å¼€å§‹å…¨æ™¯ç”Ÿæ´»è¯„ä¼°</button>
    </div>

    <div class="container hidden" id="task-area">
        <div class="progress-bar-container"><div class="progress-bar-fill" id="progress-fill"></div></div>
        <div class="progress-text" id="progress-text">1 / 5</div>

        <div id="question-container" class="question-card">
            </div>

        <div class="nav-controls">
            <button class="btn-nav btn-prev" id="btn-prev" onclick="navigate(-1)">è¿”å›ä¸Šé¢˜</button>
            <button class="btn-nav btn-next" id="btn-next" onclick="navigate(1)">ä¸‹ä¸€é¢˜ â”</button>
        </div>
    </div>

    <script>
        // ================= 1. ä¸´åºŠé—®é¢˜åº“è®¾è®¡ =================
        // æ¶µç›– IADL(å·¥å…·æ€§æ—¥å¸¸ç”Ÿæ´»èƒ½åŠ›)ã€ç¡çœ è´¨é‡ã€èŠ‚å¾‹æ›²çº¿ä¸ç¤¾ä¼šå‚ä¸
        const questions = [
            {
                id: "iadl_medication",
                type: "choice",
                title: "ğŸ’Š æœè¯ç®¡ç†èƒ½åŠ›",
                desc: "æ‚¨ç›®å‰èƒ½å¦å®Œå…¨ä¾é è‡ªå·±ï¼Œåœ¨æ­£ç¡®çš„æ—¶é—´æœç”¨æ­£ç¡®å‰‚é‡çš„è¯ç‰©ï¼Ÿ",
                options: [
                    { value: 3, label: "å®Œå…¨èƒ½ç‹¬ç«‹æŒ‰æ—¶æŒ‰é‡æœè¯", score: 0 }, // score: æ‰£åˆ†é¡¹ï¼Œ0ä¸ºæ­£å¸¸
                    { value: 2, label: "éœ€è¦åˆ«äººæé†’æˆ–å¸®å¿™åˆ†è£…å¥½", score: 1 },
                    { value: 1, label: "å®Œå…¨ä¸èƒ½ï¼Œå¿…é¡»ç”±ä»–äººå–‚æœ", score: 2 }
                ]
            },
            {
                id: "iadl_finance",
                type: "choice",
                title: "ğŸ’° è´¢åŠ¡ä¸è´­ç‰©ç®¡ç†",
                desc: "æ‚¨ç›®å‰èƒ½å¦ç‹¬ç«‹å¤„ç†æ—¥å¸¸å¼€é”€ã€å»è¶…å¸‚è´­ç‰©å¹¶ç®—æ¸…è´¦ç›®ï¼Ÿ",
                options: [
                    { value: 3, label: "èƒ½ç‹¬ç«‹å®Œæˆè´­ç‰©å’Œè´¢åŠ¡ç®¡ç†", score: 0 },
                    { value: 2, label: "èƒ½ä¹°äº›æ—¥ç”¨å“ï¼Œä½†å¤§é¢è´¢åŠ¡å¤„ç†å›°éš¾", score: 1 },
                    { value: 1, label: "å®Œå…¨æ— æ³•ç‹¬ç«‹è´­ç‰©æˆ–ç®¡é’±", score: 2 }
                ]
            },
            {
                id: "sleep_quality",
                type: "vas",
                title: "ğŸ›ï¸ ä¸»è§‚ç¡çœ è´¨é‡",
                desc: "è¯·æ‹–åŠ¨æ»‘å—ï¼Œè¯„ä¼°æ‚¨è¿‡å»ä¸€ä¸ªæœˆå†…çš„æ€»ä½“ç¡çœ è´¨é‡ã€‚",
                labels: ["æå·® (ä¸¥é‡å¤±çœ )", "æå¥½ (ä¸€è§‰åˆ°å¤©äº®)"],
                unit: "åˆ†"
            },
            {
                id: "circadian_rhythm",
                type: "curve",
                title: "ğŸ“ˆ 24å°æ—¶èƒ½é‡èŠ‚å¾‹",
                desc: "è¯·è°ƒèŠ‚ä»¥ä¸‹å››ä¸ªæ»‘å—ï¼Œæç»˜æ‚¨ä¸€å¤©ä¸­ã€ç²¾åŠ›æœ€å……æ²›ã€‘å’Œã€æœ€ç–²æƒ«ã€‘çš„æ—¶é—´æ®µåˆ†å¸ƒã€‚",
                labels: ["æ—©æ™¨ (8:00)", "ä¸­åˆ (13:00)", "å‚æ™š (18:00)", "å¤œé—´ (22:00)"]
            },
            {
                id: "social_engagement",
                type: "choice",
                title: "ğŸ¤ ç¤¾ä¼šä¸æƒ…æ„Ÿäº’åŠ¨",
                desc: "æ‚¨æœ€è¿‘ä¸€å‘¨å†…ï¼Œä¸»åŠ¨ä¸äº²æˆšã€æœ‹å‹æˆ–é‚»å±…è¿›è¡Œäº¤æµï¼ˆåŒ…æ‹¬ç”µè¯/å¾®ä¿¡ï¼‰çš„é¢‘ç‡æ˜¯ï¼Ÿ",
                options: [
                    { value: 3, label: "å‡ ä¹æ¯å¤©éƒ½æœ‰äº¤æµ", score: 0 },
                    { value: 2, label: "æ¯å‘¨åªæœ‰ 1-2 æ¬¡", score: 1 },
                    { value: 1, label: "å‡ ä¹æ²¡æœ‰ä¸äººä¸»åŠ¨äº¤æµ", score: 2 }
                ]
            }
        ];

        // ================= 2. æ ¸å¿ƒçŠ¶æ€ä¸å¼•æ“ =================
        let lifData = { module: "LIF_Lifestyle", responses: [], summary: {} };
        let currentIndex = 0;
        let questionOnset = 0; // ç”¨äºè®¡ç®—ååº”æ½œä¼æœŸ (Hesitation RT)
        let currentAnswers = {}; // å­˜å‚¨æ‰€æœ‰å›ç­”

        function startAssessment() {
            lifData.responses = [];
            currentAnswers = {};
            currentIndex = 0;
            document.getElementById('menu-area').classList.add('hidden');
            document.getElementById('task-area').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            const q = questions[currentIndex];
            const container = document.getElementById('question-container');
            
            // é‡ç½®åŠ¨ç”»
            container.style.animation = 'none';
            container.offsetHeight; // è§¦å‘é‡ç»˜
            container.style.animation = null;

            // æ›´æ–°è¿›åº¦æ¡
            const progress = ((currentIndex + 1) / questions.length) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${questions.length}`;

            // æ§åˆ¶æŒ‰é’®çŠ¶æ€
            document.getElementById('btn-prev').style.visibility = currentIndex === 0 ? 'hidden' : 'visible';
            const nextBtn = document.getElementById('btn-next');
            nextBtn.innerText = currentIndex === questions.length - 1 ? "å®Œæˆå¹¶å…¥åº“ ğŸ’¾" : "ä¸‹ä¸€é¢˜ â”";
            
            // é»˜è®¤ç¦ç”¨ä¸‹ä¸€é¢˜ï¼Œé™¤éå·²ç»ä½œç­”
            nextBtn.disabled = currentAnswers[q.id] === undefined && q.type !== 'curve' && q.type !== 'vas';

            let html = `<div class="q-title">${q.title}</div><div class="q-desc">${q.desc}</div>`;

            // æ ¹æ®é¢˜ç›®ç±»å‹æ¸²æŸ“ä¸åŒ UI
            if (q.type === 'choice') {
                html += `<div class="options-grid">`;
                q.options.forEach(opt => {
                    const isSelected = currentAnswers[q.id] && currentAnswers[q.id].value === opt.value;
                    const style = isSelected ? `border-color: var(--green); background: var(--light-green);` : ``;
                    html += `<button class="btn-option" style="${style}" onclick="selectChoice('${q.id}', ${opt.value}, ${opt.score})">
                                <span>${opt.label}</span>
                                ${isSelected ? 'âœ…' : ''}
                             </button>`;
                });
                html += `</div>`;
            } 
            else if (q.type === 'vas') {
                const val = currentAnswers[q.id] ? currentAnswers[q.id].value : 50;
                html += `
                    <div class="vas-container">
                        <div class="vas-labels"><span>${q.labels[0]}</span><span>${q.labels[1]}</span></div>
                        <input type="range" id="vas-slider" min="0" max="100" value="${val}" oninput="updateVAS('${q.id}', this.value)">
                        <div class="vas-value-display" id="vas-val-text">${val} ${q.unit}</div>
                    </div>
                `;
                // VAS é»˜è®¤æœ‰å€¼ï¼Œå…è®¸ç›´æ¥ç‚¹å‡»ä¸‹ä¸€é¢˜
                nextBtn.disabled = false;
                if(!currentAnswers[q.id]) currentAnswers[q.id] = { value: 50, rt: 0 }; 
            }
            else if (q.type === 'curve') {
                const vals = currentAnswers[q.id] ? currentAnswers[q.id].value : [50, 50, 50, 50];
                html += `<div class="vas-container" style="display:flex; justify-content:center;"><div class="circadian-grid">`;
                q.labels.forEach((label, i) => {
                    html += `
                        <div class="circadian-col">
                            <input type="range" min="0" max="100" value="${vals[i]}" onchange="updateCurve('${q.id}')" class="curve-slider" orient="vertical">
                            <span class="circadian-label">${label}</span>
                        </div>
                    `;
                });
                html += `</div></div>`;
                nextBtn.disabled = false;
                if(!currentAnswers[q.id]) currentAnswers[q.id] = { value: [50,50,50,50], rt: 0 }; 
            }

            container.innerHTML = html;
            
            // è®°å½•é¢˜ç›®å‘ˆç°çš„ç²¾ç¡®æ—¶é—´æˆ³ (è®¡ç®—è¿Ÿç–‘æ½œä¼æœŸ)
            questionOnset = performance.now();
        }

        // ================= 3. æ•°æ®ç»‘å®šä¸äº¤äº’ =================
        function selectChoice(qId, val, score) {
            const rt = Math.round(performance.now() - questionOnset);
            currentAnswers[qId] = { value: val, score: score, rt_ms: rt };
            renderQuestion(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
            
            // ä¸ºäº†æµç•…ä½“éªŒï¼Œé€‰æ‹©å•é€‰é¢˜åå»¶è¿Ÿ 400ms è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜
            setTimeout(() => { if(currentIndex < questions.length - 1) navigate(1); }, 400);
        }

        function updateVAS(qId, val) {
            document.getElementById('vas-val-text').innerText = `${val} ${questions[currentIndex].unit}`;
            const rt = Math.round(performance.now() - questionOnset);
            currentAnswers[qId] = { value: parseInt(val), rt_ms: rt };
        }

        function updateCurve(qId) {
            const sliders = document.querySelectorAll('.curve-slider');
            let vals = [];
            sliders.forEach(s => vals.push(parseInt(s.value)));
            const rt = Math.round(performance.now() - questionOnset);
            currentAnswers[qId] = { value: vals, rt_ms: rt };
        }

        function navigate(step) {
            // å¦‚æœæ˜¯ä¸‹ä¸€é¢˜ï¼Œå°†å½“å‰ç­”æ¡ˆæ¨å…¥æ­£å¼æ•°ç»„
            if (step === 1) {
                const q = questions[currentIndex];
                const ans = currentAnswers[q.id];
                
                // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è®°å½•å¹¶æ›´æ–°ï¼Œå¦åˆ™æ¨å…¥
                const existingIdx = lifData.responses.findIndex(r => r.q_id === q.id);
                const record = { q_id: q.id, type: q.type, answer: ans.value, score: ans.score, hesitation_rt_ms: ans.rt_ms };
                if (existingIdx >= 0) lifData.responses[existingIdx] = record;
                else lifData.responses.push(record);
            }

            currentIndex += step;

            if (currentIndex >= questions.length) {
                submitAssessment();
            } else {
                renderQuestion();
            }
        }

        // ================= 4. ç‰¹å¾æå–ä¸å…¥åº“ =================
        function submitAssessment() {
            // æå–å…³é”®ä¸´åºŠæŒ‡æ ‡
            let totalIadlImpairment = 0;
            let rtArray = [];

            lifData.responses.forEach(r => {
                if(r.score !== undefined) totalIadlImpairment += r.score;
                rtArray.push(r.hesitation_rt_ms);
            });

            // è®¡ç®—å¹³å‡å†³ç­–è¿Ÿç–‘æ—¶é—´
            const avgRt = rtArray.length > 0 ? Math.round(rtArray.reduce((a,b)=>a+b,0) / rtArray.length) : 0;
            
            // æå–ç¡çœ å’ŒèŠ‚å¾‹
            const sleepQ = lifData.responses.find(r => r.q_id === 'sleep_quality');
            const curve = lifData.responses.find(r => r.q_id === 'circadian_rhythm');

            lifData.summary = {
                iadl_impairment_score: totalIadlImpairment, // åˆ†æ•°è¶Šé«˜ï¼Œç”Ÿæ´»è‡ªç†èƒ½åŠ›è¶Šå·®
                avg_decision_hesitation_ms: avgRt,
                sleep_quality_index: sleepQ ? sleepQ.answer : 50,
                circadian_curve: curve ? curve.answer : [50,50,50,50]
            };

            CAS_Storage.saveModuleData('LIF_Lifestyle', lifData);

            let msg = `âœ… æ—¥å¸¸åŠŸèƒ½ä¸èŠ‚å¾‹è¯„ä¼° (LIF) å·²å…¥åº“ï¼\n\n- IADL å—æŸåˆ†: ${totalIadlImpairment} (è¶Šä½è¶Šå¥½)\n- å¹³å‡å†³ç­–è¿Ÿç–‘: ${avgRt} ms\n- ç¡çœ è´¨é‡: ${lifData.summary.sleep_quality_index} / 100\n\n`;
            
            if(totalIadlImpairment >= 2) {
                msg += "âš ï¸ ä¸´åºŠæç¤ºï¼šæ£€æµ‹åˆ°å·¥å…·æ€§æ—¥å¸¸ç”Ÿæ´»èƒ½åŠ› (IADL) å‡ºç°ä¸‹é™ã€‚\n";
            }
            if(avgRt > 6000) {
                msg += "âš ï¸ é¢„è­¦æç¤ºï¼šå—è¯•è€…åœ¨å›ç­”æ—¥å¸¸ç”Ÿæ´»é—®é¢˜æ—¶ï¼Œå†³ç­–æ½œä¼æœŸ(>6ç§’)æ˜¾è‘—å»¶é•¿ï¼Œæç¤ºå¯èƒ½å­˜åœ¨éšæ€§è®¤çŸ¥è´Ÿè·æˆ–æ‰§è¡ŒåŠŸèƒ½ä¸‹é™å¸¦æ¥çš„çŠ¹è±«ã€‚";
            }

            alert(msg);
            setTimeout(() => { location.href = 'index.html'; }, 800);
        }
    </script>
</body>
</html>
