<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-MOT | æ•°å­—ä¹¦å†™åŠ¨åŠ›å­¦ (dCDT)</title>
    <style>
        /* ç§‘æŠ€æ¸©æƒ…é£ UI */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --amber: #f59e0b; --slate: #64748b; --teal: #0d9488; }
        body { font-family: -apple-system, sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; touch-action: none; /* ç¦ç”¨å…¨å±€æ»šåŠ¨ï¼Œç¡®ä¿ç”»ç¬”æµç•… */ }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        .module-header { border-left: 6px solid var(--teal); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .instruction-box { background: #f0fdfa; border: 2px dashed #99f6e4; padding: 20px; border-radius: 16px; margin-bottom: 25px; text-align: center; font-size: 18px; color: #0f766e; font-weight: bold; }
        .instruction-box span { color: #e11d48; font-size: 22px; }

        /* ç”»æ¿åŒºåŸŸ */
        .canvas-container { position: relative; width: 100%; height: 500px; background: #f8fafc; border: 2px solid #cbd5e1; border-radius: 20px; overflow: hidden; box-shadow: inset 0 0 10px rgba(0,0,0,0.02); }
        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; touch-action: none; }

        /* åŠ¨åŠ›å­¦å®æ—¶åé¦ˆé¢æ¿ */
        .metrics-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 25px; }
        .metric-card { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: center; }
        .metric-card span { display: block; font-size: 12px; color: var(--slate); font-weight: bold; margin-bottom: 5px; }
        .metric-card strong { font-size: 20px; color: var(--teal); font-family: monospace; }

        .controls { display: flex; gap: 20px; margin-top: 30px; }
        .btn { flex: 1; padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-clear { background: #f1f5f9; color: var(--slate); border: 2px solid #e2e8f0; }
        .btn-clear:hover { background: #e2e8f0; }
        .btn-submit { background: var(--teal); color: white; box-shadow: 0 8px 20px rgba(13, 148, 136, 0.2); }
        .btn-submit:hover { background: #0f766e; transform: translateY(-2px); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--teal); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="module-header">
            <h2>âœï¸ æ•°å­—åŒ–ç”»é’Ÿæµ‹è¯• (dCDT)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>æ‰§è¡ŒåŠŸèƒ½ã€è§†ç©ºé—´èƒ½åŠ›ä¸è¯­ä¹‰è®°å¿†ã€‚ç³»ç»Ÿå°†åœ¨åå°æå–å¾®è§‚åŠ¨åŠ›å­¦ï¼ˆKinematicsï¼‰ä¸ç©ºä¸­åœé¡¿æ—¶é—´ï¼ˆIn-air Timeï¼‰ã€‚<br>
            *å»ºè®®ä½¿ç”¨ Apple Pencil æˆ–æ”¯æŒå‹æ„Ÿçš„è§¦æ§ç¬”ï¼Œä»¥è·å–é«˜ç²¾åº¦å‹åŠ›ç‰¹å¾ã€‚</p>
        </div>

        <div class="instruction-box">
            è¯·åœ¨ä¸‹æ–¹ç©ºç™½å¤„ç”»ä¸€ä¸ªåœ†å½¢çš„é’Ÿè¡¨ã€‚<br>
            æŠŠæ‰€æœ‰çš„æ•°å­—éƒ½å†™ä¸Šï¼Œå¹¶æŠŠæŒ‡é’ˆæŒ‡åœ¨ <span>11ç‚¹10åˆ†</span> çš„ä½ç½®ã€‚
        </div>

        <div class="canvas-container">
            <canvas id="dcdt-canvas"></canvas>
        </div>

        <div class="metrics-board">
            <div class="metric-card"><span>æ€»è€—æ—¶</span><strong id="m-total">0.0s</strong></div>
            <div class="metric-card"><span>è½ç¬”æ—¶é—´</span><strong id="m-surface">0.0s</strong></div>
            <div class="metric-card"><span>ç©ºä¸­æ€è€ƒæ—¶é—´</span><strong id="m-air">0.0s</strong></div>
            <div class="metric-card"><span>æ€»ç¬”ç”»æ•°</span><strong id="m-strokes">0</strong></div>
        </div>

        <div class="controls">
            <button class="btn btn-clear" onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©ºé‡ç”»</button>
            <button class="btn btn-submit" onclick="submitDCDT()">ğŸ’¾ æå–åŠ¨åŠ›å­¦ç‰¹å¾å¹¶ä¿å­˜</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('dcdt-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        // é€‚é…é«˜åˆ†å± (Retina Display) çš„ç»˜å›¾ç²¾åº¦
        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        /* ==================== æ ¸å¿ƒåŠ¨åŠ›å­¦æ•°æ®ç»“æ„ ==================== */
        let dcdtData = {
            module: "MOT_dCDT",
            strokes: [],          // è®°å½•æ¯ä¸€ç¬”çš„è¯¦ç»†ç‚¹ä½ä¸å‹æ„Ÿ
            start_time_ms: null,  // ç¬¬ä¸€æ¬¡è½ç¬”æ—¶é—´
            end_time_ms: null,    // æœ€åä¸€æ¬¡æŠ¬ç¬”æ—¶é—´
            total_surface_ms: 0,  // ç¬”å°–æ¥è§¦å±å¹•çš„æ€»æ—¶é—´
            total_air_ms: 0       // ç¬”å°–æ‚¬ç©ºæ€è€ƒæ—¶é—´ (In-air time)
        };

        let currentStroke = [];
        let isDrawing = false;
        let lastPointerUpTime = null; 
        let strokeStartTime = null;

        /* ==================== æ¸²æŸ“ä¸ç‰¹å¾æ•è·å¼•æ“ ==================== */
        // ä½¿ç”¨ Pointer Eventsï¼Œå®ƒå¯ä»¥å®Œç¾å…¼å®¹é¼ æ ‡ã€æ‰‹æŒ‡å’Œå¸¦å‹æ„Ÿçš„è§¦æ§ç¬”
        canvas.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            isDrawing = true;
            
            const now = performance.now();
            if(!dcdtData.start_time_ms) dcdtData.start_time_ms = now;
            
            // è®¡ç®—ç©ºä¸­åœé¡¿æ—¶é—´ (In-air time)
            if(lastPointerUpTime) {
                dcdtData.total_air_ms += (now - lastPointerUpTime);
            }

            strokeStartTime = now;
            currentStroke = [];
            
            // è®°å½•èµ·ç‚¹
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const pressure = e.pressure || 0.5; // è‹¥è®¾å¤‡ä¸æ”¯æŒå‹æ„Ÿï¼Œé»˜è®¤0.5
            
            currentStroke.push({ x: x, y: y, t: Math.round(now), p: pressure });
            
            ctx.beginPath();
            ctx.moveTo(x, y);
            updateMetricsUI();
        });

        canvas.addEventListener('pointermove', (e) => {
            if (!isDrawing) return;
            e.preventDefault();
            
            const now = performance.now();
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const pressure = e.pressure || 0.5;

            // åŠ¨æ€è°ƒæ•´ç¬”ç”»ç²—ç»† (åŸºäºå‹æ„Ÿï¼Œå¢åŠ è§¦è§‰åé¦ˆçš„çœŸå®åº¦)
            ctx.lineWidth = 2 + pressure * 4; 
            ctx.strokeStyle = '#1e293b';
            
            ctx.lineTo(x, y);
            ctx.stroke();

            // é«˜é¢‘é‡‡æ ·ç‰¹å¾ç‚¹
            currentStroke.push({ x: x, y: y, t: Math.round(now), p: pressure });
        });

        function endPointer(e) {
            if (!isDrawing) return;
            isDrawing = false;
            
            const now = performance.now();
            lastPointerUpTime = now;
            dcdtData.end_time_ms = now;
            
            // ç´¯åŠ æœ¬æ¬¡è½ç¬”æŒç»­æ—¶é—´
            dcdtData.total_surface_ms += (now - strokeStartTime);
            
            // å°†è¿™ä¸€ç¬”å‹å…¥æ€»åºåˆ—
            if(currentStroke.length > 0) {
                dcdtData.strokes.push({
                    stroke_index: dcdtData.strokes.length + 1,
                    duration_ms: Math.round(now - strokeStartTime),
                    points: currentStroke
                });
            }
            updateMetricsUI();
        }

        canvas.addEventListener('pointerup', endPointer);
        canvas.addEventListener('pointerout', endPointer); // é˜²æ­¢ç¬”å°–åˆ’å‡ºè¾¹ç•Œä¸¢å¤±äº‹ä»¶
        canvas.addEventListener('pointercancel', endPointer);

        /* ==================== ç•Œé¢æ›´æ–°ä¸æ•°æ®å…¥åº“ ==================== */
        function updateMetricsUI() {
            if(!dcdtData.start_time_ms) return;
            
            const totalSec = ((lastPointerUpTime || performance.now()) - dcdtData.start_time_ms) / 1000;
            const surfaceSec = dcdtData.total_surface_ms / 1000;
            const airSec = dcdtData.total_air_ms / 1000;

            document.getElementById('m-total').innerText = totalSec.toFixed(1) + 's';
            document.getElementById('m-surface').innerText = surfaceSec.toFixed(1) + 's';
            // å½“ç©ºä¸­æ€è€ƒæ—¶é—´å¼‚å¸¸é•¿æ—¶ï¼Œç»™äºˆæ ‡çº¢æç¤º (æ‰§è¡ŒåŠŸèƒ½è¡°é€€çš„ææ—©æœŸæŒ‡æ ‡)
            const airEl = document.getElementById('m-air');
            airEl.innerText = airSec.toFixed(1) + 's';
            if(airSec > 5.0) { airEl.style.color = 'var(--red)'; } else { airEl.style.color = 'var(--teal)'; }
            
            document.getElementById('m-strokes').innerText = dcdtData.strokes.length;
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            dcdtData.strokes = [];
            dcdtData.start_time_ms = null; dcdtData.end_time_ms = null;
            dcdtData.total_surface_ms = 0; dcdtData.total_air_ms = 0;
            lastPointerUpTime = null;
            updateMetricsUI();
            
            document.getElementById('m-total').innerText = '0.0s';
            document.getElementById('m-surface').innerText = '0.0s';
            document.getElementById('m-air').innerText = '0.0s';
            document.getElementById('m-air').style.color = 'var(--teal)';
            document.getElementById('m-strokes').innerText = '0';
        }

        function submitDCDT() {
            if(dcdtData.strokes.length === 0) return alert("è¯·å…ˆåœ¨ç”»æ¿ä¸Šå®Œæˆç”»é’Ÿæµ‹è¯•ã€‚");
            
            // ç®€å•çš„æ•°æ®æ¸…æ´—ä¸æ±‡æ€»
            dcdtData.summary = {
                total_duration_sec: parseFloat(document.getElementById('m-total').innerText),
                on_surface_sec: parseFloat(document.getElementById('m-surface').innerText),
                in_air_sec: parseFloat(document.getElementById('m-air').innerText),
                total_strokes: dcdtData.strokes.length
            };

            CAS_Storage.saveModuleData('MOT_dCDT', dcdtData);
            
            alert(`âœ… åŠ¨åŠ›å­¦ç‰¹å¾æå–æˆåŠŸï¼\n\n- æ€»ç¬”ç”»æ•°: ${dcdtData.summary.total_strokes}\n- è½ç¬”æ—¶é—´: ${dcdtData.summary.on_surface_sec} s\n- ç©ºä¸­æ€è€ƒæ—¶é—´: ${dcdtData.summary.in_air_sec} s\n\n*åå°å·²è®°å½•æ•°ç™¾ä¸ªå¾®è§‚æ—¶ç©ºç‚¹ä½ä¸å‹æ„Ÿåæ ‡ï¼Œå¯ä¾›åç»­æœºå™¨å­¦ä¹ å»ºæ¨¡ã€‚`);
            
            setTimeout(() => { location.href = 'index.html'; }, 800);
        }
    </script>
</body>
</html>
