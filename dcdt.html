<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-dCDT | æ•°å­—åŒ–ç”»é’Ÿä¸ä¹¦å†™åŠ¨åŠ›å­¦ (ç§‘ç ”å®Œå…¨ä½“)</title>
    <style>
        /* ==================== UI ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --teal: #0d9488; --red: #f43f5e; --slate: #64748b; --bg: #fcfcfd; }
        /* ç»å¯¹ç¦æ­¢æµè§ˆå™¨çš„é»˜è®¤æ©¡çš®ç­‹å›å¼¹ã€åŒå‡»æ”¾å¤§å’Œé•¿æŒ‰é€‰è¯ï¼Œä¿è¯ç”»å¸ƒçš„çº¯å‡€åº¦ */
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); overscroll-behavior: none; user-select: none; -webkit-user-select: none; }
        .container { max-width: 900px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        .module-header { border-left: 6px solid var(--teal); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .instruction-box { background: #f0fdfa; border: 2px dashed #99f6e4; padding: 20px; border-radius: 16px; margin-bottom: 25px; text-align: center; }
        .instruction-box p { margin: 0; color: #0f766e; font-size: 18px; font-weight: bold; }

        /* ç”»å¸ƒå®¹å™¨ï¼šåˆ©ç”¨ CSS ç¡¬ä»¶åŠ é€Ÿå¹¶å½»åº•é˜»æ–­è§¦æ§é»˜è®¤è¡Œä¸º */
        .canvas-container { position: relative; width: 100%; height: 500px; background: #fff; border: 2px solid #cbd5e1; border-radius: 16px; box-shadow: inset 0 0 20px rgba(0,0,0,0.02); overflow: hidden; margin-bottom: 20px;}
        canvas { display: block; width: 100%; height: 100%; touch-action: none; /* å…³é”®ï¼šç¦ç”¨æ‰‹åŠ¿å¹³ç§»å’Œç¼©æ”¾ */ cursor: crosshair; }

        .metrics-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: center; }
        .metric-card span { display: block; font-size: 12px; color: var(--slate); font-weight: bold; margin-bottom: 5px; }
        .metric-card strong { font-size: 22px; color: var(--primary); font-family: monospace; }
        .highlight-val { color: var(--teal) !important; }

        .btn-group { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; }
        .btn { padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-clear { background: #f1f5f9; color: var(--slate); border: 2px solid #e2e8f0;}
        .btn-clear:hover { background: #e2e8f0; }
        .btn-submit { background: var(--teal); color: white; box-shadow: 0 8px 20px rgba(13, 148, 136, 0.2); }
        .btn-submit:hover { background: #0f766e; transform: translateY(-2px); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--teal); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="module-header">
            <h2>âœï¸ æ•°å­—åŒ–ç”»é’ŸåŠ¨åŠ›å­¦ (dCDT)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>è¯„ä¼°æ‰§è¡ŒåŠŸèƒ½ã€è§†ç©ºé—´ç»“æ„èƒ½åŠ›ä¸è¿åŠ¨è®¡åˆ’ã€‚ç³»ç»Ÿå°†ä»¥é«˜é¢‘é‡‡æ ·ç‡è®°å½•ç¬”å°–åæ ‡(X/Y)ã€æ—¶é—´æˆ³(t)åŠå‹åŠ›(p)ã€‚<br>
            *æ•æ‰ç©ºä¸­æ€è€ƒæ—¶é—´ (In-air Time)ï¼Œé¢„è­¦æ—©æœŸé¢é¡¶ç½‘ç»œæ‰§è¡Œè¡°é€€ã€‚</p>
        </div>

        <div class="instruction-box">
            <p>â€œè¯·åœ¨ä¸‹æ–¹ç”»ä¸€ä¸ªåœ†å½¢çš„é’Ÿè¡¨ï¼Œæ ‡ä¸Šæ‰€æœ‰æ•°å­—ï¼Œå¹¶å°†æŒ‡é’ˆç”»åœ¨ã€11ç‚¹10åˆ†ã€‘ã€‚â€</p>
        </div>

        <div class="canvas-container" id="canvas-container">
            <canvas id="dcdt-canvas"></canvas>
        </div>

        <div class="metrics-board">
            <div class="metric-card"><span>æ€»ç¬”ç”»æ•° (Strokes)</span><strong id="m-strokes">0</strong></div>
            <div class="metric-card"><span>è½ç¬”ä¹¦å†™æ—¶é—´ (On-surface)</span><strong id="m-on">0.00 s</strong></div>
            <div class="metric-card"><span>ç©ºä¸­æ€è€ƒæ—¶é—´ (In-air)</span><strong id="m-off" class="highlight-val">0.00 s</strong></div>
        </div>

        <div class="btn-group">
            <button class="btn btn-clear" onclick="clearCanvas()">ğŸ—‘ï¸ é‡ç”»</button>
            <button class="btn btn-submit" onclick="submitDCDT()">ğŸ’¾ æå–æ—¶ç©ºç‰¹å¾å¹¶å…¥åº“</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('dcdt-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true }); // ä¼˜åŒ–é«˜é¢‘ç»˜åˆ¶æ€§èƒ½
        
        // æ•°æ®ç»“æ„ï¼šä¸¥æ ¼éµå¾ªå›½é™…ä¹¦å†™åŠ¨åŠ›å­¦è§„èŒƒ
        let dcdtData = { module: "MOT_dCDT", raw_strokes: [], summary: {} };
        let currentStroke = [];
        let isDrawing = false;
        
        let sessionStartTime = null;
        let totalOnSurfaceTime = 0; // ç´¯è®¡è½ç¬”æ—¶é—´ (ms)
        let totalInAirTime = 0;     // ç´¯è®¡æ‚¬ç©ºæ€è€ƒæ—¶é—´ (ms)
        let lastPointerUpTime = null; // ä¸Šä¸€ç¬”ç»“æŸçš„æ—¶é—´

        // è§£å†³é«˜åˆ†å±æ¨¡ç³Šå’Œåæ ‡åç§»é—®é¢˜ (Retina Ready)
        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            // åˆå§‹åŒ–ç”»ç¬”æ ·å¼
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#0f172a';
            ctx.lineWidth = 3;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function clearCanvas() {
            if(!confirm("ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒé‡æ–°å¼€å§‹å—ï¼Ÿ")) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            dcdtData.raw_strokes = [];
            currentStroke = [];
            isDrawing = false;
            sessionStartTime = null;
            totalOnSurfaceTime = 0;
            totalInAirTime = 0;
            lastPointerUpTime = null;
            updateUI();
        }

        // ================= æ ¸å¿ƒä¹¦å†™å¼•æ“ (åŸºäº PointerEvent) =================
        
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: Math.round(e.clientX - rect.left),
                y: Math.round(e.clientY - rect.top),
                t: Math.round(e.timeStamp),
                p: e.pressure ? parseFloat(e.pressure.toFixed(3)) : 1.0 // è®°å½•å‹æ„Ÿï¼Œå¦‚æœä¸æ”¯æŒåˆ™é»˜è®¤1.0
            };
        }

        canvas.addEventListener('pointerdown', (e) => {
            e.preventDefault(); // é˜»æ–­é»˜è®¤æ»šåŠ¨
            if (e.pointerType === 'mouse' && e.button !== 0) return; // å¿½ç•¥é¼ æ ‡å³é”®
            
            isDrawing = true;
            const pos = getPos(e);
            currentStroke = [pos];
            
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);

            // å¦‚æœæ˜¯ç¬¬ä¸€ç¬”ï¼Œè®°å½•æ€»ä½“èµ·å§‹æ—¶é—´
            if (!sessionStartTime) {
                sessionStartTime = pos.t;
            } else if (lastPointerUpTime) {
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€ç¬”ï¼Œæœ¬æ¬¡è½ç¬”æ—¶é—´ - ä¸Šæ¬¡æŠ¬ç¬”æ—¶é—´ = è¿™ä¸€æ®µçš„æ‚¬ç©ºæ€è€ƒæ—¶é—´
                totalInAirTime += (pos.t - lastPointerUpTime);
            }
            updateUI();
        });

        canvas.addEventListener('pointermove', (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            
            const pos = getPos(e);
            currentStroke.push(pos);
            
            // å®æ—¶ç»˜åˆ¶åé¦ˆ (ä½¿ç”¨çº¿æ®µè¿æ¥ä¿è¯åœ†æ»‘ï¼Œå¦‚æœç¡¬ä»¶æ”¯æŒå‹æ„Ÿå¯æ ¹æ® p æ”¹å˜çº¿å®½)
            ctx.lineWidth = 2 + (pos.p * 3); // å‹æ„Ÿè”åŠ¨è§†è§‰æ•ˆæœ
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            
            // ä¸ºäº†å¹³æ»‘è¿‡æ¸¡ï¼Œé‡ç½®èµ·ç‚¹
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        });

        // å°† pointerup, pointerout, pointercancel ç»Ÿä¸€å¤„ç†ä¸ºæ–­ç¬”
        const endStroke = (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            isDrawing = false;
            
            const pos = getPos(e);
            // è®¡ç®—è¿™ä¸€ç¬”ç”»èŠ±è´¹çš„è½ç¬”æ—¶é—´
            if (currentStroke.length > 0) {
                const strokeStartTime = currentStroke[0].t;
                totalOnSurfaceTime += (pos.t - strokeStartTime);
            }
            
            lastPointerUpTime = pos.t;
            dcdtData.raw_strokes.push([...currentStroke]);
            currentStroke = [];
            
            updateUI();
        };

        canvas.addEventListener('pointerup', endStroke);
        canvas.addEventListener('pointerout', endStroke);
        canvas.addEventListener('pointercancel', endStroke);

        // ================= æ•°æ®ç»Ÿè®¡ç®—æ³• =================

        function updateUI() {
            document.getElementById('m-strokes').innerText = dcdtData.raw_strokes.length;
            document.getElementById('m-on').innerText = (totalOnSurfaceTime / 1000).toFixed(2) + ' s';
            
            // æ‚¬ç©ºæ—¶é—´ UI å®æ—¶å˜è‰²é¢„è­¦
            const inAirSec = (totalInAirTime / 1000).toFixed(2);
            const inAirEl = document.getElementById('m-off');
            inAirEl.innerText = inAirSec + ' s';
            
            if(inAirSec > 8.0) {
                inAirEl.style.color = 'var(--red)';
            } else {
                inAirEl.style.color = 'var(--teal)';
            }
        }

        function submitDCDT() {
            if (dcdtData.raw_strokes.length === 0) return alert("ç”»å¸ƒä¸ºç©ºï¼Œè¯·è®©å—è¯•è€…ç”»é’Ÿã€‚");

            // è®¡ç®—å…¨å±€æ€»è€—æ—¶
            const finalTime = performance.now(); // ç›¸å¯¹èµ·ç‚¹
            const totalSessionTime = lastPointerUpTime ? (lastPointerUpTime - sessionStartTime) : 0;

            dcdtData.summary = {
                num_strokes: dcdtData.raw_strokes.length,
                on_surface_sec: parseFloat((totalOnSurfaceTime / 1000).toFixed(2)),
                in_air_sec: parseFloat((totalInAirTime / 1000).toFixed(2)),
                total_duration_sec: parseFloat((totalSessionTime / 1000).toFixed(2))
            };

            CAS_Storage.saveModuleData('MOT_dCDT', dcdtData);
            
            let msg = `âœ… dCDT æ—¶ç©ºç‰¹å¾å·²å…¥åº“ï¼\n\n- æ€»ç¬”ç”»æ•°: ${dcdtData.summary.num_strokes}\n- ä¹¦å†™æ€»è€—æ—¶: ${dcdtData.summary.on_surface_sec} ç§’\n- ç©ºä¸­æ€è€ƒæ—¶é—´: ${dcdtData.summary.in_air_sec} ç§’\n\n`;
            if(dcdtData.summary.in_air_sec > 8.0) {
                msg += "âš ï¸ ä¸´åºŠæç¤ºï¼šå—è¯•è€…çš„æ‚¬ç©ºæ€è€ƒæ—¶é—´æ˜¾è‘—å»¶é•¿ï¼Œæç¤ºå¯èƒ½å­˜åœ¨è§†ç©ºé—´è§„åˆ’å›°éš¾æˆ–æ‰§è¡ŒåŠŸèƒ½æ—©è¡°ã€‚";
            } else {
                msg += "* è¿åŠ¨è§„åˆ’ä¸ç©ºé—´ç»“æ„æ‰§è¡Œæµç•…ã€‚";
            }

            alert(msg);
            setTimeout(() => { location.href = 'index.html'; }, 800);
        }
    </script>
</body>
</html>
