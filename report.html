<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>NeuroMap 1.0 - ç¥ç»è¡Œä¸ºå¤šæ¨¡æ€è¯„ä¼°å›¾è°±ä¸è®¡ç®—ç²¾ç¥ç—…å­¦é£é™©æŠ¥å‘Š</title>
    <style>
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --amber: #f59e0b; --purple: #8b5cf6; --teal: #0d9488; --slate: #64748b; }
        
        /* å¼ºåˆ¶æ‰“å°æ—¶ä¿ç•™èƒŒæ™¯è‰²ä¸æ¸å˜è‰²ï¼Œè¿™å¯¹å¯è§†åŒ–å›¾è¡¨æ‰“å°æå…¶é‡è¦ */
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { background: white; padding: 0; }
            .input-panel, .btn-group, button { display: none !important; }
            .container { box-shadow: none; padding: 0; border: none; max-width: 100%; }
            .results-box { break-inside: avoid; }
            .viz-card { break-inside: avoid; }
        }

        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; padding: 30px; color: #334155; line-height: 1.6; margin: 0;}
        .container { max-width: 1050px; margin: auto; background: white; padding: 45px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        h2 { color: var(--blue); border-bottom: 3px solid var(--light-blue); padding-bottom: 15px; margin-top: 0; display: flex; align-items: center; gap: 10px;}
        
        /* é¡¶éƒ¨æ§åˆ¶å° */
        .input-panel { background: #f8fafc; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 35px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-input { padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 15px; outline: none; font-weight: bold;}
        .btn-action { padding: 12px 20px; background: white; border: 2px solid var(--blue); color: var(--blue); border-radius: 8px; font-weight: bold; cursor: pointer; display: block; text-align: center;}
        .btn-generate { margin-top: 20px; width: 100%; padding: 15px; background: var(--blue); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;}
        
        /* åŸºç¡€ä¿¡æ¯åŒº */
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; background: #f8fafc; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; }
        .info-item span { display: block; font-size: 13.5px; color: var(--slate); font-weight: bold;}
        .info-item strong { font-size: 18px; color: var(--primary); }

        /* æ¨¡å— 1ï¼šå…­å¤§åŸºå¸¦é›·è¾¾ */
        .chart-container { background: white; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 1px solid #e2e8f0; }
        .bar-row { display: flex; align-items: center; margin-bottom: 15px; }
        .bar-label { width: 150px; font-weight: bold; color: var(--slate); font-size: 14.5px; }
        .bar-track { flex: 1; height: 20px; background: #f1f5f9; border-radius: 10px; overflow: hidden;}
        .bar-fill { height: 100%; border-radius: 10px; width: 0%; transition: width 1.5s; }
        .bar-value { width: 50px; text-align: right; font-weight: bold; color: var(--primary); font-size: 16px; }

        .fill-cog { background: linear-gradient(90deg, #818cf8, #4f46e5); } .fill-emo { background: linear-gradient(90deg, #fb7185, #e11d48); }
        .fill-mot { background: linear-gradient(90deg, #fcd34d, #f59e0b); } .fill-sen { background: linear-gradient(90deg, #fef08a, #eab308); }
        .fill-lan { background: linear-gradient(90deg, #c084fc, #9333ea); } .fill-lif { background: linear-gradient(90deg, #2dd4bf, #0d9488); }

        /* æ¨¡å— 2ï¼šè®¡ç®—ç²¾ç¥ç—…å­¦é£é™©å›¾è°± */
        .risk-container { background: #fffbeb; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 2px dashed #fcd34d; }
        .risk-header { font-size: 18px; font-weight: bold; color: #b45309; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;}
        .risk-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;}
        .risk-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #fde68a; box-shadow: 0 4px 10px rgba(0,0,0,0.02);}
        .risk-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: flex; justify-content: space-between;}
        .risk-bar-track { height: 12px; background: #f1f5f9; border-radius: 6px; overflow: hidden; margin-bottom: 10px;}
        .risk-bar-fill { height: 100%; width: 0%; transition: width 1.5s ease-out; }
        .risk-details { font-size: 12px; color: var(--slate); margin: 0; line-height: 1.5;}
        
        .risk-low { background: var(--green); } .risk-med { background: var(--amber); } .risk-high { background: var(--red); }

        /* ================= æ–°å¢æ¨¡å— 3ï¼šç”Ÿç‰©æ ‡å¿—ç‰©å¯è§†åŒ–é¢æ¿ ================= */
        .viz-box { background: white; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 1px solid #e2e8f0; }
        .viz-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .viz-card { background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .viz-title { font-size: 14px; font-weight: bold; color: var(--slate); margin-bottom: 15px; width: 100%; text-align: left; }
        
        /* å¯è§†åŒ–ç»„ä»¶ï¼šç¯å½¢å›¾ (Donut) */
        .viz-donut { width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 10px; }
        .viz-donut-inner { width: 75px; height: 75px; background: #f8fafc; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; color: var(--primary); z-index: 2; }
        .viz-donut-inner span { font-size: 11px; color: var(--slate); font-weight: normal; }
        
        /* å¯è§†åŒ–ç»„ä»¶ï¼šæ¸å˜é˜ˆå€¼æ ‡å°º (Gauge) */
        .viz-gauge-container { width: 100%; margin-top: 10px; margin-bottom: 15px; position: relative; }
        .viz-gauge-track { width: 100%; height: 14px; border-radius: 7px; background: linear-gradient(90deg, var(--green) 0%, var(--amber) 50%, var(--red) 100%); }
        .viz-gauge-marker { position: absolute; top: -5px; width: 4px; height: 24px; background: var(--primary); border-radius: 2px; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: left 1s; }
        .viz-gauge-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--slate); margin-top: 5px; font-weight: bold;}
        .viz-value-text { font-size: 22px; font-weight: bold; color: var(--primary); font-family: monospace; }

        /* æ¨¡å— 4ï¼šä¸´åºŠæŠ¥å‘Šæ˜ç»†ä¸æ¨¡å—å¾—åˆ† UI */
        .results-box { background: #f8fafc; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 2px dashed #cbd5e1; }
        .domain-section { margin-bottom: 25px; }
        .domain-title { font-size: 16px; font-weight: bold; color: white; background: var(--primary); padding: 8px 15px; border-radius: 8px; display: inline-block; margin-bottom: 12px;}
        .result-item { font-size: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; padding: 12px 15px; background: white; border-radius: 12px; border: 1px solid #e2e8f0; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);}
        .item-text-group { display: flex; flex-direction: column; gap: 4px; }
        .alert-badge { color: white; background: var(--red); font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: bold;}
        .warning-badge { color: white; background: var(--amber); font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: bold;}
        .module-score { padding: 6px 12px; border-radius: 10px; font-weight: bold; font-size: 15px; border: 1px solid; display: flex; align-items: center; gap: 5px; min-width: 80px; justify-content: center;}

        /* åº•éƒ¨æ“ä½œåŒº */
        .btn-group { display: flex; gap: 20px; }
        .btn { flex: 1; padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-export { background: var(--green); color: white; }
        .btn-print { background: var(--slate); color: white; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div class="container">
        <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer; font-size: 16px; margin-bottom: 20px;">â† è¿”å›æ§åˆ¶å°</button>

        <div class="input-panel">
            <h3>âš™ï¸ ä¸´åºŠåŸºçº¿èåˆå¼•æ“</h3>
            <div class="input-grid">
                <div>
                    <label style="font-size:13px; font-weight:bold; color:var(--slate);">é€‰æ‹©æ•°æ®æº</label>
                    <select id="data-source-select" class="form-input" style="width:100%; margin-bottom:10px;" onchange="document.getElementById('file-uploader').style.display = this.value === 'file' ? 'block' : 'none';">
                        <option value="local">è¯»å–å½“å‰æµ‹è¯•æ‚£è€… (æœ¬åœ°ç¼“å­˜)</option>
                        <option value="file">å¯¼å…¥ç¦»çº¿ BIDS-JSON æ•°æ®åŒ…</option>
                    </select>
                    <div id="file-uploader" style="display:none; position:relative;">
                        <span class="btn-action" id="btn-file-label">ğŸ“‚ ç‚¹å‡»ä¸Šä¼  JSON æ¡£æ¡ˆ</span>
                        <input type="file" id="json-file-input" accept=".json" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="input-mmse" class="form-input" placeholder="MMSE å¾—åˆ† (é€‰å¡«)" style="flex:1;">
                    <input type="number" id="input-moca" class="form-input" placeholder="MoCA å¾—åˆ† (é€‰å¡«)" style="flex:1;">
                </div>
            </div>
            <button class="btn-generate" onclick="generateReport()">âš¡ å¯åŠ¨è”åˆè¯„ä¼°ä¸å¤šæ¨¡æ€è§£æ</button>
        </div>

        <h2>ğŸ“Š NeuroMap å¤šæ¨¡æ€å›¾è°±ä¸è®¡ç®—é¢„è­¦æŠ¥å‘Š</h2>
        
        <div class="info-grid">
            <div class="info-item"><span>è¢«è¯• ID</span><strong id="r-id">-</strong></div>
            <div class="info-item"><span>å¹´é¾„ / æ€§åˆ«</span><strong id="r-bio">-</strong></div>
            <div class="info-item"><span>ä¼ ç»Ÿé‡è¡¨å¾—åˆ†</span><strong id="r-scales" style="color:var(--blue);">- / -</strong></div>
        </div>

        <div class="chart-container">
            <h3 style="margin-top:0; color:var(--primary);">ç¬¬ä¸€å±‚ï¼šåŸºå¸¦è®¤çŸ¥ä¸ç”Ÿç†ç‰¹å¾å›¾è°± (ç¥ç»ç”Ÿç†ç»´åº¦)</h3>
            <div class="bar-row"><div class="bar-label">ğŸ§  è®¤çŸ¥æ‰§è¡Œ (COG)</div><div class="bar-track"><div class="bar-fill fill-cog" id="bar-cog"></div></div><div class="bar-value" id="val-cog">0</div></div>
            <div class="bar-row"><div class="bar-label">â¤ï¸ æƒ…ç»ªç¤¾ä¼š (EMO)</div><div class="bar-track"><div class="bar-fill fill-emo" id="bar-emo"></div></div><div class="bar-value" id="val-emo">0</div></div>
            <div class="bar-row"><div class="bar-label">ğŸ¯ è¿åŠ¨å…±æµ (MOT)</div><div class="bar-track"><div class="bar-fill fill-mot" id="bar-mot"></div></div><div class="bar-value" id="val-mot">0</div></div>
            <div class="bar-row"><div class="bar-label">âš¡ æ„Ÿè§‰çŸ¥è§‰ (SEN)</div><div class="bar-track"><div class="bar-fill fill-sen" id="bar-sen"></div></div><div class="bar-value" id="val-sen">0</div></div>
            <div class="bar-row"><div class="bar-label">ğŸ’¬ è¯­è¨€ç½‘ç»œ (LAN)</div><div class="bar-track"><div class="bar-fill fill-lan" id="bar-lan"></div></div><div class="bar-value" id="val-lan">0</div></div>
            <div class="bar-row"><div class="bar-label">ğŸŒ™ ç”Ÿæ´»åŠŸèƒ½ (LIF)</div><div class="bar-track"><div class="bar-fill fill-lif" id="bar-lif"></div></div><div class="bar-value" id="val-lif">0</div></div>
        </div>

        <div class="risk-container" id="risk-panel" style="display:none;">
            <div class="risk-header">âš ï¸ ç¬¬äºŒå±‚ï¼šè®¡ç®—ç²¾ç¥ç—…å­¦è”åˆé¢„è­¦æ¨¡å‹ (å¤šç»´ç‰¹å¾äº¤å‰æ˜ å°„)</div>
            <div class="risk-grid">
                <div class="risk-card">
                    <div class="risk-title"><span>é˜¿å°”èŒ¨æµ·é»˜ç—… (AD/MCI) ç»¼åˆé£é™©</span><span id="risk-val-ad">0%</span></div>
                    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-ad"></div></div>
                    <p class="risk-details">èåˆé¶ç‚¹: è¯­ä¹‰é˜»æ»(VFT) + ç©ºé—´è¡°é€€(Corsi) + æ‰§è¡Œè¿Ÿç¼“(TMT/dCDT) + å†³ç­–è¿Ÿç–‘(LIF)</p>
                </div>
                <div class="risk-card">
                    <div class="risk-title"><span>é‡åº¦æŠ‘éƒç—‡ (MDD) ç»¼åˆé£é™©</span><span id="risk-val-mdd">0%</span></div>
                    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-mdd"></div></div>
                    <p class="risk-details">èåˆé¶ç‚¹: å†…éšè´Ÿæ€§åç½®(IAT) + å‰é¢å¶è°ƒèŠ‚å¤±è´¥(ERT) + è¿·èµ°å¼ åŠ›æŠ‘åˆ¶(rPPG) + è¯­éŸ³è¿Ÿæ»(VBM)</p>
                </div>
                <div class="risk-card">
                    <div class="risk-title"><span>å¸•é‡‘æ£®ç—… (PD) ç»¼åˆé£é™©</span><span id="risk-val-pd">0%</span></div>
                    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-pd"></div></div>
                    <p class="risk-details">èåˆé¶ç‚¹: å‰‚æœ«è¡°ç«­(AFT) + æŒ‰é”®è‚Œå¼ºç›´(KeyStroke) + åŒé‡ä»»åŠ¡æ­¥æ€å˜å¼‚(IMU)</p>
                </div>
                <div class="risk-card">
                    <div class="risk-title"><span>æ³¨æ„ç¼ºé™·/è­¦è§‰å—æŸé£é™©</span><span id="risk-val-att">0%</span></div>
                    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-att"></div></div>
                    <p class="risk-details">èåˆé¶ç‚¹: è“æ–‘ç½‘ç»œå¤±è¯¯(PVT Lapses) + æ‰§è¡Œç½‘ç»œé˜»æ»(TMT)</p>
                </div>
            </div>
        </div>

        <div class="viz-box" id="viz-panel" style="display:none;">
            <h3 style="margin-top:0; color:var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom:10px;">ğŸ”¬ æ ¸å¿ƒæ•°å­—ç”Ÿç‰©æ ‡å¿—ç‰© (å¯è§†åŒ–è§£æ)</h3>
            <div class="viz-grid" id="viz-content">
                </div>
        </div>

        <div class="results-box">
            <h3 style="margin-top:0; color:var(--primary);">ğŸ“‹ åŸå§‹ç‰¹å¾æ˜ç»†ä¸æ¨¡å—å•é¡¹å¾—åˆ† (0-100)</h3>
            <div id="results-content"><p style="color:var(--slate);">è¯·å¯åŠ¨å¤šæ¨¡æ€è§£æå¼•æ“è·å–åº•å±‚æ•°æ®æ˜ç»†...</p></div>
        </div>

        <div class="btn-group">
            <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°ä¸´åºŠåˆ†ææ¡£æ¡ˆ</button>
            <button class="btn btn-export" onclick="CAS_Storage.exportJSON()">ğŸ“¥ å¯¼å‡ºåˆ†æçº§ JSON (å«é£é™©æ ‡ç­¾ä¸æ—¶åº)</button>
        </div>
    </div>

    <script>
        let importedSessionData = null;
        document.getElementById('json-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('btn-file-label').innerText = "âœ… " + file.name;
            const reader = new FileReader();
            reader.onload = function(event) {
                try { importedSessionData = JSON.parse(event.target.result); } 
                catch(err) { alert("âš ï¸ JSON æ¡£æ¡ˆè§£æå¤±è´¥ï¼è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚"); }
            };
            reader.readAsText(file);
        });

        function generateReport() {
            const mode = document.getElementById('data-source-select').value;
            let session = (mode === 'file') ? importedSessionData : CAS_Storage.getSession();
            if (!session) return alert("âš ï¸ æ— æœ‰æ•ˆæ•°æ®å¯ä¾›è§£æï¼");

            // å›å¡«åŸºçº¿ä¿¡æ¯
            if(session.demographics) {
                document.getElementById('r-id').innerText = session.demographics.subject_id || '-';
                const age = session.demographics.dob ? (new Date().getFullYear() - parseInt(session.demographics.dob.split('-')[0])) : '-';
                document.getElementById('r-bio').innerText = `${age}å² / ${session.demographics.gender || '-'}`;
            }
            document.getElementById('r-scales').innerText = `${document.getElementById('input-mmse').value||'--'} / ${document.getElementById('input-moca').value||'--'}`;

            const mods = session.modules || {};
            let htmlMap = { COG:'', EMO:'', MOT:'', SEN:'', LAN:'', LIF:'', PHY:'' };
            let chartScores = { COG: 100, EMO: 100, MOT: 100, SEN: 100, LAN: 100, LIF: 100 };
            
            // é£é™©ä¸å¯è§†åŒ–è¿½è¸ªæ± 
            let riskScores = { AD: 0, MDD: 0, PD: 0, ATT: 0 };
            let activeRiskModules = { AD: 0, MDD: 0, PD: 0, ATT: 0 }; 
            let clinicalFlags = []; 
            let vizHtml = ''; // ç”¨äºæ”¶é›†å¯è§†åŒ–å¡ç‰‡çš„ HTML

            const buildItem = (label, value, alertHtml = '', singleScore = null) => {
                let scoreBadge = '';
                if (singleScore !== null) {
                    let sColor = singleScore >= 80 ? 'var(--green)' : (singleScore >= 60 ? 'var(--amber)' : 'var(--red)');
                    let sBg = singleScore >= 80 ? '#ecfdf5' : (singleScore >= 60 ? '#fffbeb' : '#fff1f2');
                    scoreBadge = `<div class="module-score" style="color:${sColor}; background:${sBg}; border-color:${sColor}80;">${singleScore} åˆ†</div>`;
                }
                return `<div class="result-item"><div class="item-text-group"><span style="color:var(--slate); font-size:13px; font-weight:bold;">${label}</span><strong style="color:var(--primary); font-size:16px;">${value} ${alertHtml}</strong></div>${scoreBadge}</div>`;
            };
            const alertTag = (text, type='danger') => `<span class="${type==='warning'?'warning-badge':'alert-badge'}">${text}</span>`;

            // ===== è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆç¯å½¢å›¾ (Donut) HTML =====
            const createDonut = (title, percent, color, label) => `
                <div class="viz-card">
                    <div class="viz-title">${title}</div>
                    <div class="viz-donut" style="background: conic-gradient(${color} 0% ${percent}%, #e2e8f0 ${percent}% 100%);">
                        <div class="viz-donut-inner">${percent}%<span>${label}</span></div>
                    </div>
                </div>`;

            // ===== è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ¸å˜æ ‡å°º (Gauge) HTML =====
            const createGauge = (title, value, min, max, unit, invertColor = false) => {
                // è®¡ç®—æŒ‡é’ˆçš„ç™¾åˆ†æ¯”ä½ç½®
                let pct = Math.max(0, Math.min(100, ((value - min) / (max - min)) * 100));
                // å¦‚æœæ˜¯é€†å‘æŒ‡æ ‡ï¼ˆæ•°å€¼è¶Šä½è¶Šå¥½ï¼Œå¦‚CVå˜å¼‚æ€§ï¼‰ï¼Œåè½¬æ ‡å°ºæ¸å˜æ–¹å‘
                let bgGradient = invertColor ? `linear-gradient(90deg, var(--green) 0%, var(--amber) 50%, var(--red) 100%)` : `linear-gradient(90deg, var(--red) 0%, var(--amber) 50%, var(--green) 100%)`;
                return `
                <div class="viz-card" style="justify-content:center;">
                    <div class="viz-title">${title}</div>
                    <div class="viz-value-text">${value} <span style="font-size:12px;color:var(--slate);">${unit}</span></div>
                    <div class="viz-gauge-container">
                        <div class="viz-gauge-track" style="background: ${bgGradient};"></div>
                        <div class="viz-gauge-marker" style="left: calc(${pct}% - 2px);"></div>
                    </div>
                    <div class="viz-gauge-labels"><span>ä¼˜ (${min})</span><span>é«˜å± (${max})</span></div>
                </div>`;
            };

            try {
                // ================= è§£æä¸å¸¸æ¨¡æŠ˜ç®— =================
                if(mods['COG_Corsi']) {
                    const span = mods['COG_Corsi'].data.max_span;
                    const modScore = Math.min(100, Math.round((span / 7) * 100)); 
                    htmlMap.COG += buildItem('ğŸ§© Corsi ç©ºé—´æé™å¹¿åº¦:', `${span}`, '', modScore);
                    if(span < 4) { chartScores.COG -= 15; riskScores.AD += 25; clinicalFlags.push('ç©ºé—´å·¥ä½œè®°å¿†è¡°é€€'); }
                    activeRiskModules.AD += 25;
                    vizHtml += createGauge('ğŸ§© Corsi ç©ºé—´å·¥ä½œè®°å¿†å¹¿åº¦', span, 0, 7, 'ä¸ª', false);
                }
                if(mods['COG_Stroop']) {
                    const stp = mods['COG_Stroop'].data.records;
                    const stpAcc = stp.length ? Math.round((stp.filter(r=>r.correct).length/stp.length)*100) : 0;
                    htmlMap.COG += buildItem('ğŸš¥ Stroop ä¾§æŠ‘åˆ¶ç½‘ç»œ (å‡†ç¡®ç‡):', `${stpAcc}%`, '', stpAcc);
                    if(stpAcc < 80) chartScores.COG -= 10;
                    vizHtml += createDonut('ğŸš¥ Stroop ä¾§æŠ‘åˆ¶å‡†ç¡®ç‡', stpAcc, 'var(--blue)', 'ACC');
                }
                if(mods['COG_TMT_B']) {
                    const tmt = mods['COG_TMT_B'].data;
                    const modScore = Math.max(0, Math.min(100, Math.round(100 - (tmt.total_time_ms - 60000) / 1000)));
                    const alertHtml = tmt.total_time_ms > 100000 ? alertTag('æ‰§è¡Œç½‘ç»œè¿Ÿç¼“') : '';
                    htmlMap.COG += buildItem('ğŸ”— TMT-B æ‰§è¡Œä»»åŠ¡åˆ‡æ¢è€—æ—¶:', `${(tmt.total_time_ms/1000).toFixed(1)} s`, alertHtml, modScore);
                    if(tmt.total_time_ms > 100000) { chartScores.COG -= 20; riskScores.AD += 25; riskScores.ATT += 20; }
                    activeRiskModules.AD += 25; activeRiskModules.ATT += 20;
                }
                if(mods['SEN_PVT']) {
                    const lapses = mods['SEN_PVT'].data.summary.lapses;
                    const modScore = Math.max(0, 100 - lapses * 10);
                    const alertHtml = lapses > 3 ? alertTag('è“æ–‘è­¦è§‰å¤±è¯¯', 'warning') : '';
                    htmlMap.SEN += buildItem('â±ï¸ PVT è“æ–‘è­¦è§‰ Lapses:', `${lapses} æ¬¡`, alertHtml, modScore);
                    if(lapses > 3) { chartScores.SEN -= (lapses*5); riskScores.ATT += 40; clinicalFlags.push('è“æ–‘ç½‘ç»œå¤±è¯¯'); }
                    activeRiskModules.ATT += 40;
                    vizHtml += createGauge('â±ï¸ PVT æ³¨æ„åŠ›è„±èŠ‚ (Lapses)', lapses, 0, 10, 'æ¬¡', true);
                }
                if(mods['Language_VFT']) {
                    const words = mods['Language_VFT'].data.summary.total_valid_words;
                    const modScore = Math.min(100, Math.round((words / 20) * 100));
                    const alertHtml = words < 12 ? alertTag('è¯­ä¹‰æå–éšœç¢') : '';
                    htmlMap.LAN += buildItem('ğŸ—£ï¸ VFT ç±»åˆ«è¯æ±‡æµç•…æ€§:', `${words} è¯`, alertHtml, modScore);
                    if(words < 12) { chartScores.LAN -= 30; riskScores.AD += 30; }
                    activeRiskModules.AD += 30;
                }
                if(mods['Voice_Biomarkers']) {
                    const ratio = mods['Voice_Biomarkers'].data.summary.silence_ratio_percent || mods['Voice_Biomarkers'].data.summary.pause_ratio || 0;
                    const modScore = Math.max(0, 100 - Math.round(ratio * 2)); 
                    const alertHtml = ratio > 40 ? alertTag('æ‰¾è¯å›°éš¾/ç©ºæ´è¨€è¯­') : '';
                    htmlMap.LAN += buildItem('ğŸ™ï¸ VBM æ‰¾è¯ç©ºæ´/é™é»˜æ¯”:', `${ratio}%`, alertHtml, modScore);
                    if(ratio > 35) { chartScores.LAN -= 20; riskScores.MDD += 20; riskScores.AD += 15; }
                    activeRiskModules.MDD += 20; activeRiskModules.AD += 15;
                    vizHtml += createDonut('ğŸ™ï¸ è¯­éŸ³åœé¡¿ç©ºç™½æ¯” (è¿Ÿæ»)', ratio, 'var(--purple)', 'Silence');
                }
                if(mods['MOT_AFT']) {
                    const fatigue = mods['MOT_AFT'].data.summary.fatigue_index_percent;
                    const modScore = Math.max(0, 100 - Math.round(Math.max(0, fatigue) * 3));
                    const alertHtml = fatigue > 20 ? alertTag('å‰‚æœ«è¡°ç«­ä¸¥é‡') : '';
                    htmlMap.MOT += buildItem('ğŸ‘‡ AFT äº¤æ›¿æ•²å‡»å‰‚æœ«è¡°å‡:', `${fatigue}%`, alertHtml, modScore);
                    if(fatigue > 15) { chartScores.MOT -= 15; riskScores.PD += 40; clinicalFlags.push('åŸºåº•èŠ‚è¡°ç«­'); }
                    activeRiskModules.PD += 40;
                    vizHtml += createGauge('ğŸ‘‡ AFT è¿åŠ¨ç–²åŠ³è¡°å‡æŒ‡æ•°', fatigue, 0, 30, '%', true);
                }
                if(mods['MOT_Keystroke']) {
                    const cv = mods['MOT_Keystroke'].data.summary.dwell_cv;
                    const modScore = Math.max(0, 100 - Math.round(Math.max(0, cv - 10) * 4));
                    const alertHtml = cv > 25 ? alertTag('Dwellå˜å¼‚(è‚Œå¼ºç›´)') : '';
                    htmlMap.MOT += buildItem('âŒ¨ï¸ æŒ‰é”®æ»ç•™æ—¶é—´è‚Œå¼ºç›´ CV:', `${cv}%`, alertHtml, modScore);
                    if(cv > 20) { chartScores.MOT -= 15; riskScores.PD += 35; }
                    activeRiskModules.PD += 35;
                }
                if(mods['MOT_DualTaskGait']) {
                    const gaitCV = mods['MOT_DualTaskGait'].data.summary.stride_time_cv_percent || mods['MOT_DualTaskGait'].data.summary.variability_cv || 0;
                    const modScore = Math.max(0, 100 - Math.round(Math.max(0, gaitCV - 2) * 15));
                    const alertHtml = gaitCV > 5.0 ? alertTag('é«˜å±è·Œå€’æ­¥é¢‘') : '';
                    htmlMap.MOT += buildItem('ğŸš¶â€â™‚ï¸ IMU åŒé‡ä»»åŠ¡æ­¥æ€å˜å¼‚:', `${gaitCV}%`, alertHtml, modScore);
                    if(gaitCV > 4.0) { chartScores.MOT -= 20; riskScores.PD += 25; }
                    activeRiskModules.PD += 25;
                    vizHtml += createGauge('ğŸš¶â€â™‚ï¸ æ­¥æ€ç¨³å®šæ€§ (å˜å¼‚ç³»æ•°CV)', gaitCV, 0, 10, '%', true);
                }
                if(mods['MOT_dCDT']) {
                    const inair = mods['MOT_dCDT'].data.summary.in_air_sec;
                    const modScore = Math.max(0, 100 - Math.round(Math.max(0, inair - 1) * 15));
                    const alertHtml = inair > 6.0 ? alertTag('ç©ºä¸­æ€ç»´æ‚¬åœè¿‡é•¿', 'warning') : '';
                    htmlMap.MOT += buildItem('âœï¸ dCDT ç”»é’Ÿç©ºä¸­æ‚¬åœæ—¶é—´:', `${inair} s`, alertHtml, modScore);
                    if(inair > 5.0) { chartScores.MOT -= 15; riskScores.AD += 20; }
                    activeRiskModules.AD += 20;
                }
                if(mods['PHY_Face_rPPG']) {
                    const rmssd = mods['PHY_Face_rPPG'].data.summary.estimated_rmssd_ms || 0;
                    const hr = mods['PHY_Face_rPPG'].data.summary.estimated_hr_bpm || '-';
                    const modScore = Math.min(100, Math.round((rmssd / 40) * 100)); 
                    const alertHtml = (rmssd < 20 && rmssd > 0) ? alertTag('è¿·èµ°å¼ åŠ›æŠ‘åˆ¶') : '';
                    htmlMap.PHY += buildItem('ğŸ¥ rPPG æ‹Ÿåˆå¿ƒç‡/RMSSD:', `${hr} bpm / ${rmssd} ms`, alertHtml, modScore);
                    if(rmssd < 20 && rmssd > 0) { chartScores.PHY -= 20; riskScores.MDD += 25; }
                    activeRiskModules.MDD += 25;
                    vizHtml += createGauge('ğŸ¥ rPPG è¿·èµ°å¼ åŠ› (RMSSD)', rmssd, 0, 60, 'ms', false); // RMSSDè¶Šé«˜è¶Šå¥½ï¼Œä¸åè½¬
                }
                if(mods['LIF_Lifestyle']) {
                    const lif = mods['LIF_Lifestyle'].data.summary.avg_decision_hesitation_ms;
                    const modScore = Math.max(0, 100 - Math.round(Math.max(0, lif - 2000) / 80));
                    htmlMap.LIF += buildItem('ğŸ¥— LIF æ—¥å¸¸åŠŸèƒ½å†³ç­–è¿Ÿç–‘:', `${lif} ms`, '', modScore);
                    if(lif > 5000) { chartScores.LIF -= 15; riskScores.AD += 15; }
                    activeRiskModules.AD += 15;
                }
            } catch(e) { console.error(e); }

            // ================= æ¸²æŸ“å¯è§†åŒ–é¢æ¿ =================
            if (vizHtml !== '') {
                document.getElementById('viz-panel').style.display = 'block';
                document.getElementById('viz-content').innerHTML = vizHtml;
            }

            // ================= æ¸²æŸ“æ˜ç»†åº“ =================
            let out = '';
            for(let key of ['COG','MOT','EMO','SEN','LAN','LIF','PHY']) {
                if(htmlMap[key]) {
                    let mapName = {COG:'ğŸ§  è®¤çŸ¥æ‰§è¡Œ', MOT:'ğŸ¯ è¿åŠ¨åŠ¨åŠ›å­¦', EMO:'â¤ï¸ æƒ…ç»ªç¤¾ä¼š', SEN:'âš¡ æ„Ÿè§‰çŸ¥è§‰', LAN:'ğŸ’¬ è¯­è¨€å£°å­¦', LIF:'ğŸŒ™ ç”Ÿæ´»èŠ‚å¾‹', PHY:'ğŸ¥ ç”Ÿç†è¡€æµ'};
                    out += `<div class="domain-section"><div class="domain-title">${mapName[key]}</div>${htmlMap[key]}</div>`;
                }
            }
            document.getElementById('results-content').innerHTML = out || '<p style="color:var(--slate);">æœªè¯»å–åˆ°æœ‰æ•ˆæ•°æ®ã€‚</p>';

            // æ¸²æŸ“åŸºå¸¦é›·è¾¾æ¡
            setTimeout(() => { 
                for(let key in chartScores) {
                    let score = Math.max(0, Math.round(chartScores[key]));
                    if(!htmlMap[key]) score = 0; 
                    document.getElementById(`bar-${key.toLowerCase()}`).style.width = score + '%';
                    document.getElementById(`val-${key.toLowerCase()}`).innerText = score;
                }
            }, 300);

            // ================= æ¸²æŸ“è®¡ç®—ç²¾ç¥ç—…å­¦é£é™© =================
            document.getElementById('risk-panel').style.display = 'block';
            const setRiskBar = (id, score, maxPotential) => {
                let pct = maxPotential > 0 ? Math.min(100, Math.round((score / maxPotential) * 100)) : 0;
                let bar = document.getElementById(`risk-bar-${id}`);
                bar.style.width = pct + '%';
                bar.className = 'risk-bar-fill ' + (pct < 30 ? 'risk-low' : (pct < 60 ? 'risk-med' : 'risk-high'));
                document.getElementById(`risk-val-${id}`).innerText = maxPotential > 0 ? `${pct}%` : 'æœªæµ‹é¶å‘';
                document.getElementById(`risk-val-${id}`).style.color = (pct >= 60) ? 'var(--red)' : '';
                return pct;
            };

            const finalRisks = {
                AD: setRiskBar('ad', riskScores.AD, activeRiskModules.AD),
                MDD: setRiskBar('mdd', riskScores.MDD, activeRiskModules.MDD),
                PD: setRiskBar('pd', riskScores.PD, activeRiskModules.PD),
                ATT: setRiskBar('att', riskScores.ATT, activeRiskModules.ATT)
            };

            // ä¿å­˜åº•å±‚æ•°æ®
            if (mode !== 'file') CAS_Storage.saveRiskProfile(finalRisks, clinicalFlags);
            else {
                session.computational_risk_profile = { generated_at: new Date().toISOString(), risk_scores: finalRisks, clinical_flags: clinicalFlags };
                window.temporarySessionExport = function() {
                    const a = document.createElement('a');
                    a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(session, null, 2));
                    a.download = `CAS_Data_${session.demographics.subject_id||'Sub'}_${new Date().getTime()}.json`;
                    a.click();
                };
                document.querySelector('.btn-export').setAttribute('onclick', 'window.temporarySessionExport()');
            }
            
            document.querySelector('.viz-box').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
