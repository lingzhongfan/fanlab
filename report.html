<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAS ä¸´åºŠæ•°å­—è¡¨å‹æ•°æ®ä¸­å¿ƒ</title>
    <style>
        :root { --primary: #0f172a; --success: #10b981; --danger: #f43f5e; --blue: #3b82f6; --bg: #f8fafc; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 20px; color: #334155; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); border-top: 6px solid var(--success); }
        
        .header-area { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; }
        .header-area h2 { color: var(--primary); margin: 0 0 5px 0; font-size: 28px; }
        .session-badge { background: var(--success); color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; font-size: 15px; box-shadow: 0 4px 10px rgba(16,185,129,0.3); }
        
        .demographics-panel { background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 16px; padding: 25px; margin-bottom: 35px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; }
        .demo-item { display: flex; flex-direction: column; }
        .demo-label { font-size: 12.5px; color: #64748b; margin-bottom: 6px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .demo-value { font-size: 17px; color: #0f172a; font-weight: bold; font-family: monospace; }
        
        .progress-wrapper { margin-bottom: 35px; }
        .progress-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; font-size: 16px; color: var(--primary); }
        .progress-bar { width: 100%; height: 14px; background: #e2e8f0; border-radius: 7px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        .domain-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 45px; }
        .domain-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px; padding: 22px; transition: 0.2s; } .domain-card:hover { border-color: #cbd5e1; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .domain-title { font-size: 18px; font-weight: bold; color: var(--primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px; }
        .module-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #cbd5e1; font-size: 14.5px; } .module-item:last-child { border-bottom: none; padding-bottom: 0; }
        .module-name { color: #475569; font-weight: 500; }
        .status-badge { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: bold; padding: 5px 10px; border-radius: 8px; }
        .status-done { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; } .status-pending { background: #ffe4e6; color: #9f1239; border: 1px solid #fecdd3; }
        .time-stamp { font-family: monospace; font-size: 12px; opacity: 0.8; margin-left: 6px; }

        .action-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .btn { padding: 20px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; color: white; transition: all 0.2s; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); } .btn:active { transform: translateY(0); }
        .btn-export { background: var(--success); grid-column: 1 / -1; font-size: 19px; } .btn-preview { background: #64748b; } .btn-nav { background: var(--blue); } .btn-danger { background: var(--danger); }

        .preview-box { display: none; flex-direction: column; background: #1e293b; padding: 25px; border-radius: 16px; margin-top: 25px; animation: slideDown 0.3s ease-out; }
        .preview-box textarea { width: 100%; height: 450px; background: #0f172a; color: #10b981; border: 1px solid #334155; border-radius: 12px; padding: 18px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; outline: none; box-sizing: border-box; line-height: 1.6; }
        .copy-action-btn { align-self: flex-end; margin-top: 15px; background: var(--blue); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; } .copy-action-btn:hover { background: #2563eb; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div class="container">
        <div class="header-area">
            <div><h2>ğŸ”¬ CAS ä¸´åºŠæ•°æ®æ•´åˆé¢æ¿</h2><span style="color: #64748b; font-size: 15px;">å…¨ç»´åº¦ç¥ç»å¿ƒç†å­¦ç‰¹å¾èšåˆä¸­å¿ƒ</span></div>
            <div class="session-badge" id="session-status">çŠ¶æ€: é‡‡é›†ä¸­...</div>
        </div>

        <div class="demographics-panel" id="demo-panel">
            <div class="demo-item"><span class="demo-label">å—è¯•è€… ID</span><span class="demo-value" id="info-id">-</span></div>
            <div class="demo-item"><span class="demo-label">å§“åç¼©å†™</span><span class="demo-value" id="info-name">-</span></div>
            <div class="demo-item"><span class="demo-label">å‡ºç”Ÿæ—¥æœŸ</span><span class="demo-value" id="info-dob">-</span></div>
            <div class="demo-item"><span class="demo-label">æ€§åˆ«</span><span class="demo-value" id="info-gender">-</span></div>
            <div class="demo-item"><span class="demo-label">åˆ©æ‰‹</span><span class="demo-value" id="info-hand">-</span></div>
            <div class="demo-item"><span class="demo-label">æ•™è‚²å¹´é™</span><span class="demo-value" id="info-edu">-</span></div>
        </div>
        
        <div class="progress-wrapper">
            <div class="progress-header"><span>æµ‹è¯•æ€»è¿›åº¦ (Progress)</span><span id="progress-text" style="color: var(--success);">0 / 22 (0%)</span></div>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        </div>

        <div class="domain-grid" id="domain-board"></div>

        <div class="action-group">
            <button class="btn btn-export" onclick="CAS_Storage.exportJSON()">ğŸ“¥ ä¸€é”®æå–é«˜ç»´ JSON æ¨¡å‹ç‰¹å¾åŒ…</button>
            <button class="btn btn-preview" onclick="togglePreview()">ğŸ‘€ å±•å¼€/æŠ˜å åå° JSON æºç é¢æ¿</button>
            <a href="index.html" class="btn btn-nav">â† è¿”å›ä¸»é¢æ¿è¡¥å…¨æµ‹è¯•</a>
            <button class="btn btn-danger" onclick="CAS_Storage.clearSession()">âš ï¸ æ¸…é™¤ç¼“å­˜å¹¶ç»“æŸè¯¥å—è¯•è€…ä¼šè¯</button>
        </div>

        <div class="preview-box" id="preview-container">
            <textarea id="json-output-text" readonly spellcheck="false"></textarea>
            <button class="copy-action-btn" id="copy-btn" onclick="copyJSON()">ğŸ“‹ å¤åˆ¶å…¨éƒ¨ JSON è‡³å‰ªè´´æ¿</button>
        </div>
    </div>

    <script>
        // å®šä¹‰åŒ…å«é¢†åŸŸçš„å®Œæ•´ 22 é¡¹æ¶æ„ (æ–°å¢äº†è¯­è¨€å’Œç”Ÿæ´»åŸŸçš„ 3 ä¸ªé‡è¦æµ‹è¯•)
        const domains = [
            { name: 'ğŸ§  è®¤çŸ¥åŸŸ (Cognition)', modules: [ { id: 'Cognition_Corsi', name: 'ç©ºé—´è®°å¿† (Corsi)' }, { id: 'Cognition_Stroop', name: 'æ‰§è¡ŒæŠ‘åˆ¶ (Stroop)' }, { id: 'Cognition_TMT_B', name: 'è®¤çŸ¥æŸ”æ€§ (TMT-B)' }, { id: 'Cognition_DSST', name: 'å¤„ç†é€Ÿåº¦ (DSST)' } ] },
            { name: 'â¤ï¸ æƒ…æ„Ÿä¸å†³ç­– (Emotion)', modules: [ { id: 'Emotion_State_EMA', name: 'çŠ¶æ€è‡ªè¯„ (EMA)' }, { id: 'Emotion_Trait_Big5', name: 'äººæ ¼ç‰¹è´¨ (Big5)' }, { id: 'Emotion_Risk_BART', name: 'é£é™©å†³ç­– (BART)' }, { id: 'Emotion_Affective_Stroop', name: 'æƒ…ç»ªæ³¨æ„ (E-Stroop)' } ] },
            { name: 'ğŸ¯ è¿åŠ¨ä¸å…±æµ (Motor)', modules: [ { id: 'Motor_SimpleTapping', name: 'å•æŒ‡æ•²å‡» (Tapping)' }, { id: 'Motor_Fitts', name: 'é¶å‘è¿åŠ¨ (Fitts)' }, { id: 'Motor_Spiral_Tracing', name: 'éœ‡é¢¤åˆ†æ (Spiral)' } ] },
            { name: 'âš¡ æ„Ÿè§‰ä¸çŸ¥è§‰ (Sensation)', modules: [ { id: 'Sensation_SimpleRT', name: 'ç®€å•ååº” (SRT)' }, { id: 'Sensation_ChoiceRT', name: 'å†³ç­–ååº” (CRT)' }, { id: 'Sensation_GoNoGo', name: 'æ„Ÿè§‰æŠ‘åˆ¶ (Go/No-Go)' }, { id: 'Sensation_VisualSearch', name: 'è§†è§‰æœç´¢ (V-Search)' } ] },
            { name: 'ğŸ’¬ è¯­è¨€åŠŸèƒ½ (Language)', modules: [ { id: 'Language_VFT', name: 'è¯æ±‡æµç•…æ€§ (VFT)' }, { id: 'Language_Naming', name: 'å›¾ç‰‡å‘½å (Naming)' }, { id: 'Language_Semantic', name: 'è¯­ä¹‰å…³è” (Semantic)' } ] },
            { name: 'ğŸŒ™ ä¸»è§‚ä¸ç”Ÿæ´» (Lifestyle)', modules: [ { id: 'Lifestyle_SCD', name: 'ä¸»è§‚è®¤çŸ¥ä¸‹é™ (SCD)' }, { id: 'Lifestyle_Sleep', name: 'ç¡çœ ä¸èŠ‚å¾‹ (Sleep)' }, { id: 'Lifestyle_IADL', name: 'æ—¥å¸¸èƒ½åŠ›é‰´åˆ« (IADL)' }, { id: 'Lifestyle_PHQ2', name: 'æŠ‘éƒé‰´åˆ«ç­›æŸ¥ (PHQ2)' } ] }
        ];

        window.onload = function() {
            const session = CAS_Storage.getSession();
            
            // å¡«å……äººå£å­¦æ•°æ®
            if(session.demographics && Object.keys(session.demographics).length > 0) {
                document.getElementById('info-id').innerText = session.demographics.subject_id || '-'; 
                document.getElementById('info-name').innerText = session.demographics.name || '-'; 
                document.getElementById('info-dob').innerText = session.demographics.dob || '-';
                
                let gStr = '-'; 
                if(session.demographics.gender==='Male') gStr='ç”· (Male)'; else if(session.demographics.gender==='Female') gStr='å¥³ (Female)'; else if(session.demographics.gender==='Other') gStr='å…¶ä»–'; 
                document.getElementById('info-gender').innerText = gStr;
                
                let hStr = '-'; 
                if(session.demographics.handedness==='Right') hStr='å³æ‰‹'; else if(session.demographics.handedness==='Left') hStr='å·¦æ‰‹'; else if(session.demographics.handedness==='Ambidextrous') hStr='åŒåˆ©æ‰‹'; 
                document.getElementById('info-hand').innerText = hStr;
                
                document.getElementById('info-edu').innerText = session.demographics.education_years ? session.demographics.education_years + ' å¹´' : 'æœªå½•å…¥';
            } else { 
                document.getElementById('info-id').innerText = session.session_id || 'æœªå»ºæ¡£'; 
            }

            // åŠ¨æ€æ„å»ºçœ‹æ¿è§†å›¾ä¸è¿›åº¦
            const board = document.getElementById('domain-board'); 
            let total = 0, completed = 0;
            
            domains.forEach(d => {
                let html = `<div class="domain-card"><h3 class="domain-title">${d.name}</h3>`;
                d.modules.forEach(m => {
                    total++; 
                    const data = session.modules ? session.modules[m.id] : null; 
                    const isDone = !!data; 
                    if (isDone) completed++;
                    
                    // è§£æå®Œæˆæ—¶é—´
                    let tStr = ""; 
                    if (isDone && data.completed_at) { 
                        const dt = new Date(data.completed_at); 
                        tStr = `<span class="time-stamp">${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}:${dt.getSeconds().toString().padStart(2,'0')}</span>`; 
                    }
                    
                    const badge = isDone ? `<div class="status-badge status-done">âœ“ å·²é‡‡å½• ${tStr}</div>` : `<div class="status-badge status-pending">â—‹ å¾…å®Œæˆ</div>`;
                    html += `<div class="module-item"><span class="module-name">${m.name}</span>${badge}</div>`;
                }); 
                html += `</div>`; 
                board.innerHTML += html;
            });

            // æ›´æ–°æ€»è¿›åº¦æ¡ (åŸºäº22é¡¹)
            const pct = Math.round((completed / total) * 100) || 0;
            document.getElementById('progress-text').innerText = `${completed} / ${total} (${pct}%)`; 
            document.getElementById('progress-fill').style.width = `${pct}%`;
            
            // é€šå…³æ•ˆæœ
            if (completed === total && total > 0) {
                document.getElementById('progress-fill').style.background = "linear-gradient(90deg, #10b981, #34d399)"; 
                document.getElementById('progress-fill').style.boxShadow = "0 0 15px rgba(52, 211, 153, 0.6)";
                document.getElementById('session-status').innerText = "âœ“ æµ‹è¯•å·²å…¨éƒ¨é€šå…³"; 
                document.getElementById('session-status').style.background = "#059669";
            }
        };

        function togglePreview() {
            const c = document.getElementById('preview-container');
            if (c.style.display === 'flex') { 
                c.style.display = 'none'; 
            } else {
                const session = CAS_Storage.getSession(); 
                session.end_time = new Date().toISOString();
                document.getElementById('json-output-text').value = JSON.stringify(session, null, 2);
                c.style.display = 'flex'; 
                c.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }
        
        function copyJSON() {
            const t = document.getElementById('json-output-text'), b = document.getElementById('copy-btn');
            t.select(); 
            t.setSelectionRange(0, 999999);
            navigator.clipboard.writeText(t.value).then(() => { 
                b.innerText = "âœ“ æˆåŠŸå¤åˆ¶è‡³å‰ªè´´æ¿ï¼"; 
                b.style.background = "#10b981"; 
                setTimeout(() => { 
                    b.innerText = "ğŸ“‹ å¤åˆ¶å…¨éƒ¨ JSON è‡³å‰ªè´´æ¿"; 
                    b.style.background = "#3b82f6"; 
                }, 2500); 
            }).catch(err => { 
                alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·å°è¯•åœ¨ä»£ç æ¡†å†…æ‰‹åŠ¨å…¨é€‰å¤åˆ¶ã€‚"); 
            });
        }
    </script>
</body>
</html>
