<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>NeuroMap-4.0 - ç¥ç»è¡Œä¸ºå¤šæ¨¡æ€è¯„ä¼°å›¾è°±</title>
    <style>
        :root { --primary: #0f172a; --slate: #64748b; --cog: #4f46e5; --emo: #e11d48; --mot: #f59e0b; --lan: #9333ea; --lif: #10b981; --phy: #06b6d4; }
        body { font-family: -apple-system, sans-serif; background: #f8fafc; padding: 30px; color: var(--primary); line-height: 1.6; }
        .container { max-width: 1050px; margin: auto; background: white; padding: 50px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        .report-header { border-bottom: 4px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end;}
        .report-header h2 { margin: 0; font-size: 28px; }
        
        .info-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 40px; background: #f1f5f9; padding: 20px; border-radius: 12px; }
        .info-item span { display: block; font-size: 12px; color: var(--slate); font-weight: bold; text-transform: uppercase;}
        .info-item strong { font-size: 16px; color: var(--primary); font-family: monospace;}

        /* é«˜ç»´é›·è¾¾æŸ±çŠ¶å›¾ */
        .chart-box { background: white; border: 2px solid #e2e8f0; padding: 30px; border-radius: 20px; margin-bottom: 40px; }
        .bar-row { display: flex; align-items: center; margin-bottom: 15px; }
        .bar-label { width: 150px; font-weight: bold; font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .bar-track { flex: 1; height: 24px; background: #f1f5f9; border-radius: 12px; position: relative; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);}
        .bar-fill { height: 100%; border-radius: 12px; width: 0%; transition: width 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .bar-value { width: 60px; text-align: right; font-weight: bold; font-size: 18px; font-family: monospace;}
        
        /* æ¨¡å—è§£æä½“ */
        .domain-block { margin-bottom: 30px; border: 1px solid #e2e8f0; border-radius: 16px; overflow: hidden;}
        .domain-title { font-size: 18px; font-weight: bold; color: white; padding: 12px 20px; display: flex; align-items: center; gap: 10px;}
        .domain-content { padding: 20px; background: #fcfcfd;}
        .result-item { font-size: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; padding: 10px 15px; background: white; border-radius: 10px; border: 1px solid #f1f5f9; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}
        .result-item strong { font-family: monospace; font-size: 17px; display: flex; align-items: center; gap: 10px;}
        
        .alert-badge { color: white; background: var(--emo); font-size: 12px; padding: 4px 10px; border-radius: 12px; font-weight: bold; letter-spacing: 0.5px;}
        .warning-badge { color: white; background: var(--mot); font-size: 12px; padding: 4px 10px; border-radius: 12px; font-weight: bold;}

        .btn-export { width: 100%; padding: 25px; border: none; border-radius: 16px; background: var(--primary); color: white; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.3); transition: 0.2s;}
        .btn-export:hover { background: black; transform: translateY(-3px); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--slate); font-weight:bold; cursor:pointer; font-size: 16px; margin-bottom: 20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="report-header">
            <div>
                <h2>CAS 4.0 ä¸´åºŠè®¡ç®—è¡¨å‹å…¨æ™¯å›¾è°±</h2>
                <div style="color:var(--slate); margin-top:5px;">å…¨ç»´åº¦åŠ¨åŠ›å­¦ã€å£°å­¦ã€å½±åƒè¡€æµåŠè®¤çŸ¥æ‰§è¡Œè”åˆåˆ†æ</div>
            </div>
            <div style="text-align:right;">
                <div style="font-family:monospace; font-size:12px; color:var(--slate);">SYSTEM BUILD: V4.0.0 (Clinical Grade)</div>
                <div style="font-family:monospace; font-size:12px; color:var(--slate);" id="report-time"></div>
            </div>
        </div>
        
        <div class="info-grid" id="info-panel">
            <div class="info-item"><span>Subject ID</span><strong id="r-id">--</strong></div>
            <div class="info-item"><span>Sex / Age</span><strong id="r-bio">--</strong></div>
            <div class="info-item"><span>Hardware Config</span><strong id="r-device">--</strong></div>
            <div class="info-item"><span>EMA Fatigue Max</span><strong id="r-fatigue">0</strong></div>
        </div>

        <div class="chart-box">
            <div class="bar-row"><div class="bar-label" style="color:var(--cog);">ğŸ§  è®¤çŸ¥æ‰§è¡Œ (COG)</div><div class="bar-track"><div class="bar-fill" style="background:var(--cog);" id="bar-cog"></div></div><div class="bar-value" style="color:var(--cog);" id="val-cog">0</div></div>
            <div class="bar-row"><div class="bar-label" style="color:var(--lan);">ğŸ—£ï¸ è¨€è¯­è¯­è¨€ (LAN)</div><div class="bar-track"><div class="bar-fill" style="background:var(--lan);" id="bar-lan"></div></div><div class="bar-value" style="color:var(--lan);" id="val-lan">0</div></div>
            <div class="bar-row"><div class="bar-label" style="color:var(--mot);">ğŸ¯ åŠ¨åŠ›å­¦ç½‘ç»œ (MOT)</div><div class="bar-track"><div class="bar-fill" style="background:var(--mot);" id="bar-mot"></div></div><div class="bar-value" style="color:var(--mot);" id="val-mot">0</div></div>
            <div class="bar-row"><div class="bar-label" style="color:var(--emo);">ğŸ­ æƒ…æ„Ÿè°ƒèŠ‚ (EMO)</div><div class="bar-track"><div class="bar-fill" style="background:var(--emo);" id="bar-emo"></div></div><div class="bar-value" style="color:var(--emo);" id="val-emo">0</div></div>
            <div class="bar-row"><div class="bar-label" style="color:var(--phy);">ğŸ¥ ç”Ÿç†ä¼ æ„Ÿ (PHY)</div><div class="bar-track"><div class="bar-fill" style="background:var(--phy);" id="bar-phy"></div></div><div class="bar-value" style="color:var(--phy);" id="val-phy">0</div></div>
            <div class="bar-row"><div class="bar-label" style="color:var(--lif);">ğŸ¥— åŠŸèƒ½èŠ‚å¾‹ (LIF)</div><div class="bar-track"><div class="bar-fill" style="background:var(--lif);" id="bar-lif"></div></div><div class="bar-value" style="color:var(--lif);" id="val-lif">0</div></div>
        </div>

        <div id="results-content">
            <div style="text-align:center; padding: 50px; color:var(--slate);">è§£æå¼•æ“è®¡ç®—ä¸­...</div>
        </div>

        <button class="btn-export" onclick="CAS_Storage.exportJSON()">ğŸ“¥ å¯¼å‡ºå®Œæ•´çš„ BIDS-JSON æ ¼å¼ç‰¹å¾å¤§åŒ…</button>
    </div>

    <script>
        window.onload = function() {
            document.getElementById('report-time').innerText = new Date().toLocaleString();
            
            const session = CAS_Storage.getSession();
            const mods = session.modules || {};
            
            // åŸºç¡€ä¿¡æ¯è§£æ
            if(session.demographics && session.demographics.subject_id) {
                document.getElementById('r-id').innerText = session.demographics.subject_id;
                let age = new Date().getFullYear() - parseInt(session.demographics.dob.split('-')[0]) || '--';
                document.getElementById('r-bio').innerText = `${session.demographics.gender} / ${age}`;
            }
            if(session.hardware_metadata) {
                let ua = session.hardware_metadata.user_agent;
                document.getElementById('r-device').innerText = ua.includes('iPad') ? 'iPadOS' : (ua.includes('Android') ? 'Android' : 'Desktop');
            }
            if(session.ema_fatigue_logs && session.ema_fatigue_logs.length > 0) {
                let maxFatigue = Math.max(...session.ema_fatigue_logs.map(log => log.fatigue_score));
                document.getElementById('r-fatigue').innerText = maxFatigue;
                if(maxFatigue > 70) document.getElementById('r-fatigue').style.color = 'var(--emo)';
            }

            // åˆå§‹åŒ–ç»´åº¦å¾—åˆ† (åŸºç¡€æ»¡åˆ†100ï¼Œæ ¹æ®ä¸´åºŠç¡¬æŒ‡æ ‡å¼‚å¸¸è¿›è¡Œæƒ©ç½šæ‰£åˆ†)
            let scores = { COG: 100, LAN: 100, MOT: 100, EMO: 100, PHY: 100, LIF: 100 };
            let htmlMap = { COG: '', LAN: '', MOT: '', EMO: '', PHY: '', LIF: '' };

            const buildItem = (label, value, alertHtml = '') => `<div class="result-item"><span>${label}</span><strong>${value} ${alertHtml}</strong></div>`;
            const alertTag = (text, type='danger') => `<span class="${type==='warning'?'warning-badge':'alert-badge'}">${text}</span>`;

            try {
                // ================= 1. è®¤çŸ¥ä¸æ„ŸçŸ¥ (COG + SEN_PVT/TimeRep) =================
                if(mods['COG_Corsi']) {
                    const span = mods['COG_Corsi'].data.max_span;
                    htmlMap.COG += buildItem('ğŸ§© Corsi è§†ç©ºé—´å·¥ä½œè®°å¿†å®¹é‡:', `${span} è·¨åº¦`);
                    if(span < 4) scores.COG -= 10;
                }
                if(mods['COG_DSST']) {
                    const count = mods['COG_DSST'].data.correct_count;
                    htmlMap.COG += buildItem('ğŸ”¢ DSST é™æ—¶åŠ å·¥é€Ÿåº¦ (90så®Œæˆæ•°):', `${count} ä¸ª`);
                    if(count < 25) scores.COG -= 15;
                }
                if(mods['COG_Pattern']) {
                    const pCount = mods['COG_Pattern'].data.correct_count;
                    htmlMap.COG += buildItem('âš¡ Pattern æ¨¡å¼æ¯”å¯¹åŠ å·¥ (90så®Œæˆæ•°):', `${pCount} ä¸ª`);
                }
                if(mods['COG_Stroop']) {
                    const stp = mods['COG_Stroop'].data.records;
                    const stpAcc = stp.length ? Math.round((stp.filter(r=>r.correct).length/stp.length)*100) : 0;
                    htmlMap.COG += buildItem('ğŸš¥ Stroop ä¾§æŠ‘åˆ¶ç½‘ç»œ (å‡†ç¡®ç‡):', `${stpAcc}%`);
                    if(stpAcc < 80) scores.COG -= 10;
                }
                if(mods['COG_TMT_B']) {
                    const tmt = mods['COG_TMT_B'].data;
                    const sec = (tmt.total_time_ms/1000).toFixed(1);
                    const alert = tmt.total_time_ms > 120000 ? alertTag('æ‰§è¡Œç½‘ç»œæåº¦è¿Ÿç¼“') : '';
                    htmlMap.COG += buildItem('ğŸ”— TMT-B æ‰§è¡ŒåŠŸèƒ½åˆ‡æ¢ (25èŠ‚ç‚¹è€—æ—¶/é”™è¯¯):', `${sec}s / ${tmt.errors}æ¬¡`, alert);
                    if(tmt.total_time_ms > 100000) scores.COG -= 20;
                }
                if(mods['SEN_PVT']) {
                    const pvt = mods['SEN_PVT'].data.summary;
                    const alert = pvt.lapses > 3 ? alertTag('è“æ–‘è­¦è§‰å¤±è¯¯', 'warning') : '';
                    htmlMap.COG += buildItem('â±ï¸ PVT æŒç»­è­¦è§‰ç½‘ç»œ (Lapses >500ms):', `${pvt.lapses} æ¬¡`, alert);
                    scores.COG -= (pvt.lapses * 5);
                }
                if(mods['SEN_TimeRep']) {
                    const tr = mods['SEN_TimeRep'].data.summary;
                    htmlMap.COG += buildItem('â³ TimeRep å†…éƒ¨æ—¶é—´çŸ¥è§‰ (3ç§’ç»å¯¹è¯¯å·®):', `${tr.mean_absolute_error_ms} ms`);
                }

                // ================= 2. è¯­è¨€ (LAN) =================
                if(mods['Language_VFT']) {
                    const vft = mods['Language_VFT'].data.summary;
                    const alert = vft.total_valid_words < 12 ? alertTag('è¯­ä¹‰æå–éšœç¢') : '';
                    htmlMap.LAN += buildItem('ğŸ—£ï¸ VFT åŠ¨ç‰©æµç•…æ€§ (60sè¯æ±‡ / å‡è¯é—´é—´éš”):', `${vft.total_valid_words} ä¸ª / ${vft.avg_inter_word_interval_ms}ms`, alert);
                    if(vft.total_valid_words < 15) scores.LAN -= (15 - vft.total_valid_words) * 3;
                }
                if(mods['Voice_Biomarkers']) {
                    const vbm = mods['Voice_Biomarkers'].data.summary;
                    const alert = vbm.silence_ratio_percent > 40 ? alertTag('æ‰¾è¯å›°éš¾/ç©ºæ´è¨€è¯­') : '';
                    htmlMap.LAN += buildItem('ğŸ™ï¸ VBM å£°å­¦ç‰¹å¾ (æ³¢å£«é¡¿å·é¥¼å›¾é™é»˜æ¯”):', `${vbm.silence_ratio_percent}%`, alert);
                    if(vbm.silence_ratio_percent > 30) scores.LAN -= (vbm.silence_ratio_percent - 30);
                }

                // ================= 3. åŠ¨åŠ›å­¦ä¸è¿åŠ¨ (MOT) =================
                if(mods['MOT_AFT']) {
                    const aft = mods['MOT_AFT'].data.summary;
                    const alert = aft.fatigue_index_percent > 20 ? alertTag('å‰‚æœ«è¡°ç«­ä¸¥é‡') : '';
                    htmlMap.MOT += buildItem('ğŸ‘‡ AFT äº¤æ›¿æŒ‡æ•²å‡» (èŠ‚å¾‹CV / ç–²åŠ³æŒ‡æ•°):', `${aft.iti_cv_percent}% / ${aft.fatigue_index_percent}%`, alert);
                    if(aft.fatigue_index_percent > 15) scores.MOT -= 15;
                }
                if(mods['MOT_SRT']) {
                    const srt = mods['MOT_SRT'].data.summary;
                    htmlMap.MOT += buildItem('âš¡ SRT ç®€å•è¿åŠ¨èµ·åŠ¨ååº”æ—¶:', `${srt.mean_rt_ms} ms`);
                }
                if(mods['MOT_Keystroke']) {
                    const key = mods['MOT_Keystroke'].data.summary;
                    const alert = key.dwell_cv > 25 ? alertTag('Dwellå˜å¼‚æ¿€å¢(è‚Œå¼ºç›´)') : '';
                    htmlMap.MOT += buildItem('âŒ¨ï¸ æŒ‰é”®å¾®è§‚åŠ¨åŠ›å­¦ (é•¿æ–‡æœ¬å‡Dwell / CV):', `${key.avg_dwell_ms}ms / ${key.dwell_cv}%`, alert);
                    if(key.dwell_cv > 20) scores.MOT -= (key.dwell_cv - 20) * 1.5;
                }
                if(mods['MOT_DualTaskGait']) {
                    const gait = mods['MOT_DualTaskGait'].data.summary;
                    const alert = gait.stride_time_cv_percent > 5.0 ? alertTag('é«˜å±è·Œå€’/æ­¥é¢‘å¤±çµ') : '';
                    htmlMap.MOT += buildItem('ğŸš¶â€â™‚ï¸ IMU åŒé‡ä»»åŠ¡æ­¥æ€ (å‡7å¹²æ‰°ä¸‹æ­¥æ—¶ CV):', `${gait.stride_time_cv_percent}%`, alert);
                    if(gait.stride_time_cv_percent > 4.0) scores.MOT -= (gait.stride_time_cv_percent - 4.0) * 5;
                }
                if(mods['MOT_dCDT']) {
                    const dcdt = mods['MOT_dCDT'].data.summary;
                    const alert = dcdt.in_air_sec > 6.0 ? alertTag('ç©ºä¸­æ€ç»´æ‚¬åœè¿‡é•¿', 'warning') : '';
                    htmlMap.MOT += buildItem('âœï¸ dCDT ç”»é’Ÿæ—¶ç©ºç‰¹å¾ (æ€»æ‚¬ç©ºæ€è€ƒæ—¶é—´):', `${dcdt.in_air_sec} s`, alert);
                    if(dcdt.in_air_sec > 5.0) scores.MOT -= (dcdt.in_air_sec - 5.0) * 4;
                }

                // ================= 4. æƒ…æ„Ÿä¸è®¡ç®—ç²¾ç¥ç—…å­¦ (EMO) =================
                if(mods['Emotion_FER']) {
                    const fer = mods['Emotion_FER'].data.summary;
                    const fearAcc = fer.emotion_specific_matrix['fear'] ? fer.emotion_specific_matrix['fear'].accuracy_percent : 100;
                    const alert = fearAcc < 60 ? alertTag('ç‰¹å¼‚æ€§ææƒ§è¯†åˆ«éšœç¢') : '';
                    htmlMap.EMO += buildItem('ğŸ˜ƒ FER é¢å­”æƒ…ç»ªè¯†åˆ« (ER60 æ€»æ­£ç¡®ç‡ / ææƒ§è¯†åˆ«):', `${fer.overall_accuracy_percent}% / ${fearAcc}%`, alert);
                    if(fearAcc < 60) scores.EMO -= 15;
                }
                if(mods['AEMO_ERT']) {
                    const ert = mods['AEMO_ERT'].data;
                    const alert = ert.regulation_capacity <= 0 ? alertTag('å‰é¢å¶æŠ‘åˆ¶å¤±è´¥') : '';
                    htmlMap.EMO += buildItem('ğŸ–¼ï¸ ERT è®¤çŸ¥é‡è¯„ (dlPFC å¯¹æä»æ ¸è°ƒèŠ‚å·®å€¼):', `${ert.regulation_capacity}`, alert);
                    if(ert.regulation_capacity < 10) scores.EMO -= (10 - Math.max(0, ert.regulation_capacity)) * 2;
                }
                if(mods['AEMO_IAT']) {
                    const iat = mods['AEMO_IAT'].data;
                    const alert = iat.implicit_bias_ms > 150 ? alertTag('å†…éšæŠ‘éƒåç½®') : '';
                    htmlMap.EMO += buildItem('âš¡ IAT å†…éšé˜»åŠ› D-Score (ä¸ç›¸å®¹å‡ç›¸å®¹):', `${iat.implicit_bias_ms} ms`, alert);
                    if(iat.implicit_bias_ms > 100) scores.EMO -= (iat.implicit_bias_ms - 100) * 0.2;
                }
                if(mods['AEMO_LLM_Big5']) {
                    const big5 = mods['AEMO_LLM_Big5'].data.data; 
                    const alert = big5.N > 70 ? alertTag('é«˜ç¥ç»è´¨è¡¨å‹', 'warning') : '';
                    htmlMap.EMO += buildItem('ğŸ¤– NLP è¯­ä¹‰å¤§äº”äººæ ¼ (ç¥ç»è´¨ N åˆ†):', `${big5.N} / 100`, alert);
                }

                // ================= 5. ç”Ÿç†ä¼ æ„Ÿ (PHY) =================
                if(mods['PHY_Face_rPPG']) {
                    const rppg = mods['PHY_Face_rPPG'].data.summary;
                    const alert = (rppg.estimated_rmssd_ms < 20 && rppg.estimated_rmssd_ms > 0) ? alertTag('è¿·èµ°å¼ åŠ›æ·±åº¦æŠ‘åˆ¶') : '';
                    htmlMap.PHY += buildItem('ğŸ¥ é¢éƒ¨å½±åƒè¡€æµ rPPG (é™æ¯æ‹Ÿåˆ HR / RMSSD):', `${rppg.estimated_hr_bpm} bpm / ${rppg.estimated_rmssd_ms} ms`, alert);
                    if(rppg.estimated_rmssd_ms < 25 && rppg.estimated_rmssd_ms > 0) scores.PHY -= (25 - rppg.estimated_rmssd_ms) * 1.5;
                } else {
                    htmlMap.PHY += `<div style="color:var(--slate); font-size:14px; padding:10px;">å°šæœªæ”¶é›†ç”Ÿç†ä¼ æ„Ÿå™¨æ•°æ®</div>`;
                    scores.PHY = 0;
                }

                // ================= 6. åŠŸèƒ½èŠ‚å¾‹ (LIF) =================
                if(mods['LIF_Lifestyle']) {
                    const lif = mods['LIF_Lifestyle'].data.summary;
                    const alert1 = lif.iadl_impairment_score >= 2 ? alertTag('ç”Ÿæ´»è‡ªç†å—æŸ') : '';
                    const alert2 = lif.avg_decision_hesitation_ms > 5000 ? alertTag('éšæ€§å†³ç­–è¿Ÿç–‘(>5s)', 'warning') : '';
                    htmlMap.LIF += buildItem('ğŸ¥— IADL åŠŸèƒ½é‡è¡¨ (å—æŸæ‰£åˆ† / å‡å†³ç­–è¿Ÿç–‘):', `${lif.iadl_impairment_score} åˆ† / ${lif.avg_decision_hesitation_ms} ms`, alert1 + ' ' + alert2);
                    htmlMap.LIF += buildItem('ğŸ›ï¸ ä¸»è§‚ç¡çœ è´¨é‡ (VAS æ ‡å°º):', `${lif.sleep_quality_index} / 100`);
                    scores.LIF -= (lif.iadl_impairment_score * 15);
                    if(lif.avg_decision_hesitation_ms > 5000) scores.LIF -= 10;
                } else {
                    htmlMap.LIF += `<div style="color:var(--slate); font-size:14px; padding:10px;">å°šæœªæ”¶é›†æ—¥å¸¸åŠŸèƒ½æ•°æ®</div>`;
                    scores.LIF = 0;
                }

            } catch(e) {
                console.error("è§£ææ•°æ®ç»“æ„å¼‚å¸¸:", e);
                document.getElementById('results-content').innerHTML = `<div style="color:var(--emo); padding:20px; font-weight:bold;">âš ï¸ æ•°æ®è§£æå¼‚å¸¸ï¼Œå¯èƒ½æ˜¯ç”±äºè·¨ç‰ˆæœ¬æ•°æ®ç»“æ„ä¸å…¼å®¹å¯¼è‡´çš„æ®‹ç•™ã€‚è¯·è¿”å›ä¸»é¡µæ‰§è¡Œ [é”€æ¯ç¼“å­˜]ã€‚</div>`;
                return;
            }

            // ================= æ¸²æŸ“ç»“æœå— =================
            let finalOutput = '';
            const domains = [
                { key: 'COG', name: 'ğŸ§  è®¤çŸ¥æ‰§è¡Œä¸è­¦è§‰ç½‘ç»œ (Cognition & Sensation)', color: 'var(--cog)' },
                { key: 'LAN', name: 'ğŸ—£ï¸ è¨€è¯­è¯­è¨€ç½‘ç»œ (Language & Voice)', color: 'var(--lan)' },
                { key: 'MOT', name: 'ğŸ¯ é”¥ä½“å¤–ç³»ä¸å¾®è§‚åŠ¨åŠ›å­¦ (Motor Kinematics)', color: 'var(--mot)' },
                { key: 'EMO', name: 'ğŸ­ ç¤¾ä¼šæƒ…ç»ªä¸è®¡ç®—ç²¾ç¥ç—…å­¦ (Emotion)', color: 'var(--emo)' },
                { key: 'PHY', name: 'ğŸ¥ è‡ªä¸»ç¥ç»ä¸è¡€æµä¼ æ„Ÿ (Physiology)', color: 'var(--phy)' },
                { key: 'LIF', name: 'ğŸ¥— æ—¥å¸¸åŠŸèƒ½ä¸ç”Ÿç‰©èƒ½é‡èŠ‚å¾‹ (Lifestyle)', color: 'var(--lif)' }
            ];

            domains.forEach(d => {
                if(htmlMap[d.key] !== '' && !htmlMap[d.key].includes('å°šæœªæ”¶é›†')) {
                    finalOutput += `
                        <div class="domain-block">
                            <div class="domain-title" style="background:${d.color};">${d.name}</div>
                            <div class="domain-content">${htmlMap[d.key]}</div>
                        </div>
                    `;
                }
            });

            if(finalOutput === '') finalOutput = '<div style="text-align:center; padding: 50px; color:var(--slate); border:2px dashed #e2e8f0; border-radius:16px;">å°šæœªæ”¶é›†åˆ°ä»»ä½•æœ‰æ•ˆæ¨¡å—æ•°æ®ã€‚è¯·è¿”å›æ§åˆ¶å°æ‰§è¡Œæµ‹è¯•ã€‚</div>';
            document.getElementById('results-content').innerHTML = finalOutput;

            // ================= ç»˜åˆ¶å›¾è¡¨åˆ†æ•°åŠ¨ç”» =================
            setTimeout(() => { 
                domains.forEach(d => { 
                    let s = Math.max(0, Math.min(100, Math.round(scores[d.key]))); 
                    // å¦‚æœè¯¥æ¨¡å—æ ¹æœ¬æ²¡åšï¼Œç½®ä¸º0
                    if(htmlMap[d.key] === '' || htmlMap[d.key].includes('å°šæœªæ”¶é›†')) s = 0;
                    
                    let elBar = document.getElementById(`bar-${d.key.toLowerCase()}`);
                    if(elBar) { 
                        elBar.style.width = s + '%'; 
                        document.getElementById(`val-${d.key.toLowerCase()}`).innerText = s; 
                    }
                }); 
            }, 600);
        };
    </script>
</body>
</html>
