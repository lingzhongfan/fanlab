<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAS ä¸´åºŠæ•°å­—è¡¨å‹æ•°æ®ä¸­å¿ƒ</title>
    <style>
        :root { 
            --primary: #0f172a; 
            --success: #10b981; 
            --danger: #f43f5e; 
            --blue: #3b82f6;
            --bg: #f8fafc;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; color: #334155; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-top: 6px solid var(--success); }
        
        /* å¤´éƒ¨çŠ¶æ€åŒº */
        .header-area { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .header-area h2 { color: var(--primary); margin: 0 0 10px 0; font-size: 28px; }
        .session-badge { background: #f1f5f9; padding: 8px 15px; border-radius: 8px; font-family: monospace; font-size: 15px; color: #475569; font-weight: bold; border: 1px solid #cbd5e1; }
        
        /* å…¨å±€è¿›åº¦æ¡ */
        .progress-wrapper { margin-bottom: 30px; }
        .progress-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px; font-size: 16px; }
        .progress-bar { width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease-in-out; }

        /* åˆ†ç»„ç½‘æ ¼è§†å›¾ */
        .domain-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .domain-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; }
        .domain-title { font-size: 18px; font-weight: bold; color: var(--primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        
        /* åˆ—è¡¨é¡¹ */
        .module-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #cbd5e1; font-size: 14px; }
        .module-item:last-child { border-bottom: none; padding-bottom: 0; }
        .module-name { color: #475569; font-weight: 500; }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: bold; padding: 4px 8px; border-radius: 6px; }
        .status-done { background: #d1fae5; color: #065f46; }
        .status-pending { background: #ffe4e6; color: #9f1239; }
        .time-stamp { font-family: monospace; font-size: 11px; opacity: 0.8; }

        /* æ“ä½œæŒ‰é’®åŒº */
        .action-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .btn { padding: 18px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; color: white; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:active { transform: translateY(0); }
        .btn-export { background: var(--success); grid-column: 1 / -1; font-size: 18px; }
        .btn-preview { background: #64748b; }
        .btn-nav { background: var(--blue); }
        .btn-danger { background: var(--danger); }

        /* éšè—çš„ä»£ç é¢„è§ˆé¢æ¿ */
        .preview-box { display: none; flex-direction: column; background: #1e293b; padding: 20px; border-radius: 12px; margin-top: 20px; animation: slideDown 0.3s ease-out; }
        .preview-box textarea { width: 100%; height: 400px; background: #0f172a; color: #10b981; border: 1px solid #334155; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical; outline: none; box-sizing: border-box; line-height: 1.5; }
        .copy-action-btn { align-self: flex-end; margin-top: 15px; background: var(--blue); color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .copy-action-btn:hover { background: #2563eb; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div class="container">
        <div class="header-area">
            <div>
                <h2>ğŸ”¬ CAS å¤åˆæ•°å­—è¡¨å‹æ•°æ®ä¸­å¿ƒ</h2>
                <span style="color: #64748b; font-size: 15px;">å…¨ç»´åº¦ç¥ç»å¿ƒç†å­¦ç‰¹å¾èšåˆä¸è´¨æ§é¢æ¿</span>
            </div>
            <div class="session-badge">ID: <span id="sess-id"></span></div>
        </div>
        
        <div class="progress-wrapper">
            <div class="progress-header">
                <span>æ€»ä½“æµ‹è¯•è¿›åº¦ (Overall Progress)</span>
                <span id="progress-text" style="color: var(--success);">0 / 19 (0%)</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>

        <div class="domain-grid" id="domain-board">
            </div>

        <div class="action-group">
            <button class="btn btn-export" onclick="CAS_Storage.exportJSON()">ğŸ“¥ å¯¼å‡ºç»“æ„åŒ– JSON æ•°æ®åŒ… (ç”¨äº AI å»ºæ¨¡)</button>
            <button class="btn btn-preview" onclick="togglePreview()">ğŸ‘€ å±•å¼€/æŠ˜å æ•°æ®æºç </button>
            <a href="index.html" class="btn btn-nav">â† è¿”å›ä¸»é¢æ¿ç»§ç»­æµ‹è¯•</a>
            <button class="btn btn-danger" onclick="CAS_Storage.clearSession()">âš ï¸ ç»“æŸå¹¶æ¸…é™¤å½“å‰å—è¯•è€…æ•°æ®</button>
        </div>

        <div class="preview-box" id="preview-container">
            <textarea id="json-output-text" readonly spellcheck="false"></textarea>
            <button class="copy-action-btn" id="copy-btn" onclick="copyJSON()">ğŸ“‹ ä¸€é”®å¤åˆ¶å…¨éƒ¨ JSON ä»£ç </button>
        </div>
    </div>

    <script>
        // å®šä¹‰åŒ…å«é¢†åŸŸçš„å®Œæ•´ 19 é¡¹æ¶æ„
        const domains = [
            {
                name: 'ğŸ§  è®¤çŸ¥åŸŸ (Cognition)',
                modules: [
                    { id: 'Cognition_Corsi', name: 'ç©ºé—´å·¥ä½œè®°å¿† (Corsi)' },
                    { id: 'Cognition_Stroop', name: 'æ‰§è¡ŒæŠ‘åˆ¶ (Stroop)' },
                    { id: 'Cognition_TMT_B', name: 'è®¤çŸ¥æŸ”æ€§ (TMT)' },
                    { id: 'Cognition_DSST', name: 'å¤„ç†é€Ÿåº¦ (DSST)' }
                ]
            },
            {
                name: 'â¤ï¸ æƒ…æ„Ÿä¸å†³ç­– (Emotion)',
                modules: [
                    { id: 'Emotion_State_EMA', name: 'çŠ¶æ€è‡ªè¯„ (EMA)' },
                    { id: 'Emotion_Trait_Big5', name: 'äººæ ¼ç‰¹è´¨ (Big5)' },
                    { id: 'Emotion_Risk_BART', name: 'é£é™©å†³ç­– (BART)' },
                    { id: 'Emotion_Affective_Stroop', name: 'æƒ…ç»ªæ³¨æ„ (E-Stroop)' }
                ]
            },
            {
                name: 'ğŸ¯ è¿åŠ¨ä¸å…±æµ (Motor)',
                modules: [
                    { id: 'Motor_SimpleTapping', name: 'å•æŒ‡æ•²å‡» (Tapping)' },
                    { id: 'Motor_Fitts', name: 'é¶å‘è¿åŠ¨ (Fitts)' },
                    { id: 'Motor_Spiral_Tracing', name: 'éœ‡é¢¤åˆ†æ (Spiral)' }
                ]
            },
            {
                name: 'âš¡ æ„Ÿè§‰ä¸çŸ¥è§‰ (Sensation)',
                modules: [
                    { id: 'Sensation_SimpleRT', name: 'ç®€å•ååº” (SRT)' },
                    { id: 'Sensation_ChoiceRT', name: 'å†³ç­–ååº” (CRT)' },
                    { id: 'Sensation_GoNoGo', name: 'æ„Ÿè§‰æŠ‘åˆ¶ (Go/No-Go)' },
                    { id: 'Sensation_VisualSearch', name: 'è§†è§‰æœç´¢ (V-Search)' }
                ]
            },
            {
                name: 'ğŸ’¬ è¯­è¨€åŠŸèƒ½ (Language)',
                modules: [
                    { id: 'Language_VFT', name: 'è¯æ±‡æµç•…æ€§ (VFT)' },
                    { id: 'Language_Naming', name: 'å›¾ç‰‡å‘½å (Naming)' }
                ]
            },
            {
                name: 'ğŸŒ™ ä¸»è§‚ä¸èŠ‚å¾‹ (Lifestyle)',
                modules: [
                    { id: 'Lifestyle_SCD', name: 'ä¸»è§‚è®¤çŸ¥ä¸‹é™ (SCD)' },
                    { id: 'Lifestyle_Sleep', name: 'ç¡çœ ä¸ç”Ÿç‰©èŠ‚å¾‹ (Sleep)' }
                ]
            }
        ];

        window.onload = function() {
            const session = CAS_Storage.getSession();
            document.getElementById('sess-id').innerText = session.session_id;
            
            const board = document.getElementById('domain-board');
            let totalModules = 0;
            let completedModules = 0;

            // åŠ¨æ€ç”Ÿæˆåˆ†ç»„å¡ç‰‡
            domains.forEach(domain => {
                let cardHtml = `<div class="domain-card"><h3 class="domain-title">${domain.name}</h3>`;
                
                domain.modules.forEach(m => {
                    totalModules++;
                    const moduleData = session.modules[m.id];
                    const isDone = !!moduleData;
                    
                    if (isDone) completedModules++;

                    // è§£æå®Œæˆæ—¶é—´ï¼Œè‹¥å·²å®Œæˆåˆ™æå–å‡º HH:MM:SS
                    let timeStr = "";
                    if (isDone && moduleData.completed_at) {
                        const dateObj = new Date(moduleData.completed_at);
                        timeStr = `<span class="time-stamp">${dateObj.getHours().toString().padStart(2,'0')}:${dateObj.getMinutes().toString().padStart(2,'0')}:${dateObj.getSeconds().toString().padStart(2,'0')}</span>`;
                    }

                    const badgeHtml = isDone 
                        ? `<div class="status-badge status-done">âœ“ å·²é‡‡å½• ${timeStr}</div>`
                        : `<div class="status-badge status-pending">â—‹ å¾…å®Œæˆ</div>`;

                    cardHtml += `
                        <div class="module-item">
                            <span class="module-name">${m.name}</span>
                            ${badgeHtml}
                        </div>`;
                });
                
                cardHtml += `</div>`;
                board.innerHTML += cardHtml;
            });

            // æ›´æ–°è¿›åº¦æ¡
            const progressPercent = Math.round((completedModules / totalModules) * 100);
            document.getElementById('progress-text').innerText = `${completedModules} / ${totalModules} (${progressPercent}%)`;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            
            // å¦‚æœå…¨éƒ¨å®Œæˆï¼Œè¿›åº¦æ¡å˜æˆé‡‘è‰²/è€€çœ¼æ•ˆæœæç¤ºå¯ä»¥å¯¼å‡º
            if (completedModules === totalModules) {
                document.getElementById('progress-fill').style.background = "linear-gradient(90deg, #10b981, #34d399)";
                document.getElementById('progress-fill').style.boxShadow = "0 0 10px #34d399";
            }
        };

        // åˆ‡æ¢é¢„è§ˆé¢æ¿
        function togglePreview() {
            const container = document.getElementById('preview-container');
            if (container.style.display === 'flex') {
                container.style.display = 'none';
            } else {
                const session = CAS_Storage.getSession();
                session.end_time = new Date().toISOString(); // é¢„è§ˆæ—¶è®°å½•å½“å‰ä¸ºç»“æŸæ—¶é—´
                document.getElementById('json-output-text').value = JSON.stringify(session, null, 2);
                container.style.display = 'flex';
                // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
                container.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }

        // å¤åˆ¶ JSON åŠŸèƒ½
        function copyJSON() {
            const textArea = document.getElementById('json-output-text');
            const btn = document.getElementById('copy-btn');
            
            textArea.select();
            textArea.setSelectionRange(0, 999999); // é€‚é…ç§»åŠ¨è®¾å¤‡
            
            navigator.clipboard.writeText(textArea.value).then(() => {
                btn.innerText = "âœ“ æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼";
                btn.style.background = "#10b981";
                setTimeout(() => { 
                    btn.innerText = "ğŸ“‹ ä¸€é”®å¤åˆ¶å…¨éƒ¨ JSON ä»£ç "; 
                    btn.style.background = "#3b82f6"; 
                }, 2000);
            }).catch(err => {
                alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·å°è¯•åœ¨ä»£ç æ¡†å†…æ‰‹åŠ¨å…¨é€‰å¤åˆ¶ã€‚");
            });
        }
    </script>
</body>
</html>
