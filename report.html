<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>NeuroMap 1.0 - ç¥ç»è¡Œä¸ºå¤šæ¨¡æ€è¯„ä¼°å›¾è°±ä¸è®¡ç®—ç²¾ç¥ç—…å­¦é£é™©æŠ¥å‘Š</title>
    <style>
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --amber: #f59e0b; --purple: #8b5cf6; --teal: #0d9488; --slate: #64748b; }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; padding: 30px; color: #334155; line-height: 1.6; margin: 0;}
        .container { max-width: 1050px; margin: auto; background: white; padding: 45px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        h2 { color: var(--blue); border-bottom: 3px solid var(--light-blue); padding-bottom: 15px; margin-top: 0; display: flex; align-items: center; gap: 10px;}
        
        /* é¡¶éƒ¨æ§åˆ¶å° */
        .input-panel { background: #f8fafc; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 35px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-input { padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 15px; outline: none; font-weight: bold;}
        .btn-action { padding: 12px 20px; background: white; border: 2px solid var(--blue); color: var(--blue); border-radius: 8px; font-weight: bold; cursor: pointer; display: block; text-align: center;}
        .btn-generate { margin-top: 20px; width: 100%; padding: 15px; background: var(--blue); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;}
        
        /* åŸºç¡€ä¿¡æ¯åŒº */
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; background: #f8fafc; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; }
        .info-item span { display: block; font-size: 13.5px; color: var(--slate); font-weight: bold;}
        .info-item strong { font-size: 18px; color: var(--primary); }

        /* å…­å¤§åŸºå¸¦é›·è¾¾ */
        .chart-container { background: white; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 1px solid #e2e8f0; }
        .bar-row { display: flex; align-items: center; margin-bottom: 15px; }
        .bar-label { width: 150px; font-weight: bold; color: var(--slate); font-size: 14.5px; }
        .bar-track { flex: 1; height: 20px; background: #f1f5f9; border-radius: 10px; overflow: hidden;}
        .bar-fill { height: 100%; border-radius: 10px; width: 0%; transition: width 1.5s; }
        .bar-value { width: 50px; text-align: right; font-weight: bold; color: var(--primary); font-size: 16px; }

        .fill-cog { background: linear-gradient(90deg, #818cf8, #4f46e5); } .fill-emo { background: linear-gradient(90deg, #fb7185, #e11d48); }
        .fill-mot { background: linear-gradient(90deg, #fcd34d, #f59e0b); } .fill-sen { background: linear-gradient(90deg, #fef08a, #eab308); }
        .fill-lan { background: linear-gradient(90deg, #c084fc, #9333ea); } .fill-lif { background: linear-gradient(90deg, #2dd4bf, #0d9488); }

        /* è®¡ç®—ç²¾ç¥ç—…å­¦é£é™©å›¾è°± */
        .risk-container { background: #fffbeb; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 2px dashed #fcd34d; }
        .risk-header { font-size: 18px; font-weight: bold; color: #b45309; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;}
        .risk-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;}
        .risk-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #fde68a; box-shadow: 0 4px 10px rgba(0,0,0,0.02);}
        .risk-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: flex; justify-content: space-between;}
        .risk-bar-track { height: 12px; background: #f1f5f9; border-radius: 6px; overflow: hidden; margin-bottom: 10px;}
        .risk-bar-fill { height: 100%; width: 0%; transition: width 1.5s ease-out; }
        .risk-details { font-size: 12px; color: var(--slate); margin: 0; line-height: 1.5;}
        
        .risk-low { background: var(--green); } .risk-med { background: var(--amber); } .risk-high { background: var(--red); }

        /* ä¸´åºŠæŠ¥å‘Šæ˜ç»† */
        .results-box { background: #f8fafc; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 2px dashed #cbd5e1; }
        .domain-section { margin-bottom: 25px; }
        .domain-title { font-size: 16px; font-weight: bold; color: white; background: var(--primary); padding: 8px 15px; border-radius: 8px; display: inline-block; margin-bottom: 12px;}
        .result-item { font-size: 14px; margin-bottom: 8px; display: flex; justify-content: space-between; padding: 10px 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;}
        .alert-badge { color: white; background: var(--red); font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: bold;}
        .warning-badge { color: white; background: var(--amber); font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: bold;}

        /* æ‰“å°ä¸å¯¼å‡ºæ§åˆ¶ */
        .btn-group { display: flex; gap: 20px; }
        .btn { flex: 1; padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-export { background: var(--green); color: white; }
        .btn-print { background: var(--slate); color: white; }
        
        @media print {
            body { background: white; padding: 0; }
            .input-panel, .btn-group, button { display: none !important; }
            .container { box-shadow: none; padding: 0; border: none; }
        }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div class="container">
        <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer; font-size: 16px; margin-bottom: 20px;">â† è¿”å›æ§åˆ¶å°</button>

        <div class="input-panel">
            <h3>âš™ï¸ ä¸´åºŠåŸºçº¿èåˆå¼•æ“</h3>
            <div class="input-grid">
                <div>
                    <label style="font-size:13px; font-weight:bold; color:var(--slate);">é€‰æ‹©æ•°æ®æº</label>
                    <select id="data-source-select" class="form-input" style="width:100%; margin-bottom:10px;" onchange="document.getElementById('file-uploader').style.display = this.value === 'file' ? 'block' : 'none';">
                        <option value="local">è¯»å–å½“å‰æµ‹è¯•æ‚£è€… (æœ¬åœ°ç¼“å­˜)</option>
                        <option value="file">å¯¼å…¥ç¦»çº¿ BIDS-JSON æ•°æ®åŒ…</option>
                    </select>
                    <div id="file-uploader" style="display:none; position:relative;">
                        <span class="btn-action" id="btn-file-label">ğŸ“‚ ç‚¹å‡»ä¸Šä¼  JSON æ¡£æ¡ˆ</span>
                        <input type="file" id="json-file-input" accept=".json" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="input-mmse" class="form-input" placeholder="MMSE å¾—åˆ† (é€‰å¡«)" style="flex:1;">
                    <input type="number" id="input-moca" class="form-input" placeholder="MoCA å¾—åˆ† (é€‰å¡«)" style="flex:1;">
                </div>
            </div>
            <button class="btn-generate" onclick="generateReport()">âš¡ å¯åŠ¨è”åˆè¯„ä¼°ä¸å¤šæ¨¡æ€è§£æ</button>
        </div>

        <h2>ğŸ“Š NeuroMap å¤šæ¨¡æ€å›¾è°±ä¸è®¡ç®—é¢„è­¦æŠ¥å‘Š</h2>
        
        <div class="info-grid">
            <div class="info-item"><span>è¢«è¯• ID</span><strong id="r-id">-</strong></div>
            <div class="info-item"><span>å¹´é¾„ / æ€§åˆ«</span><strong id="r-bio">-</strong></div>
            <div class="info-item"><span>ä¼ ç»Ÿé‡è¡¨å¾—åˆ†</span><strong id="r-scales" style="color:var(--blue);">- / -</strong></div>
        </div>

        <div class="chart-container">
            <h3 style="margin-top:0; color:var(--primary);">ç¬¬ä¸€å±‚ï¼šåŸºå¸¦è®¤çŸ¥ä¸ç”Ÿç†ç‰¹å¾å›¾è°± (ç¥ç»ç”Ÿç†ç»´åº¦)</h3>
            <div class="bar-row"><div class="bar-label">ğŸ§  è®¤çŸ¥æ‰§è¡Œ (COG)</div><div class="bar-track"><div class="bar-fill fill-cog" id="bar-cog"></div></div><div class="bar-value" id="val-cog">0</div></div>
            <div class="bar-row"><div class="bar-label">â¤ï¸ æƒ…ç»ªç¤¾ä¼š (EMO)</div><div class="bar-track"><div class="bar-fill fill-emo" id="bar-emo"></div></div><div class="bar-value" id="val-emo">0</div></div>
            <div class="bar-row"><div class="bar-label">ğŸ¯ è¿åŠ¨å…±æµ (MOT)</div><div class="bar-track"><div class="bar-fill fill-mot" id="bar-mot"></div></div><div class="bar-value" id="val-mot">0</div></div>
            <div class="bar-row"><div class="bar-label">âš¡ æ„Ÿè§‰çŸ¥è§‰ (SEN)</div><div class="bar-track"><div class="bar-fill fill-sen" id="bar-sen"></div></div><div class="bar-value" id="val-sen">0</div></div>
            <div class="bar-row"><div class="bar-label">ğŸ’¬ è¯­è¨€ç½‘ç»œ (LAN)</div><div class="bar-track"><div class="bar-fill fill-lan" id="bar-lan"></div></div><div class="bar-value" id="val-lan">0</div></div>
            <div class="bar-row"><div class="bar-label">ğŸŒ™ ç”Ÿæ´»åŠŸèƒ½ (LIF)</div><div class="bar-track"><div class="bar-fill fill-lif" id="bar-lif"></div></div><div class="bar-value" id="val-lif">0</div></div>
        </div>

        <div class="risk-container" id="risk-panel" style="display:none;">
            <div class="risk-header">âš ï¸ ç¬¬äºŒå±‚ï¼šè®¡ç®—ç²¾ç¥ç—…å­¦è”åˆé¢„è­¦æ¨¡å‹ (å¤šç»´ç‰¹å¾äº¤å‰æ˜ å°„)</div>
            <div class="risk-grid">
                <div class="risk-card">
                    <div class="risk-title"><span>é˜¿å°”èŒ¨æµ·é»˜ç—… (AD/MCI) ç»¼åˆé£é™©</span><span id="risk-val-ad">0%</span></div>
                    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-ad"></div></div>
                    <p class="risk-details">èåˆé¶ç‚¹: è¯­ä¹‰é˜»æ»(VFT) + ç©ºé—´è¡°é€€(Corsi) + æ‰§è¡Œè¿Ÿç¼“(TMT/dCDT) + å†³ç­–è¿Ÿç–‘(LIF)</p>
                </div>
                <div class="risk-card">
                    <div class="risk-title"><span>é‡åº¦æŠ‘éƒç—‡ (MDD) ç»¼åˆé£é™©</span><span id="risk-val-mdd">0%</span></div>
                    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-mdd"></div></div>
                    <p class="risk-details">èåˆé¶ç‚¹: å†…éšè´Ÿæ€§åç½®(IAT) + å‰é¢å¶è°ƒèŠ‚å¤±è´¥(ERT) + è¿·èµ°å¼ åŠ›æŠ‘åˆ¶(rPPG) + è¯­éŸ³è¿Ÿæ»(VBM)</p>
                </div>
                <div class="risk-card">
                    <div class="risk-title"><span>å¸•é‡‘æ£®ç—… (PD) ç»¼åˆé£é™©</span><span id="risk-val-pd">0%</span></div>
                    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-pd"></div></div>
                    <p class="risk-details">èåˆé¶ç‚¹: å‰‚æœ«è¡°ç«­(AFT) + æŒ‰é”®è‚Œå¼ºç›´(KeyStroke) + åŒé‡ä»»åŠ¡æ­¥æ€å˜å¼‚(IMU)</p>
                </div>
                <div class="risk-card">
                    <div class="risk-title"><span>æ³¨æ„ç¼ºé™·/è­¦è§‰å—æŸé£é™©</span><span id="risk-val-att">0%</span></div>
                    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-att"></div></div>
                    <p class="risk-details">èåˆé¶ç‚¹: è“æ–‘ç½‘ç»œå¤±è¯¯(PVT Lapses) + æ‰§è¡Œç½‘ç»œé˜»æ»(TMT)</p>
                </div>
            </div>
        </div>

        <div class="results-box">
            <h3 style="margin-top:0; color:var(--primary);">ğŸ“‹ åŸå§‹é«˜é¢‘ç‰¹å¾æŒ‡æ ‡è§£æåº“</h3>
            <div id="results-content"><p style="color:var(--slate);">è¯·å¯åŠ¨å¤šæ¨¡æ€è§£æå¼•æ“è·å–åº•å±‚æ•°æ®æ˜ç»†...</p></div>
        </div>

        <div class="btn-group">
            <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°ä¸´åºŠåˆ†ææ¡£æ¡ˆ</button>
            <button class="btn btn-export" onclick="CAS_Storage.exportJSON()">ğŸ“¥ å¯¼å‡ºåˆ†æçº§ JSON (å«é£é™©æ ‡ç­¾ä¸æ—¶åº)</button>
        </div>
    </div>

    <script>
        // ================= ç¦»çº¿ JSON å¯¼å…¥ç›‘å¬ =================
        let importedSessionData = null;
        document.getElementById('json-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('btn-file-label').innerText = "âœ… " + file.name;
            const reader = new FileReader();
            reader.onload = function(event) {
                try { 
                    importedSessionData = JSON.parse(event.target.result); 
                } catch(err) { 
                    alert("âš ï¸ JSON æ¡£æ¡ˆè§£æå¤±è´¥ï¼è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚"); 
                }
            };
            reader.readAsText(file);
        });

        // ================= æ ¸å¿ƒåˆ†æå¼•æ“ =================
        function generateReport() {
            // 1. è·å–ç›®æ ‡æ•°æ®æº
            const mode = document.getElementById('data-source-select').value;
            let session = (mode === 'file') ? importedSessionData : CAS_Storage.getSession();
            
            if (!session) return alert("âš ï¸ æ— æœ‰æ•ˆæ•°æ®å¯ä¾›è§£æï¼");

            // 2. åŸºçº¿ä¿¡æ¯ä¸ä¼ ç»Ÿé‡è¡¨å›å¡«
            if(session.demographics) {
                document.getElementById('r-id').innerText = session.demographics.subject_id || '-';
                const age = session.demographics.dob ? (new Date().getFullYear() - parseInt(session.demographics.dob.split('-')[0])) : '-';
                document.getElementById('r-bio').innerText = `${age}å² / ${session.demographics.gender || '-'}`;
            }
            document.getElementById('r-scales').innerText = `${document.getElementById('input-mmse').value||'--'} / ${document.getElementById('input-moca').value||'--'}`;

            const mods = session.modules || {};
            let htmlMap = { COG:'', EMO:'', MOT:'', SEN:'', LAN:'', LIF:'', PHY:'' };
            let chartScores = { COG: 100, EMO: 100, MOT: 100, SEN: 100, LAN: 100, LIF: 100 };
            
            // --- è®¡ç®—ç²¾ç¥ç—…å­¦ï¼šç–¾ç—…é£é™©å¼•æ“åˆå§‹åŒ– ---
            let riskScores = { AD: 0, MDD: 0, PD: 0, ATT: 0 };
            // activeRiskModules è®°å½•ç”¨æˆ·å®é™…å®Œæˆäº†å“ªäº›æ¨¡å—ï¼ˆä½œä¸ºåˆ†æ¯è¿›è¡Œæƒé‡å½’ä¸€åŒ–è®¡ç®—ï¼‰
            let activeRiskModules = { AD: 0, MDD: 0, PD: 0, ATT: 0 }; 
            let clinicalFlags = []; // å­˜å‚¨ç³»ç»Ÿå‘ç°çš„æ‰€æœ‰ä¸´åºŠå±é™©ä½“å¾

            const buildItem = (label, value, alertHtml = '') => `<div class="result-item"><span>${label}</span><strong>${value} ${alertHtml}</strong></div>`;
            const alertTag = (text, type='danger') => `<span class="${type==='warning'?'warning-badge':'alert-badge'}">${text}</span>`;

            try {
                // ================= 3. è§£æå…¨éƒ¨ 13 ä¸ªæ¨¡å—ï¼Œå¹¶å¹¶è¡Œè®¡ç®—è”åˆç–¾ç—…é£é™© =================
                
                // ã€COG / SEN è®¤çŸ¥ä¸è­¦è§‰ç»´åº¦ã€‘
                if(mods['COG_Corsi']) {
                    const span = mods['COG_Corsi'].data.max_span;
                    htmlMap.COG += buildItem('ğŸ§© Corsi ç©ºé—´æé™å¹¿åº¦:', `${span}`);
                    if(span < 4) { chartScores.COG -= 15; riskScores.AD += 25; clinicalFlags.push('ç©ºé—´å·¥ä½œè®°å¿†è¡°é€€'); }
                    activeRiskModules.AD += 25;
                }
                if(mods['COG_DSST']) {
                    const count = mods['COG_DSST'].data.correct_count;
                    htmlMap.COG += buildItem('ğŸ”¢ DSST é™æ—¶åŠ å·¥é€Ÿåº¦:', `${count} ä¸ª`);
                    if(count < 25) { chartScores.COG -= 15; }
                }
                if(mods['COG_Stroop']) {
                    const stp = mods['COG_Stroop'].data.records;
                    const stpAcc = stp.length ? Math.round((stp.filter(r=>r.correct).length/stp.length)*100) : 0;
                    htmlMap.COG += buildItem('ğŸš¥ Stroop ä¾§æŠ‘åˆ¶ç½‘ç»œ (å‡†ç¡®ç‡):', `${stpAcc}%`);
                    if(stpAcc < 80) chartScores.COG -= 10;
                }
                if(mods['COG_TMT_B']) {
                    const tmt = mods['COG_TMT_B'].data;
                    const alertHtml = tmt.total_time_ms > 100000 ? alertTag('æ‰§è¡Œç½‘ç»œè¿Ÿç¼“') : '';
                    htmlMap.COG += buildItem('ğŸ”— TMT-B æ‰§è¡Œä»»åŠ¡åˆ‡æ¢è€—æ—¶:', `${(tmt.total_time_ms/1000).toFixed(1)} s`, alertHtml);
                    if(tmt.total_time_ms > 100000) { chartScores.COG -= 20; riskScores.AD += 25; riskScores.ATT += 20; clinicalFlags.push('æ‰§è¡Œç½‘ç»œè¿Ÿç¼“'); }
                    activeRiskModules.AD += 25; activeRiskModules.ATT += 20;
                }
                if(mods['SEN_PVT']) {
                    const lapses = mods['SEN_PVT'].data.summary.lapses;
                    const alertHtml = lapses > 3 ? alertTag('è“æ–‘è­¦è§‰å¤±è¯¯', 'warning') : '';
                    htmlMap.SEN += buildItem('â±ï¸ PVT è“æ–‘è­¦è§‰ Lapses:', `${lapses} æ¬¡`, alertHtml);
                    if(lapses > 3) { chartScores.SEN -= (lapses*5); riskScores.ATT += 40; clinicalFlags.push('è“æ–‘è­¦è§‰ç½‘ç»œå¤±è¯¯'); }
                    activeRiskModules.ATT += 40;
                }
                if(mods['SEN_TimeRep']) {
                    const tr = mods['SEN_TimeRep'].data.summary.mean_absolute_error_ms;
                    htmlMap.SEN += buildItem('â³ TimeRep å†…éƒ¨æ—¶é—´ç»å¯¹è¯¯å·®:', `${tr} ms`);
                }

                // ã€LAN è¯­è¨€ç½‘ç»œç»´åº¦ã€‘
                if(mods['Language_VFT']) {
                    const words = mods['Language_VFT'].data.summary.total_valid_words;
                    const alertHtml = words < 12 ? alertTag('è¯­ä¹‰æå–éšœç¢') : '';
                    htmlMap.LAN += buildItem('ğŸ—£ï¸ VFT ç±»åˆ«è¯æ±‡æµç•…æ€§:', `${words} è¯`, alertHtml);
                    if(words < 12) { chartScores.LAN -= 30; riskScores.AD += 30; clinicalFlags.push('è¯­ä¹‰ç½‘ç»œæå–é˜»æ»'); }
                    activeRiskModules.AD += 30;
                }
                if(mods['Voice_Biomarkers']) {
                    const ratio = mods['Voice_Biomarkers'].data.summary.silence_ratio_percent || mods['Voice_Biomarkers'].data.summary.pause_ratio || 0;
                    const alertHtml = ratio > 40 ? alertTag('æ‰¾è¯å›°éš¾/ç©ºæ´è¨€è¯­') : '';
                    htmlMap.LAN += buildItem('ğŸ™ï¸ VBM æ‰¾è¯ç©ºæ´/é™é»˜æ¯”:', `${ratio}%`, alertHtml);
                    if(ratio > 35) { chartScores.LAN -= 20; riskScores.MDD += 20; riskScores.AD += 15; clinicalFlags.push('è¨€è¯­åŠ¨åŠ›ç¼ºä¹/ç©ºæ´'); }
                    activeRiskModules.MDD += 20; activeRiskModules.AD += 15;
                }

                // ã€MOT åŠ¨åŠ›å­¦ä¸è¿åŠ¨ç»´åº¦ã€‘
                if(mods['MOT_AFT']) {
                    const fatigue = mods['MOT_AFT'].data.summary.fatigue_index_percent;
                    const alertHtml = fatigue > 20 ? alertTag('å‰‚æœ«è¡°ç«­ä¸¥é‡') : '';
                    htmlMap.MOT += buildItem('ğŸ‘‡ AFT äº¤æ›¿æ•²å‡»å‰‚æœ«è¡°å‡:', `${fatigue}%`, alertHtml);
                    if(fatigue > 15) { chartScores.MOT -= 15; riskScores.PD += 40; clinicalFlags.push('åŸºåº•èŠ‚è¿åŠ¨è¡°ç«­'); }
                    activeRiskModules.PD += 40;
                }
                if(mods['MOT_SRT']) {
                    const srt = mods['MOT_SRT'].data.summary.mean_rt_ms;
                    htmlMap.MOT += buildItem('âš¡ SRT ç®€å•è¿åŠ¨ååº”æ—¶:', `${srt} ms`);
                }
                if(mods['MOT_Keystroke']) {
                    const cv = mods['MOT_Keystroke'].data.summary.dwell_cv;
                    const alertHtml = cv > 25 ? alertTag('Dwellå˜å¼‚(è‚Œå¼ºç›´)') : '';
                    htmlMap.MOT += buildItem('âŒ¨ï¸ æŒ‰é”®æ»ç•™æ—¶é—´è‚Œå¼ºç›´ CV:', `${cv}%`, alertHtml);
                    if(cv > 20) { chartScores.MOT -= 15; riskScores.PD += 35; clinicalFlags.push('éšåŒ¿æ€§æ‰‹æŒ‡è‚Œå¼ºç›´'); }
                    activeRiskModules.PD += 35;
                }
                if(mods['MOT_DualTaskGait']) {
                    const gaitCV = mods['MOT_DualTaskGait'].data.summary.stride_time_cv_percent || mods['MOT_DualTaskGait'].data.summary.variability_cv || 0;
                    const alertHtml = gaitCV > 5.0 ? alertTag('é«˜å±è·Œå€’æ­¥é¢‘') : '';
                    htmlMap.MOT += buildItem('ğŸš¶â€â™‚ï¸ IMU åŒé‡ä»»åŠ¡æ­¥æ€å˜å¼‚:', `${gaitCV}%`, alertHtml);
                    if(gaitCV > 4.0) { chartScores.MOT -= 20; riskScores.PD += 25; clinicalFlags.push('æ­¥æ€å¤±è¡¡/è·Œå€’é«˜å±'); }
                    activeRiskModules.PD += 25;
                }
                if(mods['MOT_dCDT']) {
                    const inair = mods['MOT_dCDT'].data.summary.in_air_sec;
                    const alertHtml = inair > 6.0 ? alertTag('ç©ºä¸­æ€ç»´æ‚¬åœè¿‡é•¿', 'warning') : '';
                    htmlMap.MOT += buildItem('âœï¸ dCDT ç”»é’Ÿç©ºä¸­æ‚¬åœæ—¶é—´:', `${inair} s`, alertHtml);
                    if(inair > 5.0) { chartScores.MOT -= 15; riskScores.AD += 20; clinicalFlags.push('è§†ç©ºé—´è§£æ„è¿Ÿç–‘'); }
                    activeRiskModules.AD += 20;
                }

                // ã€EMO & PHY æƒ…æ„Ÿä¸ç”Ÿç†ç»´åº¦ã€‘
                if(mods['AEMO_IAT']) {
                    const bias = mods['AEMO_IAT'].data.implicit_bias_ms;
                    const alertHtml = bias > 150 ? alertTag('å†…éšæŠ‘éƒåç½®') : '';
                    htmlMap.EMO += buildItem('âš¡ IAT å†…éšè´Ÿæ€§è”æƒ³é˜»åŠ›:', `${bias} ms`, alertHtml);
                    if(bias > 100) { chartScores.EMO -= 15; riskScores.MDD += 30; clinicalFlags.push('ä¸¥é‡å†…éšè´Ÿæ€§åç½®'); }
                    activeRiskModules.MDD += 30;
                }
                if(mods['AEMO_ERT']) {
                    const ert = mods['AEMO_ERT'].data.regulation_capacity;
                    const alertHtml = ert <= 0 ? alertTag('å‰é¢å¶æŠ‘åˆ¶å¤±è´¥') : '';
                    htmlMap.EMO += buildItem('ğŸ–¼ï¸ ERT å‰é¢å¶è°ƒèŠ‚å·®å€¼:', `${ert}`, alertHtml);
                    if(ert < 5) { chartScores.EMO -= 20; riskScores.MDD += 25; clinicalFlags.push('æƒ…ç»ªä¸‹è°ƒæŠ‘åˆ¶å¤±è´¥'); }
                    activeRiskModules.MDD += 25;
                }
                if(mods['Emotion_FER']) {
                    const acc = mods['Emotion_FER'].data.summary.overall_accuracy_percent;
                    htmlMap.EMO += buildItem('ğŸ˜ƒ FER é¢å­”æƒ…ç»ªè¯†åˆ«å‡†ç¡®ç‡:', `${acc}%`);
                }
                if(mods['PHY_Face_rPPG']) {
                    const rmssd = mods['PHY_Face_rPPG'].data.summary.estimated_rmssd_ms || 0;
                    const hr = mods['PHY_Face_rPPG'].data.summary.estimated_hr_bpm || '-';
                    const alertHtml = (rmssd < 20 && rmssd > 0) ? alertTag('è¿·èµ°å¼ åŠ›æŠ‘åˆ¶') : '';
                    htmlMap.PHY += buildItem('ğŸ¥ rPPG æ‹Ÿåˆå¿ƒç‡/RMSSD:', `${hr} bpm / ${rmssd} ms`, alertHtml);
                    if(rmssd < 20 && rmssd > 0) { chartScores.PHY -= 20; riskScores.MDD += 25; clinicalFlags.push('è‡ªä¸»ç¥ç»/è¿·èµ°æ·±åº¦æŠ‘åˆ¶'); }
                    activeRiskModules.MDD += 25;
                }
                
                // ã€LIF èŠ‚å¾‹ä¸ç”Ÿæ´»ç»´åº¦ã€‘
                if(mods['LIF_Lifestyle']) {
                    const lif = mods['LIF_Lifestyle'].data.summary.avg_decision_hesitation_ms;
                    const alertHtml = lif > 5000 ? alertTag('éšæ€§å†³ç­–è¿Ÿç–‘', 'warning') : '';
                    htmlMap.LIF += buildItem('ğŸ¥— LIF æ—¥å¸¸åŠŸèƒ½å†³ç­–è¿Ÿç–‘:', `${lif} ms`, alertHtml);
                    if(lif > 5000) { chartScores.LIF -= 15; riskScores.AD += 15; clinicalFlags.push('éšåŒ¿æ€§ç”Ÿæ´»èƒ½åŠ›è¡°é€€');}
                    activeRiskModules.AD += 15;
                }

            } catch(e) { 
                console.error("æ¨¡å—è§£æå‡ºç°å¼‚å¸¸:", e); 
            }

            // ================= 4. æ¸²æŸ“æ˜ç»†åº“ä¸å›¾è¡¨ =================
            
            // æ‹¼æ¥åŸå§‹ç»“æœæ–‡æœ¬åº“
            let out = '';
            for(let key of ['COG','MOT','EMO','SEN','LAN','LIF','PHY']) {
                if(htmlMap[key]) {
                    let domainName = '';
                    if(key==='COG') domainName='ğŸ§  è®¤çŸ¥æ‰§è¡Œä¸è­¦è§‰ç½‘ç»œ';
                    else if(key==='MOT') domainName='ğŸ¯ è¿åŠ¨å…±æµä¸å¾®è§‚åŠ¨åŠ›å­¦';
                    else if(key==='EMO') domainName='â¤ï¸ æƒ…ç»ªè°ƒèŠ‚ä¸è®¡ç®—ç²¾ç¥ç—…å­¦';
                    else if(key==='SEN') domainName='âš¡ æ„Ÿè§‰çŸ¥è§‰åº•åº§';
                    else if(key==='LAN') domainName='ğŸ’¬ è¯­è¨€ä¸è¯­éŸ³å£°å­¦';
                    else if(key==='LIF') domainName='ğŸŒ™ ä¸´åºŠç”Ÿæ´»èŠ‚å¾‹';
                    else if(key==='PHY') domainName='ğŸ¥ ç”Ÿç†å½±åƒä¸è¡€æµåŠ¨åŠ›å­¦';
                    out += `<div class="domain-section"><div class="domain-title">${domainName}</div>${htmlMap[key]}</div>`;
                }
            }
            document.getElementById('results-content').innerHTML = out || '<p style="color:var(--slate);">æ¡£æ¡ˆä¸­æœªè¯»å–åˆ°æœ‰æ•ˆçš„æ¨¡å—åˆ†ææ•°æ®ã€‚</p>';

            // æ¸²æŸ“å…­å¤§åŸºå¸¦é›·è¾¾æ¡åŠ¨ç”»
            setTimeout(() => { 
                for(let key in chartScores) {
                    let score = Math.max(0, Math.round(chartScores[key]));
                    if(!htmlMap[key]) score = 0; // è‹¥è¯¥ç»´åº¦æ— æ•°æ®ï¼Œç½®é›¶
                    document.getElementById(`bar-${key.toLowerCase()}`).style.width = score + '%';
                    document.getElementById(`val-${key.toLowerCase()}`).innerText = score;
                }
            }, 300);

            // ================= 5. è®¡ç®—ç²¾ç¥ç—…å­¦ï¼šæ¸²æŸ“è”åˆé£é™©é›·è¾¾ =================
            document.getElementById('risk-panel').style.display = 'block';
            
            // åŠ¨æ€æƒé‡å½’ä¸€åŒ–å‡½æ•°ï¼šåŸºäºå®é™…å®Œæˆçš„é¶å‘æ¨¡å—æŠ˜ç®—é£é™©ç™¾åˆ†æ¯”
            const setRiskBar = (id, score, maxPotential) => {
                let pct = maxPotential > 0 ? Math.min(100, Math.round((score / maxPotential) * 100)) : 0;
                let bar = document.getElementById(`risk-bar-${id}`);
                
                bar.style.width = pct + '%';
                bar.className = 'risk-bar-fill ' + (pct < 30 ? 'risk-low' : (pct < 60 ? 'risk-med' : 'risk-high'));
                
                let valNode = document.getElementById(`risk-val-${id}`);
                valNode.innerText = maxPotential > 0 ? `${pct}%` : 'æœªæµ‹é¶å‘æ¨¡å—';
                valNode.style.color = (pct >= 60) ? 'var(--red)' : '';
                return pct;
            };

            const finalRisks = {
                AD: setRiskBar('ad', riskScores.AD, activeRiskModules.AD),
                MDD: setRiskBar('mdd', riskScores.MDD, activeRiskModules.MDD),
                PD: setRiskBar('pd', riskScores.PD, activeRiskModules.PD),
                ATT: setRiskBar('att', riskScores.ATT, activeRiskModules.ATT)
            };

            // ================= 6. å°†è®¡ç®—é£é™©æ ‡ç­¾å†™å›åº•å±‚ JSON =================
            if (mode !== 'file') {
                // å°†å¸¦æœ‰ AI åˆç­›é¢„è­¦çš„æ•°æ®è¿›è¡Œæœ¬åœ°åŒ–æŒä¹…ä¿å­˜
                CAS_Storage.saveRiskProfile(finalRisks, clinicalFlags);
            } else {
                // å¦‚æœæ˜¯è¯»å–å¤–éƒ¨ JSON é¢„è§ˆï¼Œä»…åœ¨å†…å­˜ä¸­æ›´æ–°ï¼Œä»¥ä¾›â€œå¯¼å‡ºâ€æ—¶ä½¿ç”¨
                session.computational_risk_profile = { 
                    generated_at: new Date().toISOString(), 
                    risk_scores: finalRisks, 
                    clinical_flags: clinicalFlags 
                };
                
                // è¦†ç›– exportJSON ä¸´æ—¶é€»è¾‘ï¼Œç›´æ¥ä¸‹è½½è¡¥å…¨äº†é£é™©æ ‡ç­¾çš„ JSON
                window.temporarySessionExport = function() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(session, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    const subId = (session.demographics && session.demographics.subject_id) ? session.demographics.subject_id : "Anonymous";
                    downloadAnchorNode.setAttribute("download", `CAS_Data_Sub-${subId}_RiskUpdated_${new Date().toISOString().replace(/[:.]/g, '-')}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    document.body.removeChild(downloadAnchorNode);
                };
                document.querySelector('.btn-export').setAttribute('onclick', 'window.temporarySessionExport()');
            }
            
            // è§†çª—æ»šåŠ¨åé¦ˆ
            document.querySelector('.chart-container').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
