<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CAS - ä¸´åºŠæ•°å­—è¡¨å‹å…¨æ™¯æ•°æ®è§£æ (v3.0)</title>
    <style>
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --amber: #f59e0b; --purple: #8b5cf6; --teal: #0d9488; --slate: #64748b; }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; padding: 30px; color: #334155; line-height: 1.6; }
        .container { max-width: 1050px; margin: auto; background: white; padding: 45px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        h2 { color: var(--blue); border-bottom: 3px solid var(--light-blue); padding-bottom: 15px; margin-top: 0; display: flex; align-items: center; gap: 10px;}
        
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; background: #f8fafc; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; }
        .info-item span { display: block; font-size: 13.5px; color: var(--slate); font-weight: bold; margin-bottom: 4px;}
        .info-item strong { font-size: 18px; color: var(--primary); }

        .progress-box { margin-bottom: 40px; }
        .progress-bar { width: 100%; height: 16px; background: #e2e8f0; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        /* é›·è¾¾å›¾è¡¨åŒº */
        .chart-container { background: white; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 1px solid #e2e8f0; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .chart-container h3 { margin-top: 0; color: var(--primary); display: flex; justify-content: space-between; align-items: center;}
        .chart-badge { font-size: 13px; background: var(--light-blue); color: var(--blue); padding: 5px 12px; border-radius: 12px; font-weight: normal; }
        .bar-row { display: flex; align-items: center; margin-bottom: 15px; }
        .bar-label { width: 150px; font-weight: bold; color: var(--slate); font-size: 14.5px; display: flex; align-items: center; gap: 8px; }
        .bar-track { flex: 1; height: 20px; background: #f1f5f9; border-radius: 10px; position: relative; overflow: hidden;}
        .bar-fill { height: 100%; border-radius: 10px; width: 0%; transition: width 1.5s; }
        .bar-value { width: 50px; text-align: right; font-weight: bold; color: var(--primary); font-size: 16px; }

        .fill-cog { background: linear-gradient(90deg, #818cf8, #4f46e5); } .fill-emo { background: linear-gradient(90deg, #fb7185, #e11d48); }
        .fill-mot { background: linear-gradient(90deg, #fcd34d, #f59e0b); } .fill-sen { background: linear-gradient(90deg, #fef08a, #eab308); }
        .fill-lan { background: linear-gradient(90deg, #c084fc, #9333ea); } .fill-lif { background: linear-gradient(90deg, #2dd4bf, #0d9488); }

        /* ä¸´åºŠæŠ¥å‘ŠåŒºå—åŒ– */
        .results-box { background: #f8fafc; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 2px dashed #cbd5e1; }
        .domain-section { margin-bottom: 25px; }
        .domain-title { font-size: 16px; font-weight: bold; color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 12px; display: flex; gap: 8px; align-items: center;}
        .result-item { font-size: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid #f1f5f9;}
        .result-item strong { color: var(--primary); font-family: monospace; font-size: 16px;}
        .alert-badge { color: white; background: var(--red); font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: bold; margin-left: 10px;}

        .btn-group { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 10px; }
        .btn { padding: 20px; border: none; border-radius: 16px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-export { background: var(--green); color: white; font-size: 18px; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2); }
        .btn-export:hover { background: #059669; transform: translateY(-2px); }
        .btn-preview { background: var(--slate); color: white; }
        .preview-box { background: #0f172a; padding: 20px; border-radius: 16px; margin-top: 25px; display: none; }
        .preview-box textarea { width: 100%; height: 400px; background: transparent; color: #10b981; border: none; font-family: monospace; outline: none; resize: vertical; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer; font-size: 16px; margin-bottom: 20px;">â† è¿”å›æµ‹è¯•æ§åˆ¶å°</button>

    <div class="container">
        <h2>ğŸ“Š CAS å¤šæ¨¡æ€å…¨æ™¯æ•°å­—è¡¨å‹æ¡£æ¡ˆ</h2>
        
        <div class="info-grid" id="info-panel">
            <div class="info-item"><span>è¢«è¯• ID</span><strong id="r-id">-</strong></div>
            <div class="info-item"><span>å§“åç¼©å†™</span><strong id="r-name">-</strong></div>
            <div class="info-item"><span>æ€§åˆ« / å‡ºç”Ÿ</span><strong id="r-bio">-</strong></div>
            <div class="info-item"><span>åˆ©æ‰‹ (Handedness)</span><strong id="r-hand">-</strong></div>
            <div class="info-item"><span>æ•™è‚²æ°´å¹³ (Education)</span><strong id="r-edu">-</strong></div>
            <div class="info-item"><span>æŠ¥å‘Šç”Ÿæˆæ—¶é—´</span><strong id="r-time">-</strong></div>
        </div>

        <div class="progress-box">
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom: 8px;">
                <span style="color:var(--primary);">æ•°æ®é‡‡é›†å®Œæ•´åº¦ (åŠ¨æ€æ£€æµ‹)</span>
                <span id="prog-text" style="color:var(--green);">0 é¡¹</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="fill"></div></div>
        </div>

        <div class="chart-container">
            <h3>å¤šç»´ç¥ç»å¥åº·ç‰¹å¾å›¾è°± <span class="chart-badge">åŸºäºé¢„è®¾å¸¸æ¨¡å¤šæ¨¡æ€æ¢ç®—</span></h3>
            <div class="bar-row"><div class="bar-label"><span>ğŸ§ </span> è®¤çŸ¥æ‰§è¡Œ (COG)</div><div class="bar-track"><div class="bar-fill fill-cog" id="bar-cog"></div></div><div class="bar-value" id="val-cog">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>â¤ï¸</span> æƒ…ç»ªç¤¾ä¼š (EMO)</div><div class="bar-track"><div class="bar-fill fill-emo" id="bar-emo"></div></div><div class="bar-value" id="val-emo">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>ğŸ¯</span> è¿åŠ¨å…±æµ (MOT)</div><div class="bar-track"><div class="bar-fill fill-mot" id="bar-mot"></div></div><div class="bar-value" id="val-mot">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>âš¡</span> æ„Ÿè§‰çŸ¥è§‰ (SEN)</div><div class="bar-track"><div class="bar-fill fill-sen" id="bar-sen"></div></div><div class="bar-value" id="val-sen">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>ğŸ’¬</span> è¯­è¨€ç½‘ç»œ (LAN)</div><div class="bar-track"><div class="bar-fill fill-lan" id="bar-lan"></div></div><div class="bar-value" id="val-lan">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>ğŸŒ™</span> ç”Ÿæ´»åŠŸèƒ½ (LIF)</div><div class="bar-track"><div class="bar-fill fill-lif" id="bar-lif"></div></div><div class="bar-value" id="val-lif">0</div></div>
        </div>

        <div class="results-box" id="readable-results">
            <h3 style="border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 0; color:var(--primary);">ğŸ“‹ æ ¸å¿ƒæŒ‡æ ‡è§£æåº“ (ä¾›ç›´æ¥å¤åˆ¶)</h3>
            <div id="results-content"><p style="color:var(--slate); font-size:14px;">ç­‰å¾…è§£æå¼•æ“è¯»å–ç¼“å­˜æ•°æ®...</p></div>
        </div>

        <div class="btn-group">
            <button class="btn btn-export" onclick="CAS_Storage.exportJSON()">ğŸ“¥ ç¡®è®¤æ— è¯¯ï¼Œä¸€é”®å¯¼å‡º JSON ç‰¹å¾å…¨é›†</button>
            <button class="btn btn-preview" onclick="togglePreview()">ğŸ‘€ å±•å¼€ JSON æºç é¢„è§ˆ</button>
        </div>
        <div class="preview-box" id="preview-panel"><textarea id="json-code" readonly></textarea></div>
    </div>

    <script>
        window.onload = function() {
            const session = CAS_Storage.getSession();
            
            // 1. åŸºçº¿å¡«å……
            if(session && session.demographics) {
                document.getElementById('r-id').innerText = session.demographics.subject_id || '-';
                document.getElementById('r-name').innerText = session.demographics.name || '-';
                document.getElementById('r-bio').innerText = `${session.demographics.gender} / ${session.demographics.dob}`;
                document.getElementById('r-hand').innerText = session.demographics.handedness || '-';
                document.getElementById('r-edu').innerText = session.demographics.education_level || '-';
                document.getElementById('r-time').innerText = new Date(session.start_time).toLocaleString();
            }

            const mods = session.modules || {};
            
            // 2. åŠ¨æ€è¿›åº¦æ¡è®¡ç®— (æ€»é‡æŒ‰æ‰€æœ‰å¯èƒ½æ¨¡å—è®¡ï¼Œçº¦ä¸º25)
            const completedCount = Object.keys(mods).length;
            const TOTAL_MODULES = 25; 
            const pct = Math.min(Math.round((completedCount / TOTAL_MODULES) * 100), 100);
            setTimeout(() => { document.getElementById('fill').style.width = pct + '%'; }, 300);
            document.getElementById('prog-text').innerText = `${completedCount} ä¸ªç»„ä»¶å·²å®Œæˆé‡‡é›†`;

            // ================= 3. é«˜çº§ç‰¹å¾è§£æä¸èåˆæ‰“åˆ† =================
            let htmlMap = { COG:'', EMO:'', MOT:'', SEN:'', LAN:'', LIF:'', PHY:'' };
            let chartScores = { COG: 50, EMO: 50, MOT: 100, SEN: 50, LAN: 50, LIF: 100 }; // åŸºç¡€åˆ†è®¾å®š

            // ã€è®¤çŸ¥ COGã€‘
            if(mods['COG_Corsi']) {
                let span = mods['COG_Corsi'].data.max_span;
                htmlMap.COG += `<div class="result-item"><span>ğŸ§© Corsi ç©ºé—´æé™å¹¿åº¦:</span> <strong>${span}</strong></div>`;
                chartScores.COG = Math.min(100, (span / 8) * 100);
            }
            if(mods['COG_TMT_B']) {
                htmlMap.COG += `<div class="result-item"><span>ğŸ”— TMT-B ä»»åŠ¡åˆ‡æ¢ (è€—æ—¶/é”™è¯¯):</span> <strong>${mods['COG_TMT_B'].data.total_time_ms} ms / ${mods['COG_TMT_B'].data.errors} æ¬¡</strong></div>`;
            }

            // ã€æƒ…æ„Ÿ EMOã€‘
            if(mods['Emotion_FER']) {
                const recs = mods['Emotion_FER'].data.records;
                const acc = Math.round((recs.filter(r => r.correct).length / recs.length) * 100) || 0;
                htmlMap.EMO += `<div class="result-item"><span>ğŸ˜ƒ FER é¢å­”æƒ…ç»ªè¯†åˆ«å‡†ç¡®ç‡:</span> <strong>${acc}%</strong></div>`;
                chartScores.EMO = acc;
            }

            // ã€è¿åŠ¨ä¸åŠ¨åŠ›å­¦ MOTã€‘ (å¤šæ¨¡æ€èåˆè®¡ç®—)
            if(mods['MOT_Tapping']) {
                htmlMap.MOT += `<div class="result-item"><span>â±ï¸ Tapping 10ç§’å¿«é€Ÿæ•²å‡»:</span> <strong>${mods['MOT_Tapping'].data.total_taps} æ¬¡</strong></div>`;
            }
            if(mods['MOT_dCDT']) {
                const dcdt = mods['MOT_dCDT'].data.summary;
                let alert = dcdt.in_air_sec > 5.0 ? `<span class="alert-badge">æ€è€ƒåœé¡¿åé•¿</span>` : "";
                htmlMap.MOT += `<div class="result-item"><span>âœï¸ ç”»é’ŸåŠ¨åŠ›å­¦ (è½ç¬”/ç©ºä¸­æ‚¬åœ):</span> <strong>${dcdt.on_surface_sec}s / ${dcdt.in_air_sec}s ${alert}</strong></div>`;
                chartScores.MOT -= (dcdt.in_air_sec > 5 ? (dcdt.in_air_sec - 5) * 2 : 0); // æƒ©ç½šç©ºä¸­åœé¡¿
            }
            if(mods['MOT_DualTaskGait']) {
                const gait = mods['MOT_DualTaskGait'].data.summary;
                let alert = gait.variability_cv > 20.0 ? `<span class="alert-badge">æ­¥æ€å˜å¼‚é«˜å±</span>` : "";
                htmlMap.MOT += `<div class="result-item"><span>ğŸš¶â€â™‚ï¸ åŒé‡ä»»åŠ¡æ­¥æ€ (æ­¥é¢‘/å˜å¼‚ç³»æ•°):</span> <strong>${gait.cadence_spm} æ­¥/åˆ† | CV: ${gait.variability_cv}% ${alert}</strong></div>`;
                chartScores.MOT -= (gait.variability_cv > 15 ? (gait.variability_cv - 15) : 0); // æƒ©ç½šä¸å¹³ç¨³
            }
            if(mods['MOT_Keystroke']) {
                const key = mods['MOT_Keystroke'].data.summary;
                let alert = key.avg_dwell_ms > 150 ? `<span class="alert-badge">ä¸¥é‡æŒ‰é”®ç²˜æ»</span>` : "";
                htmlMap.MOT += `<div class="result-item"><span>âŒ¨ï¸ æŒ‰é”®åŠ¨åŠ›å­¦ (å¹³å‡æ»ç•™æ—¶é—´ Dwell):</span> <strong>${key.avg_dwell_ms} ms ${alert}</strong></div>`;
                chartScores.MOT -= (key.avg_dwell_ms > 100 ? (key.avg_dwell_ms - 100) / 3 : 0); // æƒ©ç½šç²˜æ»
            }

            // ã€è¯­è¨€ä¸å£°å­¦ LANã€‘
            if(mods['Language_VFT']) {
                const words = mods['Language_VFT'].data.words ? mods['Language_VFT'].data.words.length : 0;
                htmlMap.LAN += `<div class="result-item"><span>ğŸ—£ï¸ VFT è¯­ä¹‰æå– (1åˆ†é’Ÿ):</span> <strong>${words} è¯</strong></div>`;
                chartScores.LAN = Math.min(100, (words / 15) * 100);
            }
            if(mods['Voice_Biomarkers']) {
                const vbm = mods['Voice_Biomarkers'].data;
                let alert = vbm.pause_ratio > 40 ? `<span class="alert-badge">è¯é—´åœé¡¿>40%</span>` : "";
                htmlMap.LAN += `<div class="result-item"><span>ğŸ™ï¸ VBM å£°å­¦ç‰¹å¾ (æ—¶é•¿/åœé¡¿æ¯”):</span> <strong>${vbm.duration_sec}s / ${vbm.pause_ratio}% ${alert}</strong></div>`;
                chartScores.LAN = (chartScores.LAN + Math.max(0, 100 - vbm.pause_ratio)) / 2; // èåˆåœé¡¿æƒ©ç½š
            }

            // ã€æ„Ÿè§‰ SENã€‘
            if(mods['SEN_GoNoGo']) {
                const recs = mods['SEN_GoNoGo'].data.records;
                const acc = Math.round((recs.filter(r => r.correct).length / recs.length) * 100) || 0;
                htmlMap.SEN += `<div class="result-item"><span>ğŸ›‘ Go/No-Go å†²åŠ¨æŠ‘åˆ¶å‡†ç¡®ç‡:</span> <strong>${acc}%</strong></div>`;
                chartScores.SEN = acc;
            }

            // ã€ç”Ÿæ´» LIFã€‘
            if(mods['Lifestyle_IADL']) {
                const iadlScore = mods['Lifestyle_IADL'].data.iadl_impairment_score;
                let alert = iadlScore > 0 ? `<span class="alert-badge">å·¥å…·æ—¥å¸¸å—æŸ</span>` : "";
                htmlMap.LIF += `<div class="result-item"><span>ğŸ› ï¸ IADL éšœç¢å¾—åˆ†:</span> <strong>${iadlScore} åˆ† ${alert}</strong></div>`;
                chartScores.LIF -= (iadlScore * 10);
            }

            // ã€ç”Ÿç†ä¸å½±åƒ PHYã€‘
            if(mods['PHY_Face_rPPG']) {
                const rppg = mods['PHY_Face_rPPG'].data;
                htmlMap.PHY += `<div class="result-item"><span>ğŸ¥ é¢éƒ¨å½±åƒ (å½•åˆ¶æ—¶é•¿/æ•°æ®åŒ…):</span> <strong>${rppg.duration_sec}s / ${rppg.video_size_mb} MB <span style="font-size:12px;color:#64748b;">(å¾…äº‘ç«¯è§£ç®—)</span></strong></div>`;
            }

            // ================= 4. åˆ†å—æ¸²æŸ“ DOM =================
            let finalOutput = '';
            if(htmlMap.COG !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸ§  è®¤çŸ¥æ‰§è¡Œç½‘ç»œ</div>${htmlMap.COG}</div>`;
            if(htmlMap.MOT !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸ¯ è¿åŠ¨å…±æµä¸åŠ¨åŠ›å­¦</div>${htmlMap.MOT}</div>`;
            if(htmlMap.LAN !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸ’¬ è¯­è¨€ä¸å‘å£°è®¡ç®—</div>${htmlMap.LAN}</div>`;
            if(htmlMap.EMO !== '') finalOutput += `<div class="domain-section"><div class="domain-title">â¤ï¸ æƒ…ç»ªä¸ç¤¾ä¼šè®¤çŸ¥</div>${htmlMap.EMO}</div>`;
            if(htmlMap.SEN !== '') finalOutput += `<div class="domain-section"><div class="domain-title">âš¡ æ„Ÿè§‰çŸ¥è§‰åº•åº§</div>${htmlMap.SEN}</div>`;
            if(htmlMap.LIF !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸŒ™ ä¸´åºŠé‰´åˆ«ä¸ç”Ÿæ´»</div>${htmlMap.LIF}</div>`;
            if(htmlMap.PHY !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸ¥ å½±åƒä¸è¡€æµåŠ¨åŠ›å­¦</div>${htmlMap.PHY}</div>`;
            
            if(finalOutput !== '') {
                document.getElementById('results-content').innerHTML = finalOutput;
            }

            // æ¸²æŸ“å¯è§†åŒ–å›¾è¡¨åŠ¨ç”» (çº¦æŸæœ€å°å€¼ä¸º0)
            setTimeout(() => { 
                ['COG', 'EMO', 'MOT', 'SEN', 'LAN', 'LIF'].forEach(domain => { 
                    let score = Math.max(0, Math.round(chartScores[domain])); 
                    document.getElementById(`bar-${domain.toLowerCase()}`).style.width = score + '%'; 
                    document.getElementById(`val-${domain.toLowerCase()}`).innerText = score; 
                }); 
            }, 600);

            // å‡†å¤‡ JSON å¯¼å‡º
            session.end_time = new Date().toISOString(); 
            document.getElementById('json-code').value = JSON.stringify(session, null, 2);
        };

        function togglePreview() { 
            const panel = document.getElementById('preview-panel'); 
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block'; 
        }
    </script>
</body>
</html>
