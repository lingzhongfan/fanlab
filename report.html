<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>NeuroMap - ç¥ç»è¡Œä¸ºå¤šæ¨¡æ€è¯„ä¼°å›¾è°±ç³»ç»Ÿ (v4.0)</title>
    <style>
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --amber: #f59e0b; --purple: #8b5cf6; --teal: #0d9488; --slate: #64748b; }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: #fcfcfd; padding: 30px; color: #334155; line-height: 1.6; margin: 0;}
        .container { max-width: 1050px; margin: auto; background: white; padding: 45px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        h2 { color: var(--blue); border-bottom: 3px solid var(--light-blue); padding-bottom: 15px; margin-top: 0; display: flex; align-items: center; gap: 10px;}
        
        /* ==================== é¡¶éƒ¨è¾“å…¥ä¸å¯¼å…¥é¢æ¿ (Input Panel) ==================== */
        .input-panel { background: #f8fafc; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 35px; }
        .input-panel h3 { margin-top: 0; font-size: 16px; color: var(--primary); border-bottom: 1px dashed #cbd5e1; padding-bottom: 10px;}
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-size: 13px; font-weight: bold; color: var(--slate); }
        .form-input { padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 15px; outline: none; font-weight: bold; color: var(--primary);}
        .form-input:focus { border-color: var(--blue); }
        .btn-file-wrapper { position: relative; overflow: hidden; display: inline-block; margin-top: 5px;}
        .btn-file-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%;}
        .btn-action { padding: 12px 20px; background: white; border: 2px solid var(--blue); color: var(--blue); border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; text-align: center; display: block; width: 100%; box-sizing: border-box;}
        .btn-action:hover { background: var(--light-blue); }
        .btn-generate { margin-top: 20px; width: 100%; padding: 15px; background: var(--blue); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.2);}
        .btn-generate:hover { transform: translateY(-2px); }

        /* ==================== æŠ¥å‘Šå†…å®¹åŒº (Output) ==================== */
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; background: #f8fafc; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; }
        .info-item span { display: block; font-size: 13.5px; color: var(--slate); font-weight: bold; margin-bottom: 4px;}
        .info-item strong { font-size: 18px; color: var(--primary); }

        /* åŠ¨æ€è¿›åº¦æ¡ */
        .progress-box { margin-bottom: 40px; }
        .progress-bar { width: 100%; height: 16px; background: #e2e8f0; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        /* æ¸å˜é›·è¾¾å›¾è¡¨åŒº (åŸç‰ˆä¿ç•™) */
        .chart-container { background: white; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 1px solid #e2e8f0; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .chart-container h3 { margin-top: 0; color: var(--primary); display: flex; justify-content: space-between; align-items: center;}
        .chart-badge { font-size: 13px; background: var(--light-blue); color: var(--blue); padding: 5px 12px; border-radius: 12px; font-weight: normal; }
        .bar-row { display: flex; align-items: center; margin-bottom: 15px; }
        .bar-label { width: 150px; font-weight: bold; color: var(--slate); font-size: 14.5px; display: flex; align-items: center; gap: 8px; }
        .bar-track { flex: 1; height: 20px; background: #f1f5f9; border-radius: 10px; position: relative; overflow: hidden;}
        .bar-fill { height: 100%; border-radius: 10px; width: 0%; transition: width 1.5s; }
        .bar-value { width: 50px; text-align: right; font-weight: bold; color: var(--primary); font-size: 16px; }

        .fill-cog { background: linear-gradient(90deg, #818cf8, #4f46e5); } .fill-emo { background: linear-gradient(90deg, #fb7185, #e11d48); }
        .fill-mot { background: linear-gradient(90deg, #fcd34d, #f59e0b); } .fill-sen { background: linear-gradient(90deg, #fef08a, #eab308); }
        .fill-lan { background: linear-gradient(90deg, #c084fc, #9333ea); } .fill-lif { background: linear-gradient(90deg, #2dd4bf, #0d9488); }

        /* ä¸´åºŠæŠ¥å‘ŠåŒºå—åŒ– */
        .results-box { background: #f8fafc; padding: 30px; border-radius: 20px; margin-bottom: 35px; border: 2px dashed #cbd5e1; }
        .domain-section { margin-bottom: 25px; break-inside: avoid; }
        .domain-title { font-size: 16px; font-weight: bold; color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 12px; display: flex; gap: 8px; align-items: center;}
        .result-item { font-size: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid #f1f5f9;}
        .result-item strong { color: var(--primary); font-family: monospace; font-size: 16px;}
        .alert-badge { color: white; background: var(--red); font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: bold; margin-left: 10px;}
        .warning-badge { color: white; background: var(--amber); font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: bold; margin-left: 10px;}
        
        .notes-display { background: #fffbeb; border-left: 4px solid var(--amber); padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 14px; color: #92400e; }

        .btn-group { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 10px; }
        .btn { padding: 20px; border: none; border-radius: 16px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-export { background: var(--green); color: white; font-size: 18px; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2); }
        .btn-export:hover { background: #059669; transform: translateY(-2px); }
        .btn-preview { background: var(--slate); color: white; }
        .preview-box { background: #0f172a; padding: 20px; border-radius: 16px; margin-top: 25px; display: none; }
        .preview-box textarea { width: 100%; height: 400px; background: transparent; color: #10b981; border: none; font-family: monospace; outline: none; resize: vertical; }
        
        @media print {
            body { background: white; padding: 0; }
            .input-panel, .btn-group, button { display: none !important; }
            .container { box-shadow: none; padding: 0; max-width: 100%; }
        }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <div class="container">
        <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--blue); font-weight:bold; cursor:pointer; font-size: 16px; margin-bottom: 20px;">â† è¿”å›æµ‹è¯•æ§åˆ¶å°</button>

        <div class="input-panel">
            <h3>âš™ï¸ æ•°æ®èåˆä¸ä¸´åºŠæ§åˆ¶å°</h3>
            <div class="input-grid">
                <div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label>æ•°æ®è¯»å–æ¨¡å¼</label>
                        <select id="data-source-select" class="form-input" onchange="toggleFileUploader()">
                            <option value="local">è¯»å–å½“å‰è®¾å¤‡ç¼“å­˜ (æ­£åœ¨æµ‹è¯•æ‚£è€…)</option>
                            <option value="file">å¯¼å…¥å†å² BIDS-JSON æ¡£æ¡ˆ</option>
                        </select>
                    </div>
                    <div class="btn-file-wrapper" id="file-uploader" style="display:none;">
                        <span class="btn-action" id="btn-file-label">ğŸ“‚ ç‚¹å‡»é€‰æ‹© JSON æ–‡ä»¶</span>
                        <input type="file" id="json-file-input" accept=".json">
                    </div>
                </div>
                <div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div class="form-group" style="flex:1;">
                            <label>MMSE å¾—åˆ† (0-30)</label>
                            <input type="number" id="input-mmse" class="form-input" placeholder="é€‰å¡«">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>MoCA å¾—åˆ† (0-30)</label>
                            <input type="number" id="input-moca" class="form-input" placeholder="é€‰å¡«">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ä¸»è¯•ä¸´åºŠè§‚å¯Ÿè¯„è¯­ (å°†å°äºæŠ¥å‘Š)</label>
                        <input type="text" id="input-notes" class="form-input" placeholder="é€‰å¡«ï¼šå¦‚è®°å½•æ‚£è€…éœ‡é¢¤æƒ…å†µ">
                    </div>
                </div>
            </div>
            <button class="btn-generate" onclick="generateReport()">âš¡ èåˆä¸´åºŠæ•°æ®ï¼Œç”Ÿæˆ V4.0 å›¾è°±æŠ¥å‘Š</button>
        </div>

        <h2>ğŸ“Š NeuroMap ç¥ç»è¡Œä¸ºå¤šæ¨¡æ€è¯„ä¼°å›¾è°±æ¡£æ¡ˆ</h2>
        
        <div class="info-grid" id="info-panel">
            <div class="info-item"><span>è¢«è¯• ID</span><strong id="r-id">-</strong></div>
            <div class="info-item"><span>å§“åç¼©å†™</span><strong id="r-name">-</strong></div>
            <div class="info-item"><span>æ€§åˆ« / å‡ºç”Ÿ</span><strong id="r-bio">-</strong></div>
            <div class="info-item"><span>MMSE / MoCA</span><strong id="r-scales" style="color:var(--blue);">- / -</strong></div>
            <div class="info-item"><span>EMA å³°å€¼ç–²åŠ³</span><strong id="r-fatigue">-</strong></div>
            <div class="info-item"><span>æŠ¥å‘Šç”Ÿæˆæ—¶é—´</span><strong id="r-time">-</strong></div>
        </div>

        <div class="progress-box">
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom: 8px;">
                <span style="color:var(--primary);">é«˜é€šé‡æ•°æ®é‡‡é›†å®Œæ•´åº¦</span>
                <span id="prog-text" style="color:var(--green);">0 é¡¹å®Œæˆ</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="fill"></div></div>
        </div>

        <div class="chart-container">
            <h3>å¤šç»´ç¥ç»å¥åº·ç‰¹å¾å›¾è°± <span class="chart-badge">åŸºäºé¢„è®¾å¸¸æ¨¡å¤šæ¨¡æ€æ¢ç®—</span></h3>
            <div class="bar-row"><div class="bar-label"><span>ğŸ§ </span> è®¤çŸ¥æ‰§è¡Œ (COG)</div><div class="bar-track"><div class="bar-fill fill-cog" id="bar-cog"></div></div><div class="bar-value" id="val-cog">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>â¤ï¸</span> æƒ…ç»ªç¤¾ä¼š (EMO)</div><div class="bar-track"><div class="bar-fill fill-emo" id="bar-emo"></div></div><div class="bar-value" id="val-emo">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>ğŸ¯</span> è¿åŠ¨å…±æµ (MOT)</div><div class="bar-track"><div class="bar-fill fill-mot" id="bar-mot"></div></div><div class="bar-value" id="val-mot">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>âš¡</span> æ„Ÿè§‰çŸ¥è§‰ (SEN)</div><div class="bar-track"><div class="bar-fill fill-sen" id="bar-sen"></div></div><div class="bar-value" id="val-sen">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>ğŸ’¬</span> è¯­è¨€ç½‘ç»œ (LAN)</div><div class="bar-track"><div class="bar-fill fill-lan" id="bar-lan"></div></div><div class="bar-value" id="val-lan">0</div></div>
            <div class="bar-row"><div class="bar-label"><span>ğŸŒ™</span> ç”Ÿæ´»åŠŸèƒ½ (LIF)</div><div class="bar-track"><div class="bar-fill fill-lif" id="bar-lif"></div></div><div class="bar-value" id="val-lif">0</div></div>
        </div>

        <div class="results-box" id="readable-results">
            <h3 style="border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 0; color:var(--primary);">ğŸ“‹ æ ¸å¿ƒæŒ‡æ ‡è§£æåº“ (ä¾›ç›´æ¥å¤åˆ¶)</h3>
            <div id="results-content"><p style="color:var(--slate); font-size:14px;">è¯·åœ¨ä¸Šæ–¹ç‚¹å‡»ã€ç”ŸæˆæŠ¥å‘Šã€‘è¯»å–æ•°æ®...</p></div>
            <div id="notes-display" class="notes-display" style="display:none;"></div>
        </div>

        <div class="btn-group">
            <button class="btn btn-export" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°ä¸´åºŠåˆ†ææŠ¥å‘Š</button>
            <button class="btn btn-preview" onclick="togglePreview()">ğŸ‘€ å±•å¼€ JSON æºç è¿½è¸ª</button>
        </div>
        <div class="preview-box" id="preview-panel"><textarea id="json-code" readonly></textarea></div>
    </div>

    <script>
        // ================= æ•°æ®å¯¼å…¥é€»è¾‘ =================
        let importedSessionData = null;

        function toggleFileUploader() {
            const mode = document.getElementById('data-source-select').value;
            document.getElementById('file-uploader').style.display = (mode === 'file') ? 'block' : 'none';
        }

        document.getElementById('json-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('btn-file-label').innerText = "âœ… " + file.name;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    importedSessionData = JSON.parse(event.target.result);
                } catch(err) {
                    alert("âš ï¸ JSON æ¡£æ¡ˆè§£æå¤±è´¥ï¼");
                    importedSessionData = null;
                }
            };
            reader.readAsText(file);
        });

        // ================= V4.0 è§£æä¸æ¸²æŸ“å¼•æ“ =================
        function generateReport() {
            // 1. è·å–æ•°æ®æº
            const mode = document.getElementById('data-source-select').value;
            let session;
            if (mode === 'file') {
                if (!importedSessionData) return alert("âš ï¸ è¯·å…ˆä¸Šä¼  JSON æ–‡ä»¶");
                session = importedSessionData;
            } else {
                session = CAS_Storage.getSession();
            }

            // 2. åŸºçº¿ä¿¡æ¯ä¸æ‰‹åŠ¨è¾“å…¥å¡«å……
            if(session.demographics) {
                document.getElementById('r-id').innerText = session.demographics.subject_id || '-';
                document.getElementById('r-name').innerText = session.demographics.name || '-';
                document.getElementById('r-bio').innerText = `${session.demographics.gender || '-'} / ${session.demographics.dob || '-'}`;
                document.getElementById('r-hand').innerText = session.demographics.handedness || '-';
                document.getElementById('r-edu').innerText = session.demographics.education_level || session.demographics.education_years || '-';
                document.getElementById('r-time').innerText = new Date().toLocaleString();
            }

            const mmse = document.getElementById('input-mmse').value || '--';
            const moca = document.getElementById('input-moca').value || '--';
            document.getElementById('r-scales').innerText = `${mmse} / ${moca}`;

            // EMA ç–²åŠ³å¤„ç†
            if(session.ema_fatigue_logs && session.ema_fatigue_logs.length > 0) {
                let maxFatigue = Math.max(...session.ema_fatigue_logs.map(log => log.fatigue_score));
                document.getElementById('r-fatigue').innerText = maxFatigue;
            } else {
                document.getElementById('r-fatigue').innerText = "0";
            }

            // ä¸»è¯•è¯„è¯­å¤„ç†
            const notes = document.getElementById('input-notes').value.trim();
            if(notes) {
                document.getElementById('notes-display').style.display = 'block';
                document.getElementById('notes-display').innerHTML = `<strong>ğŸ‘¨â€âš•ï¸ ä¸´åºŠè§‚å¯Ÿï¼š</strong>${notes}`;
            } else {
                document.getElementById('notes-display').style.display = 'none';
            }

            const mods = session.modules || {};
            
            // 3. åŠ¨æ€è¿›åº¦æ¡è®¡ç®—
            const completedCount = Object.keys(mods).length;
            const TOTAL_MODULES = 13; // V4.0æ ¸å¿ƒæ¨¡å—æ•°
            const pct = Math.min(Math.round((completedCount / TOTAL_MODULES) * 100), 100);
            document.getElementById('fill').style.width = pct + '%';
            document.getElementById('prog-text').innerText = `${completedCount} ä¸ªç»„ä»¶æ•°æ®å·²è½½å…¥`;

            // ================= 4. é«˜ç»´æ•°å­—è¡¨å‹è§£æ =================
            let htmlMap = { COG:'', EMO:'', MOT:'', SEN:'', LAN:'', LIF:'', PHY:'' };
            let chartScores = { COG: 100, EMO: 100, MOT: 100, SEN: 100, LAN: 100, LIF: 100 };

            const buildItem = (label, value, alertHtml = '') => `<div class="result-item"><span>${label}</span><strong>${value} ${alertHtml}</strong></div>`;
            const alertTag = (text, type='danger') => `<span class="${type==='warning'?'warning-badge':'alert-badge'}">${text}</span>`;

            try {
                // ã€COG & SEN è®¤çŸ¥è­¦è§‰ã€‘
                if(mods['COG_Corsi']) {
                    const span = mods['COG_Corsi'].data.max_span;
                    htmlMap.COG += buildItem('ğŸ§© Corsi ç©ºé—´æé™å¹¿åº¦:', `${span}`);
                    if(span < 4) chartScores.COG -= 15;
                }
                if(mods['COG_DSST']) {
                    const count = mods['COG_DSST'].data.correct_count;
                    htmlMap.COG += buildItem('ğŸ”¢ DSST é™æ—¶åŠ å·¥é€Ÿåº¦:', `${count} ä¸ª`);
                    if(count < 25) chartScores.COG -= 15;
                }
                if(mods['COG_TMT_B']) {
                    const tmt = mods['COG_TMT_B'].data;
                    const alert = tmt.total_time_ms > 100000 ? alertTag('æ‰§è¡Œç½‘ç»œè¿Ÿç¼“') : '';
                    htmlMap.COG += buildItem('ğŸ”— TMT-B ä»»åŠ¡åˆ‡æ¢ (è€—æ—¶/é”™è¯¯):', `${(tmt.total_time_ms/1000).toFixed(1)}s / ${tmt.errors}æ¬¡`, alert);
                    if(tmt.total_time_ms > 100000) chartScores.COG -= 20;
                }
                if(mods['SEN_PVT']) {
                    const pvt = mods['SEN_PVT'].data.summary;
                    const alert = pvt.lapses > 3 ? alertTag('è“æ–‘è­¦è§‰å¤±è¯¯', 'warning') : '';
                    htmlMap.SEN += buildItem('â±ï¸ PVT æŒç»­è­¦è§‰ (Lapses >500ms):', `${pvt.lapses} æ¬¡`, alert);
                    chartScores.SEN -= (pvt.lapses * 5);
                }

                // ã€LAN è¯­è¨€ç½‘ç»œã€‘
                if(mods['Language_VFT']) {
                    const vft = mods['Language_VFT'].data.summary;
                    const alert = vft.total_valid_words < 12 ? alertTag('è¯­ä¹‰æå–éšœç¢') : '';
                    htmlMap.LAN += buildItem('ğŸ—£ï¸ VFT è¯æ±‡æµç•…æ€§ (60sè¾“å‡º/IWI):', `${vft.total_valid_words} è¯ / ${vft.avg_inter_word_interval_ms}ms`, alert);
                    if(vft.total_valid_words < 15) chartScores.LAN -= (15 - vft.total_valid_words) * 3;
                }
                if(mods['Voice_Biomarkers']) {
                    const vbm = mods['Voice_Biomarkers'].data.summary || mods['Voice_Biomarkers'].data;
                    const ratio = vbm.silence_ratio_percent || vbm.pause_ratio;
                    const alert = ratio > 40 ? alertTag('æ‰¾è¯å›°éš¾/ç©ºæ´è¨€è¯­') : '';
                    htmlMap.LAN += buildItem('ğŸ™ï¸ VBM è¯­éŸ³ç‰¹å¾ (é™é»˜åœé¡¿æ¯”ä¾‹):', `${ratio}%`, alert);
                    if(ratio > 30) chartScores.LAN -= (ratio - 30);
                }

                // ã€MOT åŠ¨åŠ›å­¦ã€‘
                if(mods['MOT_Keystroke']) {
                    const key = mods['MOT_Keystroke'].data.summary;
                    const alert = key.dwell_cv > 25 ? alertTag('Dwellå˜å¼‚(è‚Œå¼ºç›´)') : '';
                    htmlMap.MOT += buildItem('âŒ¨ï¸ æŒ‰é”®å¾®è§‚åŠ¨åŠ›å­¦ (é•¿æ–‡æœ¬å‡Dwell/CV):', `${key.avg_dwell_ms}ms / ${key.dwell_cv}%`, alert);
                    if(key.dwell_cv > 20) chartScores.MOT -= (key.dwell_cv - 20) * 1.5;
                }
                if(mods['MOT_DualTaskGait']) {
                    const gait = mods['MOT_DualTaskGait'].data.summary;
                    const cv = gait.stride_time_cv_percent || gait.variability_cv;
                    const alert = cv > 5.0 ? alertTag('é«˜å±è·Œå€’æ­¥é¢‘') : '';
                    htmlMap.MOT += buildItem('ğŸš¶â€â™‚ï¸ åŒé‡æ­¥æ€ (å‡7å¹²æ‰°æ­¥é¢‘CV):', `${cv}%`, alert);
                    if(cv > 4.0) chartScores.MOT -= (cv - 4.0) * 5;
                }
                if(mods['MOT_dCDT']) {
                    const dcdt = mods['MOT_dCDT'].data.summary;
                    const alert = dcdt.in_air_sec > 5.0 ? alertTag('ç©ºä¸­æ€ç»´æ‚¬åœ', 'warning') : '';
                    htmlMap.MOT += buildItem('âœï¸ dCDT ç”»é’ŸåŠ¨åŠ›å­¦ (æ‚¬ç©ºæ€è€ƒæ—¶é—´):', `${dcdt.in_air_sec} s`, alert);
                    if(dcdt.in_air_sec > 5.0) chartScores.MOT -= (dcdt.in_air_sec - 5.0) * 4;
                }

                // ã€EMO æƒ…ç»ªç¤¾ä¼šã€‘
                if(mods['Emotion_FER']) {
                    const fer = mods['Emotion_FER'].data.summary || { overall_accuracy_percent: 100 };
                    let fearAcc = fer.emotion_specific_matrix ? fer.emotion_specific_matrix['fear'].accuracy_percent : fer.overall_accuracy_percent;
                    const alert = fearAcc < 60 ? alertTag('ç‰¹å¼‚æ€§ææƒ§è¯†åˆ«éšœç¢') : '';
                    htmlMap.EMO += buildItem('ğŸ˜ƒ FER é¢å­”æƒ…ç»ªè¯†åˆ« (æ€»å‡†ç¡®ç‡/ææƒ§è¯†åˆ«):', `${fer.overall_accuracy_percent}% / ${fearAcc}%`, alert);
                    if(fearAcc < 60) chartScores.EMO -= 15;
                }
                if(mods['AEMO_ERT']) {
                    const ert = mods['AEMO_ERT'].data;
                    const alert = ert.regulation_capacity <= 0 ? alertTag('å‰é¢å¶æŠ‘åˆ¶å¤±è´¥') : '';
                    htmlMap.EMO += buildItem('ğŸ–¼ï¸ ERT è®¤çŸ¥é‡è¯„ (dlPFCè°ƒèŠ‚åŠ›):', `${ert.regulation_capacity}`, alert);
                    if(ert.regulation_capacity < 10) chartScores.EMO -= (10 - Math.max(0, ert.regulation_capacity)) * 2;
                }
                if(mods['AEMO_IAT']) {
                    const iat = mods['AEMO_IAT'].data;
                    const alert = iat.implicit_bias_ms > 150 ? alertTag('å†…éšæŠ‘éƒåç½®') : '';
                    htmlMap.EMO += buildItem('âš¡ IAT å†…éšè”æƒ³ (D-Scoreé˜»åŠ›å·®):', `${iat.implicit_bias_ms} ms`, alert);
                    if(iat.implicit_bias_ms > 100) chartScores.EMO -= (iat.implicit_bias_ms - 100) * 0.2;
                }

                // ã€PHY ç”Ÿç†ã€‘
                if(mods['PHY_Face_rPPG']) {
                    const rppg = mods['PHY_Face_rPPG'].data.summary || mods['PHY_Face_rPPG'].data;
                    const rmssd = rppg.estimated_rmssd_ms || 0;
                    const alert = (rmssd < 20 && rmssd > 0) ? alertTag('è¿·èµ°å¼ åŠ›æŠ‘åˆ¶') : '';
                    htmlMap.PHY += buildItem('ğŸ¥ rPPG å½±åƒè¡€æµ (æ‹ŸåˆHR/RMSSD):', `${rppg.estimated_hr_bpm || '-'} bpm / ${rmssd} ms`, alert);
                }

                // ã€LIF èŠ‚å¾‹ã€‘
                if(mods['LIF_Lifestyle'] || mods['Lifestyle_IADL']) {
                    const lif = mods['LIF_Lifestyle'] ? mods['LIF_Lifestyle'].data.summary : mods['Lifestyle_IADL'].data;
                    const score = lif.iadl_impairment_score || 0;
                    const alert1 = score >= 2 ? alertTag('ç”Ÿæ´»è‡ªç†å—æŸ') : '';
                    htmlMap.LIF += buildItem('ğŸ¥— IADL åŠŸèƒ½é‡è¡¨ (å—æŸæ‰£åˆ†):', `${score} åˆ†`, alert1);
                    chartScores.LIF -= (score * 15);
                }

            } catch(e) {
                console.error("æ•°æ®ç»“æ„é€‚é…å¼‚å¸¸:", e);
                document.getElementById('results-content').innerHTML = `<div style="color:var(--red); font-weight:bold;">âš ï¸ è·¨ç‰ˆæœ¬æ•°æ®è§£æå¼‚å¸¸ï¼Œè¯·åœ¨é¡¶éƒ¨å¯¼å…¥æ ‡å‡†çš„ V4.0 JSON æ¡£æ¡ˆã€‚</div>`;
                return;
            }

            // ================= 5. DOM åˆ†å—æ¸²æŸ“ä¸å›¾è¡¨æ›´æ–° =================
            let finalOutput = '';
            if(htmlMap.COG !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸ§  è®¤çŸ¥æ‰§è¡Œç½‘ç»œ</div>${htmlMap.COG}</div>`;
            if(htmlMap.MOT !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸ¯ è¿åŠ¨å…±æµä¸åŠ¨åŠ›å­¦</div>${htmlMap.MOT}</div>`;
            if(htmlMap.LAN !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸ’¬ è¯­è¨€ä¸è¯­éŸ³è®¡ç®—</div>${htmlMap.LAN}</div>`;
            if(htmlMap.EMO !== '') finalOutput += `<div class="domain-section"><div class="domain-title">â¤ï¸ æƒ…ç»ªä¸ç¤¾ä¼šè®¤çŸ¥</div>${htmlMap.EMO}</div>`;
            if(htmlMap.SEN !== '') finalOutput += `<div class="domain-section"><div class="domain-title">âš¡ æ„Ÿè§‰çŸ¥è§‰åº•åº§</div>${htmlMap.SEN}</div>`;
            if(htmlMap.LIF !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸŒ™ ä¸´åºŠé‰´åˆ«ä¸èŠ‚å¾‹</div>${htmlMap.LIF}</div>`;
            if(htmlMap.PHY !== '') finalOutput += `<div class="domain-section"><div class="domain-title">ğŸ¥ å½±åƒä¸è¡€æµåŠ¨åŠ›å­¦</div>${htmlMap.PHY}</div>`;
            
            if(finalOutput !== '') {
                document.getElementById('results-content').innerHTML = finalOutput;
            }

            // å½’é›¶é‡ç½®å›¾è¡¨åŠ¨ç”»
            ['COG', 'EMO', 'MOT', 'SEN', 'LAN', 'LIF'].forEach(d => { document.getElementById(`bar-${d.toLowerCase()}`).style.width = '0%'; });
            
            setTimeout(() => { 
                ['COG', 'EMO', 'MOT', 'SEN', 'LAN', 'LIF'].forEach(domain => { 
                    let score = Math.max(0, Math.min(100, Math.round(chartScores[domain]))); 
                    if(htmlMap[domain] === '') score = 0; // è‹¥æ— æ•°æ®åˆ™å½’é›¶
                    document.getElementById(`bar-${domain.toLowerCase()}`).style.width = score + '%'; 
                    document.getElementById(`val-${domain.toLowerCase()}`).innerText = score; 
                }); 
            }, 300);

            // å‡†å¤‡ JSON è¾“å‡º
            session.end_time = new Date().toISOString(); 
            document.getElementById('json-code').value = JSON.stringify(session, null, 2);
        }

        function togglePreview() { 
            const panel = document.getElementById('preview-panel'); 
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block'; 
        }
    </script>
</body>
</html>
