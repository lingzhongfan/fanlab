<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-PHY | å½±åƒè¡€æµä¸ç”Ÿç†è®¡ç®— (ç§‘ç ”å®Œå…¨ä½“ v4.0)</title>
    <style>
        /* ==================== UI ä¸è‰²å½©è§„èŒƒ ==================== */
        :root { --primary: #1e293b; --blue: #4f46e5; --rose: #e11d48; --red: #f43f5e; --pink: #fdf2f8; --slate: #64748b; --green: #10b981; --bg: #fcfcfd; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); user-select: none; }
        .container { max-width: 900px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--rose); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        /* ä¸´åºŠæŒ‡å¯¼è¯­åŒºå— */
        .instruction-box { background: var(--pink); border: 2px dashed #fda4af; padding: 25px; border-radius: 16px; margin-bottom: 25px; }
        .instruction-box p { margin: 0 0 10px 0; color: #be123c; font-weight: bold; font-size: 16px; }
        .instruction-box ul { margin: 0; padding-left: 20px; color: #9f1239; font-size: 15px; line-height: 1.5; }

        /* è§†é¢‘ä¸ ROI æå–åŒº */
        .camera-workspace { display: flex; gap: 20px; margin-bottom: 20px; }
        .video-container { position: relative; width: 320px; height: 240px; background: #0f172a; border-radius: 16px; overflow: hidden; border: 4px solid #cbd5e1; box-shadow: 0 10px 20px rgba(0,0,0,0.1);}
        video { display: block; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* é•œåƒç¿»è½¬ */ }
        canvas.overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; transform: scaleX(-1); }

        /* å®æ—¶çŠ¶æ€ä¸æ³¢å½¢å›¾ */
        .signal-board { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .timer-display { font-size: 40px; font-weight: bold; color: var(--primary); font-family: monospace; text-align: center; background: #f8fafc; border-radius: 16px; border: 2px solid #e2e8f0; padding: 10px; }
        .timer-alert { color: var(--red); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .ppg-visualizer { width: 100%; height: 130px; background: #0f172a; border-radius: 16px; position: relative; overflow: hidden; border: 2px solid #cbd5e1;}
        .ppg-visualizer canvas { width: 100%; height: 100%; display: block; }
        .sensor-badge { position: absolute; top: 10px; left: 10px; background: rgba(225,29,72,0.2); border: 1px solid rgba(225,29,72,0.5); color: #fda4af; font-size: 12px; padding: 4px 8px; border-radius: 6px; font-family: monospace; z-index: 10;}

        /* æ§åˆ¶æŒ‰é’® */
        .controls-board { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .sys-btn { padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-record { background: var(--rose); color: white; box-shadow: 0 8px 20px rgba(225, 29, 72, 0.2); }
        .btn-record:hover { background: #be123c; transform: translateY(-2px); }
        .btn-record:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; transform: none; }
        .btn-stop { background: var(--slate); color: white; }
        .btn-stop:hover { background: #475569; transform: translateY(-2px); }
        .btn-stop:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; transform: none;}

        /* ç‰¹å¾è®¡ç®—é¢æ¿ */
        .metrics-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .metric-card { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: center; }
        .metric-card span { display: block; font-size: 12px; color: var(--slate); font-weight: bold; margin-bottom: 5px; }
        .metric-card strong { font-size: 28px; color: var(--rose); font-family: monospace; }

        /* ä¸‹è½½åŒº */
        .download-box { background: #f0fdf4; border: 2px dashed #86efac; padding: 25px; border-radius: 16px; text-align: center; margin-top: 30px; }
        .btn-download { background: var(--green); color: white; padding: 18px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; border: none; transition: 0.2s; box-shadow: 0 5px 15px rgba(16, 185, 129, 0.2);}
        .btn-download:hover { background: #059669; transform: translateY(-2px); }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--rose); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="module-header">
            <h2>ğŸ¥ é¢éƒ¨å½±åƒè¡€æµè®¡ç®— (Face rPPG)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>è¯„ä¼°é™æ¯çŠ¶æ€ä¸‹çš„è‡ªä¸»ç¥ç»ç³»ç»Ÿ (ANS) åŠŸèƒ½ä¸è¿·èµ°ç¥ç»å¼ åŠ›ã€‚<br>
            *é€šè¿‡å‰ç½®æ‘„åƒå¤´æ•æ‰é¢éƒ¨é¢å¤´åŒºåŸŸ (ROI) çš„ç»¿å…‰é€šé“å˜å¼‚ï¼Œæå–å¿ƒç‡ (HR) ä¸å¿ƒç‡å˜å¼‚æ€§ (RMSSD)ã€‚</p>
        </div>

        <div class="instruction-box">
            <p>âš ï¸ ä¸´åºŠæ ‡å‡†æ“ä½œè§„ç¨‹ (SOP)ï¼š</p>
            <ul>
                <li><strong>å…‰æºè¦æ±‚ï¼š</strong>è¯·ç¡®ä¿å—è¯•è€…é¢éƒ¨å…‰çº¿å……è¶³ä¸”å‡åŒ€ï¼Œé¿å…é€†å…‰æˆ–å¼ºçƒˆçš„ä¾§å½±ã€‚</li>
                <li><strong>å§¿åŠ¿è¦æ±‚ï¼š</strong>è¯·å—è¯•è€…ä¿æŒæ­£è„¸é¢å¯¹é•œå¤´ï¼Œå°†ã€é¢å¤´åŒºåŸŸã€‘å¯¹å‡†ç”»é¢ä¸­çš„ç»¿è‰²æ–¹æ¡†ï¼Œæµ‹è¯•æœŸé—´ï¼ˆ60ç§’ï¼‰<strong>å°½é‡ä¸è¦è¯´è¯æˆ–æ™ƒåŠ¨å¤´éƒ¨</strong>ã€‚</li>
                <li><strong>æ•°æ®éšç§ï¼š</strong>æœ¬æ¨¡å—ä»…åœ¨å‰ç«¯é€å¸§æå– RGB åƒç´ çŸ©é˜µå‡å€¼ï¼Œ<strong>ç»å¯¹ä¸ä¼šå½•åˆ¶æˆ–ä¸Šä¼ ä»»ä½•é¢éƒ¨ç…§ç‰‡/è§†é¢‘æµ</strong>ï¼Œç¬¦åˆä¸´åºŠä¼¦ç†è¦æ±‚ã€‚</li>
            </ul>
        </div>

        <div class="camera-workspace">
            <div class="video-container">
                <video id="video-feed" autoplay playsinline muted></video>
                <canvas id="overlay-canvas" class="overlay"></canvas>
            </div>
            
            <div class="signal-board">
                <div class="timer-display" id="time-display">01:00</div>
                <div class="ppg-visualizer">
                    <div class="sensor-badge">BVP (Blood Volume Pulse)</div>
                    <canvas id="ppg-canvas"></canvas>
                </div>
            </div>
        </div>

        <div class="controls-board">
            <button class="sys-btn btn-record" id="btn-record" onclick="initCamera()">ğŸ“¹ æ­¥éª¤1: å¼€å¯æ‘„åƒå¤´é¢„è§ˆå¯¹ç„¦</button>
            <button class="sys-btn btn-stop" id="btn-stop" onclick="startRPPGTest()" disabled>â–¶ æ­¥éª¤2: å¯åŠ¨ 60ç§’ ç”Ÿç†é‡‡é›†</button>
        </div>

        <div class="metrics-board" style="opacity: 0.3; pointer-events: none;" id="metrics-board">
            <div class="metric-card"><span>å®æ—¶å¿ƒç‡ä¼°è®¡ (HR)</span><strong id="m-hr">-- bpm</strong></div>
            <div class="metric-card"><span>å¿ƒç‡å˜å¼‚æ€§ (RMSSD)</span><strong id="m-rmssd">-- ms</strong></div>
            <div class="metric-card"><span>æœ‰æ•ˆé‡‡é›†å¸§æ•° (FPS)</span><strong id="m-fps">--</strong></div>
        </div>

        <div id="download-area" class="download-box hidden">
            <h3 style="color:#166534; margin-top:0;">âœ… rPPG åŸå§‹æ—¶åºä¿¡å·æå–å®Œæˆ</h3>
            <p style="font-size:14px; color:#15803d; margin-bottom:20px;">æ‘˜è¦æŒ‡æ ‡å·²å­˜å…¥ç³»ç»Ÿä¸»åº“ã€‚ä¸ºç¡®ä¿è¾¾åˆ°é¡¶çº§åŒ»ç–—çº§æµ‹ç®—ç²¾åº¦ï¼Œç³»ç»Ÿå·²å°†è§†é¢‘æ¯å¸§çš„ç»å¯¹æ—¶é—´æˆ³ä¸ R, G, B å‡å€¼å°å­˜ã€‚è¯·ä¸‹è½½ CSVï¼Œå¹¶äº¤ä»˜åç«¯ä½¿ç”¨ PyVHR (ICA/EVM) ç­‰å¼€æºç®—æ³•åº“è¿›è¡Œå»å™ªå’Œ RR é—´æœŸæå–ã€‚</p>
            <button class="btn-download" id="btn-download-csv">â¬‡ï¸ å¯¼å‡ºå®Œæ•´é«˜é¢‘ RGB æ—¶åºæ•°æ® (CSV)</button>
        </div>
    </div>

    <script>
        const TEST_DURATION = 60; // ä¸´åºŠè§„èŒƒé€šå¸¸éœ€è¦ 1 åˆ†é’Ÿä»¥è®¡ç®—çŸ­æ—¶ HRV
        let timeLeft = TEST_DURATION;
        let testInterval = null;
        let isTesting = false;

        // æ ¸å¿ƒæ•°æ®ç»“æ„
        let rawRgbData = []; 
        let testOnset = 0;
        let framesCount = 0;

        // è§†é¢‘ä¸ Canvas å…ƒç´ 
        const video = document.getElementById('video-feed');
        const overlayCanvas = document.getElementById('overlay-canvas');
        const overlayCtx = overlayCanvas.getContext('2d', { willReadFrequently: true });
        
        const ppgCanvas = document.getElementById('ppg-canvas');
        const ppgCtx = ppgCanvas.getContext('2d');
        
        let videoStream = null;
        let extractionLoopId = null;

        // ROI (Region of Interest) å‚æ•°è®¾ç½®ï¼šé’ˆå¯¹é¢å¤´ä¸­å¿ƒåŒºåŸŸ
        const ROI_WIDTH = 60;
        const ROI_HEIGHT = 40;

        // å®æ—¶æ³¢å½¢ç»˜åˆ¶ç”¨æ•°ç»„
        const signalBuffer = new Array(200).fill(0);
        let lastPeakTime = 0;
        let rrIntervals = [];

        // ================= 1. æ‘„åƒå¤´åˆå§‹åŒ–ä¸ ROI ç»˜åˆ¶ =================
        async function initCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: 320, height: 240 } });
                video.srcObject = videoStream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    overlayCanvas.width = video.videoWidth;
                    overlayCanvas.height = video.videoHeight;
                    ppgCanvas.width = ppgCanvas.parentElement.clientWidth;
                    ppgCanvas.height = ppgCanvas.parentElement.clientHeight;
                    
                    document.getElementById('btn-record').disabled = true;
                    document.getElementById('btn-record').innerText = "âœ… æ‘„åƒå¤´å·²å°±ç»ª";
                    document.getElementById('btn-stop').disabled = false;
                    document.getElementById('btn-stop').style.background = 'var(--green)';
                    document.getElementById('btn-stop').innerText = "â–¶ æ­¥éª¤2: å¯åŠ¨ 60ç§’ ç”Ÿç†é‡‡é›†";
                    
                    // å¼€å§‹æ¸²æŸ“é¢„è§ˆæ¡†
                    drawOverlay();
                };
            } catch (err) {
                alert("âš ï¸ æ— æ³•è°ƒç”¨æ‘„åƒå¤´ï¼è¯·ç¡®ä¿æµè§ˆå™¨æ‹¥æœ‰æƒé™ï¼Œæˆ–å½“å‰å¤„äº HTTPS åŠ å¯†ç¯å¢ƒã€‚");
                console.error(err);
            }
        }

        function drawOverlay() {
            if (!isTesting) {
                extractionLoopId = requestAnimationFrame(drawOverlay);
            }
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // ç»˜åˆ¶ç»¿è‰²çš„é¢å¤´å¯¹å‡†æ¡†
            const startX = (overlayCanvas.width - ROI_WIDTH) / 2;
            const startY = overlayCanvas.height * 0.2; // é ä¸Šå¤§çº¦ 20% çš„ä½ç½®ï¼Œé€šå¸¸æ˜¯é¢å¤´
            
            overlayCtx.strokeStyle = 'rgba(16, 185, 129, 0.8)'; // Green
            overlayCtx.lineWidth = 3;
            overlayCtx.setLineDash([5, 5]);
            overlayCtx.strokeRect(startX, startY, ROI_WIDTH, ROI_HEIGHT);
            
            // ç»˜åˆ¶ç„å‡†åå­—
            overlayCtx.beginPath();
            overlayCtx.moveTo(startX + ROI_WIDTH/2, startY - 10);
            overlayCtx.lineTo(startX + ROI_WIDTH/2, startY + ROI_HEIGHT + 10);
            overlayCtx.moveTo(startX - 10, startY + ROI_HEIGHT/2);
            overlayCtx.lineTo(startX + ROI_WIDTH + 10, startY + ROI_HEIGHT/2);
            overlayCtx.stroke();
            overlayCtx.setLineDash([]);
        }

        // ================= 2. æ ¸å¿ƒæå–å¾ªç¯ (rPPG Pipeline) =================
        function startRPPGTest() {
            cancelAnimationFrame(extractionLoopId); // åœæ­¢å•çº¯çš„é¢„è§ˆ
            
            rawRgbData = [];
            rrIntervals = [];
            timeLeft = TEST_DURATION;
            framesCount = 0;
            isTesting = true;
            testOnset = performance.now();

            document.getElementById('btn-stop').disabled = true;
            document.getElementById('btn-stop').style.background = 'var(--slate)';
            document.getElementById('btn-stop').innerText = "é‡‡é›†ä¸­...";
            document.getElementById('metrics-board').style.opacity = '1';

            // å¯åŠ¨å€’è®¡æ—¶
            testInterval = setInterval(() => {
                timeLeft--;
                let sec = timeLeft < 10 ? '0' + timeLeft : timeLeft;
                document.getElementById('time-display').innerText = `00:${sec}`;
                
                if (timeLeft <= 10) document.getElementById('time-display').classList.add('timer-alert');
                
                if (timeLeft <= 0) {
                    stopRPPGTest();
                }
            }, 1000);

            // å¯åŠ¨è§†é¢‘æµåƒç´ æŠ“å–ä¸æ³¢å½¢æ¸²æŸ“
            extractFrame();
        }

        function extractFrame() {
            if (!isTesting) return;
            
            const now = performance.now();
            const relTimeMs = now - testOnset;

            // 1. å°†å½“å‰è§†é¢‘å¸§ç”»åˆ°éšå½¢/é‡å çš„ Canvas ä¸Š
            overlayCtx.drawImage(video, 0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // 2. æå– ROI åŒºåŸŸçš„å›¾åƒçŸ©é˜µæ•°æ®
            const startX = (overlayCanvas.width - ROI_WIDTH) / 2;
            const startY = overlayCanvas.height * 0.2;
            const frameData = overlayCtx.getImageData(startX, startY, ROI_WIDTH, ROI_HEIGHT);
            const data = frameData.data;

            // 3. è®¡ç®— ROI åŒºåŸŸ RGB å¹³å‡å€¼
            let sumR = 0, sumG = 0, sumB = 0;
            const pixelCount = ROI_WIDTH * ROI_HEIGHT;
            for (let i = 0; i < data.length; i += 4) {
                sumR += data[i];     // Red
                sumG += data[i + 1]; // Green (åŒ…å«æœ€å¤šè„‰æè¡€æµä¿¡æ¯)
                sumB += data[i + 2]; // Blue
            }
            const avgR = sumR / pixelCount;
            const avgG = sumG / pixelCount;
            const avgB = sumB / pixelCount;

            // å­˜å…¥åŸå§‹æ•°æ®åº“ä¾›åç»­å¯¼å‡º
            rawRgbData.push({ t: Math.round(relTimeMs), r: avgR.toFixed(3), g: avgG.toFixed(3), b: avgB.toFixed(3) });
            framesCount++;

            // ================= å‰ç«¯æ¨¡æ‹Ÿä¿¡å·å¤„ç†ä¸ç‰¹å¾æå– =================
            // å°† Green é€šé“æ¨å…¥ç¼“å†²ï¼Œå¹¶è¿›è¡Œæç®€çš„å»è¶‹åŠ¿æ»¤æ³¢ (Detrending)
            signalBuffer.push(avgG);
            signalBuffer.shift();

            // è®¡ç®—å‡å€¼åŸºçº¿
            const meanG = signalBuffer.reduce((a,b)=>a+b,0) / signalBuffer.length;
            
            // æå– AC äº¤æµåˆ†é‡ (å³è„‰ææ³¢åŠ¨)
            const acSignal = signalBuffer.map(val => val - meanG);

            // å‰ç«¯æ³¢å½¢ç»˜åˆ¶
            drawPPGWaveform(acSignal);

            // æç®€å³°å€¼æ£€æµ‹ (è¯„ä¼°å‰ç«¯å®æ—¶å¿ƒç‡ï¼Œä¸´åºŠä»¥å¯¼å‡ºæ•°æ®åç«¯å¤„ç†ä¸ºå‡†)
            const latestVal = acSignal[acSignal.length - 1];
            const prevVal = acSignal[acSignal.length - 2];
            const prevPrevVal = acSignal[acSignal.length - 3];
            
            // å¯»æ‰¾å±€éƒ¨æœ€å¤§å€¼ï¼Œå¹¶é™åˆ¶ä¸åˆç†çš„æçŸ­å¿ƒè·³ï¼ˆé˜²å™ªéŸ³é˜ˆå€¼ï¼‰
            if (prevVal > latestVal && prevVal > prevPrevVal && prevVal > 0.5) {
                if (lastPeakTime !== 0) {
                    const rr = now - lastPeakTime;
                    if (rr > 400 && rr < 1500) { // å¿ƒç‡åœ¨ 40 - 150 bpm ä¹‹é—´ç®—æœ‰æ•ˆ
                        rrIntervals.push(rr);
                        if(rrIntervals.length > 20) rrIntervals.shift(); // ç»´æŒä¸€ä¸ªæ»‘åŠ¨çª—å£
                        updateLiveMetrics();
                    }
                }
                lastPeakTime = now;
            }

            // é‡æ–°ç”»å›ç„å‡†æ¡†
            drawOverlay();

            // è¯·æ±‚ä¸‹ä¸€å¸§
            extractionLoopId = requestAnimationFrame(extractFrame);
        }

        function drawPPGWaveform(acSignal) {
            ppgCtx.fillStyle = '#0f172a';
            ppgCtx.fillRect(0, 0, ppgCanvas.width, ppgCanvas.height);
            
            ppgCtx.strokeStyle = '#e11d48'; // è„‰æçº¢
            ppgCtx.lineWidth = 2;
            ppgCtx.beginPath();
            
            const sliceWidth = ppgCanvas.width / acSignal.length;
            let drawX = 0;
            
            // å¯»æ‰¾æœ€å¤§æŒ¯å¹…ç”¨äºåŠ¨æ€ç¼©æ”¾ (è‡ªåŠ¨å¢ç›Š)
            const maxAmp = Math.max(...acSignal.map(Math.abs)) || 1;

            for(let i=0; i<acSignal.length; i++) {
                // åŠ¨æ€ç¼©æ”¾å¹¶å±…ä¸­
                let normalizedY = (acSignal[i] / maxAmp) * (ppgCanvas.height * 0.4); 
                let drawY = (ppgCanvas.height / 2) - normalizedY;
                
                if (i === 0) ppgCtx.moveTo(drawX, drawY);
                else ppgCtx.lineTo(drawX, drawY);
                drawX += sliceWidth;
            }
            ppgCtx.stroke();
        }

        function updateLiveMetrics() {
            if (rrIntervals.length < 5) return; // æ•°æ®å¤ªå°‘ä¸è®¡ç®—

            // è®¡ç®—å¹³å‡å¿ƒç‡ HR = 60000 / avg(RR)
            const meanRR = rrIntervals.reduce((a,b)=>a+b,0) / rrIntervals.length;
            const hr = 60000 / meanRR;

            // è®¡ç®— RMSSD: è¿ç»­ç›¸é‚» RR é—´æœŸå·®å€¼çš„å¹³æ–¹å’Œçš„å‡æ–¹æ ¹
            let sumSqDiff = 0;
            for(let i=1; i<rrIntervals.length; i++) {
                sumSqDiff += Math.pow(rrIntervals[i] - rrIntervals[i-1], 2);
            }
            const rmssd = Math.sqrt(sumSqDiff / (rrIntervals.length - 1));

            document.getElementById('m-hr').innerText = Math.round(hr) + ' bpm';
            document.getElementById('m-rmssd').innerText = Math.round(rmssd) + ' ms';
        }

        // ================= 3. ç»“æŸé‡‡é›†ä¸ç‰¹å¾æŒä¹…åŒ– =================
        function stopRPPGTest() {
            clearInterval(testInterval);
            cancelAnimationFrame(extractionLoopId);
            isTesting = false;

            // å…³é—­æ‘„åƒå¤´é‡Šæ”¾èµ„æº
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }

            document.getElementById('time-display').classList.remove('timer-alert');
            document.getElementById('btn-stop').innerText = "æµ‹è¯•å®Œæˆ";
            
            // è®¡ç®—æ•´ä½“å‰ç«¯æ‹Ÿåˆå‚æ•°
            let finalHR = parseInt(document.getElementById('m-hr').innerText) || 0;
            let finalRMSSD = parseInt(document.getElementById('m-rmssd').innerText) || 0;
            let avgFps = (framesCount / TEST_DURATION).toFixed(1);

            document.getElementById('m-fps').innerText = avgFps;

            let rppgSummary = {
                module: "PHY_Face_rPPG",
                summary: {
                    estimated_hr_bpm: finalHR,
                    estimated_rmssd_ms: finalRMSSD,
                    avg_fps: parseFloat(avgFps),
                    duration_sec: TEST_DURATION
                }
            };
            CAS_Storage.saveModuleData('PHY_Face_rPPG', rppgSummary);

            // å‡†å¤‡ CSV ä¸‹è½½
            setupCSVDownload();

            alert(`âœ… rPPG ç”Ÿç†ç‰¹å¾è®°å½•å®Œæˆï¼\n\n- æœ‰æ•ˆé‡‡é›†å¸§æ•°: ${framesCount} å¸§ (${avgFps} fps)\n- å®æ—¶æ‹Ÿåˆå¿ƒç‡: ${finalHR} bpm\n- æ‹Ÿåˆ RMSSD: ${finalRMSSD} ms\n\n*è¯·åŠ¡å¿…ä¸‹è½½å¹¶ä¿å­˜ CSV æºæ–‡ä»¶ï¼Œä¾›åç«¯ç§‘ç ”ç»„è°ƒç”¨ã€‚`);
        }

        function setupCSVDownload() {
            const dlArea = document.getElementById('download-area');
            const dlBtn = document.getElementById('btn-download-csv');
            dlArea.classList.remove('hidden');

            dlBtn.onclick = () => {
                let csvContent = "data:text/csv;charset=utf-8,Time_ms,Red_Avg,Green_Avg,Blue_Avg\n";
                rawRgbData.forEach(row => {
                    csvContent += `${row.t},${row.r},${row.g},${row.b}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const a = document.createElement("a");
                a.setAttribute("href", encodedUri);
                a.setAttribute("download", `CAS_rPPG_RGB_TimeSeries_${new Date().getTime()}.csv`);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
        }
    </script>
</body>
</html>
