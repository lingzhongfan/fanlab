<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-PHY | é¢éƒ¨å½±åƒä¸å¾®è¡¨æƒ…è®°å½•</title>
    <style>
        /* ç§‘æŠ€æ¸©æƒ…é£ UI */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --pink: #ec4899; --slate: #64748b; }
        body { font-family: -apple-system, sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        .module-header { border-left: 6px solid var(--pink); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .instruction-box { background: #fdf2f8; border: 2px dashed #fbcfe8; padding: 20px; border-radius: 16px; margin-bottom: 25px; font-size: 15px; color: #9d174d; }

        /* æ‘„åƒå¤´è§†çª—åŒº */
        .video-workspace { position: relative; width: 100%; height: 400px; background: #0f172a; border-radius: 20px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; border: 2px solid #cbd5e1; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);}
        
        /* é•œåƒæ˜¾ç¤ºçš„è§†é¢‘æµï¼Œç¬¦åˆäººç±»ç…§é•œå­çš„ä¹ æƒ¯ */
        #cam-preview { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.8; }
        
        /* å½•åˆ¶æ—¶è¦†ç›–åœ¨ç”»é¢ä¸Šçš„é™æ¯æ³¨è§†ç‚¹ */
        .fixation-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; background: rgba(0,0,0,0.4); display: none; }
        .crosshair { font-size: 80px; color: white; font-weight: bold; opacity: 0.8; margin-bottom: 20px;}
        .timer-text { font-family: monospace; font-size: 30px; color: var(--green); font-weight: bold; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 8px;}

        /* æ§åˆ¶æŒ‰é’® */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .btn { padding: 20px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-start { background: var(--blue); color: white; box-shadow: 0 8px 20px rgba(79, 70, 229, 0.2); }
        .btn-start:hover { background: #4338ca; }
        .btn-stop { background: var(--red); color: white; opacity: 0.5; cursor: not-allowed; }
        .btn-stop.active { opacity: 1; cursor: pointer; box-shadow: 0 8px 20px rgba(244, 63, 94, 0.2); }
        
        /* äººè„¸æ¡†è¾…åŠ©å¯¹é½ UI */
        .face-guide { position: absolute; width: 200px; height: 280px; border: 2px dashed rgba(255,255,255,0.5); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; top: 50px; pointer-events: none; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--pink); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container">
        <div class="module-header">
            <h2>ğŸ¥ å½±åƒè¡¨å‹ä¸ rPPG æå– (é™æ¯æ€)</h2>
            <p><strong>ä¸´åºŠé¶å‘ï¼š</strong>æ•æ‰å¾®è¡¨æƒ…å»¶è¿Ÿ (æƒ…æ„Ÿæ·¡æ¼ ) ä¸é¢éƒ¨è¡€æµå˜å¼‚ (è‡ªä¸»ç¥ç» HRV)ã€‚<br>
            ç³»ç»Ÿå°†å½•å–ä¸€æ®µ 60 ç§’çš„é«˜æ¸…é™æ¯æ€è§†é¢‘ï¼Œä¾›åç«¯æŠ½å–ç”Ÿç†æŒ‡æ ‡ã€‚</p>
        </div>
        

        <div class="instruction-box">
            <strong>ğŸ“‹ ä¸»è¯•æŒ‡å¯¼è¯­ï¼š</strong>â€œè¯·æ‚¨åæ­£ï¼Œè„¸éƒ¨å¯¹å‡†å±å¹•ä¸­å¤®çš„è™šçº¿æ¡†ã€‚ç‚¹å‡»å¼€å§‹åï¼Œè¯·æ”¾æ¾ï¼Œè‡ªç„¶å‘¼å¸ï¼Œå¹¶å…¨ç¨‹ç›¯ç€å±å¹•ä¸­å¤®çš„åå­—å…‰æ ‡ï¼Œå°½é‡ä¸è¦è¯´è¯æˆ–å¤§å¹…æ™ƒåŠ¨å¤´éƒ¨ã€‚â€
        </div>

        <div class="video-workspace">
            <video id="cam-preview" autoplay muted playsinline></video>
            <div class="face-guide" id="face-guide"></div>
            
            <div class="fixation-overlay" id="fixation-overlay">
                <div class="crosshair">+</div>
                <div class="timer-text" id="record-timer">00:00</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-start" id="btn-start" onclick="startCameraAndRecord()">ğŸ“· å¼€å¯ç›¸æœºå¹¶å½•åˆ¶</button>
            <button class="btn btn-stop" id="btn-stop" onclick="stopRecording()" disabled>â¹ æå‰ç»“æŸ</button>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let timerInterval;
        let elapsedSeconds = 0;
        const RECORD_LIMIT_SEC = 60; // ä¸´åºŠæ ‡å‡† 60 ç§’é™æ¯æ€

        async function startCameraAndRecord() {
            try {
                // è¯·æ±‚å‰ç½®æ‘„åƒå¤´ï¼Œé™åˆ¶å¸§ç‡ä¸º 30fps ä»¥ä¿è¯ rPPG é¢‘åŸŸåˆ†æçš„ç¨³å®šæ€§
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", frameRate: { ideal: 30, max: 30 }, width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false // çº¯å½±åƒåˆ†æä¸éœ€è¦éŸ³é¢‘ï¼Œå‡å°ä½“ç§¯
                });
                
                const videoElement = document.getElementById('cam-preview');
                videoElement.srcObject = stream;
                
                // ç»™å—è¯•è€… 3 ç§’æ—¶é—´å¯¹é½äººè„¸æ¡†
                document.getElementById('btn-start').innerText = "è¯·å¯¹é½äººè„¸ (3såè‡ªåŠ¨å½•åƒ)...";
                document.getElementById('btn-start').disabled = true;

                setTimeout(() => {
                    startRecordingEngine();
                }, 3000);

            } catch (err) {
                alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™ã€‚\né”™è¯¯: " + err);
            }
        }

        function startRecordingEngine() {
            // UI åˆ‡æ¢ï¼šéšè—äººè„¸è¾…åŠ©æ¡†ï¼Œæ˜¾ç¤ºé»‘å±åå­—æ³¨è§†ç‚¹
            document.getElementById('face-guide').style.display = 'none';
            document.getElementById('fixation-overlay').style.display = 'flex';
            
            document.getElementById('btn-start').innerText = "ğŸ”´ å½•åƒä¸­...";
            const btnStop = document.getElementById('btn-stop');
            btnStop.disabled = false; btnStop.classList.add('active');

            recordedChunks = [];
            // ä½¿ç”¨æé«˜å…¼å®¹æ€§çš„ webm æ ¼å¼æ‰“åŒ…è§†é¢‘æµ
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            
            mediaRecorder.ondataavailable = function(e) {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.start();
            
            // è®¡æ—¶å™¨
            elapsedSeconds = 0;
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                const mins = String(Math.floor(elapsedSeconds / 60)).padStart(2, '0');
                const secs = String(elapsedSeconds % 60).padStart(2, '0');
                document.getElementById('record-timer').innerText = `${mins}:${secs}`;
                
                // è¾¾åˆ° 60 ç§’è‡ªåŠ¨åœæ­¢
                if (elapsedSeconds >= RECORD_LIMIT_SEC) {
                    stopRecording();
                }
            }, 1000);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
            clearInterval(timerInterval);
            
            // å…³é—­æ‘„åƒå¤´ç¡¬ä»¶
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            document.getElementById('fixation-overlay').style.display = 'none';
            document.getElementById('btn-start').innerText = "âœ… å½•åˆ¶å®Œæˆ";
            document.getElementById('btn-stop').disabled = true;
            document.getElementById('btn-stop').classList.remove('active');

            mediaRecorder.onstop = () => {
                const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                
                // 1. ä¿å­˜å…ƒæ•°æ®åˆ° CAS ç»“æ„ä¸­
                const physioData = {
                    module: "PHY_Face_rPPG",
                    duration_sec: elapsedSeconds,
                    video_size_mb: (videoBlob.size / (1024 * 1024)).toFixed(2),
                    backend_processed: false
                };
                CAS_Storage.saveModuleData('PHY_Face_rPPG', physioData);

                // 2. æ¨¡æ‹Ÿåç«¯å‘é€æœºåˆ¶
                alert(`å½±åƒé‡‡é›†å®Œæˆï¼\n\n- æ—¶é•¿: ${elapsedSeconds}s\n- æ•°æ®åŒ…ä½“ç§¯: ${physioData.video_size_mb} MB\n\n*åå°é€»è¾‘æç¤º: è§†é¢‘æµ Blob å·²åœ¨å†…å­˜ä¸­å°±ç»ªã€‚æ‚¨å¯é€šè¿‡ REST API å°†å…¶å‘é€è‡³è£…æœ‰ OpenFace å’Œ PyVHR çš„ Python æœåŠ¡å™¨ï¼Œä»¥æå– FACS åŠ¨ä½œå•å…ƒï¼ˆAUsï¼‰å’Œ HRV å¿ƒç‡å˜å¼‚æ€§ã€‚`);
                
                setTimeout(() => { location.href = 'index.html'; }, 1000);
            };
        }
    </script>
</body>
</html>
