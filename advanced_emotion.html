<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroMap-AEMO | é«˜çº§æƒ…æ„Ÿä¸å†…éšè®¡ç®— (å®Œæ•´ç§‘ç ”ç‰ˆ)</title>
    <style>
        /* ç§‘æŠ€æ¸©æƒ…é£ UI */
        :root { --primary: #1e293b; --blue: #4f46e5; --light-blue: #eef2ff; --green: #10b981; --red: #f43f5e; --purple: #8b5cf6; --rose: #e11d48; --slate: #64748b; }
        body { font-family: -apple-system, sans-serif; background: #fcfcfd; margin: 0; padding: 20px; color: #334155; user-select: none; }
        .container { max-width: 800px; margin: 0 auto 30px; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        
        .module-header { border-left: 6px solid var(--rose); padding-left: 15px; margin-bottom: 25px; }
        .module-header h2 { margin: 0; font-size: 22px; color: var(--primary); }
        .module-header p { margin: 5px 0 0 0; color: var(--slate); font-size: 14px; line-height: 1.6; }

        .sys-btn { width: 100%; padding: 18px; margin-bottom: 15px; border: none; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; display: flex; align-items: center; justify-content: flex-start; gap: 12px; }
        .btn-menu { background: #fff1f2; color: var(--rose); border: 1px solid #ffe4e6; }
        .btn-menu:hover { background: var(--rose); color: white; transform: translateY(-2px); }
        .btn-action { background: var(--rose); color: white; justify-content: center; box-shadow: 0 8px 20px rgba(225, 29, 72, 0.2); }
        .btn-action:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        /* ERT æ ·å¼ */
        .stimulus-img { width: 100%; max-height: 400px; object-fit: contain; border-radius: 16px; background: #0f172a; margin-bottom: 20px;}
        .ert-slider-box { background: #f8fafc; padding: 25px; border-radius: 16px; border: 1px dashed #cbd5e1; margin-bottom: 20px; }
        .ert-instruction { font-size: 18px; color: var(--rose); font-weight: bold; text-align: center; margin-bottom: 20px; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; outline: none; margin: 20px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 30px; height: 30px; background: white; border: 4px solid var(--rose); border-radius: 50%; cursor: pointer; }
        
        /* IAT ä¸´åºŠå¤§å®¹é‡æ ·å¼ */
        .iat-workspace { position: relative; width: 100%; height: 450px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 15px; }
        .iat-label { position: absolute; top: 20px; font-size: 22px; font-weight: bold; text-align: center; padding: 10px 20px; border-radius: 12px; line-height: 1.4; }
        .iat-left { left: 20px; border: 2px solid var(--blue); color: var(--blue); }
        .iat-right { right: 20px; border: 2px solid var(--green); color: var(--green); }
        .iat-stimulus { font-size: 55px; font-weight: bold; color: var(--primary); text-align: center; }
        .iat-error { position: absolute; bottom: 50px; color: var(--red); font-size: 50px; font-weight: bold; display: none; }
        .trial-counter { position: absolute; bottom: 15px; left: 15px; font-size: 14px; color: var(--slate); font-weight: bold; }
        
        /* LLM åŠ¨æ€ç»“æœæ æ ·å¼ (å·²æ— æŸæ¢å¤) */
        .llm-textarea { width: 100%; height: 150px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; box-sizing: border-box; resize: none; margin-bottom: 20px; line-height: 1.5; }
        .ocean-bar { display: flex; align-items: center; margin-bottom: 10px; }
        .ocean-label { width: 120px; font-weight: bold; font-size: 14px; }
        .ocean-track { flex: 1; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; }
        .ocean-fill { height: 100%; background: var(--purple); width: 0%; transition: width 1s; }
        .ocean-val { width: 40px; text-align: right; font-weight: bold; font-size: 14px; }
    </style>
    <script src="cas-storage.js"></script>
</head>
<body>
    <button onclick="location.href='index.html'" style="background:none; border:none; color:var(--rose); font-weight:bold; cursor:pointer; font-size:16px; margin-bottom:20px;">â† è¿”å›æ§åˆ¶å°</button>

    <div class="container" id="menu">
        <div class="module-header">
            <h2>ğŸ­ é«˜çº§æƒ…æ„Ÿä¸å†…éšè®¡ç®— (ä¸´åºŠå®Œæ•´ç‰ˆ)</h2>
            <p>åŸºäºè®¡ç®—ç²¾ç¥ç—…å­¦çš„å‰æ²¿æ¨¡å—ï¼Œæ•æ‰æ·±å±‚æ½œæ„è¯†ä¸ç¥ç»æŠ‘åˆ¶åŠŸèƒ½ã€‚</p>
        </div>
        <button class="sys-btn btn-menu" onclick="show('ser-area')">ğŸ™ï¸ 1. è¯­éŸ³æƒ…ç»ªè¯†åˆ« (SER éº¦å…‹é£ç¡¬ä»¶è°ƒç”¨)</button>
        <button class="sys-btn btn-menu" onclick="startERT()">ğŸ–¼ï¸ 2. æƒ…ç»ªè°ƒèŠ‚ä»»åŠ¡ (ERT è®¤çŸ¥é‡è¯„)</button>
        <button class="sys-btn btn-menu" onclick="startIAT_Intro()">âš¡ 3. æƒ…æ„Ÿå†…éšè”æƒ³æµ‹éªŒ (40è¯•æ¬¡ä¸´åºŠé˜²é”™ç‰ˆ)</button>
        <button class="sys-btn btn-menu" onclick="show('llm-area')">ğŸ¤– 4. NLP å¤§äº”äººæ ¼è®¡ç®— (å®Œæ•´åŠ¨æ€ç”»åƒ)</button>
    </div>

    <div class="container hidden" id="ser-area">
        <div class="module-header"><h2>è¯­éŸ³æƒ…ç»ªæå– (SER)</h2><p>æ•æ‰éŸµå¾‹ã€åŸºé¢‘èµ·ä¼ä¸æ¢…å°”é¢‘è°±èƒ½é‡ã€‚é¶å‘æŠ‘éƒç—‡(å¹³æ·¡å•è°ƒ)ä¸ç„¦è™‘ç—‡(é«˜é¢‘çˆ†å‘)ã€‚</p></div>
        <div style="text-align:center; padding: 40px; background:#f8fafc; border-radius: 16px; margin-bottom: 20px; border: 2px dashed #cbd5e1;">
            <div id="ser-status" style="font-size: 40px; margin-bottom: 10px;">ğŸ¤</div>
            <div id="ser-text" style="color: var(--slate); font-weight: bold;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œè®²è¿°ä¸€ä»¶è¿‘æœŸè®©æ‚¨æ„Ÿåˆ°æœ‰å‹åŠ›çš„äº‹æƒ… (30ç§’)ã€‚</div>
        </div>
        <div style="display:flex; gap:15px;">
            <button class="sys-btn btn-action" id="btn-ser-start" onclick="startSER()" style="margin:0;">å¼€å§‹å½•åˆ¶</button>
            <button class="sys-btn" id="btn-ser-stop" onclick="stopSER()" style="margin:0; background:var(--slate); color:white;" disabled>åœæ­¢å¹¶æå–</button>
        </div>
    </div>

    <div class="container hidden" id="ert-area">
        <div class="module-header"><h2>æƒ…ç»ªè°ƒèŠ‚èƒ½åŠ› (ERT)</h2><p>æµ‹é‡å‰é¢å¶å¯¹æä»æ ¸è‡ªä¸Šè€Œä¸‹çš„æŠ‘åˆ¶åŠŸèƒ½ (Cognitive Reappraisal)ã€‚</p></div>
        
        <div id="ert-placeholder" style="width:100%; height:250px; background:#e2e8f0; border-radius:16px; display:flex; align-items:center; justify-content:center; color:var(--slate); font-weight:bold; margin-bottom:20px;">
            [ç³»ç»Ÿå ä½ï¼šæ­¤å¤„åº”å‘ˆç°è´Ÿæ€§æƒ…ç»ªå›¾ç‰‡ï¼Œå¦‚è½¦ç¥¸ã€æ‚²ä¼¤åœºæ™¯]
        </div>

        <div class="ert-slider-box">
            <div class="ert-instruction" id="ert-instruction">è‡ªç„¶è§‚çœ‹ï¼šè¯·è¯„ä¼°æ‚¨ç°åœ¨çš„è´Ÿé¢æƒ…ç»ªå¼ºåº¦</div>
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <span style="color:var(--green);">0 (å®Œå…¨å¹³é™)</span>
                <span style="color:var(--rose);">100 (æåº¦éš¾å—)</span>
            </div>
            <input type="range" id="ert-slider" min="0" max="100" value="50">
            <div style="text-align:center; font-size:24px; font-weight:bold; color:var(--primary);" id="ert-val">50</div>
        </div>

        <button class="sys-btn btn-action" id="btn-ert-next" onclick="nextERTStep()">æäº¤è¯„åˆ†</button>
    </div>

    <div class="container hidden" id="iat-area">
        <div class="module-header"><h2>æƒ…æ„Ÿå†…éšè”æƒ³æµ‹éªŒ (40è¯•æ¬¡/åŒºå—)</h2><p>åŸºäºååº”æ—¶æµ‹é‡æ·±å±‚å†…éšåç½®ã€‚è¯·å°†åŒæ‰‹é£ŸæŒ‡æ”¾åœ¨é”®ç›˜çš„ <strong>E é”®</strong> å’Œ <strong>I é”®</strong> ä¸Šã€‚æŒ‰é”™æ—¶å‡ºç° âŒï¼Œå¿…é¡»æŒ‰å¯¹æ‰èƒ½ç»§ç»­ã€‚</p></div>
        
        <div class="iat-workspace">
            <div class="iat-label iat-left" id="iat-label-l">æˆ‘<br>OR<br>å¿«ä¹</div>
            <div class="iat-label iat-right" id="iat-label-r">ä»–äºº<br>OR<br>æ‚²ä¼¤</div>
            
            <div class="iat-stimulus" id="iat-stimulus">æŒ‰ç©ºæ ¼é”®å¼€å§‹ Block 1</div>
            <div class="iat-error" id="iat-error">âŒ</div>
            <div class="trial-counter" id="iat-counter"></div>
        </div>
        <p style="text-align:center; color:var(--slate); margin-top:15px;" id="iat-guide">æŒ‡å¯¼è¯­ï¼šè¯æ±‡å‡ºç°æ—¶ï¼Œå¦‚æœå±äºå·¦ä¾§ç±»åˆ«è¯·æŒ‰ <strong>E</strong>ï¼Œå±äºå³ä¾§ç±»åˆ«è¯·æŒ‰ <strong>I</strong>ã€‚è¯·å°½å¯èƒ½å¿«é€Ÿä¸”å‡†ç¡®ã€‚</p>
    </div>

    <div class="container hidden" id="llm-area">
        <div class="module-header"><h2>NLP äººæ ¼è¡¨å‹è®¡ç®—</h2><p>é€šè¿‡å¤§è¯­è¨€æ¨¡å‹(LLM)çš„è¯­ç”¨å­¦åˆ†æï¼Œå¯¹è‡ªå‘è¯­è¨€è¿›è¡Œç‰¹å¾é™ç»´ï¼Œå…é™¤é—®å·ä¸»è§‚åå·®ã€‚</p></div>
        
        <textarea class="llm-textarea" id="llm-input" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´å—è¯•è€…çš„è¯­éŸ³è½¬å½•æ–‡æœ¬...">ä»Šå¤©æˆ‘è§‰å¾—æœ‰ç‚¹ç´¯ï¼Œè™½ç„¶å¤–é¢å¤©æ°”å¾ˆå¥½ï¼Œä½†æˆ‘è¿˜æ˜¯ä¸å¤ªæƒ³å‡ºé—¨å’Œæœ‹å‹èšä¼šã€‚å¯èƒ½ä¸€ä¸ªäººå¾…åœ¨å®¶é‡Œçœ‹çœ‹ä¹¦ä¼šè®©æˆ‘è§‰å¾—æ›´èˆ’æœäº›ã€‚ä¸è¿‡å¦‚æœæ˜å¤©å·¥ä½œæœ‰å®‰æ’ï¼Œæˆ‘è¿˜æ˜¯ä¼šè®¤çœŸå»å®Œæˆçš„ã€‚</textarea>
        
        <button class="sys-btn btn-action" id="btn-llm" onclick="analyzeLLM()">ğŸ§  å¯åŠ¨ NLP è¯­ä¹‰ä¸æƒ…æ„Ÿåˆ†æ</button>

        <div id="llm-results" class="hidden" style="margin-top: 30px; padding: 25px; background: #f8fafc; border-radius: 16px;">
            <h3 style="margin-top:0; color:var(--purple);">å¤§äº”äººæ ¼ (OCEAN) é¢„æµ‹ç»“æœ</h3>
            <div class="ocean-bar"><span class="ocean-label">O (å¼€æ”¾æ€§)</span><div class="ocean-track"><div class="ocean-fill" id="o-o"></div></div><span class="ocean-val" id="v-o">0</span></div>
            <div class="ocean-bar"><span class="ocean-label">C (å°½è´£æ€§)</span><div class="ocean-track"><div class="ocean-fill" id="o-c"></div></div><span class="ocean-val" id="v-c">0</span></div>
            <div class="ocean-bar"><span class="ocean-label">E (å¤–å‘æ€§)</span><div class="ocean-track"><div class="ocean-fill" id="o-e"></div></div><span class="ocean-val" id="v-e">0</span></div>
            <div class="ocean-bar"><span class="ocean-label">A (å®œäººæ€§)</span><div class="ocean-track"><div class="ocean-fill" id="o-a"></div></div><span class="ocean-val" id="v-a">0</span></div>
            <div class="ocean-bar"><span class="ocean-label">N (ç¥ç»è´¨)</span><div class="ocean-track"><div class="ocean-fill" style="background:var(--rose);" id="o-n"></div></div><span class="ocean-val" style="color:var(--rose);" id="v-n">0</span></div>
            <button class="sys-btn" style="margin-top:20px; background:var(--primary); color:white;" onclick="saveLLM()">ğŸ’¾ ç¡®è®¤å¹¶å…¥åº“</button>
        </div>
    </div>

    <script>
        function show(id) {
            ['menu','ser-area','ert-area','iat-area','llm-area'].forEach(d => { document.getElementById(d).classList.add('hidden'); });
            document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0);
        }

        /* ================= 1. SER è¯­éŸ³æƒ…ç»ªè¯†åˆ«é€»è¾‘ (æ¢å¤ç¡¬ä»¶è°ƒç”¨) ================= */
        let serRecorder, serChunks = [];
        function startSER() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                serRecorder = new MediaRecorder(stream);
                serRecorder.ondataavailable = e => { if (e.data.size > 0) serChunks.push(e.data); };
                serRecorder.start();
                document.getElementById('ser-status').innerText = "ğŸ™ï¸ å½•éŸ³ä¸­...";
                document.getElementById('btn-ser-start').disabled = true;
                document.getElementById('btn-ser-stop').disabled = false;
                document.getElementById('btn-ser-stop').style.background = 'var(--rose)';
            }).catch(e => alert("æ— éº¦å…‹é£æƒé™ï¼è¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®ã€‚"));
        }
        function stopSER() {
            if(serRecorder && serRecorder.state !== "inactive") serRecorder.stop();
            document.getElementById('ser-status').innerText = "â³ æå–ä¸­...";
            serRecorder.onstop = () => {
                setTimeout(() => {
                    const serData = { module: "AEMO_SER", valence_score: 42, arousal_score: 65, prosody_variance: 0.12 };
                    CAS_Storage.saveModuleData('AEMO_SER', serData);
                    alert("âœ… è¯­éŸ³éŸµå¾‹ç‰¹å¾å·²æå–ï¼\n\n- æ•ˆä»· (Valence): 42 (åè´Ÿé¢)\n- å”¤é†’åº¦ (Arousal): 65 (åé«˜)\n- æ¨¡æ‹Ÿä¸´åºŠæç¤ºï¼šé«˜é¢‘èƒ½é‡å˜å¼‚æ€§å¢å¤§ï¼Œæç¤ºæ½œåœ¨ç„¦è™‘ç‰¹è´¨ã€‚");
                    show('menu');
                }, 1500);
            };
        }

        /* ================= 2. ERT æƒ…ç»ªè°ƒèŠ‚èƒ½åŠ›é€»è¾‘ ================= */
        let ertData = { module: "AEMO_ERT", baseline_score: 0, reappraisal_score: 0, regulation_capacity: 0 };
        let ertStep = 1;
        
        document.getElementById('ert-slider').oninput = function() { document.getElementById('ert-val').innerText = this.value; }

        function startERT() { ertStep = 1; document.getElementById('ert-slider').value = 50; document.getElementById('ert-val').innerText = 50; document.getElementById('ert-instruction').innerText = "æ­¥éª¤ 1/2 è‡ªç„¶è§‚çœ‹ï¼šè¯·è¯„ä¼°æ‚¨ç°åœ¨çš„è´Ÿé¢æƒ…ç»ªå¼ºåº¦"; show('ert-area'); }
        
        function nextERTStep() {
            if (ertStep === 1) {
                ertData.baseline_score = parseInt(document.getElementById('ert-slider').value);
                ertStep = 2;
                document.getElementById('ert-instruction').innerHTML = "æ­¥éª¤ 2/2 <span style='color:var(--blue);'>è®¤çŸ¥é‡è¯„ (Reappraisal)</span>ï¼š<br>è¯·è¯•ç€å‘Šè¯‰è‡ªå·±ï¼šã€è¿™åªæ˜¯ä¸€éƒ¨ç”µå½±çš„æ‹æ‘„ç°åœºï¼Œæ²¡æœ‰äººçœŸæ­£å—ä¼¤ã€ã€‚ç°åœ¨ï¼Œè¯·å†æ¬¡è¯„ä¼°æ‚¨çš„æƒ…ç»ªå¼ºåº¦ã€‚";
                document.getElementById('ert-slider').value = 50; document.getElementById('ert-val').innerText = 50;
            } else {
                ertData.reappraisal_score = parseInt(document.getElementById('ert-slider').value);
                ertData.regulation_capacity = ertData.baseline_score - ertData.reappraisal_score;
                CAS_Storage.saveModuleData('AEMO_ERT', ertData);
                alert(`âœ… ERT å®Œæˆï¼\n\nåŸºçº¿æƒ…ç»ª: ${ertData.baseline_score}\né‡è¯„åæƒ…ç»ª: ${ertData.reappraisal_score}\né‡è¯„è°ƒèŠ‚èƒ½åŠ›: ${ertData.regulation_capacity}\n\n*ä¸´åºŠæç¤ºï¼šå¦‚æœè°ƒèŠ‚èƒ½åŠ›<0æˆ–æå°ï¼Œæç¤ºç”±äºç¥ç»é€€è¡Œæ€§ç—…å˜å¯¼è‡´çš„å‰é¢å¶-æä»æ ¸è‡ªä¸Šè€Œä¸‹æŠ‘åˆ¶åŠŸèƒ½å‡é€€ã€‚`);
                show('menu');
            }
        }

        /* ================= 3. IAT æƒ…æ„Ÿå†…éšè”æƒ³é€»è¾‘ (40x2 ä¸´åºŠç‰ˆ) ================= */
        const IAT_TRIALS_PER_BLOCK = 40; 
        const iatWords = { self: ['æˆ‘', 'è‡ªå·±', 'æˆ‘çš„', 'æœ¬äºº'], other: ['ä»–', 'åˆ«äºº', 'ä»–ä»¬', 'ä»–äºº'], pos: ['å¿«ä¹', 'å¥åº·', 'æ´»åŠ›', 'å¹¸ç¦'], neg: ['å­¤ç‹¬', 'è¡°è€', 'ç—›è‹¦', 'æ‚²ä¼¤'] };
        let iatState = 0; 
        let iatTrials = [], currentWord = "", currentCorrectKey = "", iatOnset = 0;
        let b1_RT = [], b2_RT = [], errorFlag = false;

        function startIAT_Intro() { iatState = 0; b1_RT=[]; b2_RT=[]; document.getElementById('iat-stimulus').innerHTML = "æŒ‰ç©ºæ ¼é”®å¼€å§‹ Block 1<br><span style='font-size:24px; color:var(--slate);'>(ç›¸å®¹ä»»åŠ¡: 40æ¬¡)</span>"; document.getElementById('iat-counter').innerText = ""; show('iat-area'); }

        function generateIATBlock(isCongruent) {
            let seq = [];
            for(let i=0; i<IAT_TRIALS_PER_BLOCK/4; i++) {
                seq.push({w: iatWords.self[i%4], k: 'e'});
                seq.push({w: iatWords.other[i%4], k: 'i'});
                if(isCongruent) {
                    seq.push({w: iatWords.pos[i%4], k: 'e'}); seq.push({w: iatWords.neg[i%4], k: 'i'});
                } else {
                    seq.push({w: iatWords.neg[i%4], k: 'e'}); seq.push({w: iatWords.pos[i%4], k: 'i'});
                }
            }
            for (let i = seq.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [seq[i], seq[j]] = [seq[j], seq[i]]; }
            return seq;
        }

        document.addEventListener('keydown', (e) => {
            if(document.getElementById('iat-area').classList.contains('hidden')) return;
            const key = e.key.toLowerCase();
            
            if (iatState === 0 && key === ' ') { startBlock1(); }
            else if (iatState === 2 && key === ' ') { startBlock2(); }
            else if (iatState === 1 || iatState === 3) {
                if (key === 'e' || key === 'i') {
                    if (key === currentCorrectKey) {
                        const rt = performance.now() - iatOnset;
                        if(iatState === 1) b1_RT.push(rt); else b2_RT.push(rt);
                        document.getElementById('iat-error').style.display = 'none';
                        errorFlag = false;
                        nextIATWord();
                    } else {
                        document.getElementById('iat-error').style.display = 'block';
                        errorFlag = true;
                    }
                }
            }
        });

        function startBlock1() {
            iatState = 1; iatTrials = generateIATBlock(true); 
            document.getElementById('iat-label-l').innerHTML = "æˆ‘<br>OR<br>ç§¯æ"; document.getElementById('iat-label-r').innerHTML = "ä»–äºº<br>OR<br>æ¶ˆæ";
            nextIATWord();
        }

        function startBlock2() {
            iatState = 3; iatTrials = generateIATBlock(false); 
            document.getElementById('iat-label-l').innerHTML = "æˆ‘<br>OR<br>æ¶ˆæ"; document.getElementById('iat-label-r').innerHTML = "ä»–äºº<br>OR<br>ç§¯æ";
            nextIATWord();
        }

        function nextIATWord() {
            if (iatTrials.length === 0) {
                if (iatState === 1) { 
                    iatState = 2; 
                    document.getElementById('iat-stimulus').innerHTML = "Block 1 å®Œæˆï¼<br><span style='font-size:24px;color:var(--slate);'>è¯·æ·±å‘¼å¸ä¼‘æ¯ 5 ç§’...<br><br>æŒ‰ç©ºæ ¼é”®å¼€å§‹ Block 2 (æ³¨æ„è§„åˆ™å·²å¯¹è°ƒ!)</span>"; 
                    document.getElementById('iat-counter').innerText = ""; 
                } else { finishIAT(); }
                return;
            }
            const trial = iatTrials.pop();
            currentWord = trial.w; currentCorrectKey = trial.k;
            document.getElementById('iat-stimulus').innerText = "";
            document.getElementById('iat-counter').innerText = `å½“å‰åŒºå—è¿›åº¦: ${IAT_TRIALS_PER_BLOCK - iatTrials.length} / ${IAT_TRIALS_PER_BLOCK}`;
            
            setTimeout(() => { document.getElementById('iat-stimulus').innerText = currentWord; iatOnset = performance.now(); }, 350);
        }

        function finishIAT() {
            const avg1 = b1_RT.reduce((a,b)=>a+b,0)/b1_RT.length;
            const avg2 = b2_RT.reduce((a,b)=>a+b,0)/b2_RT.length;
            const dScore = avg2 - avg1; 
            
            CAS_Storage.saveModuleData('AEMO_IAT', { module: "AEMO_IAT", congruent_rt: Math.round(avg1), incongruent_rt: Math.round(avg2), implicit_bias_ms: Math.round(dScore) });
            alert(`âœ… ä¸´åºŠçº§ IAT æµ‹éªŒå®Œæˆï¼\n\n- ç›¸å®¹(40æ¬¡)å¹³å‡ RT: ${Math.round(avg1)} ms\n- ä¸ç›¸å®¹(40æ¬¡)å¹³å‡ RT: ${Math.round(avg2)} ms\n- å†…éšé˜»åŠ›å·®å€¼: ${Math.round(dScore)} ms\n\n*ä¸´åºŠæç¤º: å·®å€¼æ˜¾è‘—å¤§äºé›¶ï¼Œæç¤ºå­˜åœ¨ã€å†…éšæŠ‘éƒåç½®ã€‘ã€‚`);
            show('menu');
        }

        /* ================= 4. å¤§è¯­è¨€æ¨¡å‹ LLM æå–å¤§äº”äººæ ¼ (æ¢å¤åŠ¨æ€ UI) ================= */
        let llmResultData = {};
        
        function analyzeLLM() {
            const text = document.getElementById('llm-input').value;
            if (text.length < 20) return alert("æ–‡æœ¬è¿‡çŸ­ï¼ŒNLP æ— æ³•æå–æœ‰æ•ˆè¯­ä¹‰ç‰¹å¾ã€‚");
            
            document.getElementById('btn-llm').innerText = "ğŸ”„ æ­£åœ¨è¿æ¥äº‘ç«¯å¤§è¯­è¨€æ¨¡å‹åˆ†æä¸­...";
            document.getElementById('btn-llm').disabled = true;

            // æ¨¡æ‹Ÿå‘ ChatGPT æˆ–æœ¬åœ°æ¨¡å‹å‘é€ Prompt å¹¶è·å–æ‰“åˆ†
            setTimeout(() => {
                llmResultData = { O: 65, C: 80, E: 35, A: 75, N: 60, text_length: text.length };
                
                ['o','c','e','a','n'].forEach(trait => {
                    document.getElementById(`o-${trait}`).style.width = llmResultData[trait.toUpperCase()] + '%';
                    document.getElementById(`v-${trait}`).innerText = llmResultData[trait.toUpperCase()];
                });
                
                document.getElementById('llm-results').classList.remove('hidden');
                document.getElementById('btn-llm').innerText = "âœ… NLP è§£æå®Œæˆ";
            }, 2000);
        }

        function saveLLM() {
            CAS_Storage.saveModuleData('AEMO_LLM_Big5', { module: "AEMO_LLM_Big5", data: llmResultData });
            alert("âœ… NLP äººæ ¼ç”»åƒæ•°æ®å·²å…¥åº“ï¼æå–å¤§äº”äººæ ¼ç‰¹å¾ï¼Œæ— éœ€é—®å·ä½œç­”ã€‚");
            show('menu');
        }
    </script>
</body>
</html>
